<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Créateur de CV IA - Pro Recruteur</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&family=Montserrat:wght@400;500;700;800&family=Playfair+Display:ital,wght@0,400..900;1,400..900&family=Roboto+Mono:wght@400;700&family=Merriweather:wght@400;700&family=Oswald:wght@400;700&family=Cormorant+Garamond:wght@400;700&family=Open+Sans:wght@400;700&family=Source+Sans+Pro:wght@400;700&family=Nunito+Sans:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    
    <style>
        /* ===== SYSTÈME D'HARMONISATION MODERNE - STYLE APPLE ===== */
        
        /* Variables CSS pour une cohérence totale inspirée d'Apple */
        :root {
            --page-margin: 2cm;
            
            /* Couleurs inspirées d'Apple */
            --primary-color: #007AFF;
            --primary-hover: #0056CC;
            --primary-light: #339FFF;
            --secondary-color: #8E8E93;
            --accent-color: #FF3B30;
            --success-color: #34C759;
            --warning-color: #FF9500;
            --info-color: #5AC8FA;
            
            /* Palette de gris Apple */
            --white: #FFFFFF;
            --gray-50: #F9F9F9;
            --gray-100: #F2F2F7;
            --gray-200: #E5E5EA;
            --gray-300: #D1D1D6;
            --gray-400: #C7C7CC;
            --gray-500: #AEAEB2;
            --gray-600: #8E8E93;
            --gray-700: #636366;
            --gray-800: #48484A;
            --gray-900: #1C1C1E;
            --black: #000000;
            
            /* Système de couleurs sombres */
            --dark-bg: #1C1C1E;
            --dark-secondary-bg: #2C2C2E;
            --dark-tertiary-bg: #3A3A3C;
            --dark-text: #FFFFFF;
            --dark-secondary-text: #EBEBF5;
            
            /* Rayons de bordure Apple */
            --border-radius-xs: 4px;
            --border-radius-sm: 6px;
            --border-radius: 8px;
            --border-radius-md: 10px;
            --border-radius-lg: 12px;
            --border-radius-xl: 16px;
            --border-radius-2xl: 20px;
            --border-radius-3xl: 24px;
            
            /* Ombres sophistiquées Apple */
            --shadow-xs: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            --shadow-2xl: 0 50px 100px -20px rgba(0, 0, 0, 0.25);
            
            /* Effets de flou Apple */
            --backdrop-blur: blur(20px);
            --backdrop-blur-sm: blur(4px);
            --backdrop-blur-md: blur(12px);
            --backdrop-blur-lg: blur(16px);
            
            /* Transitions Apple fluides */
            --transition-fast: 0.15s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            --transition: 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            --transition-slow: 0.35s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            --transition-spring: 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            
            /* Typographie San Francisco inspirée */
            --font-family-system: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', 'Roboto', sans-serif;
            --font-family-h1: var(--font-family-system);
            --font-family-h2: var(--font-family-system);
            --font-family-body: var(--font-family-system);
            --font-size-h1: 40pt;
            --font-size-h2: 21pt;
            --font-size-p: 10pt;
            --font-size-banner: 9pt;
            --line-height: 1.5;
            --paragraph-spacing: 0.5rem;
            --module-spacing: 1.5rem;
            --item-spacing: 0.5rem;
            --banner-element-spacing: 1rem;
            
            /* Variables spécifiques au design Apple */
            --sidebar-width: 320px;
            --sidebar-bg: rgba(255, 255, 255, 0.8);
            --sidebar-backdrop: var(--backdrop-blur);
            --content-bg: var(--gray-50);
            --card-bg: var(--white);
            --text-primary: var(--gray-900);
            --text-secondary: var(--gray-600);
            --text-tertiary: var(--gray-500);
            --border-color: var(--gray-200);
            --border-color-light: var(--gray-100);
        }

        /* ===== STYLE DU SIDEBAR APPLE-LIKE ===== */
        
        /* Body et structure générale */
        body {
            font-family: var(--font-family-system);
            background: var(--content-bg);
            color: var(--text-primary);
            line-height: var(--line-height);
        }
        
        /* Container principal avec design Apple */
        .main-container {
            display: flex;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--gray-50) 0%, var(--gray-100) 100%);
        }
        
        /* Sidebar principal avec effet glassmorphism */
        #controls {
            width: var(--sidebar-width) !important;
            background: var(--sidebar-bg);
            backdrop-filter: var(--sidebar-backdrop);
            -webkit-backdrop-filter: var(--sidebar-backdrop);
            border-right: 1px solid var(--border-color-light);
            box-shadow: var(--shadow-xl);
            position: relative;
            overflow: hidden;
        }
        
        /* Effet de gradient subtil sur le sidebar */
        #controls::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--border-color), transparent);
            z-index: 1;
        }
        
        /* Header du sidebar avec style Apple */
        #controls .flex.justify-between.items-center {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border-radius: var(--border-radius-xl);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border-color-light);
            box-shadow: var(--shadow-sm);
        }
        
        /* Logo et titre avec style Apple */
        #controls .flex.items-center.gap-3 {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        #controls .fas.fa-magic-wand-sparkles {
            font-size: 1.75rem;
            color: var(--primary-color);
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            filter: drop-shadow(0 2px 4px rgba(0, 122, 255, 0.3));
        }
        
        #controls h1 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
            letter-spacing: -0.02em;
            margin: 0;
        }
        
        /* Boutons d'action dans le header */
        #controls .flex.items-center.gap-2 {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        /* Barre de progression avec style Apple */
        #controls .mb-4.flex-shrink-0:has(#progress-bar-container) {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius-lg);
            padding: 1rem;
            border: 1px solid var(--border-color-light);
            margin-bottom: 1.5rem;
        }
        
        #progress-bar-container {
            background: var(--gray-200);
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        
        #progress-bar {
            background: linear-gradient(90deg, var(--success-color), #40D572);
            border-radius: var(--border-radius);
            transition: width var(--transition-slow);
            box-shadow: 0 1px 3px rgba(52, 199, 89, 0.4);
        }
        
        /* Actions rapides avec design Apple */
        #controls .space-y-2.mb-4.p-4 {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(15px);
            border-radius: var(--border-radius-xl);
            padding: 1.25rem;
            border: 1px solid var(--border-color-light);
            box-shadow: var(--shadow);
            margin-bottom: 1.5rem;
        }
        
        /* Navigation des onglets avec style Apple */
        #tab-navigation {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border-radius: var(--border-radius-xl);
            padding: 0.5rem;
            border: 1px solid var(--border-color-light);
            box-shadow: var(--shadow-sm);
            margin-bottom: 1.5rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
        }
        
        /* Onglets avec effet de pilule Apple */
        .tab-btn {
            background: transparent;
            border: none;
            border-radius: var(--border-radius-md);
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
            transition: all var(--transition);
            cursor: pointer;
            position: relative;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            min-width: 0;
            flex: 1;
            justify-content: center;
        }
        
        .tab-btn:hover {
            color: var(--text-primary);
            background: rgba(0, 122, 255, 0.1);
            transform: translateY(-1px);
        }
        
        .tab-btn.active {
            background: var(--primary-color);
            color: white;
            box-shadow: var(--shadow-sm), 0 0 0 1px rgba(0, 122, 255, 0.2);
            transform: translateY(-1px);
        }
        
        .tab-btn i {
            font-size: 1rem;
            flex-shrink: 0;
        }
        
        .tab-btn .btn-text {
            font-size: 0.75rem;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* Contenu des onglets */
        #tab-content {
            flex: 1;
            overflow-y: auto;
            padding: 0 0.5rem;
        }
        
        /* Groupes de contrôles avec style Apple */
        .control-group {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(15px);
            border-radius: var(--border-radius-xl);
            border: 1px solid var(--border-color-light);
            margin-bottom: 1rem;
            box-shadow: var(--shadow-sm);
            overflow: hidden;
            transition: all var(--transition);
        }
        
        .control-group:hover {
            box-shadow: var(--shadow);
            border-color: var(--border-color);
        }
        
        .control-group[open] {
            box-shadow: var(--shadow-md);
        }
        
        /* Summary des groupes avec design Apple */
        .control-group summary {
            background: rgba(248, 248, 248, 0.8);
            padding: 1rem 1.25rem;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-primary);
            border-bottom: 1px solid var(--border-color-light);
            transition: all var(--transition);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
        }
        
        .control-group summary:hover {
            background: rgba(245, 245, 245, 0.9);
            color: var(--primary-color);
        }
        
        .control-group[open] summary {
            background: rgba(240, 240, 240, 0.9);
            border-bottom-color: var(--border-color);
        }
        
        /* Indicateur d'ouverture/fermeture */
        .control-group summary::after {
            content: '';
            width: 0.5rem;
            height: 0.5rem;
            border-right: 2px solid var(--text-secondary);
            border-bottom: 2px solid var(--text-secondary);
            transform: rotate(-45deg);
            transition: transform var(--transition);
        }
        
        .control-group[open] summary::after {
            transform: rotate(45deg);
        }
        
        /* Contenu des groupes */
        .control-group-content {
            padding: 1.25rem;
            background: rgba(255, 255, 255, 0.9);
        }
        
        /* Responsive pour écrans plus petits */
        @media (max-width: 1024px) {
            #controls {
                width: 100% !important;
                border-right: none;
                border-bottom: 1px solid var(--border-color-light);
            }
            
            .tab-btn .btn-text {
                display: none;
            }
            
            .tab-btn {
                min-width: 2.5rem;
                padding: 0.75rem;
            }
        }
        
        @media (max-width: 640px) {
            #controls {
                padding: 1rem;
            }
            
            #controls h1 {
                font-size: 1.25rem;
            }
            
            .tab-btn {
                min-width: 2rem;
                padding: 0.5rem;
            }
        }
        /* ===== ANIMATIONS FLUIDES APPLE ===== */
        
        @keyframes slideDown {
            from { 
                opacity: 0; 
                transform: translateY(-8px) scale(0.96); 
                max-height: 0; 
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
                max-height: 1000px; 
            }
        }

        @keyframes slideUp {
            from { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
                max-height: 1000px; 
            }
            to { 
                opacity: 0; 
                transform: translateY(-8px) scale(0.96); 
                max-height: 0; 
            }
        }

        @keyframes fadeIn {
            from { 
                opacity: 0; 
                transform: scale(0.94) translateY(4px); 
            }
            to { 
                opacity: 1; 
                transform: scale(1) translateY(0); 
            }
        }

        @keyframes fadeOut {
            from { 
                opacity: 1; 
                transform: scale(1) translateY(0); 
            }
            to { 
                opacity: 0; 
                transform: scale(0.94) translateY(4px); 
            }
        }

        @keyframes bounce {
            0%, 20%, 53%, 80%, 100% { 
                transform: translate3d(0,0,0); 
            }
            40%, 43% { 
                transform: translate3d(0, -6px, 0) scale(1.02); 
            }
            70% { 
                transform: translate3d(0, -3px, 0) scale(1.01); 
            }
            90% { 
                transform: translate3d(0, -1px, 0); 
            }
        }

        @keyframes pulse {
            0%, 100% { 
                opacity: 1; 
                transform: scale(1); 
            }
            50% { 
                opacity: 0.8; 
                transform: scale(1.02); 
            }
        }

        @keyframes shimmer {
            0% { background-position: -200px 0; }
            100% { background-position: calc(200px + 100%) 0; }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-2px); }
            20%, 40%, 60%, 80% { transform: translateX(2px); }
        }

        @keyframes glow {
            0%, 100% { 
                box-shadow: 0 0 5px var(--primary-color); 
            }
            50% { 
                box-shadow: 0 0 20px var(--primary-color), 0 0 30px var(--primary-color); 
            }
        }

        /* ===== SYSTÈME DE BOUTONS APPLE-LIKE ===== */
        
        /* Base pour tous les éléments interactifs */
        .interactive-element {
            transition: all var(--transition);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        /* Système de boutons harmonisé Apple */
        .btn-base {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            border: none;
            border-radius: var(--border-radius-md);
            font-family: var(--font-family-system);
            font-weight: 500;
            font-size: 0.875rem;
            line-height: 1.25rem;
            text-decoration: none;
            transition: all var(--transition);
            cursor: pointer;
            position: relative;
            overflow: hidden;
            outline: none;
            box-shadow: var(--shadow-xs);
            user-select: none;
            backdrop-filter: blur(10px);
            border: 1px solid transparent;
        }

        .btn-base:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }

        .btn-base:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none !important;
        }

        /* Effet de survol subtil Apple */
        .btn-base::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.15), transparent);
            transition: left var(--transition-slow);
        }

        .btn-base:hover::before {
            left: 100%;
        }

        /* Variantes de boutons Apple */
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            color: white;
            box-shadow: var(--shadow-sm), 0 4px 14px 0 rgba(0, 122, 255, 0.25);
            border: 1px solid rgba(0, 122, 255, 0.3);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, var(--primary-hover), var(--primary-color));
            transform: translateY(-1px) scale(1.02);
            box-shadow: var(--shadow-md), 0 8px 25px 0 rgba(0, 122, 255, 0.35);
        }

        .btn-primary:active {
            transform: translateY(0) scale(0.98);
            box-shadow: var(--shadow-xs);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.8);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.95);
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
            border-color: var(--border-color);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color), #40D572);
            color: white;
            box-shadow: var(--shadow-sm), 0 4px 14px 0 rgba(52, 199, 89, 0.25);
            border: 1px solid rgba(52, 199, 89, 0.3);
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #30B955, var(--success-color));
            transform: translateY(-1px) scale(1.02);
            box-shadow: var(--shadow-md), 0 8px 25px 0 rgba(52, 199, 89, 0.35);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color), #FFB340);
            color: white;
            box-shadow: var(--shadow-sm), 0 4px 14px 0 rgba(255, 149, 0, 0.25);
            border: 1px solid rgba(255, 149, 0, 0.3);
        }

        .btn-warning:hover {
            background: linear-gradient(135deg, #E6850E, var(--warning-color));
            transform: translateY(-1px) scale(1.02);
            box-shadow: var(--shadow-md), 0 8px 25px 0 rgba(255, 149, 0, 0.35);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--accent-color), #FF6B5A);
            color: white;
            box-shadow: var(--shadow-sm), 0 4px 14px 0 rgba(255, 59, 48, 0.25);
            border: 1px solid rgba(255, 59, 48, 0.3);
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #E8342A, var(--accent-color));
            transform: translateY(-1px) scale(1.02);
            box-shadow: var(--shadow-md), 0 8px 25px 0 rgba(255, 59, 48, 0.35);
        }

        .btn-info {
            background: linear-gradient(135deg, var(--info-color), #7DD3FC);
            color: white;
            box-shadow: var(--shadow-sm), 0 4px 14px 0 rgba(90, 200, 250, 0.25);
            border: 1px solid rgba(90, 200, 250, 0.3);
        }

        .btn-info:hover {
            background: linear-gradient(135deg, #38BDF8, var(--info-color));
            transform: translateY(-1px) scale(1.02);
            box-shadow: var(--shadow-md), 0 8px 25px 0 rgba(90, 200, 250, 0.35);
        }

        /* Tailles des boutons Apple */
        .btn-xs {
            padding: 0.375rem 0.5rem;
            font-size: 0.75rem;
            line-height: 1rem;
            min-height: 28px;
            border-radius: var(--border-radius-sm);
        }

        .btn-sm {
            padding: 0.5rem 0.75rem;
            font-size: 0.8rem;
            line-height: 1.1rem;
            min-height: 32px;
            border-radius: var(--border-radius);
        }

        .btn-base {
            padding: 0.625rem 1rem;
            font-size: 0.875rem;
            line-height: 1.25rem;
            min-height: 38px;
            border-radius: var(--border-radius-md);
        }

        .btn-lg {
            padding: 0.75rem 1.25rem;
            font-size: 0.95rem;
            line-height: 1.4rem;
            min-height: 44px;
            border-radius: var(--border-radius-lg);
        }

        .btn-xl {
            padding: 1rem 1.5rem;
            font-size: 1.1rem;
            line-height: 1.6rem;
            min-height: 52px;
            border-radius: var(--border-radius-xl);
        }

        /* Boutons compacts et formes spéciales */
        .btn-compact {
            padding: 0.5rem;
            min-width: 2.5rem;
            min-height: 2.5rem;
        }

        .btn-circle {
            border-radius: 50%;
            aspect-ratio: 1;
        }

        .btn-pill {
            border-radius: 9999px;
        }

        /* Boutons icon-only avec style Apple */
        .icon-only-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all var(--transition);
        }

        .icon-only-btn i {
            flex-shrink: 0;
        }

        .icon-only-btn .btn-text {
            font-size: 0.8rem;
            font-weight: 500;
        }

        /* Boutons AI avec style Apple amélioré */
        .ai-btn-enhanced {
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .ai-btn-enhanced::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            transform: translateX(-100%);
            transition: transform 0.6s;
        }

        .ai-btn-enhanced:hover::after {
            transform: translateX(100%);
        }

        /* Grilles responsives pour boutons */
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
        }

        @media (max-width: 640px) {
            .grid-2 {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }
            
            .grid-3 {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }
        }

        /* ===== FORMULAIRES ET INPUTS APPLE-LIKE ===== */
        
        .cv-input, input[type="text"], input[type="email"], input[type="tel"], 
        input[type="password"], input[type="url"], textarea, select {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid var(--border-color-light);
            border-radius: var(--border-radius-md);
            padding: 0.75rem 1rem;
            font-family: var(--font-family-system);
            font-size: 0.875rem;
            color: var(--text-primary);
            transition: all var(--transition);
            backdrop-filter: blur(10px);
            box-shadow: var(--shadow-xs);
        }
        
        .cv-input:focus, input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1), var(--shadow-sm);
            background: rgba(255, 255, 255, 0.95);
            transform: translateY(-1px);
        }
        
        .cv-input:hover, input:hover, textarea:hover, select:hover {
            border-color: var(--border-color);
            box-shadow: var(--shadow-sm);
        }
        
        .cv-input::placeholder, input::placeholder, textarea::placeholder {
            color: var(--text-tertiary);
        }
        
        /* Labels avec style Apple */
        label {
            font-family: var(--font-family-system);
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            display: block;
        }
        
        /* Checkboxes et completion labels */
        .completion-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-left: auto;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            padding: 0.5rem 0.75rem;
            border-radius: var(--border-radius-lg);
            border: 1px solid var(--border-color-light);
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--text-secondary);
            transition: all var(--transition);
        }
        
        .completion-label:hover {
            background: rgba(255, 255, 255, 0.95);
            border-color: var(--success-color);
            color: var(--success-color);
        }
        
        .completion-checkbox {
            appearance: none;
            width: 1rem;
            height: 1rem;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            background: white;
            cursor: pointer;
            transition: all var(--transition);
            position: relative;
        }
        
        .completion-checkbox:checked {
            background: var(--success-color);
            border-color: var(--success-color);
        }
        
        .completion-checkbox:checked::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 0.75rem;
            font-weight: bold;
        }
        
        /* Badges et indicateurs */
        .new-badge {
            background: linear-gradient(135deg, var(--accent-color), #FF6B5A);
            color: white;
            font-size: 0.6rem;
            font-weight: 600;
            padding: 0.125rem 0.375rem;
            border-radius: var(--border-radius-sm);
            margin-left: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.02em;
            box-shadow: var(--shadow-xs);
        }
        
        .api-key-status {
            font-size: 0.75rem;
            font-weight: 500;
            padding: 0.25rem 0.5rem;
            border-radius: var(--border-radius-sm);
            border: 1px solid;
        }
        
        .api-key-status.text-red-500 {
            color: var(--accent-color);
            background: rgba(255, 59, 48, 0.1);
            border-color: rgba(255, 59, 48, 0.2);
        }
        
        .api-key-status.text-green-500 {
            color: var(--success-color);
            background: rgba(52, 199, 89, 0.1);
            border-color: rgba(52, 199, 89, 0.2);
        }
        
        /* Skill style buttons */
        .skill-style-btn {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid var(--border-color-light);
            color: var(--text-secondary);
            transition: all var(--transition);
            backdrop-filter: blur(10px);
        }
        
        .skill-style-btn:hover {
            background: rgba(255, 255, 255, 0.95);
            border-color: var(--primary-color);
            color: var(--primary-color);
            transform: translateY(-1px);
        }
        
        .skill-style-btn.active {
            background: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
            box-shadow: var(--shadow-sm);
        }
        
        /* Dividers et séparateurs */
        .divider {
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--border-color), transparent);
            margin: 1rem 0;
        }
        
        /* Scrollbars avec style Apple */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
            border-radius: var(--border-radius);
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: var(--border-radius);
            transition: background var(--transition);
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.3);
        }
        
        /* Notifications et alertes */
        .notification {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-color-light);
            border-radius: var(--border-radius-xl);
            box-shadow: var(--shadow-lg);
            padding: 1rem 1.25rem;
            font-family: var(--font-family-system);
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .notification.success {
            border-left: 4px solid var(--success-color);
            background: rgba(52, 199, 89, 0.1);
        }
        
        .notification.error {
            border-left: 4px solid var(--accent-color);
            background: rgba(255, 59, 48, 0.1);
        }
        
        .notification.warning {
            border-left: 4px solid var(--warning-color);
            background: rgba(255, 149, 0, 0.1);
        }
        
        .notification.info {
            border-left: 4px solid var(--info-color);
            background: rgba(90, 200, 250, 0.1);
        }

        /* ===== AMÉLIORATION DES ICÔNES ET ESPACEMENT ===== */
        .btn-base i {
            font-size: 1em;
            margin-right: 0.375rem;
        }

        .btn-base i:only-child {
            margin-right: 0;
        }

        .btn-sm i {
            font-size: 0.9em;
            margin-right: 0.25rem;
        }

        .btn-lg i {
            font-size: 1.1em;
            margin-right: 0.5rem;
        }

        .btn-compact i {
            font-size: 1em;
            margin-right: 0;
        }

        /* Espacement harmonieux pour les boutons avec texte et icône */
        .btn-base:not(.btn-compact) {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.375rem;
        }

        .btn-base:not(.btn-compact) i + span,
        .btn-base:not(.btn-compact) i + text {
            margin-left: 0;
        }

        :root {
            --page-margin: 2cm;
            --primary-color: #2563eb;
            --secondary-color: #334155;
            --body-text-color: #334155;
            --font-family-h1: 'Montserrat', sans-serif;
            --font-family-h2: 'Montserrat', sans-serif;
            --font-family-body: 'Lato', sans-serif;
            --font-size-h1: 40pt;
            --font-size-h2: 21pt;
            --font-size-p: 10pt;
            --font-size-banner: 9pt;
            --line-height: 1.6;
            --paragraph-spacing: 0.5rem;
            --module-spacing: 1.5rem;
            --item-spacing: 0.5rem;
            --banner-element-spacing: 1rem;
        }

        #cv-preview-wrapper { width: 100%; display: flex; flex-direction: column; align-items: center; gap: 20px; }
        .a4-page-container { position: relative; }
        /* CORRECTIF : Remplacement de min-height par height pour une détection de dépassement fiable */
        .a4-page { width: 21cm; height: 29.7cm; box-shadow: 0 10px 30px rgba(0,0,0,0.15); background-color: white; overflow: hidden; display: flex; flex-direction: column; transition: all 0.3s ease; font-family: var(--font-family-body); color: var(--body-text-color); position: relative; outline: 2px solid transparent; outline-offset: -2px; padding: var(--page-margin); box-sizing: border-box; }
        body.overflow-check-active .is-overflowing { outline: 3px solid #ef4444 !important; box-shadow: 0 0 20px 8px rgba(239, 68, 68, 0.3) !important; }
        
        .remove-page-btn { position: absolute; top: -10px; right: -10px; width: 30px; height: 30px; background-color: #ef4444; color: white; border: none; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; opacity: 0.5; transition: opacity 0.2s, transform 0.2s; z-index: 10; }
        .remove-page-btn:hover { opacity: 1; transform: scale(1.1); }
        .a4-page-container:first-child .remove-page-btn { display: none; }

        #add-page-btn-wrapper { width: 21cm; text-align: center; padding: 10px 0; }
        #add-page-btn { width: 50px; height: 50px; background-color: #3b82f6; color: white; border-radius: 50%; border: none; cursor: pointer; font-size: 24px; transition: transform 0.2s; }
        #add-page-btn:hover { transform: scale(1.1); }

        .cv-body-container { display: grid; gap: 1rem; height: 100%; flex-grow: 1; position: relative; }
        .layout-1-col { grid-template-columns: 1fr; }
        .layout-2-col-33-67 { grid-template-columns: 1fr 2fr; }
        .layout-2-col-50-50 { grid-template-columns: 1fr 1fr; }
        .layout-2-col-67-33 { grid-template-columns: 2fr 1fr; }

        .cv-column { min-height: 150px; height: 100%; border: 1px dotted #ccc; padding: 5px; }
        .cv-module { position: relative; margin-bottom: var(--module-spacing); }
        .cv-module .drag-handle { position: absolute; top: 10px; left: -25px; cursor: grab; color: #d1d5db; opacity: 0; transition: opacity 0.2s; font-size: 1.2rem; }
        .cv-module:hover .drag-handle { opacity: 1; }
        .sortable-ghost { opacity: 0.4; background: #cce7ff; border: 1px dashed var(--primary-color); }

        [contenteditable="true"]:hover { outline: 1px dashed #3b82f6; background-color: #eff6ff; }
        [contenteditable="true"]:focus { outline: 2px solid #3b82f6; background-color: #dbeafe; }

        .cv-header h1 { font-family: var(--font-family-h1); font-weight: 800; font-size: var(--font-size-h1); color: var(--primary-color); margin-bottom: 0.25rem; }
        .cv-header p { font-family: var(--font-family-body); font-size: 1.2rem; color: var(--secondary-color); }
        .section-title { font-family: var(--font-family-h2); font-weight: 700; font-size: var(--font-size-h2); margin-bottom: 0.8rem; padding-bottom: 0.4rem; color: var(--primary-color); display: flex; align-items: center; gap: 0.5rem; transition: opacity 0.3s; }
        .section-title.style-underline { border-bottom: 2px solid var(--primary-color); }
        .section-title.style-side-line { border-left: 4px solid var(--primary-color); border-bottom: none; padding-left: 0.5rem; }
        .section-title.style-background { background-color: var(--primary-color); color: white; padding: 0.3rem 0.6rem; margin-bottom: 1rem; border-radius: 0.25rem; }
        .section-title.style-background .section-icon { color: white !important; }
        .section-title.style-boxed { border: 2px solid var(--primary-color); padding: 0.3rem 0.6rem; }
        .section-title.style-gradient { background: linear-gradient(45deg, var(--primary-color), var(--secondary-color)); color: white; padding: 0.3rem 0.6rem; margin-bottom: 1rem; border-radius: 0.25rem; }
        .section-title.style-gradient .section-icon { color: white !important; }
        .section-title.style-shadow { text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }

        /* New theme styles */
        .theme-elegant { --primary-color: #8b5a3c; --secondary-color: #d4af37; --body-text-color: #2c2c2c; }
        .theme-tech { --primary-color: #00d4aa; --secondary-color: #1a1a1a; --body-text-color: #333; }
        .theme-luxury { --primary-color: #b8860b; --secondary-color: #4b0082; --body-text-color: #2c2c2c; }
        .theme-startup { --primary-color: #ff6b35; --secondary-color: #f7931e; --body-text-color: #333; }
        .theme-academic { --primary-color: #2c3e50; --secondary-color: #34495e; --body-text-color: #2c3e50; }
        .theme-artistic { --primary-color: #e91e63; --secondary-color: #9c27b0; --body-text-color: #424242; }

        /* Glassmorphism effect */
        .glassmorphism { background: rgba(255, 255, 255, 0.25); backdrop-filter: blur(10px); border-radius: 10px; border: 1px solid rgba(255, 255, 255, 0.18); }
        .glassmorphism-dark { background: rgba(0, 0, 0, 0.25); backdrop-filter: blur(10px); border-radius: 10px; border: 1px solid rgba(255, 255, 255, 0.18); color: white; }

        /* Animation effects */
        @keyframes subtle-bounce { 0%, 20%, 50%, 80%, 100% { transform: translateY(0); } 40% { transform: translateY(-2px); } 60% { transform: translateY(-1px); } }
        @keyframes fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .cv-module.animate { animation: fade-in 0.3s ease-out; }
        .section-title.animate:hover { animation: subtle-bounce 0.6s; }

        /* Enhanced color palettes */
        .color-palette-btn { transition: all 0.2s ease; cursor: pointer; }
        .color-palette-btn:hover { transform: scale(1.05); }

        /* ===== SYSTÈME DE TOOLTIPS HARMONISÉ ===== */
        
        /* Tooltips pour tous les éléments avec l'attribut title */
        [title] {
            position: relative;
        }

        [title]:hover::after {
            content: attr(title);
            position: absolute;
            bottom: 130%;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
            color: white;
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 500;
            white-space: normal;
            max-width: 250px;
            min-width: max-content;
            z-index: 1001;
            pointer-events: none;
            box-shadow: 0 8px 25px rgba(0,0,0,0.25), 0 3px 10px rgba(0,0,0,0.15);
            animation: tooltipFadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards;
            line-height: 1.4;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
        }

        [title]:hover::before {
            content: '';
            position: absolute;
            bottom: 120%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: #1f2937;
            z-index: 1001;
            pointer-events: none;
            animation: tooltipFadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
        }

        /* Animation de reconstruction IA */
        .ai-reconstruction-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(168, 85, 247, 0.1));
            backdrop-filter: blur(2px);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
        }

        .ai-reconstruction-content {
            text-align: center;
            color: var(--primary-color);
            padding: 2rem;
        }

        .ai-reconstruction-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            animation: ai-spin 2s linear infinite;
        }

        .ai-reconstruction-text {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            animation: ai-pulse 1.5s ease-in-out infinite;
        }

        .ai-reconstruction-subtext {
            font-size: 0.9rem;
            opacity: 0.8;
            animation: ai-fade 2s ease-in-out infinite;
        }

        .ai-reconstruction-progress {
            width: 200px;
            height: 4px;
            background: rgba(59, 130, 246, 0.2);
            border-radius: 2px;
            margin: 1rem auto 0;
            overflow: hidden;
        }

        .ai-reconstruction-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6, #06d6a0);
            background-size: 200% 100%;
            animation: ai-progress 3s ease-in-out infinite, ai-gradient-shift 2s linear infinite;
            border-radius: 2px;
        }

        /* Animations clés */
        @keyframes ai-spin {
            0% { transform: rotate(0deg) scale(1); }
            25% { transform: rotate(90deg) scale(1.1); }
            50% { transform: rotate(180deg) scale(1); }
            75% { transform: rotate(270deg) scale(1.1); }
            100% { transform: rotate(360deg) scale(1); }
        }

        @keyframes ai-pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }

        @keyframes ai-fade {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }

        @keyframes ai-progress {
            0% { width: 0%; }
            50% { width: 70%; }
            100% { width: 100%; }
        }

        @keyframes ai-gradient-shift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Animation de particules */
        .ai-particles {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
        }

        .ai-particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: var(--primary-color);
            border-radius: 50%;
            animation: ai-float 3s linear infinite;
            opacity: 0;
        }

        @keyframes ai-float {
            0% {
                transform: translateY(100%) translateX(0) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(-100%) translateX(50px) rotate(360deg);
                opacity: 0;
            }
        }

        /* Animation de "reconstruction" des sections */
        .ai-rebuilding {
            animation: ai-rebuild 0.8s ease-in-out;
            transform-origin: left center;
        }

        @keyframes ai-rebuild {
            0% { 
                transform: scaleX(0.8) skewX(-5deg);
                opacity: 0.5;
                filter: blur(1px);
            }
            50% { 
                transform: scaleX(1.05) skewX(2deg);
                opacity: 0.8;
                filter: blur(0.5px);
            }
            100% { 
                transform: scaleX(1) skewX(0deg);
                opacity: 1;
                filter: blur(0px);
            }
        }

        /* Animation sur les boutons IA pendant le chargement */
        .ai-button-loading {
            position: relative;
            overflow: hidden;
        }

        .ai-button-loading::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: ai-button-shimmer 1.5s linear infinite;
        }

        @keyframes ai-button-shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        [title]:hover::after {
            content: attr(title);
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #1f2937;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1000;
            pointer-events: none;
            opacity: 0;
            animation: tooltipFadeIn 0.2s forwards;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            max-width: 200px;
            white-space: normal;
            text-align: center;
            line-height: 1.3;
        }
        
        [title]:hover::before {
            content: '';
            position: absolute;
            bottom: 115%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: #1f2937;
            z-index: 1000;
            pointer-events: none;
            opacity: 0;
            animation: tooltipFadeIn 0.2s forwards;
        }
        
        @keyframes tooltipFadeIn {
            from { 
                opacity: 0; 
                transform: translateX(-50%) translateY(8px) scale(0.95); 
                filter: blur(1px);
            }
            to { 
                opacity: 1; 
                transform: translateX(-50%) translateY(0) scale(1); 
                filter: blur(0);
            }
        }

        /* ===== SYSTÈME DE BOUTONS HARMONISÉ (ICÔNES SEULEMENT) ===== */
        
        /* Style pour tous les boutons icône-seulement */
        .icon-only-btn,
        .btn-compact,
        .skill-style-btn,
        .gauge-style-btn,
        .logo-size-btn,
        .banner-align-btn,
        .tab-btn,
        .ai-btn-enhanced,
        .theme-btn,
        .layout-btn,
        .style-toggle-btn,
        .section-title-style-btn,
        .color-palette-btn,
        button[data-gauge-style],
        button[data-skill-style],
        button[data-skill-template],
        button[class*="ai-btn"],
        .skill-template-btn {
            position: relative;
            display: inline-flex !important;
            align-items: center;
            justify-content: center;
            padding: 0.75rem !important;
            min-width: 2.5rem;
            min-height: 2.5rem;
            border-radius: var(--border-radius);
            transition: all var(--transition);
            font-size: 1rem;
            text-decoration: none;
            cursor: pointer;
            border: none;
            outline: none;
            box-shadow: var(--shadow-sm);
        }

        /* Masquer le texte, garder seulement les icônes */
        .icon-only-btn .btn-text,
        .icon-only-btn span:not(.new-badge):not(.completion-checkbox):not([class*="fa"]):not([class*="fas"]):not([class*="far"]):not([class*="fab"]),
        .skill-style-btn .btn-text,
        .skill-style-btn span:not(.new-badge):not(.completion-checkbox):not([class*="fa"]):not([class*="fas"]):not([class*="far"]):not([class*="fab"]),
        .gauge-style-btn span:not(.new-badge):not(.completion-checkbox):not([class*="fa"]):not([class*="fas"]):not([class*="far"]):not([class*="fab"]),
        .ai-btn-compact span:not(.new-badge):not(.completion-checkbox):not([class*="fa"]):not([class*="fas"]):not([class*="far"]):not([class*="fab"]),
        .ai-btn-enhanced.icon-only-btn .btn-text,
        .ai-btn-enhanced.icon-only-btn span:not(.new-badge):not(.completion-checkbox):not([class*="fa"]):not([class*="fas"]):not([class*="far"]):not([class*="fab"]),
        .theme-btn .btn-text,
        .theme-btn span:not(.new-badge):not(.completion-checkbox):not([class*="fa"]):not([class*="fas"]):not([class*="far"]):not([class*="fab"]),
        .layout-btn .btn-text,
        .layout-btn span:not(.new-badge):not(.completion-checkbox):not([class*="fa"]):not([class*="fas"]):not([class*="far"]):not([class*="fab"]),
        .style-toggle-btn .btn-text,
        .style-toggle-btn span:not(.new-badge):not(.completion-checkbox):not([class*="fa"]):not([class*="fas"]):not([class*="far"]):not([class*="fab"]),
        .section-title-style-btn .btn-text,
        .section-title-style-btn span:not(.new-badge):not(.completion-checkbox):not([class*="fa"]):not([class*="fas"]):not([class*="far"]):not([class*="fab"]),
        .color-palette-btn .btn-text,
        .color-palette-btn span:not(.new-badge):not(.completion-checkbox):not([class*="fa"]):not([class*="fas"]):not([class*="far"]):not([class*="fab"]),
        .btn-compact span:not(.new-badge):not(.completion-checkbox):not([class*="fa"]):not([class*="fas"]):not([class*="far"]):not([class*="fab"]) {
            display: none !important;
        }

        /* Garde les icônes visibles */
        .icon-only-btn i,
        .skill-style-btn i,
        .gauge-style-btn i,
        .ai-btn-compact i,
        .ai-btn-enhanced.icon-only-btn i,
        .theme-btn i,
        .layout-btn i,
        .style-toggle-btn i,
        .section-title-style-btn i,
        .color-palette-btn i,
        .btn-compact i {
            display: inline-block !important;
            margin: 0 !important;
            font-size: 1.1em;
        }

        /* Styles d'état pour les boutons harmonisés */
        .icon-only-btn:hover,
        .skill-style-btn:hover,
        .gauge-style-btn:hover,
        .ai-btn-compact:hover,
        .ai-btn-enhanced.icon-only-btn:hover,
        .theme-btn:hover,
        .layout-btn:hover,
        .style-toggle-btn:hover,
        .section-title-style-btn:hover,
        .color-palette-btn:hover,
        .btn-compact:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: var(--shadow-lg);
        }

        .icon-only-btn:active,
        .skill-style-btn:active,
        .gauge-style-btn:active,
        .ai-btn-compact:active,
        .ai-btn-enhanced.icon-only-btn:active,
        .theme-btn:active,
        .layout-btn:active,
        .style-toggle-btn:active,
        .section-title-style-btn:active,
        .color-palette-btn:active,
        .btn-compact:active {
            transform: translateY(0) scale(1);
            box-shadow: var(--shadow-sm);
        }

        .icon-only-btn.active,
        .skill-style-btn.active,
        .gauge-style-btn.active,
        .theme-btn.active,
        .layout-btn.active,
        .style-toggle-btn.active,
        .section-title-style-btn.active {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light)) !important;
            color: white !important;
            box-shadow: var(--shadow), 0 4px 14px 0 rgba(37, 99, 235, 0.25);
        }

        /* Exception pour les onglets - ils gardent leur style d'origine mais masquent le texte */
        .tab-btn.icon-only-btn {
            padding: 0.75rem 1rem !important;
            min-width: auto;
            min-height: auto;
            border-radius: 0;
            box-shadow: none;
        }

        .tab-btn.icon-only-btn:hover {
            transform: none;
            box-shadow: none;
        }

        .tab-btn.icon-only-btn:active {
            transform: none;
            box-shadow: none;
        }

        /* Variantes de couleurs pour les boutons IA */
        .ai-btn-compact {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
        }

        .ai-btn-compact:hover {
            background: linear-gradient(135deg, #1d4ed8, #1e40af);
        }

        /* Positionnement spécial des tooltips pour les petits boutons */
        .icon-only-btn[title]:hover::after,
        .skill-style-btn[title]:hover::after,
        .gauge-style-btn[title]:hover::after,
        .ai-btn-compact[title]:hover::after,
        .ai-btn-enhanced.icon-only-btn[title]:hover::after,
        .theme-btn[title]:hover::after,
        .layout-btn[title]:hover::after,
        .style-toggle-btn[title]:hover::after,
        .section-title-style-btn[title]:hover::after,
        .btn-compact[title]:hover::after {
            bottom: 140%;
            font-size: 11px;
            max-width: 200px;
        }

        .icon-only-btn[title]:hover::before,
        .skill-style-btn[title]:hover::before,
        .gauge-style-btn[title]:hover::before,
        .ai-btn-compact[title]:hover::before,
        .ai-btn-enhanced.icon-only-btn[title]:hover::before,
        .theme-btn[title]:hover::before,
        .layout-btn[title]:hover::before,
        .style-toggle-btn[title]:hover::before,
        .section-title-style-btn[title]:hover::before,
        .btn-compact[title]:hover::before {
            bottom: 130%;
        }
        
        /* Special positioning for small buttons */
        .logo-size-btn[title]:hover::after,
        .banner-align-btn[title]:hover::after,
        .gauge-style-btn[title]:hover::after {
            bottom: 140%;
            font-size: 11px;
        }

        /* Smart analysis results */
        .analysis-result { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1rem; border-radius: 0.5rem; margin: 1rem 0; }
        .score-indicator { display: inline-flex; align-items: center; gap: 0.5rem; }
        .score-bar { height: 8px; border-radius: 4px; background: rgba(255,255,255,0.3); overflow: hidden; }
        .score-fill { height: 100%; background: #4ade80; transition: width 0.3s ease; }

        /* CV Variants Modal */
        .variant-preview { border: 2px solid transparent; border-radius: 0.5rem; padding: 0.5rem; cursor: pointer; transition: all 0.2s; }
        .variant-preview:hover { border-color: var(--primary-color); background: #f8fafc; }
        .variant-preview.selected { border-color: var(--primary-color); background: #eff6ff; }

        /* Language selector for translation */
        .language-flag { width: 20px; height: 15px; margin-right: 0.5rem; }

        /* Motto/Slogan display */
        .motto-display { font-style: italic; text-align: center; border-left: 4px solid var(--primary-color); padding-left: 1rem; margin: 1rem 0; }

        /* Industry keywords highlight */
        .keyword-highlight { background: rgba(59, 130, 246, 0.1); padding: 2px 4px; border-radius: 3px; font-weight: 500; }

        /* CV scoring display */
        .cv-score-container { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 1.5rem; border-radius: 0.75rem; text-align: center; }
        .score-circle { width: 80px; height: 80px; border-radius: 50%; border: 4px solid rgba(255,255,255,0.3); display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; position: relative; }
        .score-text { font-size: 1.5rem; font-weight: bold; }

        /* New layout options */
        .layout-3-col { grid-template-columns: 1fr 1fr 1fr; }
        .layout-asymmetric-1 { grid-template-columns: 1fr 2fr 1fr; }
        .layout-asymmetric-2 { grid-template-columns: 2fr 1fr 1fr; }

        /* Enhanced section customization */
        .section-icon.animated { transition: transform 0.3s ease; }
        .section-icon.animated:hover { transform: rotate(360deg) scale(1.2); }

        /* Zebra sections effect */
        body.zebra-sections .cv-module:nth-child(even) { background: rgba(0, 0, 0, 0.02); border-radius: 8px; padding: 1rem; margin: 0.5rem 0; }

        /* Floating elements effect */
        .floating-element { animation: float 3s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-5px); } }

        /* Skill styles enhancements */
        .cv-competences-circular .skill-item { border-radius: 50%; width: 60px; height: 60px; display: inline-flex; align-items: center; justify-content: center; margin: 0.25rem; }
        .cv-competences-categories { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
        .cv-competences-timeline .skill-item { position: relative; padding-left: 2rem; }
        .cv-competences-timeline .skill-item::before { content: ''; position: absolute; left: 0; top: 50%; width: 12px; height: 12px; background: var(--primary-color); border-radius: 50%; transform: translateY(-50%); }

        /* Enhanced gauge styles */
        .gauge-percentage { display: flex; align-items: center; gap: 8px; }
        .gauge-percentage .skill-level-label { min-width: 120px; }
        .gauge-percentage .gauge-container { flex-grow: 1; position: relative; }
        .gauge-percentage-fill { background: linear-gradient(90deg, var(--primary-color), var(--secondary-color)); height: 8px; border-radius: 4px; transition: width 0.3s ease; }
        .gauge-percentage-text { min-width: 40px; text-align: right; font-weight: bold; color: var(--primary-color); }

        /* Font suggestion styles */
        .font-suggestions { animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .font-suggestion-btn { transition: all 0.2s ease; }
        .font-suggestion-btn:hover { transform: translateX(5px); }

        /* Enhanced modal animations */
        .modal-overlay { backdrop-filter: blur(5px); }
        .modal-overlay.active .modal-content { animation: modalSlideIn 0.3s ease; }
        @keyframes modalSlideIn { from { opacity: 0; transform: scale(0.9) translateY(-20px); } to { opacity: 1; transform: scale(1) translateY(0); } }

        /* Completion progress enhancements */
        #progress-bar { position: relative; overflow: hidden; }
        #progress-bar::after { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent); animation: shimmer 2s infinite; }
        @keyframes shimmer { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }

        /* Template button hover effects */
        .skill-template-btn, .section-template-btn { transition: all 0.2s ease; position: relative; overflow: hidden; }
        .skill-template-btn:hover, .section-template-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .skill-template-btn::before, .section-template-btn::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent); transition: left 0.5s; }
        .skill-template-btn:hover::before, .section-template-btn:hover::before { left: 100%; }

        /* AI analysis result enhancements */
        .analysis-result { position: relative; overflow: hidden; }
        .analysis-result::before { content: '🤖'; position: absolute; top: 1rem; right: 1rem; font-size: 1.5rem; opacity: 0.3; }

        /* Advanced AI Chat Styles */
        #ai-chat-float-btn {
            position: fixed;
            right: 30px;
            bottom: 30px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 50%;
            box-shadow: 0 8px 32px rgba(102, 126, 234, 0.3);
            cursor: move;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            transition: all 0.3s ease;
            user-select: none;
        }

        #ai-chat-float-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 48px rgba(102, 126, 234, 0.4);
        }

        #ai-chat-float-btn.dragging {
            cursor: grabbing;
            transform: scale(1.05);
        }

        #ai-chat-container {
            position: fixed;
            right: 100px;
            bottom: 100px;
            width: 400px;
            height: 600px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            z-index: 9998;
            display: none;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid #e5e7eb;
        }

        #ai-chat-container.show {
            display: flex;
            animation: chatSlideIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes chatSlideIn {
            from {
                opacity: 0;
                transform: scale(0.8) translateY(20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        #ai-chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: move;
        }

        #ai-chat-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }

        #ai-chat-close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }

        #ai-chat-close-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        #ai-chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            background: #fafafa;
        }

        .chat-message {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.4;
            animation: messageSlideIn 0.3s ease;
        }

        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .chat-message.user {
            align-self: flex-end;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .chat-message.ai {
            align-self: flex-start;
            background: white;
            color: #333;
            border: 1px solid #e5e7eb;
            border-bottom-left-radius: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .chat-message.ai.thinking {
            background: #f3f4f6;
            font-style: italic;
        }

        #ai-chat-input-container {
            padding: 20px;
            background: white;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 10px;
            align-items: end;
        }

        #ai-chat-input {
            flex: 1;
            resize: none;
            border: 1px solid #d1d5db;
            border-radius: 20px;
            padding: 12px 16px;
            font-size: 14px;
            max-height: 100px;
            min-height: 40px;
            outline: none;
            transition: border-color 0.2s;
            font-family: inherit;
        }

        #ai-chat-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        #ai-chat-send-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
            flex-shrink: 0;
        }

        #ai-chat-send-btn:hover:not(:disabled) {
            transform: scale(1.05);
        }

        #ai-chat-send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .chat-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .suggestion-chip {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            color: #0369a1;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .suggestion-chip:hover {
            background: #0ea5e9;
            color: white;
            transform: translateY(-1px);
        }

        .chat-typing-indicator {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 12px 16px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #9ca3af;
            animation: typingPulse 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typingPulse {
            0%, 60%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            30% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Responsive adjustments for chat */
        @media (max-width: 768px) {
            #ai-chat-container {
                width: 100vw;
                height: 100vh;
                right: 0;
                bottom: 0;
                border-radius: 0;
            }
            
            #ai-chat-float-btn {
                right: 20px;
                bottom: 20px;
                width: 50px;
                height: 50px;
                font-size: 20px;
            }
        }

        /* Chat button tooltips */
        #ai-smart-suggest-btn, #ai-quick-fix-btn {
            position: relative;
            transition: all 0.2s ease;
        }

        #ai-smart-suggest-btn:hover, #ai-quick-fix-btn:hover {
            transform: scale(1.1);
        }

        #ai-smart-suggest-btn:hover::after {
            content: attr(title);
            position: absolute;
            bottom: 130%;
            left: 50%;
            transform: translateX(-50%);
            background: #1f2937;
            color: white;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 11px;
            white-space: nowrap;
            z-index: 1000;
            pointer-events: none;
        }

        #ai-quick-fix-btn:hover::after {
            content: attr(title);
            position: absolute;
            bottom: 130%;
            left: 50%;
            transform: translateX(-50%);
            background: #1f2937;
            color: white;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 11px;
            white-space: nowrap;
            z-index: 1000;
            pointer-events: none;
        }

        #ai-smart-suggest-btn:hover::before {
            content: '';
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            border: 4px solid transparent;
            border-top-color: #1f2937;
            z-index: 1000;
            pointer-events: none;
        }

        #ai-quick-fix-btn:hover::before {
            content: '';
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            border: 4px solid transparent;
            border-top-color: #1f2937;
            z-index: 1000;
            pointer-events: none;
        }

        /* Enhanced AI Button Tooltips */
        .ai-btn-enhanced {
            position: relative !important;
        }

        /* Base class for all action buttons - unified styling */
        .action-btn-base {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: all 0.2s ease;
            cursor: pointer;
            color: white;
            font-size: 0.875rem;
        }

        .action-btn-base:hover {
            transform: scale(1.05);
        }

        .action-btn-base i {
            font-size: 1.125rem;
        }

        /* Apply base styling to all ai-btn-enhanced buttons */
        .ai-btn-enhanced {
            position: relative !important;
        }

        .ai-btn-enhanced[data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 110%;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 12px;
            white-space: normal;
            max-width: 280px;
            width: max-content;
            z-index: 1001;
            pointer-events: none;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            line-height: 1.4;
            text-align: center;
            animation: tooltipEnhancedFadeIn 0.3s ease-out forwards;
        }

        .ai-btn-enhanced[data-tooltip]:hover::before {
            content: '';
            position: absolute;
            bottom: 102%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: #1f2937;
            z-index: 1001;
            pointer-events: none;
            animation: tooltipEnhancedFadeIn 0.3s ease-out forwards;
        }

        @keyframes tooltipEnhancedFadeIn {
            from { 
                opacity: 0; 
                transform: translateX(-50%) translateY(10px) scale(0.9); 
            }
            to { 
                opacity: 1; 
                transform: translateX(-50%) translateY(0) scale(1); 
            }
        }

        /* Specific tooltip positioning for grid buttons */
        .grid button.ai-btn-enhanced[data-tooltip]:hover::after {
            bottom: 110%;
            max-width: 250px;
        }

        /* Compact tooltip for small buttons */
        .ai-btn-compact[data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 120%;
            left: 50%;
            transform: translateX(-50%);
            background: #1f2937;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 11px;
            white-space: normal;
            max-width: 200px;
            z-index: 1001;
            pointer-events: none;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
            animation: tooltipFadeIn 0.2s forwards;
        }

        .ai-btn-compact[data-tooltip]:hover::before {
            content: '';
            position: absolute;
            bottom: 112%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: #1f2937;
            z-index: 1001;
            pointer-events: none;
            animation: tooltipFadeIn 0.2s forwards;
        }

        /* Unified button system - separate treatment for action vs style buttons */
        
        /* Style/configuration buttons - icon only */
        .btn-icon-only {
            width: 36px !important;
            height: 36px !important;
            padding: 0 !important;
            min-width: auto !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            border-radius: 8px !important;
            border: 1px solid rgba(0,0,0,0.1) !important;
            transition: all 0.2s ease !important;
            cursor: pointer !important;
            font-size: 16px !important;
            position: relative !important;
        }

        .btn-icon-only:hover {
            transform: scale(1.1) !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
        }

        /* Hide text in icon-only buttons */
        .btn-icon-only .btn-text,
        .btn-icon-only span:not(.fa):not(.fas):not(.fab):not(.far):not(.new-badge) {
            display: none !important;
        }

        /* Apply icon-only styling to style/config buttons */
        .theme-btn,
        .skill-style-btn,
        .layout-btn,
        .gauge-style-btn,
        .color-palette-btn,
        .skill-template-btn,
        .section-template-btn {
            width: 36px !important;
            height: 36px !important;
            padding: 0 !important;
            min-width: auto !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            border-radius: 8px !important;
            border: 1px solid rgba(0,0,0,0.1) !important;
            transition: all 0.2s ease !important;
            cursor: pointer !important;
            font-size: 14px !important;
            position: relative !important;
        }

        .theme-btn:hover,
        .skill-style-btn:hover,
        .layout-btn:hover,
        .gauge-style-btn:hover,
        .color-palette-btn:hover,
        .skill-template-btn:hover,
        .section-template-btn:hover {
            transform: scale(1.1) !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
        }

        /* Hide text in style buttons but keep emojis and new badges */
        .theme-btn .btn-text,
        .skill-style-btn .btn-text,
        .layout-btn .btn-text,
        .gauge-style-btn .btn-text,
        .color-palette-btn .btn-text,
        .skill-template-btn:not([data-skill-template]) span:not(.fa):not(.fas):not(.fab):not(.far):not(.new-badge),
        .section-template-btn:not([data-section-template]) span:not(.fa):not(.fas):not(.fab):not(.far):not(.new-badge) {
            display: none !important;
        }

        /* Keep text for template buttons that show labels like "Tech", "Marketing" etc */
        .skill-template-btn,
        .section-template-btn {
            width: auto !important;
            min-width: 60px !important;
            padding: 4px 8px !important;
            font-size: 11px !important;
            font-weight: 600 !important;
            text-transform: uppercase !important;
        }

        /* Action buttons - keep text and icon */
        .ai-btn-enhanced {
            padding: 8px 12px !important;
            min-height: 36px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            gap: 6px !important;
            border-radius: 8px !important;
            transition: all 0.2s ease !important;
            cursor: pointer !important;
            font-size: 13px !important;
            font-weight: 500 !important;
            white-space: nowrap !important;
        }

        .ai-btn-enhanced:hover {
            transform: scale(1.05) !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
        }

        .ai-btn-enhanced i {
            font-size: 14px !important;
        }

        /* Compact buttons - smaller action buttons */
        .ai-btn-compact {
            width: 32px !important;
            height: 32px !important;
            padding: 0 !important;
            min-width: auto !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            border-radius: 6px !important;
            transition: all 0.2s ease !important;
            cursor: pointer !important;
            font-size: 14px !important;
        }

        .ai-btn-compact:hover {
            transform: scale(1.1) !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
        }

        /* Special handling for font suggestion buttons - keep text */
        .font-suggestion-btn {
            width: auto !important;
            padding: 6px 12px !important;
            min-width: 80px !important;
            height: 32px !important;
        }

        /* Legacy icon-only buttons */
        .icon-only-btn {
            padding: 0.5rem !important;
            min-width: auto !important;
            width: auto !important;
            aspect-ratio: 1;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
        }

        .icon-only-btn .btn-text {
            display: none;
        }

        .icon-only-btn:hover {
            transform: scale(1.1);
            transition: all 0.2s ease;
        }

        /* Fix for anonymize button visibility */
        #anonymize-btn {
            background-color: #475569 !important; /* slate-600 */
            color: white !important;
            border: none !important;
        }

        #anonymize-btn:hover {
            background-color: #334155 !important; /* slate-700 */
        }

        /* Responsive enhancements for small screens */
        @media (max-width: 768px) {
            .theme-btn, .skill-style-btn, .layout-btn { font-size: 0.75rem; padding: 0.5rem; }
            .modal-content { margin: 1rem; max-height: 90vh; overflow-y: auto; }
            .grid.grid-cols-3 { grid-template-columns: repeat(2, 1fr); }
            .grid.grid-cols-6 { grid-template-columns: repeat(3, 1fr); }
        }

        .section-title .section-icon { cursor: pointer; transition: transform 0.2s; }
        .section-title .section-icon:hover { transform: scale(1.1); }
        .a4-page p, .a4-page li, #cv-description-preview, #cv-experience-preview, #cv-formation-preview { font-size: var(--font-size-p); line-height: var(--line-height); }
        .a4-page p { margin-bottom: var(--paragraph-spacing); }
        .a4-page ul { list-style: none; padding-left: 0;}
        #cv-competences-preview[data-style="simple"] ul li,
        .a4-page ul li { padding-left: 1.4em; position: relative; margin-bottom: 0.25rem; }
        #cv-competences-preview[data-style="simple"] ul li::before,
        .a4-page ul li::before { content: '›'; font-weight: bold; position: absolute; left: 0; color: var(--primary-color); font-size: 1.2em; top: -0.1em; }
        
        .item-title { font-weight: 700; color: var(--secondary-color); }
        .item-meta { font-size: calc(var(--font-size-p) * 0.9); font-style: italic; }

        #recruiter-banner { display: none; align-items: center; padding: 0.5rem; box-sizing: border-box; width: 100%; font-size: var(--font-size-banner); position: relative; overflow: hidden; }
        .banner-content-wrapper { position: relative; z-index: 1; display: flex; align-items: center; width: 100%; height: 100%; gap: var(--banner-element-spacing); }
        #banner-bg-img-preview { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 0; transition: opacity 0.3s, filter 0.3s; }
        #fixed-banner-top { margin-bottom: var(--module-spacing); display: none; }
        #fixed-banner-bottom { margin-top: auto; padding-top: var(--module-spacing); display: none; }
        
        /* Styles spécifiques pour les boutons fixer bannière - visibilité assurée */
        #fix-banner-top-btn, #fix-banner-bottom-btn {
            background-color: #0d9488 !important; /* Teal-600 avec !important */
            color: white !important;
            border: 2px solid #ffffff !important;
            box-shadow: 0 2px 8px rgba(13, 148, 136, 0.3) !important;
            font-weight: 600 !important;
            transition: all 0.2s ease !important;
        }
        
        #fix-banner-top-btn:hover, #fix-banner-bottom-btn:hover {
            background-color: #0f766e !important; /* Teal-700 avec !important */
            transform: translateY(-1px) !important;
            box-shadow: 0 4px 12px rgba(13, 148, 136, 0.4) !important;
        }
        
        /* Style spécifique pour le bouton "Rendre modulaire" - correction du fond blanc */
        #modular-banner-btn {
            background-color: #f97316 !important; /* Orange-500 avec !important */
            color: white !important;
            border: 2px solid #ffffff !important;
            box-shadow: 0 2px 8px rgba(249, 115, 22, 0.3) !important;
            font-weight: 600 !important;
            transition: all 0.2s ease !important;
        }
        
        #modular-banner-btn:hover {
            background-color: #ea580c !important; /* Orange-600 avec !important */
            transform: translateY(-1px) !important;
            box-shadow: 0 4px 12px rgba(249, 115, 22, 0.4) !important;
        }
        
        /* Contrôle de l'image de fond de bannière */
        #banner-fix-controls {
            background-color: #f8fafc;
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid #e2e8f0;
            margin-bottom: 1rem;
        }
        
        /* Amélioration de la visibilité des éléments de bannière avec image de fond */
        .banner-content-wrapper * {
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }
        
        .banner-style-modern .banner-content-wrapper *, 
        .banner-style-degrade .banner-content-wrapper * {
            text-shadow: none; /* Pas besoin d'ombre pour les styles avec fond coloré */
        }
        #banner-img-preview { border-radius: 50%; object-fit: cover; flex-shrink: 0; transition: width 0.3s, height 0.3s; background-color: rgba(255,255,255,0.5); }
        #banner-img-preview.logo-sm { width: 40px; height: 40px; }
        #banner-img-preview.logo-md { width: 60px; height: 60px; }
        #banner-img-preview.logo-lg { width: 80px; height: 80px; }
        #banner-img-preview.logo-xl { width: 100px; height: 100px; }
        #banner-img-preview.logo-xxl { width: 120px; height: 120px; }
        #banner-nom-preview { font-weight: 700; }
        .banner-align-left { justify-content: flex-start; text-align: left; }
        .banner-align-center { justify-content: center; text-align: center; }
        .banner-align-right { justify-content: flex-end; text-align: right; }
        .banner-layout-inverted { flex-direction: row-reverse; }
        .banner-style-elegant { border-top: 2px solid var(--primary-color); border-bottom: 2px solid var(--primary-color); background: transparent; }
        .banner-style-modern { background-color: var(--primary-color); color: white; border-radius: 0.5rem; }
        .banner-style-modern p, .banner-style-modern span { color: white !important; }
        .banner-style-discret { border-left: 4px solid #d1d5db; background: transparent; }
        .banner-style-carte { box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); border-radius: 0.5rem; background: #f9fafb; }
        .banner-style-degrade { background: linear-gradient(to right, var(--primary-color), #a5b4fc); color: white; border-radius: 0.5rem; }
        .banner-style-degrade p, .banner-style-degrade span { color: white !important; }
        .banner-style-premium { background-color: #1e293b; color: #fde68a; border: 1px solid #fde68a; border-radius: 0.25rem; }
        .banner-style-premium p, .banner-style-premium span { color: #f1f5f9 !important; }
        .banner-style-minimal { border-bottom: 2px solid var(--primary-color); }
        .banner-style-encadre { border: 2px solid var(--primary-color); border-radius: 0.5rem; }
        .banner-style-ligne-haute { border-top: 4px solid var(--primary-color); padding-top: 0.8rem !important; }

        #notification { position: fixed; top: 20px; right: 20px; z-index: 10000; }
        .toast { background-color: white; color: #111827; padding: 1rem 1.5rem; border-radius: 0.5rem; box-shadow: 0 5px 15px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 0.75rem; transition: all 0.3s ease; transform: translateX(120%); }
        .toast.show { transform: translateX(0); }

        /* Styles for collapsible control panel sections */
        details.control-group {
            background-color: #f9fafb;
            border: 1px solid #f3f4f6;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
        }
        details.control-group[open] {
            background-color: white;
            border-color: #e5e7eb;
        }
        details.control-group summary {
            list-style: none;
            cursor: pointer;
            padding: 1rem;
            font-weight: 600;
            color: #374151;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        details.control-group summary::-webkit-details-marker {
            display: none;
        }
        details.control-group .control-group-content {
            padding: 0 1rem 1rem 1rem;
            border-top: 1px solid #f3f4f6;
            margin-top: -0.5rem;
            padding-top: 1rem;
        }
        .completion-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
            font-weight: 400;
            color: #6b7280;
            cursor: pointer;
        }
        .completion-checkbox {
            height: 1rem;
            width: 1rem;
            border-radius: 0.25rem;
            border-color: #d1d5db;
            color: #4f46e5;
            cursor: pointer;
        }
        .completion-checkbox:focus {
            outline: 2px solid #4f46e5;
            outline-offset: 2px;
        }
        
        /* API Key Management Styles */
        .api-key-container {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border: 1px solid #cbd5e1;
            border-radius: 0.5rem;
            padding: 1rem;
        }
        
        #api-key-input {
            font-family: 'Courier New', monospace;
            letter-spacing: 0.5px;
        }
        
        #api-key-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .api-key-status {
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .api-key-status.text-green-600::before {
            content: '✓';
            color: #16a34a;
            font-weight: bold;
        }
        
        .api-key-status.text-red-500::before {
            content: '✗';
            color: #dc2626;
            font-weight: bold;
        }
        
        .api-key-status.text-yellow-600::before {
            content: '⚠';
            color: #d97706;
            font-weight: bold;
        }
        
        #toggle-api-key-visibility {
            transition: color 0.2s ease;
        }
        
        #toggle-api-key-visibility:hover {
            color: #3b82f6;
        }
        
        /* --- Specific styles for skills section --- */
        #cv-competences-preview h3.skill-category { font-family: var(--font-family-h2); font-weight: 700; color: var(--secondary-color); margin-top: 0.8rem; margin-bottom: 0.4rem; padding-bottom: 0.2rem; border-bottom: 1px solid #e5e7eb; font-size: calc(var(--font-size-p) * 1.05); text-transform: uppercase; letter-spacing: 0.5px; }
        #cv-competences-preview .skill-category:hover { background-color: #f3f4f6; }
        #cv-competences-preview[data-style="tags"] ul { padding-left: 0; list-style: none; margin-top: 0.25rem; margin-bottom: 0.5rem; line-height: 1.5; }
        #cv-competences-preview[data-style="tags"] ul li.skill-item { display: inline-block; margin: 0 8px 6px 0; padding: 3px 20px 3px 10px; border-radius: 12px; background-color: #f3f4f6; font-size: calc(var(--font-size-p) * 0.95); position: relative; cursor: grab; }
        #cv-competences-preview[data-style="tags"] ul li.skill-item:hover { background-color: #e5e7eb; }
        #cv-competences-preview[data-style="tags"] ul li::before { content: none; }
        .skills-ghost { opacity: 0.4; background: #cce7ff; border-radius: 12px; }
        .skill-item .delete-skill-btn { display: none; position: absolute; top: 50%; right: 5px; transform: translateY(-50%); cursor: pointer; font-size: 14px; line-height: 1; color: #9ca3af; padding: 2px; }
        .skill-item:hover .delete-skill-btn { display: inline-block; }
        .skill-item .delete-skill-btn:hover { color: #ef4444; }
        .style-toggle-btn.active, .skill-style-btn.active, .section-title-style-btn.active, .layout-btn.active, .banner-align-btn.active, .logo-size-btn.active, .theme-btn.active, #banner-invert-btn.active, .gauge-style-btn.active, #toggle-overflow-btn.active { background-color: #3b82f6; color: white; }
        .skill-level { display: flex; align-items: center; margin-bottom: 6px; gap: 8px; }
        .skill-level-label { width: 120px; flex-shrink: 0; font-size: var(--font-size-p); }
        
        /* Gauge Styles */
        .gauge-container { flex-grow: 1; }
        .gauge-bar-bg { background-color: #e5e7eb; border-radius: 4px; height: 8px; overflow: hidden;}
        .gauge-bar-fill { background-color: var(--primary-color); height: 100%; border-radius: 4px; transition: width 0.3s ease; }
        .gauge-dots, .gauge-stars, .gauge-squares { display: flex; gap: 4px; font-size: 1.2em; color: #d1d5db; }
        .gauge-dots .filled, .gauge-stars .filled, .gauge-squares .filled { color: var(--primary-color); }
        .gauge-number { font-weight: bold; color: var(--secondary-color); }

        .editable-wrapper { position: relative; }
        .editable-wrapper .delete-line-btn { display: none; position: absolute; top: 50%; right: 2px; transform: translateY(-50%); cursor: pointer; color: #ef4444; background-color: white; border-radius: 50%; width: 18px; height: 18px; text-align: center; line-height: 18px; font-size: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); z-index: 5; }
        .editable-wrapper:hover .delete-line-btn { display: flex; align-items: center; justify-content: center; }
        .history-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .insert-line-wrapper { position: relative; height: 0.5rem; opacity: 0; transition: opacity 0.2s; margin: 0; display: flex; justify-content: center; align-items: center; }
        .dynamic-item-container:hover .insert-line-wrapper { opacity: 1; }
        .add-line-preview-btn { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: #eef2ff; color: #4f46e5; border: 1px dashed #a5b4fc; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; z-index: 5; display: flex; align-items: center; justify-content: center; font-size: 12px; transition: all 0.2s; }
        .add-line-preview-btn:hover { background: #c7d2fe; border-style: solid; transform: translate(-50%, -50%) scale(1.1); }
        
        .add-desc-line-btn { display: none; font-size: 0.8rem; color: #4f46e5; cursor: pointer; margin-top: 0.25rem; padding: 2px 4px; border-radius: 4px; background: transparent; border: none; }
        .add-desc-line-btn:hover { background-color: #eef2ff; }
        .dynamic-preview-item:hover .add-desc-line-btn { display: inline-block; }

        .dynamic-preview-item { position: relative; border: 1px solid transparent; border-radius: 0.375rem; padding: 0.5rem; margin-bottom: var(--item-spacing); transition: border-color 0.2s, background-color 0.2s, opacity 0.3s; }
        .dynamic-preview-item:hover { background-color: #fafafa; border-color: #e5e7eb; }

        .delete-block-btn { display: none; position: absolute; top: 4px; right: 4px; width: 24px; height: 24px; background-color: #fee2e2; color: #b91c1c; border: none; border-radius: 50%; cursor: pointer; align-items: center; justify-content: center; z-index: 6; }
        .dynamic-preview-item:hover .delete-block-btn { display: flex; }
        .delete-block-btn:hover { background-color: #fecaca; color: #991b1b; }
        .new-badge { background-color: #ef4444; color: white; font-size: 0.6rem; font-weight: bold; padding: 2px 5px; border-radius: 4px; margin-left: 6px; vertical-align: middle; }
        
        /* Modal Styles */
        .modal-overlay { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 5000; opacity: 0; transition: opacity 0.2s; pointer-events: none; }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        .modal-content { background: white; padding: 2rem; border-radius: 0.5rem; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 90%; max-width: 500px; transform: scale(0.95); transition: transform 0.2s; }
        .modal-overlay.active .modal-content { transform: scale(1); }
        
        /* Icon Picker Modal */
        #icon-picker-modal .modal-content { max-width: 700px; }
        #icon-picker-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(50px, 1fr)); gap: 0.5rem; max-height: 60vh; overflow-y: auto; }
        #icon-picker-grid i { font-size: 1.5rem; padding: 0.75rem; border-radius: 0.25rem; cursor: pointer; text-align: center; transition: background-color 0.2s, color 0.2s; }
        #icon-picker-grid i:hover { background-color: #eef2ff; color: #4f46e5; }
        
        /* In-Preview AI Buttons */
        .section-ai-actions { margin-left: auto; display: flex; gap: 0.5rem; opacity: 0; transition: opacity 0.2s; }
        .cv-module:hover .section-ai-actions { opacity: 1; }
        .ai-action-btn { background: #e0e7ff; color: #4338ca; border: none; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 0.8rem; }
        .ai-action-btn:hover { background: #c7d2fe; }

        /* Styles for hiding sections */
        .cv-module.section-hidden > *:not(h2) {
            display: none;
        }
        .cv-module.section-hidden > h2 {
            opacity: 0.5;
        }

        /* For column resizing */
        .column-resizer {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 10px; /* Wider grab area */
            cursor: col-resize;
            transform: translateX(-50%);
            z-index: 20; /* High z-index */
        }
        .column-resizer::after {
            content: '';
            position: absolute;
            top: 0;
            bottom: 0;
            left: 4px; /* Centered 2px line in a 10px div */
            width: 2px;
            background-color: #d1d5db;
            transition: background-color 0.2s ease;
        }
        .column-resizer:hover::after,
        body.is-resizing .column-resizer::after {
            background-color: #3b82f6;
        }
        body.is-resizing {
            cursor: col-resize;
            user-select: none;
        }

        /* Presentation Mode & Print Styles */
        body.presentation-mode .cv-column {
            border-color: transparent;
        }
        body.presentation-mode .column-resizer,
        body.presentation-mode .drag-handle,
        body.presentation-mode .remove-page-btn,
        body.presentation-mode #add-page-btn-wrapper,
        body.presentation-mode .section-ai-actions,
        body.presentation-mode .delete-block-btn,
        body.presentation-mode .delete-line-btn,
        body.presentation-mode .insert-line-wrapper {
            display: none !important;
        }
        /* NEW: Completely hide the module in presentation mode if hidden */
        body.presentation-mode .cv-module.section-hidden {
            display: none !important;
        }

        @media print {
            body {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            .column-resizer,
            .drag-handle {
                display: none !important;
            }
            .cv-column {
                border-color: transparent !important;
            }
            .no-print {
                display: none !important;
            }
            .cv-module.section-hidden {
                display: none !important;
            }
            .a4-page {
                box-shadow: none !important;
                margin: 0;
                overflow: visible;
                height: auto;
                break-inside: avoid-page;
            }
            #cv-preview-wrapper {
                gap: 0;
            }
        }

        /* Splash Screen Styles */
        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 99999;
            opacity: 1;
            transition: opacity 0.8s ease-out;
        }

        #splash-screen.fade-out {
            opacity: 0;
            pointer-events: none;
        }

        #splash-screen::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .splash-content {
            position: relative;
            z-index: 2;
            text-align: center;
            color: white;
        }

        .splash-logo {
            font-size: 4rem;
            margin-bottom: 1rem;
            animation: pulse 2s infinite;
        }

        .splash-title {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
            font-family: 'Montserrat', sans-serif;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .splash-subtitle {
            font-size: 1.2rem;
            margin-bottom: 3rem;
            opacity: 0.9;
            font-weight: 300;
        }

        .loading-container {
            width: 300px;
            margin: 0 auto;
        }

        .loading-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 1rem;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
        }

        .loading-progress {
            height: 100%;
            background: linear-gradient(90deg, #ffffff, #f0f0f0, #ffffff);
            background-size: 200% 100%;
            border-radius: 3px;
            width: 0%;
            animation: shimmer 1.5s infinite;
            transition: width 0.3s ease;
        }

        .loading-text {
            font-size: 1rem;
            opacity: 0.8;
            font-weight: 400;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        .splash-particles {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: 1;
        }

        .particle {
            position: absolute;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            animation: float 6s infinite ease-in-out;
        }

        .particle:nth-child(1) { width: 20px; height: 20px; left: 10%; animation-delay: 0s; }
        .particle:nth-child(2) { width: 30px; height: 30px; left: 20%; animation-delay: 1s; }
        .particle:nth-child(3) { width: 15px; height: 15px; left: 35%; animation-delay: 2s; }
        .particle:nth-child(4) { width: 25px; height: 25px; left: 50%; animation-delay: 1.5s; }
        .particle:nth-child(5) { width: 18px; height: 18px; left: 65%; animation-delay: 0.5s; }
        .particle:nth-child(6) { width: 22px; height: 22px; left: 80%; animation-delay: 2.5s; }

        @keyframes float {
            0%, 100% { transform: translateY(100vh) rotate(0deg); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(-100px) rotate(360deg); opacity: 0; }
        }

        /* Compact tab system */
        #tab-navigation {
            display: flex;
            flex-wrap: wrap;
            gap: 2px;
            margin-bottom: 16px;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 8px;
        }

        .tab-btn {
            padding: 6px 12px !important;
            font-size: 12px !important;
            font-weight: 500 !important;
            border: 1px solid #d1d5db !important;
            border-radius: 6px !important;
            background: #f9fafb !important;
            color: #6b7280 !important;
            transition: all 0.2s ease !important;
            cursor: pointer !important;
            white-space: nowrap !important;
            position: relative !important;
            margin-bottom: 0 !important;
            border-bottom: none !important;
            min-height: 32px !important;
            display: flex !important;
            align-items: center !important;
            gap: 4px !important;
        }

        /* ===== SYSTÈME D'ONGLETS MODERNE ===== */
        .tab-btn {
            background: transparent;
            color: var(--gray-600);
            border: none;
            border-bottom: 2px solid transparent;
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition);
            position: relative;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            white-space: nowrap;
            overflow: hidden;
        }

        .tab-btn::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--primary-color), var(--primary-light));
            transition: all var(--transition);
            transform: translateX(-50%);
        }

        .tab-btn:hover:not(.active) {
            color: var(--gray-700);
            background: var(--gray-50);
            transform: translateY(-1px);
        }

        .tab-btn:hover:not(.active)::before {
            width: 50%;
        }

        .tab-btn.active {
            color: var(--primary-color);
            background: linear-gradient(145deg, var(--gray-50), white);
            font-weight: 600;
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }

        .tab-btn.active::before {
            width: 100%;
        }

        .tab-btn i {
            font-size: 0.875rem;
            transition: transform var(--transition);
        }

        .tab-btn:hover i,
        .tab-btn.active i {
            transform: scale(1.1);
        }

        /* Panneau d'onglets */
        .tab-panel {
            animation: fadeIn var(--transition-slow) ease-out;
        }

        .tab-panel.hidden {
            display: none;
        }

        /* ===== GROUPES DE CONTRÔLES MODERNES ===== */
        .control-group {
            border: 1px solid var(--gray-200);
            border-radius: var(--border-radius-lg);
            margin-bottom: 1rem;
            background: white;
            overflow: hidden;
            transition: all var(--transition);
            box-shadow: var(--shadow-sm);
        }

        .control-group:hover {
            border-color: var(--gray-300);
            box-shadow: var(--shadow);
        }

        .control-group[open] {
            border-color: var(--primary-color);
            box-shadow: var(--shadow-md), 0 0 0 1px rgba(37, 99, 235, 0.1);
        }

        .control-group summary {
            padding: 1rem 1.25rem;
            background: linear-gradient(145deg, var(--gray-50), white);
            cursor: pointer;
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--gray-700);
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all var(--transition);
            position: relative;
            outline: none;
        }

        .control-group summary:hover {
            background: linear-gradient(145deg, var(--gray-100), var(--gray-50));
            color: var(--gray-800);
        }

        .control-group[open] summary {
            background: linear-gradient(145deg, rgba(37, 99, 235, 0.05), rgba(37, 99, 235, 0.02));
            color: var(--primary-color);
            border-color: rgba(37, 99, 235, 0.2);
        }

        .control-group summary::marker {
            display: none;
        }

        .control-group summary::before {
            content: '▶';
            font-size: 0.75rem;
            transition: transform var(--transition);
            margin-right: 0.75rem;
            color: var(--gray-400);
        }

        .control-group[open] summary::before {
            transform: rotate(90deg);
            color: var(--primary-color);
        }

        .control-group summary:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: -2px;
        }

        .control-group-content {
            padding: 1.25rem;
            border-top: none;
            animation: slideDown var(--transition-slow) ease-out;
            background: white;
        }

        /* ===== ÉTIQUETTES DE COMPLETION ===== */
        .completion-label {
            font-size: 0.75rem;
            color: var(--gray-500);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0.5rem;
            border-radius: var(--border-radius);
            background: var(--gray-50);
            transition: all var(--transition);
        }

        .completion-label:hover {
            background: var(--gray-100);
        }

        .completion-checkbox {
            width: 1rem;
            height: 1rem;
            border-radius: var(--border-radius-sm);
            border: 2px solid var(--gray-300);
            background: white;
            cursor: pointer;
            transition: all var(--transition);
            appearance: none;
            position: relative;
        }

        .completion-checkbox:checked {
            background: var(--success-color);
            border-color: var(--success-color);
        }

        .completion-checkbox:checked::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .completion-checkbox:hover {
            border-color: var(--primary-color);
            transform: scale(1.05);
        }

        /* ===== BADGES ET INDICATEURS ===== */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.5rem;
            border-radius: var(--border-radius);
            font-size: 0.75rem;
            font-weight: 500;
            line-height: 1;
        }

        .badge-primary {
            background: rgba(37, 99, 235, 0.1);
            color: var(--primary-color);
        }

        .badge-success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success-color);
        }

        .badge-warning {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning-color);
        }

        .badge-danger {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger-color);
        }

        .new-badge {
            background: linear-gradient(45deg, var(--warning-color), #d97706);
            color: white;
            font-size: 0.625rem;
            padding: 0.125rem 0.375rem;
            border-radius: var(--border-radius-lg);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.025em;
            margin-left: 0.5rem;
            box-shadow: var(--shadow-sm);
            animation: pulse 2s infinite;
        }

        /* ===== FORMULAIRES ET INPUTS ===== */
        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--gray-300);
            border-radius: var(--border-radius);
            font-size: 0.875rem;
            line-height: 1.25rem;
            transition: all var(--transition);
            background: white;
            outline: none;
        }

        .form-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .form-input:hover:not(:focus) {
            border-color: var(--gray-400);
        }

        .form-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }

        /* ===== GRILLES ET LAYOUTS ===== */
        .grid-auto-fit {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
        }

        .grid-4 {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.75rem;
        }

        /* ===== NOTIFICATIONS ET ALERTES ===== */
        .alert {
            padding: 1rem;
            border-radius: var(--border-radius);
            border-left: 4px solid;
            margin-bottom: 1rem;
            background: white;
        }

        .alert-success {
            border-color: var(--success-color);
            background: rgba(16, 185, 129, 0.05);
            color: #065f46;
        }

        .alert-warning {
            border-color: var(--warning-color);
            background: rgba(245, 158, 11, 0.05);
            color: #92400e;
        }

        .alert-danger {
            border-color: var(--danger-color);
            background: rgba(239, 68, 68, 0.05);
            color: #991b1b;
        }

        .alert-info {
            border-color: var(--info-color);
            background: rgba(6, 182, 212, 0.05);
            color: #155e75;
        }

        /* ===== SYSTÈME DE TOOLTIPS UNIVERSEL ===== */
        [data-tooltip],
        [title],
        .btn-base[data-tooltip],
        .ai-btn-enhanced[data-tooltip],
        .ai-btn-compact[data-tooltip] {
            position: relative;
        }

        [data-tooltip]:hover::after,
        [title]:hover::after,
        .btn-base[data-tooltip]:hover::after,
        .ai-btn-enhanced[data-tooltip]:hover::after,
        .ai-btn-compact[data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--gray-900);
            color: white;
            padding: 0.75rem 1rem;
            border-radius: var(--border-radius);
            font-size: 0.875rem;
            font-weight: 500;
            white-space: normal;
            max-width: 280px;
            min-width: 120px;
            z-index: 10000;
            pointer-events: none;
            box-shadow: var(--shadow-xl);
            animation: tooltipFadeIn 0.2s ease-out forwards;
            line-height: 1.4;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        [data-tooltip]:hover::before,
        [title]:hover::before,
        .btn-base[data-tooltip]:hover::before,
        .ai-btn-enhanced[data-tooltip]:hover::before,
        .ai-btn-compact[data-tooltip]:hover::before {
            content: '';
            position: absolute;
            bottom: 117%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: var(--gray-900);
            z-index: 10000;
            pointer-events: none;
            animation: tooltipFadeIn 0.2s ease-out forwards;
        }

        /* Tooltips pour boutons dans des grilles */
        .grid button[data-tooltip]:hover::after,
        .grid .btn-base[data-tooltip]:hover::after {
            bottom: 130%;
            max-width: 240px;
            font-size: 0.8rem;
        }

        /* Tooltips pour boutons compacts */
        .btn-compact[data-tooltip]:hover::after,
        .ai-btn-compact[data-tooltip]:hover::after {
            bottom: 140%;
            max-width: 200px;
            font-size: 0.8rem;
            padding: 0.5rem 0.75rem;
        }

        /* Animation des tooltips */
        @keyframes tooltipFadeIn {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(4px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        /* Tooltips pour éléments en bordure d'écran */
        .tab-btn[data-tooltip]:hover::after {
            bottom: 140%;
            max-width: 180px;
            font-size: 0.8rem;
        }

        /* ===== RESPONSIVE DESIGN ===== */
        @media (max-width: 768px) {
            .btn-base {
                padding: 0.5rem 0.75rem;
                font-size: 0.8rem;
            }

            .tab-btn {
                padding: 0.5rem 0.75rem;
                font-size: 0.8rem;
            }

            .control-group summary {
                padding: 0.75rem 1rem;
                font-size: 0.8rem;
            }

            .control-group-content {
                padding: 1rem;
            }

            .grid-2,
            .grid-3,
            .grid-4 {
                grid-template-columns: 1fr;
            }
        }

        /* ===== ÉTATS DE CHARGEMENT ===== */
        .loading {
            opacity: 0.7;
            pointer-events: none;
            position: relative;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 1rem;
            height: 1rem;
            margin: -0.5rem 0 0 -0.5rem;
            border: 2px solid var(--gray-300);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            z-index: 10;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ===== ANIMATIONS SPÉCIALES ===== */
        .animate-bounce {
            animation: bounce 1s infinite;
        }

        .animate-pulse {
            animation: pulse 2s infinite;
        }

        .animate-spin {
            animation: spin 1s linear infinite;
        }

        .animate-glow {
            animation: glow 2s ease-in-out infinite alternate;
        }

        .animate-shake {
            animation: shake 0.5s ease-in-out;
        }

        /* ===== EFFETS VISUELS SUPPLÉMENTAIRES ===== */
        
        /* Effet de verre sur le panneau de contrôles */
        #controls {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        /* Amélioration du header */
        #controls .flex.justify-between.items-center {
            background: linear-gradient(135deg, var(--gray-50), white);
            padding: 1.5rem;
            margin: -1.5rem -1.5rem 1rem -1.5rem;
            border-bottom: 2px solid var(--gray-100);
            border-radius: 0 0 var(--border-radius-lg) var(--border-radius-lg);
        }
        
        /* Amélioration de la barre de progression */
        #progress-bar-container {
            background: linear-gradient(90deg, var(--gray-200), var(--gray-100));
            border-radius: 9999px;
            overflow: hidden;
            position: relative;
        }
        
        #progress-bar {
            background: linear-gradient(90deg, var(--success-color), var(--info-color), var(--primary-color));
            background-size: 200% 100%;
            animation: gradientShift 3s ease-in-out infinite;
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.3);
        }
        
        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        /* Hover effects pour les éléments de navigation */
        #tab-navigation {
            background: linear-gradient(145deg, var(--gray-50), white);
            border-radius: var(--border-radius-lg) var(--border-radius-lg) 0 0;
            padding: 0.5rem;
            margin: 0 -1.5rem;
            box-shadow: var(--shadow-sm);
        }
        
        /* Amélioration des scrollbars */
        #controls::-webkit-scrollbar {
            width: 8px;
        }
        
        #controls::-webkit-scrollbar-track {
            background: var(--gray-100);
            border-radius: 4px;
        }
        
        #controls::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, var(--primary-color), var(--primary-light));
            border-radius: 4px;
            border: 1px solid var(--gray-200);
        }
        
        #controls::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, var(--primary-hover), var(--primary-color));
        }
        
        /* Amélioration du CV preview */
        .a4-page {
            border: 2px solid var(--gray-200);
            transition: all var(--transition);
        }
        
        .a4-page:hover {
            border-color: var(--primary-color);
            box-shadow: var(--shadow-xl), 0 0 30px rgba(37, 99, 235, 0.1);
        }
        
        /* Effets de particules sur les boutons principaux */
        .btn-primary::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: radial-gradient(circle, rgba(255,255,255,0.8) 0%, transparent 70%);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.6s ease;
            pointer-events: none;
        }
        
        .btn-primary:active::after {
            width: 300px;
            height: 300px;
            opacity: 0;
        }
        
        /* Animation d'apparition des éléments */
        .control-group,
        .tab-panel > *,
        .btn-base {
            opacity: 0;
            animation: fadeInUp 0.6s ease-out forwards;
        }
        
        .control-group:nth-child(1) { animation-delay: 0.1s; }
        .control-group:nth-child(2) { animation-delay: 0.2s; }
        .control-group:nth-child(3) { animation-delay: 0.3s; }
        .control-group:nth-child(4) { animation-delay: 0.4s; }
        .control-group:nth-child(5) { animation-delay: 0.5s; }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Effet de focus enhanced pour les inputs */
        .form-input:focus,
        .form-select:focus {
            background: linear-gradient(145deg, white, var(--gray-50));
            transform: translateY(-1px);
            box-shadow: 
                0 0 0 3px rgba(37, 99, 235, 0.1),
                var(--shadow-md);
        }
        
        /* Amélioration des badges et indicateurs */
        .completion-label {
            background: linear-gradient(135deg, var(--gray-50), var(--gray-100));
            border: 1px solid var(--gray-200);
            box-shadow: var(--shadow-sm);
        }
        
        .completion-checkbox:checked {
            background: linear-gradient(135deg, var(--success-color), #059669);
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        }
        
        /* Mode sombre pour certains éléments */
        @media (prefers-color-scheme: dark) {
            :root {
                --gray-50: #1e293b;
                --gray-100: #334155;
                --gray-200: #475569;
            }
        }
        
        /* Responsive improvements */
        @media (max-width: 768px) {
            #controls {
                backdrop-filter: blur(5px);
            }
            
            .btn-base {
                min-height: 44px; /* Touch-friendly */
            }
            
            .tab-btn {
                min-height: 40px;
            }
        }
        
        /* Amélioration de l'accessibilité */
        .btn-base:focus-visible,
        .tab-btn:focus-visible,
        .control-group summary:focus-visible {
            outline: 3px solid var(--primary-color);
            outline-offset: 2px;
        }
        
        /* Animation de chargement global */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, 
                rgba(37, 99, 235, 0.1),
                rgba(168, 85, 247, 0.1),
                rgba(16, 185, 129, 0.1)
            );
            backdrop-filter: blur(8px);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity var(--transition);
        }
        
        .loading-overlay.active {
            opacity: 1;
            pointer-events: all;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            box-shadow: 0 0 20px rgba(37, 99, 235, 0.3);
        }

        /* ===== MODERNISATION DES ANCIENS ÉLÉMENTS ===== */
        
        /* Remplace les anciens styles tab-btn pour cohérence */
        .tab-btn.active {
            background: #3b82f6 !important;
            color: white !important;
            border-color: #3b82f6 !important;
            transform: translateY(-2px) !important;
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.2) !important;
        }

        .tab-btn:hover:not(.active) {
            background: #e5e7eb !important;
            border-color: #9ca3af !important;
            transform: translateY(-1px) !important;
        }

        .tab-btn i {
            font-size: 12px !important;
        }

        /* Collapsible sections with compact styling */
        .control-group {
            border: 1px solid #e5e7eb !important;
            border-radius: 8px !important;
            margin-bottom: 12px !important;
            background: white !important;
            overflow: hidden !important;
        }

        .control-group summary {
            padding: 8px 12px !important;
            background: #f8fafc !important;
            cursor: pointer !important;
            font-weight: 500 !important;
            font-size: 13px !important;
            color: #374151 !important;
            border-bottom: 1px solid #e5e7eb !important;
            display: flex !important;
            align-items: center !important;
            justify-content: space-between !important;
            transition: background 0.2s ease !important;
        }

        .control-group summary:hover {
            background: #e2e8f0 !important;
        }

        .control-group[open] summary {
            background: #dbeafe !important;
            color: #1d4ed8 !important;
        }

        .control-group summary::marker {
            display: none !important;
        }

        .control-group summary::before {
            content: '▶' !important;
            font-size: 10px !important;
            transition: transform 0.2s ease !important;
            margin-right: 8px !important;
        }

        .control-group[open] summary::before {
            transform: rotate(90deg) !important;
        }

        .control-group-content {
            padding: 12px !important;
            border-top: none !important;
        }

        /* Compact completion labels */
        .completion-label {
            font-size: 11px !important;
            color: #6b7280 !important;
            display: flex !important;
            align-items: center !important;
            gap: 4px !important;
        }

        .completion-checkbox {
            width: 14px !important;
            height: 14px !important;
        }

        /* New badges styling */
        .new-badge {
            background: linear-gradient(45deg, #f59e0b, #d97706) !important;
            color: white !important;
            font-size: 9px !important;
            padding: 2px 6px !important;
            border-radius: 10px !important;
            font-weight: 600 !important;
            text-transform: uppercase !important;
            letter-spacing: 0.5px !important;
            margin-left: 6px !important;
            box-shadow: 0 2px 4px rgba(245, 158, 11, 0.3) !important;
        }

        /* Enhanced tooltips for small buttons */
        .small-tooltip[data-tooltip]:hover::after {
            bottom: 130% !important;
            left: 50% !important;
            transform: translateX(-50%) !important;
            max-width: 180px !important;
            font-size: 11px !important;
            z-index: 1002 !important;
        }

        .small-tooltip[data-tooltip]:hover::before {
            bottom: 122% !important;
            left: 50% !important;
            transform: translateX(-50%) !important;
            z-index: 1002 !important;
        }

        /* Progress bar in header */
        #progress-bar-container {
            transition: all 0.3s ease !important;
        }

        /* Compact action buttons section */
        #controls .space-y-2.mb-4 {
            padding: 8px !important;
            margin-bottom: 16px !important;
        }

        #controls .grid.grid-cols-2 {
            gap: 6px !important;
        }

        /* Scrollable content optimization */
        #tab-content {
            max-height: calc(100vh - 200px);
            overflow-y: auto;
            scrollbar-width: thin;
        }

        #tab-content::-webkit-scrollbar {
            width: 6px;
        }

        #tab-content::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 3px;
        }

        #tab-content::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        #tab-content::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

    </style>
</head>
<body class="bg-gray-200 font-sans">

    <!-- SPLASH SCREEN -->
    <div id="splash-screen">
        <div class="splash-particles">
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
        </div>
        <div class="splash-content">
            <div class="splash-logo">
                <i class="fas fa-magic-wand-sparkles"></i>
            </div>
            <h1 class="splash-title">CV Creator IA</h1>
            <p class="splash-subtitle">Créez votre CV professionnel en quelques clics</p>
            <div class="loading-container">
                <div class="loading-bar">
                    <div class="loading-progress" id="splash-progress"></div>
                </div>
                <p class="loading-text" id="splash-loading-text">Initialisation...</p>
            </div>
        </div>
    </div>

    <!-- OVERLAYS AND MODALS -->
    <div id="loader-overlay" class="hidden fixed inset-0 bg-white bg-opacity-75 flex-col items-center justify-center z-[9999]">
        <div class="h-16 w-16 rounded-full border-4 border-gray-200 border-t-blue-600 animate-spin"></div>
        <p id="loader-text" class="mt-4 text-gray-600 font-medium">Chargement...</p>
    </div>

    <div id="notification"></div>

    <div class="main-container">
        <!-- CONTROLS PANEL -->
        <div id="controls" class="p-6 overflow-y-auto flex flex-col no-print">
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <div class="flex items-center gap-3"><i class="fas fa-magic-wand-sparkles text-3xl"></i><h1 class="text-2xl font-bold">Créateur de CV</h1></div>
                <div class="flex items-center gap-2">
                    <!-- Save status removed -->
                    <button id="undo-btn" class="btn-base icon-only-btn btn-secondary" title="↶ Annule la dernière action effectuée (Ctrl+Z)"><i class="fas fa-undo"></i></button>
                    <button id="redo-btn" class="btn-base icon-only-btn btn-secondary" title="↷ Rétablit la dernière action annulée (Ctrl+Y)"><i class="fas fa-redo"></i></button>
                </div>
            </div>
            
            <!-- NEW: Progress Bar -->
            <div class="mb-4 flex-shrink-0">
                <label class="text-sm font-medium text-gray-600">Progression</label>
                <div id="progress-bar-container" class="w-full bg-gray-200 rounded-full h-2.5 mt-1">
                    <div id="progress-bar" class="bg-green-500 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <p id="progress-text" class="text-xs text-right text-gray-500 mt-1">0/X sections complétées</p>
            </div>

            <!-- Actions Rapides -->
            <div class="space-y-2 mb-4 p-4 bg-slate-50 rounded-lg border border-slate-200 flex-shrink-0">
                 <div class="grid-2">
                      <button id="download-pdf-btn" class="btn-base icon-only-btn btn-secondary btn-lg w-full" title="📄 Télécharge votre CV au format PDF avec une mise en page professionnelle optimisée pour l'impression"><i class="fa-solid fa-download"></i><span class="btn-text"> PDF</span></button>
                      <button id="share-btn" class="btn-base icon-only-btn btn-success btn-lg w-full" title="🔗 Génère un lien unique pour partager facilement votre CV avec les recruteurs ou votre réseau"><i class="fa-solid fa-share-alt"></i><span class="btn-text"> Partager</span></button>
                 </div>
                 <button id="reset-cv-btn" class="btn-base icon-only-btn btn-danger btn-lg w-full" title="🗂️ Créer un nouveau CV vierge (supprime le contenu actuel)"><i class="fa-solid fa-file-circle-plus"></i><span class="btn-text"> Nouveau CV</span></button>
                 <button id="toggle-overflow-btn" class="btn-base icon-only-btn btn-warning btn-lg w-full" title="📏 Activer la détection visuelle des débordements de contenu"><i class="fa-solid fa-ruler-combined"></i><span class="btn-text"> Détection Dépassement</span></button>
            </div>


            <!-- TABS -->
            <div id="tab-navigation" class="flex flex-wrap -mb-px border-b border-gray-200">
                <button class="tab-btn icon-only-btn active -mb-px py-3 px-4 text-sm font-medium border-b-2 whitespace-nowrap" data-target="#panel-ia" title="🤖 Accédez aux outils d'intelligence artificielle pour optimiser automatiquement votre CV"><i class="fa-solid fa-robot"></i><span class="btn-text"> IA</span></button>
                <button class="tab-btn icon-only-btn -mb-px py-3 px-4 text-sm font-medium border-b-2 whitespace-nowrap" data-target="#panel-content" title="📝 Gérez le contenu principal de votre CV : expériences et formations"><i class="fa-solid fa-file-lines"></i><span class="btn-text"> Contenu</span></button>
                <button class="tab-btn icon-only-btn -mb-px py-3 px-4 text-sm font-medium border-b-2 whitespace-nowrap" data-target="#panel-skills" title="⭐ Configurez l'affichage et la gestion de vos compétences professionnelles"><i class="fa-solid fa-star"></i><span class="btn-text"> Compétences</span></button>
                <button class="tab-btn icon-only-btn -mb-px py-3 px-4 text-sm font-medium border-b-2 whitespace-nowrap" data-target="#panel-custom" title="🧩 Ajoutez des sections personnalisées comme langues, centres d'intérêt, certifications"><i class="fa-solid fa-puzzle-piece"></i><span class="btn-text"> Sections</span></button>
                <button class="tab-btn icon-only-btn -mb-px py-3 px-4 text-sm font-medium border-b-2 whitespace-nowrap" data-target="#panel-layout" title="📐 Personnalisez la mise en page, colonnes, espacements et disposition générale"><i class="fa-solid fa-columns"></i><span class="btn-text"> Mise en Page</span></button>
                <button class="tab-btn icon-only-btn -mb-px py-3 px-4 text-sm font-medium border-b-2 whitespace-nowrap" data-target="#panel-styles" title="🎨 Changez les couleurs, polices, thèmes et l'apparence visuelle de votre CV"><i class="fa-solid fa-palette"></i><span class="btn-text"> Styles</span></button>
                <button class="tab-btn icon-only-btn -mb-px py-3 px-4 text-sm font-medium border-b-2 whitespace-nowrap" data-target="#panel-banner" title="👔 Personnalisez l'en-tête de votre CV : nom, poste et informations de contact"><i class="fa-solid fa-user-tie"></i><span class="btn-text"> Bannière</span></button>
            </div>

            <div id="tab-content" class="py-4 flex-grow overflow-y-auto">
                <!-- TAB: IA -->
                <div id="panel-ia" class="tab-panel space-y-4">
                    <details class="control-group">
                        <summary><span>Actions Rapides IA</span><label class="completion-label"><input type="checkbox" id="completion-ia-actions" class="completion-checkbox"><span>Fait ✅</span></label></summary>
                        <div class="control-group-content space-y-2">
                            <div class="grid grid-cols-3 gap-2">
                                <button id="ai-optimize-one-page-btn" class="ai-btn-enhanced icon-only-btn bg-purple-600 text-white p-3 rounded-lg hover:bg-purple-700 flex items-center justify-center transition-all duration-200 hover:scale-105" title="🔮 L'IA optimise automatiquement votre CV pour qu'il tienne sur une seule page tout en gardant l'essentiel">
                                    <i class="fas fa-magic-wand-sparkles text-lg"></i>
                                </button>
                                <button id="anonymize-btn" class="ai-btn-enhanced icon-only-btn bg-slate-600 text-white p-3 rounded-lg hover:bg-slate-700 flex items-center justify-center transition-all duration-200 hover:scale-105" title="🕵️ Masquer vos informations personnelles pour créer une version anonyme de votre CV">
                                    <i class="fa-solid fa-user-secret text-lg"></i>
                                </button>
                                <button id="toggle-presentation-mode-btn" class="ai-btn-enhanced icon-only-btn bg-indigo-600 text-white p-3 rounded-lg hover:bg-indigo-700 flex items-center justify-center transition-all duration-200 hover:scale-105" title="👁️ Mode présentation : masquer tous les éléments d'édition pour une vue propre">
                                    <i class="fa-solid fa-eye text-lg"></i>
                                </button>
                            </div>
                        </div>
                    </details>
                    <details class="control-group">
                        <summary><span>Configuration API Gemini</span><label class="completion-label"><input type="checkbox" id="completion-ia-config" class="completion-checkbox"><span>Fait ✅</span></label></summary>
                        <div class="control-group-content space-y-3">
                            <div class="space-y-2">
                                <label for="api-key-input" class="block text-sm font-medium text-gray-700">Clé API Gemini</label>
                                <div class="flex gap-2">
                                    <input type="password" id="api-key-input" placeholder="Entrez votre clé API Gemini..." class="flex-1 p-2 border rounded-md text-sm">
                                    <button id="save-api-key-btn" class="ai-btn-enhanced icon-only-btn bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 text-sm flex items-center gap-1 transition-all duration-200 hover:scale-105" title="💾 Sauvegarder votre clé API Gemini pour les fonctionnalités IA">
                                        <i class="fas fa-save text-lg"></i><span class="btn-text"> Sauver</span>
                                    </button>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span id="api-key-status" class="api-key-status text-sm text-red-500">Clé API manquante</span>
                                    <button id="toggle-api-key-visibility" class="text-gray-500 hover:text-gray-700 text-sm" title="Afficher/Masquer la clé">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                                <div class="bg-blue-50 border border-blue-200 rounded-md p-3">
                                    <p class="text-xs text-blue-800">
                                        <i class="fas fa-info-circle mr-1"></i>
                                        <strong>Comment obtenir votre clé API :</strong><br>
                                        1. Allez sur <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-blue-600 underline">Google AI Studio</a><br>
                                        2. Créez une nouvelle clé API<br>
                                        3. Copiez-la et collez-la ci-dessus<br>
                                        <em>La clé est stockée localement dans votre navigateur.</em>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </details>
                    <details class="control-group">
                        <summary><span>Analyse IA Avancée</span><label class="completion-label"><input type="checkbox" id="completion-ia-analyse" class="completion-checkbox"><span>Fait ✅</span></label></summary>
                        <div class="control-group-content space-y-2">
                            <textarea id="ai-input" rows="6" class="w-full p-2 border rounded-md" placeholder="Collez ici une description de poste, un CV brut..."></textarea>
                            <div class="grid grid-cols-2 gap-2">
                                <button id="analyze-btn" class="ai-btn-enhanced icon-only-btn bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 flex items-center justify-center gap-2 transition-all duration-200 hover:scale-105" title="🔍 Analyse automatique de vos données pour remplir intelligemment votre CV avec les meilleures informations"><i class="fa-solid fa-wand-magic-sparkles text-lg"></i><span class="btn-text"> Analyser & Remplir</span></button>
                                <button id="smart-analyze-btn" class="ai-btn-enhanced icon-only-btn bg-purple-600 text-white py-2 px-4 rounded-lg hover:bg-purple-700 flex items-center justify-center gap-2 transition-all duration-200 hover:scale-105" title="🧠 Analyse intelligente avancée qui comprend le contexte et optimise automatiquement votre contenu"><i class="fa-solid fa-brain text-lg"></i><span class="btn-text"> Analyse Smart</span></button>
                            </div>
                            <button id="industry-match-btn" class="ai-btn-enhanced icon-only-btn w-full bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 flex items-center justify-center gap-2 transition-all duration-200 hover:scale-105" title="🏭 Adapte automatiquement votre CV aux standards et attentes spécifiques de votre secteur d'activité"><i class="fa-solid fa-industry text-lg"></i><span class="btn-text"> Adapter au Secteur</span></button>
                        </div>
                    </details>
                    <details class="control-group">
                        <summary><span>Optimisations IA <span class="new-badge">NOUVEAU</span></span><label class="completion-label"><input type="checkbox" id="completion-ia-optimizations" class="completion-checkbox"><span>Fait ✅</span></label></summary>
                        <div class="control-group-content space-y-2">
                            <div class="grid grid-cols-2 gap-2">
                                <button id="ai-score-cv-btn" class="ai-btn-enhanced icon-only-btn bg-emerald-600 text-white py-2 px-4 rounded-lg hover:bg-emerald-700 flex items-center justify-center gap-2 transition-all duration-200 hover:scale-105" title="📊 Calcule un score ATS détaillé et vous indique comment améliorer la visibilité de votre CV"><i class="fa-solid fa-chart-line text-lg"></i><span class="btn-text"> Score ATS</span></button>
                                <button id="ai-keyword-optimize-btn" class="ai-btn-enhanced icon-only-btn bg-teal-600 text-white py-2 px-4 rounded-lg hover:bg-teal-700 flex items-center justify-center gap-2 transition-all duration-200 hover:scale-105" title="🔑 Optimise automatiquement les mots-clés pour maximiser vos chances d'être retenu par les recruteurs"><i class="fa-solid fa-key text-lg"></i><span class="btn-text"> Mots-clés</span></button>
                            </div>
                            <button id="ai-create-variants-btn" class="ai-btn-enhanced icon-only-btn w-full bg-orange-600 text-white py-2 px-4 rounded-lg hover:bg-orange-700 flex items-center justify-center gap-2 transition-all duration-200 hover:scale-105" title="📋 Génère 3 versions différentes de votre CV adaptées à différents types de postes ou secteurs"><i class="fa-solid fa-copy text-lg"></i><span class="btn-text"> Créer 3 Variantes</span></button>
                            <button id="ai-personalize-job-btn" class="ai-btn-enhanced icon-only-btn w-full bg-rose-600 text-white py-2 px-4 rounded-lg hover:bg-rose-700 flex items-center justify-center gap-2 transition-all duration-200 hover:scale-105" title="🎯 Personnalise entièrement votre CV pour une offre d'emploi spécifique en analysant les exigences"><i class="fa-solid fa-bullseye text-lg"></i><span class="btn-text"> Personnaliser pour Poste</span></button>
                        </div>
                    </details>
                    <details class="control-group">
                        <summary><span>Présentation Recruteur</span><label class="completion-label"><input type="checkbox" id="completion-ia-presentation" class="completion-checkbox"><span>Fait ✅</span></label></summary>
                        <div class="control-group-content space-y-3">
                            <input type="text" id="qualification-dispo" placeholder="Disponibilité" class="cv-input w-full p-2 border rounded-md">
                            <input type="text" id="qualification-salaire" placeholder="Prétentions salariales" class="cv-input w-full p-2 border rounded-md">
                            <input type="text" id="qualification-loc" placeholder="Localisation" class="cv-input w-full p-2 border rounded-md">
                            <div class="grid grid-cols-2 gap-2">
                                <button id="generate-mail-btn" class="ai-btn-enhanced icon-only-btn bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 flex items-center justify-center gap-2 transition-all duration-200 hover:scale-105" title="✉️ Génère un email de présentation professionnel personnalisé basé sur votre CV et votre profil"><i class="fas fa-wand-magic-sparkles text-lg"></i><span class="btn-text"> Mail Présentation</span></button>
                                <button id="generate-linkedin-msg-btn" class="ai-btn-enhanced icon-only-btn bg-blue-700 text-white py-2 px-4 rounded-lg hover:bg-blue-800 flex items-center justify-center gap-2 transition-all duration-200 hover:scale-105" title="💼 Crée un message LinkedIn percutant pour votre recherche d'emploi et networking professionnel"><i class="fab fa-linkedin text-lg"></i><span class="btn-text"> Message LinkedIn</span></button>
                            </div>
                            <textarea id="recruiter-mail-content" rows="8" class="cv-input w-full p-2 border rounded-md mt-2" placeholder="Le message généré apparaîtra ici..."></textarea>
                        </div>
                    </details>
                    <details class="control-group">
                        <summary><span>IA Créative <span class="new-badge">NOUVEAU</span></span><label class="completion-label"><input type="checkbox" id="completion-ia-creative" class="completion-checkbox"><span>Fait ✅</span></label></summary>
                        <div class="control-group-content space-y-2">
                            <button id="ai-generate-motto-btn" class="ai-btn-enhanced icon-only-btn w-full bg-violet-600 text-white py-2 px-4 rounded-lg hover:bg-violet-700 flex items-center justify-center gap-2 transition-all duration-200 hover:scale-105" title="💭 Crée une devise ou un slogan personnel unique qui reflète votre personnalité professionnelle"><i class="fa-solid fa-quote-left text-lg"></i><span class="btn-text"> Générer Devise/Slogan</span></button>
                            <button id="ai-suggest-improvements-btn" class="ai-btn-enhanced icon-only-btn w-full bg-amber-600 text-white py-2 px-4 rounded-lg hover:bg-amber-700 flex items-center justify-center gap-2 transition-all duration-200 hover:scale-105" title="💡 Analyse votre CV et propose des améliorations intelligentes pour maximiser votre impact"><i class="fa-solid fa-lightbulb text-lg"></i><span class="btn-text"> Suggestions d'Amélioration</span></button>
                            <button id="ai-translate-cv-btn" class="ai-btn-enhanced icon-only-btn w-full bg-cyan-600 text-white py-2 px-4 rounded-lg hover:bg-cyan-700 flex items-center justify-center gap-2 transition-all duration-200 hover:scale-105" title="🌍 Traduit automatiquement votre CV dans la langue de votre choix en conservant le contexte professionnel"><i class="fa-solid fa-language text-lg"></i><span class="btn-text"> Traduire CV</span></button>
                        </div>
                    </details>
                </div>

                <!-- TAB: Contenu -->
                <div id="panel-content" class="tab-panel hidden space-y-4">
                    <details class="control-group">
                        <summary><span>Informations Principales</span><label class="completion-label"><input type="checkbox" id="completion-content-infos" class="completion-checkbox"><span>Fait ✅</span></label></summary>
                        <div class="control-group-content space-y-3">
                            <input type="text" id="nom" placeholder="Nom" class="cv-input w-full p-2 border rounded-md">
                            <input type="text" id="prenom" placeholder="Prénom" class="cv-input w-full p-2 border rounded-md">
                            <input type="text" id="poste" placeholder="Poste recherché" class="cv-input w-full p-2 border rounded-md">
                            <textarea id="description" placeholder="Description du profil" rows="4" class="cv-input w-full p-2 border rounded-md"></textarea>
                        </div>
                    </details>
                     <details class="control-group">
                        <summary><span>Expériences</span><label class="completion-label"><input type="checkbox" id="completion-content-exp" class="completion-checkbox"><span>Fait ✅</span></label></summary>
                        <div class="control-group-content space-y-2">
                            <div class="flex justify-end mb-2"><button id="add-experience" class="ai-btn-compact icon-only-btn text-sm text-blue-600 hover:text-blue-800 font-medium" title="➕ Ajoute une nouvelle expérience professionnelle avec tous les détails : poste, entreprise, dates, missions"><i class="fas fa-circle-plus"></i><span class="btn-text"> Ajouter un bloc</span></button></div>
                            <div id="experience-list" class="space-y-2"></div>
                        </div>
                    </details>
                     <details class="control-group">
                        <summary><span>Formations</span><label class="completion-label"><input type="checkbox" id="completion-content-form" class="completion-checkbox"><span>Fait ✅</span></label></summary>
                        <div class="control-group-content space-y-2">
                            <div class="flex justify-end mb-2"><button id="add-formation" class="ai-btn-compact icon-only-btn text-sm text-blue-600 hover:text-blue-800 font-medium" title="🎓 Ajoute une nouvelle formation, diplôme ou certification avec l'établissement et les dates"><i class="fas fa-circle-plus"></i><span class="btn-text"> Ajouter un bloc</span></button></div>
                            <div id="formation-list" class="space-y-2"></div>
                        </div>
                    </details>
                </div>
                
                <!-- TAB: Compétences -->
                <div id="panel-skills" class="tab-panel hidden space-y-4">
                     <details class="control-group">
                        <summary><span>Compétences</span><label class="completion-label"><input type="checkbox" id="completion-skills" class="completion-checkbox"><span>Fait ✅</span></label></summary>
                        <div class="control-group-content space-y-3">
                            <p class="text-sm font-medium">Style de Présentation</p>
                            <div class="grid grid-cols-3 gap-2">
                                <button data-skill-style="tags" class="skill-style-btn icon-only-btn bg-gray-200 p-2 rounded-md text-sm active" title="Afficher les compétences sous forme d'étiquettes colorées"><i class="fas fa-tags"></i><span class="btn-text"> Tags</span></button>
                                <button data-skill-style="levels" class="skill-style-btn icon-only-btn bg-gray-200 p-2 rounded-md text-sm" title="Présenter les compétences avec des niveaux de maîtrise"><i class="fas fa-chart-bar"></i><span class="btn-text"> Niveaux</span></button>
                                <button data-skill-style="simple" class="skill-style-btn icon-only-btn bg-gray-200 p-2 rounded-md text-sm" title="Liste simple des compétences sans niveau"><i class="fas fa-list"></i><span class="btn-text"> Simple</span></button>
                                <button data-skill-style="circular" class="skill-style-btn icon-only-btn bg-gray-200 p-2 rounded-md text-sm" title="Affichage circulaire avec jauges visuelles"><i class="fas fa-circle-notch"></i><span class="btn-text"> Circulaire</span></button>
                                <button data-skill-style="categories" class="skill-style-btn icon-only-btn bg-gray-200 p-2 rounded-md text-sm" title="Organiser les compétences par catégories"><i class="fas fa-folder"></i><span class="btn-text"> Catégories</span></button>
                                <button data-skill-style="timeline" class="skill-style-btn icon-only-btn bg-gray-200 p-2 rounded-md text-sm" title="Présentation chronologique des compétences acquises"><i class="fas fa-timeline"></i><span class="btn-text"> Timeline</span></button>
                            </div>
                            
                            <div id="skills-text-controls">
                                <div class="flex justify-between items-center"><label for="competences" class="font-medium">Liste des compétences</label><div class="flex gap-2"><button id="ai-limit-skills-btn" class="ai-btn-compact icon-only-btn text-blue-600 hover:text-blue-800" title="🎯 Utilise l'IA pour sélectionner automatiquement les 10 compétences les plus pertinentes et impactantes"><i class="fas fa-filter"></i><span class="btn-text"> 10</span></button><button id="ai-synthesize-skills-btn" class="ai-btn-compact icon-only-btn text-blue-600 hover:text-blue-800" title="🧠 Organise et synthétise intelligemment vos compétences par catégories et importance"><i class="fas fa-brain"></i></button><button id="ai-skills-from-job-btn" class="ai-btn-compact icon-only-btn text-purple-600 hover:text-purple-800" title="⚡ Génère automatiquement une liste de compétences optimales basée sur une offre d'emploi"><i class="fas fa-magic-wand-sparkles"></i><span class="btn-text"> Job</span></button></div></div>
                                <textarea id="competences" placeholder="Compétences (séparées par des virgules)..." rows="4" class="cv-input w-full p-2 border rounded-md"></textarea>
                            </div>

                            <div id="skills-level-controls" class="hidden space-y-3">
                                <p class="text-sm font-medium">Style de Jauge</p>
                                <div class="grid grid-cols-6 gap-2 text-center">
                                    <button data-gauge-style="bar" class="gauge-style-btn bg-gray-200 p-2 rounded-md text-sm active" title="Barre"><i class="fas fa-bars"></i></button>
                                    <button data-gauge-style="dots" class="gauge-style-btn bg-gray-200 p-2 rounded-md text-sm" title="Points"><i class="fas fa-circle"></i></button>
                                    <button data-gauge-style="stars" class="gauge-style-btn bg-gray-200 p-2 rounded-md text-sm" title="Étoiles"><i class="fas fa-star"></i></button>
                                    <button data-gauge-style="squares" class="gauge-style-btn bg-gray-200 p-2 rounded-md text-sm" title="Carrés"><i class="fas fa-square"></i></button>
                                    <button data-gauge-style="number" class="gauge-style-btn bg-gray-200 p-2 rounded-md text-sm font-bold" title="Chiffres">⅗</button>
                                    <button data-gauge-style="percentage" class="gauge-style-btn bg-gray-200 p-2 rounded-md text-sm" title="Pourcentage">%</button>
                                </div>
                                <div id="skills-level-list" class="space-y-2 border-t pt-3"></div>
                                <button id="add-skill-level-btn" class="ai-btn-enhanced icon-only-btn w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 flex items-center justify-center gap-2 text-sm transition-all duration-200 hover:scale-105" title="➕ Ajouter une nouvelle compétence avec niveau de maîtrise"><i class="fas fa-plus-circle text-lg"></i><span class="btn-text"> Ajouter une compétence</span></button>
                            </div>
                        </div>
                    </details>
                    <details class="control-group">
                        <summary><span>Compétences Avancées <span class="new-badge">NOUVEAU</span></span><label class="completion-label"><input type="checkbox" id="completion-skills-advanced" class="completion-checkbox"><span>Fait ✅</span></label></summary>
                        <div class="control-group-content space-y-3">
                            <button id="skill-matcher-btn" class="ai-btn-enhanced icon-only-btn w-full bg-emerald-600 text-white py-2 px-4 rounded-md hover:bg-emerald-700 flex items-center justify-center gap-2" title="🎯 Analyse en profondeur la correspondance entre vos compétences et celles demandées dans l'offre d'emploi"><i class="fa-solid fa-search"></i><span class="btn-text"> Analyse Compétences vs Poste</span></button>
                            <button id="suggest-missing-skills-btn" class="ai-btn-enhanced icon-only-btn w-full bg-orange-600 text-white py-2 px-4 rounded-md hover:bg-orange-700 flex items-center justify-center gap-2" title="🔍 Identifie intelligemment les compétences clés manquantes pour le poste que vous visez"><i class="fa-solid fa-plus-circle"></i><span class="btn-text"> Compétences Manquantes</span></button>
                            <button id="skill-trend-analysis-btn" class="ai-btn-enhanced icon-only-btn w-full bg-purple-600 text-white py-2 px-4 rounded-md hover:bg-purple-700 flex items-center justify-center gap-2" title="📈 Découvre les compétences les plus demandées et tendances dans votre secteur d'activité"><i class="fa-solid fa-trending-up"></i><span class="btn-text"> Tendances du Marché</span></button>
                            <div class="border-t pt-3">
                                <label class="text-sm font-medium mb-2 block">Templates de Compétences</label>
                                <div class="grid grid-cols-2 gap-2">
                                    <button data-skill-template="tech" class="skill-template-btn icon-only-btn bg-blue-100 text-blue-800 p-2 rounded-md text-sm hover:bg-blue-200" title="Compétences techniques et informatiques"><i class="fas fa-code"></i><span class="btn-text">Tech</span></button>
                                    <button data-skill-template="marketing" class="skill-template-btn icon-only-btn bg-green-100 text-green-800 p-2 rounded-md text-sm hover:bg-green-200" title="Compétences en marketing et communication"><i class="fas fa-bullhorn"></i><span class="btn-text">Marketing</span></button>
                                    <button data-skill-template="finance" class="skill-template-btn icon-only-btn bg-yellow-100 text-yellow-800 p-2 rounded-md text-sm hover:bg-yellow-200" title="Compétences financières et comptables"><i class="fas fa-calculator"></i><span class="btn-text">Finance</span></button>
                                    <button data-skill-template="design" class="skill-template-btn icon-only-btn bg-purple-100 text-purple-800 p-2 rounded-md text-sm hover:bg-purple-200" title="Compétences créatives et de design"><i class="fas fa-palette"></i><span class="btn-text">Design</span></button>
                                    <button data-skill-template="management" class="skill-template-btn icon-only-btn bg-red-100 text-red-800 p-2 rounded-md text-sm hover:bg-red-200" title="Compétences de management et leadership"><i class="fas fa-users"></i><span class="btn-text">Management</span></button>
                                    <button data-skill-template="sales" class="skill-template-btn icon-only-btn bg-indigo-100 text-indigo-800 p-2 rounded-md text-sm hover:bg-indigo-200" title="Compétences commerciales et de vente"><i class="fas fa-handshake"></i><span class="btn-text">Ventes</span></button>
                                </div>
                            </div>
                        </div>
                    </details>
                </div>

                <!-- TAB: Sections Perso -->
                <div id="panel-custom" class="tab-panel hidden space-y-4">
                    <details class="control-group">
                        <summary><span>Sections Personnalisées</span><label class="completion-label"><input type="checkbox" id="completion-custom" class="completion-checkbox"><span>Fait ✅</span></label></summary>
                        <div class="control-group-content space-y-3">
                            <div class="space-y-2">
                                <label class="text-sm font-medium">Ajouter une nouvelle section</label>
                                <select id="section-suggestion-select" class="w-full p-2 border rounded-md text-sm">
                                    <option value="">-- Choisir une suggestion --</option>
                                    <option value="Langues 🌐">Langues 🌐</option>
                                    <option value="Centres d'intérêt 🎨">Centres d'intérêt 🎨</option>
                                    <option value="Certifications 📜">Certifications 📜</option>
                                    <option value="Projets Personnels 💡">Projets Personnels 💡</option>
                                    <option value="Bénévolat ❤️">Bénévolat ❤️</option>
                                    <option value="Publications 📚">Publications 📚</option>
                                    <option value="Récompenses 🏆">Récompenses 🏆</option>
                                    <option value="Références 👥">Références 👥</option>
                                    <option value="Portfolio 🎨">Portfolio 🎨</option>
                                    <option value="Réseaux Sociaux 📱">Réseaux Sociaux 📱</option>
                                    <option value="Objectifs de Carrière 🎯">Objectifs de Carrière 🎯</option>
                                    <option value="Soft Skills 💭">Soft Skills 💭</option>
                                </select>
                                <div class="flex gap-2">
                                    <input type="text" id="new-section-title-input" class="flex-grow p-2 border rounded-md text-sm" placeholder="Ou tapez un titre personnalisé...">
                                    <button id="add-section-btn" class="ai-btn-enhanced icon-only-btn bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 transition-all duration-200 hover:scale-105" title="➕ Créer une nouvelle section personnalisée"><i class="fas fa-plus text-lg"></i></button>
                                </div>
                            </div>
                            <div id="custom-sections-list" class="space-y-2 mt-2 border-t pt-2"></div>
                        </div>
                    </details>
                    <details class="control-group">
                        <summary><span>Templates de Sections <span class="new-badge">NOUVEAU</span></span><label class="completion-label"><input type="checkbox" id="completion-custom-templates" class="completion-checkbox"><span>Fait ✅</span></label></summary>
                        <div class="control-group-content space-y-3">
                            <button id="ai-suggest-sections-btn" class="w-full bg-purple-600 text-white py-2 px-4 rounded-md hover:bg-purple-700 flex items-center justify-center gap-2" title="L'IA suggère les sections les plus adaptées à votre profil"><i class="fa-solid fa-magic-wand-sparkles"></i> IA : Sections Suggérées</button>
                            <div class="grid grid-cols-2 gap-2">
                                <button data-section-template="startup" class="section-template-btn bg-orange-100 text-orange-800 p-2 rounded-md text-sm hover:bg-orange-200" title="Sections spécialisées pour les profils startup et entrepreneuriat">Startup</button>
                                <button data-section-template="academic" class="section-template-btn bg-blue-100 text-blue-800 p-2 rounded-md text-sm hover:bg-blue-200" title="Sections adaptées au monde académique et à la recherche">Académique</button>
                                <button data-section-template="creative" class="section-template-btn bg-purple-100 text-purple-800 p-2 rounded-md text-sm hover:bg-purple-200" title="Sections pour les métiers créatifs et artistiques">Créatif</button>
                                <button data-section-template="executive" class="section-template-btn bg-gray-100 text-gray-800 p-2 rounded-md text-sm hover:bg-gray-200" title="Sections pour les postes de direction et management">Cadre</button>
                                <button data-section-template="international" class="section-template-btn bg-green-100 text-green-800 p-2 rounded-md text-sm hover:bg-green-200" title="Sections pour les profils internationaux et multilingues">International</button>
                                <button data-section-template="freelance" class="section-template-btn bg-yellow-100 text-yellow-800 p-2 rounded-md text-sm hover:bg-yellow-200" title="Sections adaptées aux consultants et freelances">Freelance</button>
                            </div>
                        </div>
                    </details>
                    <details class="control-group">
                        <summary><span>Import/Export Sections <span class="new-badge">NOUVEAU</span></span><label class="completion-label"><input type="checkbox" id="completion-custom-import" class="completion-checkbox"><span>Fait ✅</span></label></summary>
                        <div class="control-group-content space-y-3">
                            <button id="export-sections-btn" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 flex items-center justify-center gap-2" title="Sauvegarder vos sections personnalisées dans un fichier"><i class="fa-solid fa-download"></i> Exporter Sections</button>
                            <button id="import-sections-btn" class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 flex items-center justify-center gap-2" title="Charger des sections personnalisées depuis un fichier"><i class="fa-solid fa-upload"></i> Importer Sections</button>
                            <input type="file" id="import-sections-file" accept=".json" class="hidden">
                        </div>
                    </details>
                </div>

                <!-- TAB: Mise en Page -->
                <div id="panel-layout" class="tab-panel hidden space-y-4">
                    <details class="control-group">
                        <summary><span>Mise en Colonnes</span><label class="completion-label"><input type="checkbox" id="completion-layout-cols" class="completion-checkbox"><span>Fait ✅</span></label></summary>
                        <div class="control-group-content">
                            <div class="grid grid-cols-3 gap-2 mb-3">
                                <button data-layout="layout-1-col" class="layout-btn icon-only-btn bg-gray-200 p-2 rounded-md text-sm" title="Une seule colonne pour un design classique"><i class="fas fa-align-justify"></i><span class="btn-text"> 1</span></button>
                                <button data-layout="layout-2-col-33-67" class="layout-btn icon-only-btn bg-gray-200 p-2 rounded-md text-sm" title="Deux colonnes : petite (33%) et grande (67%)"><i class="fas fa-columns"></i><span class="btn-text"> 33/67</span></button>
                                <button data-layout="layout-2-col-50-50" class="layout-btn icon-only-btn bg-gray-200 p-2 rounded-md text-sm" title="Deux colonnes égales (50% chacune)"><i class="fas fa-pause"></i><span class="btn-text"> 50/50</span></button>
                                <button data-layout="layout-2-col-67-33" class="layout-btn icon-only-btn bg-gray-200 p-2 rounded-md text-sm" title="Deux colonnes : grande (67%) et petite (33%)"><i class="fas fa-columns"></i><span class="btn-text"> 67/33</span></button>
                                <button data-layout="layout-3-col" class="layout-btn icon-only-btn bg-gray-200 p-2 rounded-md text-sm" title="Trois colonnes égales pour plus de contenu"><i class="fas fa-th-large"></i><span class="btn-text"> 3 Col.</span></button>
                                <button data-layout="layout-asymmetric-1" class="layout-btn icon-only-btn bg-gray-200 p-2 rounded-md text-sm" title="Layout asymétrique : petite-grande-petite"><i class="fas fa-grip-horizontal"></i><span class="btn-text"> 1-2-1</span></button>
                            </div>
                            <button id="ai-suggest-layout-btn" class="ai-btn-enhanced icon-only-btn w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 flex items-center justify-center gap-2" title="🤖 L'IA analyse votre contenu et recommande automatiquement le meilleur layout pour optimiser la lisibilité"><i class="fa-solid fa-magic-wand-sparkles"></i><span class="btn-text"> Suggestion IA de Layout</span></button>
                        </div>
                    </details>
                    <details class="control-group">
                        <summary><span>Espacements & Tailles</span><label class="completion-label"><input type="checkbox" id="completion-layout-spacing" class="completion-checkbox"><span>Fait ✅</span></label></summary>
                        <div class="control-group-content space-y-4">
                            <div><label for="page-margin" class="block text-sm font-medium text-gray-700">Marge Page: <span id="page-margin-value">2</span>cm</label><input type="range" id="page-margin" min="0.5" max="3" step="0.1" value="2" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer"></div>
                            <div><label for="module-spacing" class="block text-sm font-medium text-gray-700">Espace Blocs: <span id="module-spacing-value">1.5</span>rem</label><input type="range" id="module-spacing" min="0" max="4" step="0.1" value="1.5" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer"></div>
                            <div><label for="item-spacing" class="block text-sm font-medium text-gray-700">Espace Éléments: <span id="item-spacing-value">0.5</span>rem</label><input type="range" id="item-spacing" min="0" max="2" step="0.1" value="0.5" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer"></div>
                            <div><label for="font-size-h1" class="block text-sm font-medium text-gray-700">Taille Titre Principal: <span id="font-size-h1-value">40</span>pt</label><input type="range" id="font-size-h1" min="20" max="50" step="1" value="40" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer"></div><div><label for="font-size-h2" class="block text-sm font-medium text-gray-700">Taille Titres Section: <span id="font-size-h2-value">21</span>pt</label><input type="range" id="font-size-h2" min="14" max="30" step="1" value="21" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer"></div><div><label for="font-size-p" class="block text-sm font-medium text-gray-700">Taille Paragraphe: <span id="font-size-p-value">10</span>pt</label><input type="range" id="font-size-p" min="8" max="14" step="0.5" value="10" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer"></div><div><label for="font-size-banner" class="block text-sm font-medium text-gray-700">Taille Bannière: <span id="font-size-banner-value">9</span>pt</label><input type="range" id="font-size-banner" min="7" max="12" step="0.5" value="9" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer"></div><div><label for="line-height" class="block text-sm font-medium text-gray-700">Interligne: <span id="line-height-value">1.6</span></label><input type="range" id="line-height" min="0.8" max="2.5" step="0.1" value="1.6" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer"></div><div><label for="paragraph-spacing" class="block text-sm font-medium text-gray-700">Espace Paragraphe: <span id="paragraph-spacing-value">0.5</span>rem</label><input type="range" id="paragraph-spacing" min="0" max="2" step="0.1" value="0.5" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer"></div>
                        </div>
                    </details>
                    <details class="control-group">
                        <summary><span>Présentation Avancée <span class="new-badge">NOUVEAU</span></span><label class="completion-label"><input type="checkbox" id="completion-layout-advanced" class="completion-checkbox"><span>Fait ✅</span></label></summary>
                        <div class="control-group-content space-y-4">
                            <div class="grid grid-cols-2 gap-2">
                                <label class="flex items-center gap-2 text-sm"><input type="checkbox" id="enable-zebra-sections" class="cv-input">Sections alternées</label>
                                <label class="flex items-center gap-2 text-sm"><input type="checkbox" id="enable-floating-elements" class="cv-input">Éléments flottants</label>
                            </div>
                            <button id="auto-optimize-layout-btn" class="ai-btn-enhanced icon-only-btn w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 flex items-center justify-center gap-2" title="⚡ Optimisation automatique intelligente de la mise en page pour un rendu parfait et professionnel"><i class="fa-solid fa-magic-wand-sparkles"></i><span class="btn-text"> Auto-Optimiser Layout</span></button>
                            <button id="save-layout-template-btn" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 flex items-center justify-center gap-2" title="Sauvegarder cette mise en page comme modèle réutilisable"><i class="fa-solid fa-bookmark"></i> Sauver comme Template</button>
                        </div>
                    </details>
                </div>
                
                <!-- TAB: Styles Globaux -->
                <div id="panel-styles" class="tab-panel hidden space-y-4">
                     <details class="control-group">
                        <summary><span>Thèmes Prédéfinis</span><label class="completion-label"><input type="checkbox" id="completion-styles-themes" class="completion-checkbox"><span>Fait ✅</span></label></summary>
                        <div class="control-group-content">
                            <div id="theme-buttons" class="grid grid-cols-3 gap-2">
                                <button data-theme="professional" class="theme-btn icon-only-btn bg-gray-200 p-2 rounded-md text-sm" title="Style professionnel classique et sobre"><i class="fas fa-briefcase"></i><span class="btn-text"> Pro</span></button>
                                <button data-theme="creative" class="theme-btn icon-only-btn bg-gray-200 p-2 rounded-md text-sm" title="Design créatif avec couleurs vives"><i class="fas fa-palette"></i><span class="btn-text"> Créatif</span></button>
                                <button data-theme="modern" class="theme-btn icon-only-btn bg-gray-200 p-2 rounded-md text-sm" title="Look moderne et épuré"><i class="fas fa-rocket"></i><span class="btn-text"> Moderne</span></button>
                                <button data-theme="elegant" class="theme-btn icon-only-btn bg-gray-200 p-2 rounded-md text-sm" title="Élégance avec touches dorées"><i class="fas fa-crown"></i><span class="btn-text"> Élégant</span></button>
                                <button data-theme="tech" class="theme-btn icon-only-btn bg-gray-200 p-2 rounded-md text-sm" title="Style tech avec couleurs tech"><i class="fas fa-microchip"></i><span class="btn-text"> Tech</span></button>
                                <button data-theme="luxury" class="theme-btn icon-only-btn bg-gray-200 p-2 rounded-md text-sm" title="Thème luxueux et premium"><i class="fas fa-gem"></i><span class="btn-text"> Luxe</span></button>
                                <button data-theme="startup" class="theme-btn icon-only-btn bg-gray-200 p-2 rounded-md text-sm" title="Dynamique et innovant pour startups"><i class="fas fa-lightbulb"></i><span class="btn-text"> Startup</span></button>
                                <button data-theme="academic" class="theme-btn bg-gray-200 p-2 rounded-md text-sm" title="Style académique et sérieux">Académique</button>
                                <button data-theme="artistic" class="theme-btn bg-gray-200 p-2 rounded-md text-sm" title="Thème artistique et créatif">Artistique</button>
                            </div>
                            <button id="random-theme-btn" class="w-full mt-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white py-2 px-4 rounded-md hover:from-purple-600 hover:to-pink-600 flex items-center justify-center gap-2" title="Appliquer un thème au hasard pour l'inspiration"><i class="fa-solid fa-dice"></i> Thème Aléatoire</button>
                        </div>
                    </details>
                     <details class="control-group">
                        <summary><span>Couleurs</span><label class="completion-label"><input type="checkbox" id="completion-styles-colors" class="completion-checkbox"><span>Fait ✅</span></label></summary>
                        <div class="control-group-content">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="primary-color-picker" class="block text-sm font-medium text-gray-700">Principale</label>
                                    <input type="color" id="primary-color-picker" value="#2563eb" class="cv-input w-full h-10 p-1 border rounded-md">
                                </div>
                                <div>
                                    <label for="secondary-color-picker" class="block text-sm font-medium text-gray-700">Secondaire</label>
                                    <div class="flex items-center">
                                        <input type="color" id="secondary-color-picker" value="#334155" class="cv-input w-full h-10 p-1 border rounded-md">
                                        <button id="ai-color-btn" title="Suggestion IA" class="ml-2 text-blue-600 hover:text-blue-800"><i class="fas fa-wand-magic-sparkles"></i></button>
                                    </div>
                                </div>
                                <div class="col-span-2">
                                    <label for="body-text-color-picker" class="block text-sm font-medium text-gray-700">Texte du corps</label>
                                    <input type="color" id="body-text-color-picker" value="#334155" class="cv-input w-full h-10 p-1 border rounded-md">
                                </div>
                            </div>
                            <div class="mt-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Palettes Harmonieuses</label>
                                <div class="grid grid-cols-4 gap-2">
                                    <button class="color-palette-btn h-8 rounded-md border-2 border-transparent hover:border-gray-400" style="background: linear-gradient(45deg, #667eea 0%, #764ba2 100%)" data-colors='["#667eea", "#764ba2", "#2d3748"]' title="💙 Palette Bleu-Violet professionnelle"></button>
                                    <button class="color-palette-btn h-8 rounded-md border-2 border-transparent hover:border-gray-400" style="background: linear-gradient(45deg, #f093fb 0%, #f5576c 100%)" data-colors='["#f093fb", "#f5576c", "#2d3748"]' title="💗 Palette Rose-Rouge créative"></button>
                                    <button class="color-palette-btn h-8 rounded-md border-2 border-transparent hover:border-gray-400" style="background: linear-gradient(45deg, #4facfe 0%, #00f2fe 100%)" data-colors='["#4facfe", "#00f2fe", "#2d3748"]' title="💙 Palette Bleu-Cyan moderne"></button>
                                    <button class="color-palette-btn h-8 rounded-md border-2 border-transparent hover:border-gray-400" style="background: linear-gradient(45deg, #43e97b 0%, #38f9d7 100%)" data-colors='["#43e97b", "#38f9d7", "#2d3748"]' title="💚 Palette Vert-Turquoise nature"></button>
                                    <button class="color-palette-btn h-8 rounded-md border-2 border-transparent hover:border-gray-400" style="background: linear-gradient(45deg, #fa709a 0%, #fee140 100%)" data-colors='["#fa709a", "#fee140", "#2d3748"]' title="🌅 Palette Rose-Jaune énergie"></button>
                                    <button class="color-palette-btn h-8 rounded-md border-2 border-transparent hover:border-gray-400" style="background: linear-gradient(45deg, #a8edea 0%, #fed6e3 100%)" data-colors='["#a8edea", "#fed6e3", "#2d3748"]' title="🌸 Palette Pastel douce et délicate"></button>
                                    <button class="color-palette-btn h-8 rounded-md border-2 border-transparent hover:border-gray-400" style="background: linear-gradient(45deg, #ff9a9e 0%, #fecfef 100%)" data-colors='["#ff9a9e", "#fecfef", "#2d3748"]' title="🌺 Palette Rose poudré romantique"></button>
                                    <button class="color-palette-btn h-8 rounded-md border-2 border-transparent hover:border-gray-400" style="background: linear-gradient(45deg, #667eea 0%, #764ba2 100%)" data-colors='["#667eea", "#764ba2", "#2d3748"]' title="💎 Palette Violet classique"></button>
                                </div>
                            </div>
                        </div>
                    </details>
                     <details class="control-group">
                        <summary><span>Polices</span><label class="completion-label"><input type="checkbox" id="completion-styles-fonts" class="completion-checkbox"><span>Fait ✅</span></label></summary>
                        <div class="control-group-content space-y-4">
                            <button id="ai-suggest-fonts-btn" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 flex items-center justify-center gap-2" title="L'IA recommande les meilleures combinaisons de polices pour votre CV"><i class="fa-solid fa-font"></i> Suggestions IA de Polices</button>
                            <div>
                                <label for="font-family-h1-select" class="block text-sm font-medium text-gray-700">Titre Principal (H1)</label>
                                <select id="font-family-h1-select" class="cv-input w-full p-2 border rounded-md"></select>
                            </div>
                            <div>
                                <label for="font-family-h2-select" class="block text-sm font-medium text-gray-700">Titres de Section (H2)</label>
                                <select id="font-family-h2-select" class="cv-input w-full p-2 border rounded-md"></select>
                            </div>
                            <div>
                                <label for="font-family-body-select" class="block text-sm font-medium text-gray-700">Corps de Texte</label>
                                <select id="font-family-body-select" class="cv-input w-full p-2 border rounded-md"></select>
                            </div>
                        </div>
                    </details>
                     <details class="control-group">
                        <summary><span>Effets Visuels <span class="new-badge">NOUVEAU</span></span><label class="completion-label"><input type="checkbox" id="completion-styles-effects" class="completion-checkbox"><span>Fait ✅</span></label></summary>
                        <div class="control-group-content space-y-4">
                            <div>
                                <label for="cv-shadow-intensity" class="block text-sm font-medium text-gray-700">Ombre des pages: <span id="cv-shadow-intensity-value">10</span></label>
                                <input type="range" id="cv-shadow-intensity" min="0" max="30" step="1" value="10" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer">
                            </div>
                            <div>
                                <label for="section-border-radius" class="block text-sm font-medium text-gray-700">Arrondi des sections: <span id="section-border-radius-value">0</span>px</label>
                                <input type="range" id="section-border-radius" min="0" max="20" step="1" value="0" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer">
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <label class="flex items-center gap-2 text-sm"><input type="checkbox" id="enable-gradients" class="cv-input">Dégradés sur titres</label>
                                <label class="flex items-center gap-2 text-sm"><input type="checkbox" id="enable-animations" class="cv-input">Animations subtiles</label>
                            </div>
                            <button id="apply-glassmorphism-btn" class="w-full bg-gradient-to-r from-cyan-500 to-blue-500 text-white py-2 px-4 rounded-md hover:from-cyan-600 hover:to-blue-600 flex items-center justify-center gap-2" title="Appliquer un effet glassmorphism moderne et tendance"><i class="fa-solid fa-sparkles"></i> Effet Glassmorphism</button>
                        </div>
                    </details>
                     <details class="control-group">
                        <summary><span>Style des Titres de Section</span><label class="completion-label"><input type="checkbox" id="completion-styles-titles" class="completion-checkbox"><span>Fait ✅</span></label></summary>
                        <div class="control-group-content">
                            <div class="grid grid-cols-2 gap-2">
                                <button data-title-style="style-underline" class="section-title-style-btn bg-gray-200 p-2 rounded-md text-sm active" title="Titres avec soulignement classique">Souligné</button>
                                <button data-title-style="style-side-line" class="section-title-style-btn bg-gray-200 p-2 rounded-md text-sm" title="Ligne verticale sur le côté gauche">Ligne Côté</button>
                                <button data-title-style="style-background" class="section-title-style-btn bg-gray-200 p-2 rounded-md text-sm" title="Arrière-plan coloré pour les titres">Fond</button>
                                <button data-title-style="style-boxed" class="section-title-style-btn bg-gray-200 p-2 rounded-md text-sm" title="Titres encadrés avec bordure">Encadré</button>
                                <button data-title-style="style-gradient" class="section-title-style-btn bg-gray-200 p-2 rounded-md text-sm" title="Dégradé de couleurs sur les titres">Dégradé</button>
                                <button data-title-style="style-shadow" class="section-title-style-btn bg-gray-200 p-2 rounded-md text-sm" title="Effet d'ombre sur le texte">Ombre</button>
                            </div>
                        </div>
                    </details>
                </div>

                <!-- TAB: Bannière -->
                <div id="panel-banner" class="tab-panel hidden space-y-4">
                     <details class="control-group">
                        <summary><span>Bannière Recruteur</span><label class="completion-label"><input type="checkbox" id="completion-banner-main" class="completion-checkbox"><span>Fait ✅</span></label></summary>
                        <div class="control-group-content space-y-3">
                            <div class="flex justify-between items-center">
                                <h3 class="font-semibold text-gray-700">Bannière Recruteur</h3>
                                <button id="reset-recruiter-btn" class="text-sm text-gray-500 hover:text-red-600" title="Réinitialiser les informations recruteur"><i class="fas fa-undo"></i></button>
                            </div>
                            
                            <!-- Contrôles de fixation de bannière -->
                            <div id="banner-fix-controls" class="space-y-2">
                                <h4 class="text-sm font-medium text-gray-700">🔧 Position de la bannière</h4>
                                <button id="fix-banner-top-btn" class="w-full bg-teal-600 text-white py-2 px-4 rounded-md hover:bg-teal-700 flex items-center justify-center gap-2" title="Fixer la bannière en haut de toutes les pages">
                                    <i class="fas fa-arrow-up"></i>Fixer en haut
                                </button>
                                <button id="fix-banner-bottom-btn" class="w-full bg-teal-600 text-white py-2 px-4 rounded-md hover:bg-teal-700 flex items-center justify-center gap-2" title="Fixer la bannière en bas de toutes les pages">
                                    <i class="fas fa-arrow-down"></i>Fixer en bas
                                </button>
                            </div>
                            
                            <button id="modular-banner-btn" class="w-full bg-orange-500 text-white py-2 px-4 rounded-md hover:bg-orange-600 flex items-center justify-center gap-2 hidden" title="Rendre la bannière déplaçable dans les colonnes">
                                <i class="fas fa-arrows-up-down-left-right"></i>Rendre modulaire
                            </button>
                            
                            <label class="flex items-center gap-2 text-sm">
                                <input type="checkbox" id="toggle-banner-checkbox" class="cv-input">Afficher la bannière
                            </label>                            <label for="banner-style-select" class="text-sm font-medium">Style de Bannière</label>
                            <select id="banner-style-select" class="cv-input w-full p-2 border rounded-md">
                                <option value="banner-style-modern">Moderne</option>
                                <option value="banner-style-elegant">Élégant</option>
                                <option value="banner-style-discret">Discret</option>
                                <option value="banner-style-carte">Carte</option>
                                <option value="banner-style-degrade">Dégradé</option>
                                <option value="banner-style-premium">Premium</option>
                                <option value="banner-style-minimal">Minimal</option>
                                <option value="banner-style-encadre">Encadré</option>
                                <option value="banner-style-ligne-haute">Ligne Haute</option>
                            </select>
                            
                            <p class="text-sm font-medium">Alignement</p>
                            <div class="flex gap-2">
                                <button data-banner-align="left" class="banner-align-btn flex-1 bg-gray-200 p-2 rounded-md text-sm" title="Aligner la bannière à gauche">
                                    <i class="fas fa-align-left"></i>
                                </button>
                                <button data-banner-align="center" class="banner-align-btn flex-1 bg-gray-200 p-2 rounded-md text-sm" title="Centrer la bannière">
                                    <i class="fas fa-align-center"></i>
                                </button>
                                <button data-banner-align="right" class="banner-align-btn flex-1 bg-gray-200 p-2 rounded-md text-sm" title="Aligner la bannière à droite">
                                    <i class="fas fa-align-right"></i>
                                </button>
                                <button id="banner-invert-btn" class="p-2 bg-gray-200 rounded-md text-sm" title="Inverser Logo/Texte">
                                    <i class="fas fa-right-left"></i>
                                </button>
                            </div>
                            
                            <p class="text-sm font-medium">Taille Logo</p>
                            <div class="flex gap-2">
                                <button data-logo-size="sm" class="logo-size-btn flex-1 bg-gray-200 p-2 rounded-md text-sm" title="Logo petit (40px)">P</button>
                                <button data-logo-size="md" class="logo-size-btn flex-1 bg-gray-200 p-2 rounded-md text-sm" title="Logo moyen (60px)">M</button>
                                <button data-logo-size="lg" class="logo-size-btn flex-1 bg-gray-200 p-2 rounded-md text-sm" title="Logo grand (80px)">G</button>
                                <button data-logo-size="xl" class="logo-size-btn flex-1 bg-gray-200 p-2 rounded-md text-sm" title="Logo très grand (100px)">XL</button>
                                <button data-logo-size="xxl" class="logo-size-btn flex-1 bg-gray-200 p-2 rounded-md text-sm" title="Logo extra grand (120px)">XXL</button>
                            </div>
                            
                            <div>
                                <label for="banner-element-spacing" class="block text-sm font-medium text-gray-700">
                                    Espace Bannière: <span id="banner-element-spacing-value">1</span>rem
                                </label>
                                <input type="range" id="banner-element-spacing" min="0.5" max="4" step="0.1" value="1" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer">
                            </div>
                            
                            <input type="text" id="banner-nom" placeholder="Votre Nom & Prénom" class="banner-input w-full p-2 border rounded-md">
                            <input type="text" id="banner-poste" placeholder="Votre Poste" class="banner-input w-full p-2 border rounded-md">
                            <input type="email" id="banner-email" placeholder="Email" class="banner-input w-full p-2 border rounded-md">
                            <input type="tel" id="banner-tel" placeholder="Téléphone" class="banner-input w-full p-2 border rounded-md">
                            
                            <div>
                                <label for="banner-image" class="block text-sm font-medium text-gray-700">Photo/Logo</label>
                                <input type="file" id="banner-image" accept="image/*" class="banner-input mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                            </div>
                        </div>
                    </details>
                     <details class="control-group">
                        <summary><span>Image de Fond</span><label class="completion-label"><input type="checkbox" id="completion-banner-bg" class="completion-checkbox"><span>Fait ✅</span></label></summary>
                        <div class="control-group-content space-y-4">
                            <div class="bg-yellow-50 border border-yellow-200 rounded-md p-3 text-sm">
                                <p class="text-yellow-800">
                                    <i class="fas fa-info-circle mr-2"></i>
                                    <strong>Note importante :</strong> L'image de fond n'est pas appliquée automatiquement. 
                                    Vous devez manuellement télécharger et ajuster l'image selon vos besoins.
                                </p>
                            </div>
                            
                            <div>
                                <label for="banner-bg-image" class="block text-sm font-medium text-gray-700">
                                    🖼️ Télécharger une image de fond pour la bannière
                                </label>
                                <input type="file" id="banner-bg-image" accept="image/*" class="banner-input mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                                <p class="text-xs text-gray-500 mt-1">Formats acceptés : JPG, PNG, WebP - Taille recommandée : 1200x300px</p>
                            </div>
                            
                            <div>
                                <label for="banner-bg-opacity" class="block text-sm font-medium text-gray-700">
                                    Opacité de l'image: <span id="banner-bg-opacity-value">1</span>
                                </label>
                                <input type="range" id="banner-bg-opacity" min="0" max="1" step="0.05" value="1" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer">
                                <p class="text-xs text-gray-500">Réduisez l'opacité pour rendre le texte plus lisible</p>
                            </div>
                            
                            <div>
                                <label for="banner-bg-blur" class="block text-sm font-medium text-gray-700">
                                    Flou de l'image: <span id="banner-bg-blur-value">0</span>px
                                </label>
                                <input type="range" id="banner-bg-blur" min="0" max="20" step="1" value="0" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer">
                                <p class="text-xs text-gray-500">Ajoutez du flou pour améliorer la lisibilité du texte</p>
                            </div>
                            
                            <label class="flex items-center gap-2 text-sm">
                                <input type="checkbox" id="banner-bg-grayscale" class="cv-input">
                                Image en noir et blanc
                            </label>
                            
                            <button id="remove-banner-bg-btn" class="ai-btn-enhanced w-full bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 flex items-center justify-center gap-2 transition-all duration-200 hover:scale-105" data-tooltip="🗑️ Supprimer l'image de fond de la bannière">
                                <i class="fas fa-trash text-lg"></i> Supprimer l'image de fond
                            </button>
                        </div>
                    </details>
                     <details class="control-group">
                        <summary><span>Style du Texte</span><label class="completion-label"><input type="checkbox" id="completion-banner-text" class="completion-checkbox"><span>Fait ✅</span></label></summary>
                        <div class="control-group-content space-y-4">
                            <button id="randomize-banner-style-btn" class="w-full bg-indigo-500 text-white py-2 px-4 rounded-md hover:bg-indigo-600 flex items-center justify-center gap-2" title="Appliquer un style de bannière aléatoire pour l'inspiration"><i class="fas fa-dice"></i> Style Aléatoire</button><div class="border-t pt-4 mt-4"><h4 class="font-semibold text-sm mb-2">Nom & Prénom</h4><label class="text-xs">Police</label><select id="banner-nom-font" class="cv-input w-full p-1 border text-sm rounded-md"><option value="'Montserrat', sans-serif">Montserrat</option><option value="'Playfair Display', serif">Playfair Display</option><option value="'Oswald', sans-serif">Oswald</option><option value="'Cormorant Garamond', serif">Cormorant Garamond</option><option value="'Merriweather', serif">Merriweather</option><option value="'Lato', sans-serif">Lato</option></select><label class="text-xs mt-2 block">Taille: <span id="banner-nom-size-value">24</span>pt</label><input type="range" id="banner-nom-size" min="14" max="40" step="1" value="24" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer"><div class="flex items-center gap-2 mt-2"><label class="text-xs">Couleur:</label><input type="color" id="banner-nom-color" value="#334155" class="cv-input w-full h-8 p-1 border rounded-md"><button id="banner-nom-bold" class="style-toggle-btn p-1 px-2 rounded-md bg-gray-200 text-sm" title="Mettre le nom en gras"><i class="fas fa-bold"></i></button><button id="banner-nom-italic" class="style-toggle-btn p-1 px-2 rounded-md bg-gray-200 text-sm" title="Mettre le nom en italique"><i class="fas fa-italic"></i></button></div></div><div class="border-t pt-4 mt-4"><h4 class="font-semibold text-sm mb-2">Poste</h4><label class="text-xs mt-2 block">Taille: <span id="banner-poste-size-value">12</span>pt</label><input type="range" id="banner-poste-size" min="8" max="20" step="0.5" value="12" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer"><div class="flex items-center gap-2 mt-2"><label class="text-xs">Couleur:</label><input type="color" id="banner-poste-color" value="#334155" class="cv-input w-full h-8 p-1 border rounded-md"><button id="banner-poste-bold" class="style-toggle-btn p-1 px-2 rounded-md bg-gray-200 text-sm" title="Mettre le poste en gras"><i class="fas fa-bold"></i></button><button id="banner-poste-italic" class="style-toggle-btn p-1 px-2 rounded-md bg-gray-200 text-sm" title="Mettre le poste en italique"><i class="fas fa-italic"></i></button></div></div><div class="border-t pt-4 mt-4"><h4 class="font-semibold text-sm mb-2">Coordonnées</h4><label class="text-xs mt-2 block">Taille: <span id="banner-contact-size-value">9</span>pt</label><input type="range" id="banner-contact-size" min="7" max="14" step="0.5" value="9" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer"><div class="flex items-center gap-2 mt-2"><label class="text-xs">Couleur:</label><input type="color" id="banner-contact-color" value="#334155" class="cv-input w-full h-8 p-1 border rounded-md"><button id="banner-contact-bold" class="style-toggle-btn p-1 px-2 rounded-md bg-gray-200 text-sm" title="Mettre les coordonnées en gras"><i class="fas fa-bold"></i></button><button id="banner-contact-italic" class="style-toggle-btn p-1 px-2 rounded-md bg-gray-200 text-sm" title="Mettre les coordonnées en italique"><i class="fas fa-italic"></i></button></div></div>
                        </div>
                    </details>
                </div>
            </div>

        </div>

        <!-- PREVIEW PANEL -->
        <div class="flex-1 p-4 bg-gray-50 flex flex-col items-center overflow-auto" id="preview-area">
            
            <div class="w-full flex justify-center">
            <div id="cv-preview-wrapper">
                <div class="a4-page-container">
                    <div id="page-1" class="a4-page">
                        <div id="fixed-banner-top"></div>
                        <div class="cv-body-container layout-1-col">
                            <div id="cv-col-1-1" class="cv-column">
                                <div id="banner-module" class="cv-module">
                                    <div class="drag-handle"><i class="fas fa-grip-vertical"></i></div>
                                    <div id="recruiter-banner" class="banner-align-left">
                                        <img id="banner-bg-img-preview" src="" alt="Banner background" class="absolute top-0 left-0 w-full h-full object-cover z-0 transition-all duration-300">
                                        <div class="banner-content-wrapper">
                                            <img id="banner-img-preview" class="logo-md" src="https://placehold.co/100x100/EFEFEF/AAAAAA&text=Photo" alt="Photo recruteur" onerror="this.onerror=null; this.src='https://placehold.co/100x100/EFEFEF/AAAAAA&text=Photo';">
                                            <div class="banner-content">
                                                <p id="banner-nom-preview" class="item-title" contenteditable="true"></p>
                                                <p id="banner-poste-preview" contenteditable="true"></p>
                                                <p id="banner-contact-preview"><span id="banner-email-preview" contenteditable="true"></span> | <span id="banner-tel-preview" contenteditable="true"></span></p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div id="header-module" class="cv-module"><div class="drag-handle"><i class="fas fa-grip-vertical"></i></div><div class="cv-header text-center"><div class="editable-wrapper"><h1 id="cv-nom-prenom-preview" contenteditable="true">Prénom NOM</h1><span class="delete-line-btn"><i class="fas fa-times"></i></span></div><div class="editable-wrapper"><p id="cv-poste-preview" contenteditable="true">Poste Recherché</p><span class="delete-line-btn"><i class="fas fa-times"></i></span></div></div></div>
                                <div id="qualification-module" class="cv-module"><div class="drag-handle"><i class="fas fa-grip-vertical"></i></div><div id="qualification-preview" class="flex justify-center gap-4 text-center text-sm p-2 bg-slate-50 rounded-md"></div></div>
                                <div id="description-module" class="cv-module"><div class="drag-handle"><i class="fas fa-grip-vertical"></i></div><h2 class="section-title style-underline" data-section-id="description"><i class="fas fa-user-circle section-icon"></i><span contenteditable="true">Profil</span><div class="section-ai-actions"><button class="ai-action-btn toggle-visibility-btn" title="Masquer/Afficher la section"><i class="fas fa-eye"></i></button><button class="ai-action-btn" data-action="rewrite-profile" title="Réécrire le profil avec l'IA"><i class="fas fa-magic-wand-sparkles"></i></button></div></h2><div id="cv-description-preview"></div></div>
                                <div id="experience-module" class="cv-module"><div class="drag-handle"><i class="fas fa-grip-vertical"></i></div><h2 class="section-title style-underline" data-section-id="experience"><i class="fas fa-briefcase section-icon"></i><span contenteditable="true">Expérience</span><div class="section-ai-actions"><button class="ai-action-btn toggle-visibility-btn" title="Masquer/Afficher la section"><i class="fas fa-eye"></i></button><button class="ai-action-btn" data-action="summarize-experience" title="Synthétiser les expériences avec l'IA (5 lignes max)"><i class="fas fa-magic-wand-sparkles"></i></button></div></h2><div id="cv-experience-preview"></div></div>
                                <div id="formation-module" class="cv-module"><div class="drag-handle"><i class="fas fa-grip-vertical"></i></div><h2 class="section-title style-underline" data-section-id="formation"><i class="fas fa-graduation-cap section-icon"></i><span contenteditable="true">Formation</span><div class="section-ai-actions"><button class="ai-action-btn toggle-visibility-btn" title="Masquer/Afficher la section"><i class="fas fa-eye"></i></button><button class="ai-action-btn" data-action="rewrite-formation" title="Améliorer les formations avec l'IA"><i class="fas fa-magic-wand-sparkles"></i></button></div></h2><div id="cv-formation-preview"></div></div>
                                <div id="competences-module" class="cv-module"><div class="drag-handle"><i class="fas fa-grip-vertical"></i></div><h2 class="section-title style-underline" data-section-id="competences"><i class="fas fa-star section-icon"></i><span contenteditable="true">Compétences</span><div class="section-ai-actions"><button class="ai-action-btn toggle-visibility-btn" title="Masquer/Afficher la section"><i class="fas fa-eye"></i></button><button class="ai-action-btn" data-action="rewrite-skills" title="Améliorer les compétences avec l'IA"><i class="fas fa-magic-wand-sparkles"></i></button></div></h2><div id="cv-competences-preview" data-style="tags"></div></div>
                            </div>
                            <div id="cv-col-1-2" class="cv-column"></div>
                        </div>
                        <div id="fixed-banner-bottom"></div>
                    </div>
                     <button class="remove-page-btn no-print" title="🗑️ Supprimer cette page du CV"><i class="fas fa-trash-can"></i></button>
                </div>
                 <div id="add-page-btn-wrapper" class="no-print">
                     <button id="add-page-btn" title="Ajouter une nouvelle page au CV"><i class="fas fa-plus"></i></button>
                 </div>
            </div>
            </div>
        </div>
    </div>
    
    <!-- MODALS -->
    <div id="share-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="text-xl font-bold mb-4">Partager le CV</h2>
            <p class="text-sm text-gray-600 mb-2">Copiez ce lien unique pour partager une version en lecture seule de ce CV.</p>
            <div class="flex items-center border rounded-md p-2 bg-gray-50">
                <input type="text" id="share-link-input" readonly class="flex-grow bg-transparent outline-none text-sm">
                <button id="copy-share-link-btn" class="ml-2 px-3 py-1 bg-blue-500 text-white text-sm rounded-md hover:bg-blue-600" title="📋 Copier le lien de partage dans le presse-papiers">Copier</button>
            </div>
            <div class="text-right mt-4">
                 <button id="close-share-modal" class="px-4 py-2 bg-gray-200 text-sm rounded-md hover:bg-gray-300" title="Fermer la fenêtre de partage">Fermer</button>
            </div>
        </div>
    </div>
    
    <div id="icon-picker-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Choisir une icône</h2>
                <button id="close-icon-picker-modal" class="text-gray-500 hover:text-gray-800 text-2xl" title="Fermer le sélecteur d'icônes">&times;</button>
            </div>
            <div class="mb-4">
                <input type="text" id="icon-search-input" placeholder="Rechercher une icône..." class="w-full p-2 border rounded-md">
            </div>
            <div id="icon-picker-grid"></div>
        </div>
    </div>

    <div id="confirm-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="confirm-modal-title" class="text-xl font-bold mb-4">Confirmation</h2>
            <p id="confirm-modal-text" class="text-gray-600 mb-6">Êtes-vous sûr ?</p>
            <div class="flex justify-end gap-4">
                <button id="confirm-modal-cancel-btn" class="px-4 py-2 bg-gray-200 text-sm rounded-md hover:bg-gray-300" title="Annuler l'action et fermer">Annuler</button>
                <button id="confirm-modal-ok-btn" class="px-4 py-2 bg-red-600 text-white text-sm rounded-md hover:bg-red-700" title="Confirmer l'action définitivement">Confirmer</button>
            </div>
        </div>
    </div>

    <!-- NEW MODALS -->
    <div id="cv-variants-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 800px;">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Variantes de CV générées par l'IA</h2>
                <button id="close-variants-modal" class="text-gray-500 hover:text-gray-800 text-2xl" title="Fermer le sélecteur de variantes">&times;</button>
            </div>
            <div id="variants-container" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- Variants will be inserted here -->
            </div>
            <div class="flex justify-end gap-4 mt-6">
                <button id="cancel-variants-btn" class="px-4 py-2 bg-gray-200 text-sm rounded-md hover:bg-gray-300" title="Annuler et garder la version actuelle">Annuler</button>
                <button id="apply-variant-btn" class="px-4 py-2 bg-blue-600 text-white text-sm rounded-md hover:bg-blue-700" disabled title="Appliquer la variante sélectionnée à votre CV">Appliquer la Variante</button>
            </div>
        </div>
    </div>

    <div id="translation-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Traduire le CV</h2>
                <button id="close-translation-modal" class="text-gray-500 hover:text-gray-800 text-2xl" title="Fermer le traducteur">&times;</button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Langue cible</label>
                    <select id="target-language-select" class="w-full p-2 border rounded-md">
                        <option value="en">🇺🇸 Anglais</option>
                        <option value="es">🇪🇸 Espagnol</option>
                        <option value="de">🇩🇪 Allemand</option>
                        <option value="it">🇮🇹 Italien</option>
                        <option value="pt">🇵🇹 Portugais</option>
                        <option value="zh">🇨🇳 Chinois</option>
                        <option value="ja">🇯🇵 Japonais</option>
                        <option value="ar">🇸🇦 Arabe</option>
                    </select>
                </div>
                <div class="flex justify-end gap-4">
                    <button id="cancel-translation-btn" class="px-4 py-2 bg-gray-200 text-sm rounded-md hover:bg-gray-300">Annuler</button>
                    <button id="start-translation-btn" class="px-4 py-2 bg-blue-600 text-white text-sm rounded-md hover:bg-blue-700">Traduire</button>
                </div>
            </div>
        </div>
    </div>

    <div id="cv-score-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Score ATS du CV</h2>
                <button id="close-score-modal" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <div id="score-result-container">
                <!-- Score results will be inserted here -->
            </div>
            <div class="text-right mt-4">
                <button id="close-score-modal-btn" class="px-4 py-2 bg-gray-200 text-sm rounded-md hover:bg-gray-300">Fermer</button>
            </div>
        </div>
    </div>

    <div id="improvements-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 600px;">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Suggestions d'amélioration IA</h2>
                <button id="close-improvements-modal" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <div id="improvements-container" class="space-y-4">
                <!-- Improvements will be inserted here -->
            </div>
            <div class="text-right mt-4">
                <button id="close-improvements-modal-btn" class="px-4 py-2 bg-gray-200 text-sm rounded-md hover:bg-gray-300">Fermer</button>
            </div>
        </div>
    </div>

    <div id="skill-analysis-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 700px;">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Analyse des Compétences</h2>
                <button id="close-skill-analysis-modal" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <div id="skill-analysis-container">
                <!-- Analysis results will be inserted here -->
            </div>
            <div class="text-right mt-4">
                <button id="close-skill-analysis-modal-btn" class="px-4 py-2 bg-gray-200 text-sm rounded-md hover:bg-gray-300">Fermer</button>
            </div>
        </div>
    </div>

    <script type="module">
        // This script is now self-contained and does not use Firebase for saving.
        
        document.addEventListener('DOMContentLoaded', function() {
            // --- GLOBAL SELECTORS (STATIC) ---
            const controls = {
                aiInput: document.getElementById('ai-input'), analyzeBtn: document.getElementById('analyze-btn'), loader: document.getElementById('loader-overlay'), loaderText: document.getElementById('loader-text'),
                nom: document.getElementById('nom'), prenom: document.getElementById('prenom'), poste: document.getElementById('poste'),
                description: document.getElementById('description'), competences: document.getElementById('competences'), aiSynthesizeSkillsBtn: document.getElementById('ai-synthesize-skills-btn'),
                experienceList: document.getElementById('experience-list'), addExperienceBtn: document.getElementById('add-experience'),
                formationList: document.getElementById('formation-list'), addFormationBtn: document.getElementById('add-formation'),
                toggleBanner: document.getElementById('toggle-banner-checkbox'), bannerNom: document.getElementById('banner-nom'), bannerPoste: document.getElementById('banner-poste'), bannerEmail: document.getElementById('banner-email'), bannerTel: document.getElementById('banner-tel'), bannerImage: document.getElementById('banner-image'),
                bannerStyleSelect: document.getElementById('banner-style-select'), bannerInvertBtn: document.getElementById('banner-invert-btn'),
                fixBannerTopBtn: document.getElementById('fix-banner-top-btn'), fixBannerBottomBtn: document.getElementById('fix-banner-bottom-btn'), modularBannerBtn: document.getElementById('modular-banner-btn'),
                qualificationDispo: document.getElementById('qualification-dispo'), qualificationSalaire: document.getElementById('qualification-salaire'), qualificationLoc: document.getElementById('qualification-loc'),
                generateMailBtn: document.getElementById('generate-mail-btn'), recruiterMailContent: document.getElementById('recruiter-mail-content'),
                anonymizeBtn: document.getElementById('anonymize-btn'), downloadPdfBtn: document.getElementById('download-pdf-btn'),
                resetCvBtn: document.getElementById('reset-cv-btn'),
                togglePresentationModeBtn: document.getElementById('toggle-presentation-mode-btn'),
                toggleOverflowBtn: document.getElementById('toggle-overflow-btn'),
                aiOptimizeOnePageBtn: document.getElementById('ai-optimize-one-page-btn'),
                resetRecruiterBtn: document.getElementById('reset-recruiter-btn'),
                aiLimitSkillsBtn: document.getElementById('ai-limit-skills-btn'),
                pageMargin: document.getElementById('page-margin'), pageMarginValue: document.getElementById('page-margin-value'),
                moduleSpacing: document.getElementById('module-spacing'), moduleSpacingValue: document.getElementById('module-spacing-value'),
                itemSpacing: document.getElementById('item-spacing'), itemSpacingValue: document.getElementById('item-spacing-value'),
                fontSizeH1: document.getElementById('font-size-h1'), fontSizeH1Value: document.getElementById('font-size-h1-value'),
                fontSizeH2: document.getElementById('font-size-h2'), fontSizeH2Value: document.getElementById('font-size-h2-value'),
                fontSizeP: document.getElementById('font-size-p'), fontSizePValue: document.getElementById('font-size-p-value'),
                fontSizeBanner: document.getElementById('font-size-banner'), fontSizeBannerValue: document.getElementById('font-size-banner-value'),
                bannerElementSpacing: document.getElementById('banner-element-spacing'), bannerElementSpacingValue: document.getElementById('banner-element-spacing-value'),
                lineHeight: document.getElementById('line-height'), lineHeightValue: document.getElementById('line-height-value'),
                paragraphSpacing: document.getElementById('paragraph-spacing'), paragraphSpacingValue: document.getElementById('paragraph-spacing-value'),
                randomizeBannerStyleBtn: document.getElementById('randomize-banner-style-btn'),
                bannerNomFont: document.getElementById('banner-nom-font'), bannerNomSize: document.getElementById('banner-nom-size'), bannerNomSizeValue: document.getElementById('banner-nom-size-value'), bannerNomColor: document.getElementById('banner-nom-color'), bannerNomBold: document.getElementById('banner-nom-bold'), bannerNomItalic: document.getElementById('banner-nom-italic'),
                bannerPosteSize: document.getElementById('banner-poste-size'), bannerPosteSizeValue: document.getElementById('banner-poste-size-value'), bannerPosteColor: document.getElementById('banner-poste-color'), bannerPosteBold: document.getElementById('banner-poste-bold'), bannerPosteItalic: document.getElementById('banner-poste-italic'),
                bannerContactSize: document.getElementById('banner-contact-size'), bannerContactSizeValue: document.getElementById('banner-contact-size-value'), bannerContactColor: document.getElementById('banner-contact-color'), bannerContactBold: document.getElementById('banner-contact-bold'), bannerContactItalic: document.getElementById('banner-contact-italic'),
                undoBtn: document.getElementById('undo-btn'), redoBtn: document.getElementById('redo-btn'),
                addSectionBtn: document.getElementById('add-section-btn'), customSectionsList: document.getElementById('custom-sections-list'), sectionSuggestionSelect: document.getElementById('section-suggestion-select'), newSectionTitleInput: document.getElementById('new-section-title-input'),
                primaryColorPicker: document.getElementById('primary-color-picker'),
                secondaryColorPicker: document.getElementById('secondary-color-picker'),
                aiColorBtn: document.getElementById('ai-color-btn'),
                bodyTextColorPicker: document.getElementById('body-text-color-picker'),
                fontFamilyH1Select: document.getElementById('font-family-h1-select'),
                fontFamilyH2Select: document.getElementById('font-family-h2-select'),
                fontFamilyBodySelect: document.getElementById('font-family-body-select'),
                shareBtn: document.getElementById('share-btn'), shareModal: document.getElementById('share-modal'), closeShareModal: document.getElementById('close-share-modal'), shareLinkInput: document.getElementById('share-link-input'), copyShareLinkBtn: document.getElementById('copy-share-link-btn'),
                iconPickerModal: document.getElementById('icon-picker-modal'), closeIconPickerModal: document.getElementById('close-icon-picker-modal'), iconPickerGrid: document.getElementById('icon-picker-grid'), iconSearchInput: document.getElementById('icon-search-input'),
                addPageBtn: document.getElementById('add-page-btn'),
                bannerBgImage: document.getElementById('banner-bg-image'),
                bannerBgOpacity: document.getElementById('banner-bg-opacity'),
                bannerBgOpacityValue: document.getElementById('banner-bg-opacity-value'),
                bannerBgBlur: document.getElementById('banner-bg-blur'),
                bannerBgBlurValue: document.getElementById('banner-bg-blur-value'),
                bannerBgGrayscale: document.getElementById('banner-bg-grayscale'),
                removeBannerBgBtn: document.getElementById('remove-banner-bg-btn'),
                skillsTextControls: document.getElementById('skills-text-controls'),
                skillsLevelControls: document.getElementById('skills-level-controls'),
                skillsLevelList: document.getElementById('skills-level-list'),
                addSkillLevelBtn: document.getElementById('add-skill-level-btn'),
                apiKeyInput: document.getElementById('api-key-input'),
                apiKeyStatus: document.getElementById('api-key-status'),
                saveApiKeyBtn: document.getElementById('save-api-key-btn'),
                toggleApiKeyVisibilityBtn: document.getElementById('toggle-api-key-visibility'),
                confirmModal: {
                    overlay: document.getElementById('confirm-modal'),
                    title: document.getElementById('confirm-modal-title'),
                    text: document.getElementById('confirm-modal-text'),
                    okBtn: document.getElementById('confirm-modal-ok-btn'),
                    cancelBtn: document.getElementById('confirm-modal-cancel-btn'),
                }
            };

            // --- DYNAMIC SELECTORS ---
            let preview = {};
            function reinitializePreviewSelectors() {
                preview.previewWrapper = document.getElementById('cv-preview-wrapper');
                preview.cvNomPrenom = document.getElementById('cv-nom-prenom-preview');
                preview.cvPoste = document.getElementById('cv-poste-preview');
                preview.cvDescription = document.getElementById('cv-description-preview');
                preview.cvFormation = document.getElementById('cv-formation-preview');
                preview.cvCompetences = document.getElementById('cv-competences-preview');
                preview.cvExperience = document.getElementById('cv-experience-preview');
                preview.bannerModule = document.getElementById('banner-module');
                preview.banner = document.getElementById('recruiter-banner');
                preview.bannerImg = document.getElementById('banner-img-preview');
                preview.bannerNom = document.getElementById('banner-nom-preview');
                preview.bannerPoste = document.getElementById('banner-poste-preview');
                preview.bannerContact = document.getElementById('banner-contact-preview');
                preview.bannerEmail = document.getElementById('banner-email-preview');
                preview.bannerTel = document.getElementById('banner-tel-preview');
                preview.qualificationModule = document.getElementById('qualification-module');
                preview.qualificationPreview = document.getElementById('qualification-preview');
                preview.fixedBannerTop = document.getElementById('fixed-banner-top');
                preview.fixedBannerBottom = document.getElementById('fixed-banner-bottom');
                preview.bannerBgImg = document.getElementById('banner-bg-img-preview');
            }
            
            // --- CONFIGURATION OBJECTS ---
            const sliders = {
                pageMargin: { el: controls.pageMargin, valueEl: controls.pageMarginValue, property: '--page-margin', unit: 'cm' },
                moduleSpacing: { el: controls.moduleSpacing, valueEl: controls.moduleSpacingValue, property: '--module-spacing', unit: 'rem' },
                itemSpacing: { el: controls.itemSpacing, valueEl: controls.itemSpacingValue, property: '--item-spacing', unit: 'rem' },
                fontSizeH1: { el: controls.fontSizeH1, valueEl: controls.fontSizeH1Value, property: '--font-size-h1', unit: 'pt' },
                fontSizeH2: { el: controls.fontSizeH2, valueEl: controls.fontSizeH2Value, property: '--font-size-h2', unit: 'pt' },
                fontSizeP: { el: controls.fontSizeP, valueEl: controls.fontSizePValue, property: '--font-size-p', unit: 'pt' },
                fontSizeBanner: { el: controls.fontSizeBanner, valueEl: controls.fontSizeBannerValue, property: '--font-size-banner', unit: 'pt' },
                lineHeight: { el: controls.lineHeight, valueEl: controls.lineHeightValue, property: '--line-height', unit: '' },
                paragraphSpacing: { el: controls.paragraphSpacing, valueEl: controls.paragraphSpacingValue, property: '--paragraph-spacing', unit: 'rem' },
                bannerElementSpacing: { el: controls.bannerElementSpacing, valueEl: controls.bannerElementSpacingValue, property: '--banner-element-spacing', unit: 'rem' },
            };

            const bannerStyleControls = {
                nomFont: { el: controls.bannerNomFont, event: 'change', stateKey: 'nomFont' },
                nomSize: { el: controls.bannerNomSize, event: 'input', valueEl: controls.bannerNomSizeValue, stateKey: 'nomSize' },
                nomColor: { el: controls.bannerNomColor, event: 'input', stateKey: 'nomColor' },
                nomBold: { el: controls.bannerNomBold, event: 'click', toggle: true, stateKey: 'nomBold' },
                nomItalic: { el: controls.bannerNomItalic, event: 'click', toggle: true, stateKey: 'nomItalic' },
                posteSize: { el: controls.bannerPosteSize, event: 'input', valueEl: controls.bannerPosteSizeValue, stateKey: 'posteSize' },
                posteColor: { el: controls.bannerPosteColor, event: 'input', stateKey: 'posteColor' },
                posteBold: { el: controls.bannerPosteBold, event: 'click', toggle: true, stateKey: 'posteBold' },
                posteItalic: { el: controls.bannerPosteItalic, event: 'click', toggle: true, stateKey: 'posteItalic' },
                contactSize: { el: controls.bannerContactSize, event: 'input', valueEl: controls.bannerContactSizeValue, stateKey: 'contactSize' },
                contactColor: { el: controls.bannerContactColor, event: 'input', stateKey: 'contactColor' },
                contactBold: { el: controls.bannerContactBold, event: 'click', toggle: true, stateKey: 'contactBold' },
                contactItalic: { el: controls.bannerContactItalic, event: 'click', toggle: true, stateKey: 'contactItalic' },
            };

            const themes = {
                professional: {
                    primaryColor: '#2563eb', secondaryColor: '#334155', bodyTextColor: '#334155',
                    fontH1: "'Montserrat', sans-serif", fontH2: "'Montserrat', sans-serif", fontBody: "'Lato', sans-serif"
                },
                creative: {
                    primaryColor: '#db2777', secondaryColor: '#4f46e5', bodyTextColor: '#44403c',
                    fontH1: "'Playfair Display', serif", fontH2: "'Oswald', sans-serif", fontBody: "'Nunito Sans', sans-serif"
                },
                modern: {
                    primaryColor: '#16a34a', secondaryColor: '#1f2937', bodyTextColor: '#374151',
                    fontH1: "'Oswald', sans-serif", fontH2: "'Source Sans Pro', sans-serif", fontBody: "'Source Sans Pro', sans-serif"
                },
                elegant: {
                    primaryColor: '#8b5a3c', secondaryColor: '#d4af37', bodyTextColor: '#2c2c2c',
                    fontH1: "'Playfair Display', serif", fontH2: "'Cormorant Garamond', serif", fontBody: "'Merriweather', serif"
                },
                tech: {
                    primaryColor: '#00d4aa', secondaryColor: '#1a1a1a', bodyTextColor: '#333',
                    fontH1: "'Roboto Mono', monospace", fontH2: "'Source Sans Pro', sans-serif", fontBody: "'Source Sans Pro', sans-serif"
                },
                luxury: {
                    primaryColor: '#b8860b', secondaryColor: '#4b0082', bodyTextColor: '#2c2c2c',
                    fontH1: "'Playfair Display', serif", fontH2: "'Cormorant Garamond', serif", fontBody: "'Lato', sans-serif"
                },
                startup: {
                    primaryColor: '#ff6b35', secondaryColor: '#f7931e', bodyTextColor: '#333',
                    fontH1: "'Montserrat', sans-serif", fontH2: "'Nunito Sans', sans-serif", fontBody: "'Open Sans', sans-serif"
                },
                academic: {
                    primaryColor: '#2c3e50', secondaryColor: '#34495e', bodyTextColor: '#2c3e50',
                    fontH1: "'Merriweather', serif", fontH2: "'Source Sans Pro', sans-serif", fontBody: "'Source Sans Pro', sans-serif"
                },
                artistic: {
                    primaryColor: '#e91e63', secondaryColor: '#9c27b0', bodyTextColor: '#424242',
                    fontH1: "'Playfair Display', serif", fontH2: "'Oswald', sans-serif", fontBody: "'Nunito Sans', sans-serif"
                }
            };

            // Skill templates
            const skillTemplates = {
                tech: "JavaScript, Python, React, Node.js, SQL, Git, Docker, AWS, TypeScript, MongoDB",
                marketing: "Google Analytics, SEO, SEM, Social Media Marketing, Content Marketing, Email Marketing, Adobe Creative Suite, HubSpot, Canva, WordPress",
                finance: "Excel Avancé, Analyse Financière, Budgétisation, SAP, Bloomberg Terminal, VBA, PowerBI, Audit, Comptabilité, Gestion des Risques",
                design: "Adobe Photoshop, Illustrator, InDesign, Figma, Sketch, After Effects, UI/UX Design, Prototypage, Design Thinking, Typography",
                management: "Leadership, Gestion d'Équipe, Planification Stratégique, Gestion de Projet, Scrum, Agile, Communication, Négociation, Budgets, KPI",
                sales: "Prospection, Négociation, CRM, Salesforce, Closing, Pipeline Management, Présentation Commerciale, Relation Client, Téléprospection, Account Management"
            };

            // Section templates
            const sectionTemplates = {
                startup: ["Projets Entrepreneuriaux 🚀", "Levées de Fonds 💰", "Équipes Constituées 👥", "Technologies Maîtrisées 💻"],
                academic: ["Publications 📚", "Conférences 🎤", "Recherches 🔬", "Collaborations 🤝"],
                creative: ["Portfolio 🎨", "Créations 🎭", "Expositions 🖼️", "Collaborations Artistiques 🎪"],
                executive: ["Équipes Dirigées 👔", "Budgets Gérés 💼", "Stratégies Déployées 📊", "Acquisitions 🏢"],
                international: ["Langues 🌍", "Expérience Internationale ✈️", "Certifications Linguistiques 📜", "Missions à l'Étranger 🗺️"],
                freelance: ["Clients Principaux 👥", "Projets Réalisés 💼", "Testimonials 💬", "Tarification 💰"]
            };
            
            // --- GLOBAL STATE VARIABLES ---
            let pageCounter = 1;
            let customSectionCounter = 0;
            const root = document.documentElement;
            let isAnonymized = false;
            let originalData = {};
            let isRestoringState = false; 
            let activeIconTarget = null;
            
            // --- UI UTILITIES ---
            function showLoader(text = "Chargement...") {
                controls.loaderText.textContent = text;
                controls.loader.classList.remove('hidden');
                controls.loader.classList.add('flex');
            }

            function hideLoader() {
                controls.loader.classList.add('hidden');
                controls.loader.classList.remove('flex');
            }

            function showNotification(message, type = 'success', duration = 3000) {
                const toast = document.createElement('div');
                const icon = type === 'error' ? 'fa-times-circle text-red-500' : 'fa-check-circle text-green-500';
                toast.className = 'toast';
                toast.innerHTML = `<i class="fas ${icon}"></i><span>${message}</span>`;
                document.getElementById('notification').appendChild(toast);
                setTimeout(() => toast.classList.add('show'), 10);
                setTimeout(() => {
                    toast.classList.remove('show');
                    toast.addEventListener('transitionend', () => toast.remove());
                }, duration);
            }
            
            // --- ANIMATIONS IA ---
            function showAIReconstruction(targetElement = null) {
                const cvPreview = targetElement || document.querySelector('.a4-page');
                if (!cvPreview) return;

                // Créer l'overlay d'animation
                const overlay = document.createElement('div');
                overlay.className = 'ai-reconstruction-overlay';
                overlay.style.display = 'flex';
                
                // Messages aléatoires pour l'animation
                const messages = [
                    { main: "🤖 IA en action...", sub: "Optimisation en cours" },
                    { main: "✨ Reconstruction...", sub: "Amélioration du contenu" },
                    { main: "🔧 Personnalisation...", sub: "Adaptation intelligente" },
                    { main: "🎯 Optimisation ATS...", sub: "Maximisation des chances" },
                    { main: "📝 Réécriture...", sub: "Style professionnel" }
                ];
                
                const randomMessage = messages[Math.floor(Math.random() * messages.length)];
                
                overlay.innerHTML = `
                    <div class="ai-reconstruction-content">
                        <div class="ai-reconstruction-icon">🤖</div>
                        <div class="ai-reconstruction-text">${randomMessage.main}</div>
                        <div class="ai-reconstruction-subtext">${randomMessage.sub}</div>
                        <div class="ai-reconstruction-progress">
                            <div class="ai-reconstruction-progress-bar"></div>
                        </div>
                    </div>
                    <div class="ai-particles"></div>
                `;
                
                cvPreview.style.position = 'relative';
                cvPreview.appendChild(overlay);
                
                // Ajouter des particules animées
                createAIParticles(overlay.querySelector('.ai-particles'));
                
                return overlay;
            }
            
            function hideAIReconstruction(overlay) {
                if (overlay && overlay.parentNode) {
                    overlay.style.opacity = '0';
                    overlay.style.transition = 'opacity 0.5s ease-out';
                    setTimeout(() => {
                        if (overlay.parentNode) {
                            overlay.parentNode.removeChild(overlay);
                        }
                    }, 500);
                }
            }
            
            function createAIParticles(container) {
                const particleCount = 15;
                for (let i = 0; i < particleCount; i++) {
                    setTimeout(() => {
                        const particle = document.createElement('div');
                        particle.className = 'ai-particle';
                        particle.style.left = Math.random() * 100 + '%';
                        particle.style.animationDelay = Math.random() * 2 + 's';
                        particle.style.animationDuration = (2 + Math.random() * 2) + 's';
                        container.appendChild(particle);
                        
                        // Supprimer la particule après l'animation
                        setTimeout(() => {
                            if (particle.parentNode) {
                                particle.parentNode.removeChild(particle);
                            }
                        }, 4000);
                    }, i * 100);
                }
            }
            
            function animateAIButton(button) {
                if (!button) return;
                
                button.classList.add('ai-button-loading');
                button.style.pointerEvents = 'none';
                
                return () => {
                    button.classList.remove('ai-button-loading');
                    button.style.pointerEvents = 'auto';
                };
            }
            
            function animateCVRebuild() {
                const cvModules = document.querySelectorAll('.cv-module');
                cvModules.forEach((module, index) => {
                    setTimeout(() => {
                        module.classList.add('ai-rebuilding');
                        setTimeout(() => {
                            module.classList.remove('ai-rebuilding');
                        }, 800);
                    }, index * 100);
                });
            }
            
            // Fonction wrapper pour les appels IA avec animation
            async function callAIWithAnimation(button, asyncFunction, targetElement = null) {
                const overlay = showAIReconstruction(targetElement);
                const resetButton = animateAIButton(button);
                
                try {
                    const result = await asyncFunction();
                    
                    // Animation de reconstruction
                    setTimeout(() => {
                        animateCVRebuild();
                    }, 500);
                    
                    return result;
                } finally {
                    setTimeout(() => {
                        hideAIReconstruction(overlay);
                        resetButton();
                    }, 1500); // Laisser l'animation se terminer
                }
            }

            function showConfirmModal(title, text) {
                return new Promise((resolve) => {
                    controls.confirmModal.title.textContent = title;
                    controls.confirmModal.text.innerHTML = text;
                    controls.confirmModal.overlay.classList.add('active');

                    const cleanup = (result) => {
                        controls.confirmModal.overlay.classList.remove('active');
                        controls.confirmModal.okBtn.onclick = null;
                        controls.confirmModal.cancelBtn.onclick = null;
                        resolve(result);
                    };

                    controls.confirmModal.okBtn.onclick = () => cleanup(true);
                    controls.confirmModal.cancelBtn.onclick = () => cleanup(false);
                });
            }


            // --- HISTORY (UNDO/REDO) SYSTEM ---
            // History is not saved, so this is a simple implementation
            function undo() { showNotification("Fonctionnalité non disponible en mode hors ligne.", "error"); }
            function redo() { showNotification("Fonctionnalité non disponible en mode hors ligne.", "error"); }
            
            // --- DRAG & DROP & RESIZE ---
            let activeResizer = null;
            let activeContainer = null;
            let activeCol1 = null;
            let initialX = 0;
            let initialCol1Width = 0;

            function initResize(e) {
                e.preventDefault();
                activeResizer = e.target;
                activeContainer = activeResizer.parentElement;
                if (!activeContainer) return; // Protection contre les éléments manquants
                
                const columns = activeContainer.querySelectorAll('.cv-column');
                if (columns.length === 0) return; // Protection contre les colonnes manquantes
                
                activeCol1 = columns[0];
                initialX = e.clientX;
                initialCol1Width = activeCol1.offsetWidth;

                document.addEventListener('mousemove', doResize);
                document.addEventListener('mouseup', stopResize);
                document.body.classList.add('is-resizing');
            }

            function doResize(e) {
                if (!activeResizer) return;
                const dx = e.clientX - initialX;
                const newCol1Width = initialCol1Width + dx;
                const containerWidth = activeContainer.offsetWidth;
                
                if (newCol1Width < 50 || newCol1Width > containerWidth - 50) return;

                const newCol1Percent = (newCol1Width / containerWidth) * 100;
                const newCol2Percent = 100 - newCol1Percent;

                activeContainer.classList.remove('layout-2-col-33-67', 'layout-2-col-50-50', 'layout-2-col-67-33');
                activeContainer.style.gridTemplateColumns = `${newCol1Percent}% ${newCol2Percent}%`;
                activeResizer.style.left = `${newCol1Percent}%`;
            }

            function stopResize() {
                document.removeEventListener('mousemove', doResize);
                document.removeEventListener('mouseup', stopResize);
                document.body.classList.remove('is-resizing');
                activeResizer = null;
                activeContainer = null;
                activeCol1 = null;
            }

            function setupAllResizers() {
                document.querySelectorAll('.a4-page').forEach(page => {
                    const container = page.querySelector('.cv-body-container');
                    if (!container) return; // Protection contre les éléments manquants
                    
                    const oldResizer = container.querySelector('.column-resizer');
                    if (oldResizer) oldResizer.remove();

                    const columns = container.querySelectorAll('.cv-column');
                    if (columns.length === 2 && getComputedStyle(container).gridTemplateColumns.split(' ').length === 2) {
                        const resizer = document.createElement('div');
                        resizer.className = 'column-resizer';
                        container.appendChild(resizer);
                        const col1 = columns[0];
                        const col1WidthPercent = parseFloat(getComputedStyle(col1).width) / parseFloat(getComputedStyle(container).width) * 100;
                        resizer.style.left = col1WidthPercent + '%';
                        resizer.addEventListener('mousedown', initResize);
                    }
                });
            }

            function initializeSortableForPage(pageId) {
                const col1 = document.getElementById(`cv-col-${pageId}-1`);
                const col2 = document.getElementById(`cv-col-${pageId}-2`);
                const onEnd = () => { checkAllPagesOverflow(); };
                
                // Destroy existing Sortable instances to avoid conflicts
                if (col1 && col1.sortable) {
                    col1.sortable.destroy();
                }
                if (col2 && col2.sortable) {
                    col2.sortable.destroy();
                }
                
                // Create new Sortable instances
                if (col1) {
                    col1.sortable = new Sortable(col1, { 
                        group: 'cv-modules', 
                        animation: 150, 
                        handle: '.drag-handle', 
                        ghostClass: 'sortable-ghost', 
                        onEnd 
                    });
                }
                if (col2) {
                    col2.sortable = new Sortable(col2, { 
                        group: 'cv-modules', 
                        animation: 150, 
                        handle: '.drag-handle', 
                        ghostClass: 'sortable-ghost', 
                        onEnd 
                    });
                }
            }

            function initializeAllSortable() {
                // Initialize drag and drop for all existing pages
                const pages = document.querySelectorAll('.a4-page');
                if (!pages || pages.length === 0) return; // Protection contre les éléments manquants
                
                pages.forEach((page) => {
                    const pageId = page.id.replace('page-', '');
                    if (pageId) {
                        initializeSortableForPage(pageId);
                    } else {
                        // For the first page that might not have an ID
                        initializeSortableForPage(1);
                    }
                });
            }

            function initializeSkillSorting() {
                const skillLists = document.querySelectorAll('#cv-competences-preview ul');
                if (!skillLists || skillLists.length === 0) return; // Protection contre les éléments manquants
                
                skillLists.forEach(list => {
                    new Sortable(list, {
                        group: 'skills', animation: 150, ghostClass: 'skills-ghost',
                        onEnd: function () {
                            syncFormFromPreview(document.getElementById('cv-competences-preview'));
                        }
                    });
                });
            }

            // --- PAGE & OVERFLOW MANAGEMENT ---
            function checkPageOverflow(page) {
                requestAnimationFrame(() => {
                    // Using a 1px tolerance for floating point inaccuracies
                    const isOverflowing = page.scrollHeight > page.clientHeight + 1;
                    page.classList.toggle('is-overflowing', isOverflowing);
                });
            }

            function checkAllPagesOverflow() {
                const pages = document.querySelectorAll('.a4-page');
                if (!pages || pages.length === 0) return; // Protection contre les éléments manquants
                
                pages.forEach(checkPageOverflow);
            }

            function setupOverflowObserver(pageElement) {
                const observer = new ResizeObserver(() => {
                    checkPageOverflow(pageElement);
                });
                // Observe the page element itself and its direct content container
                observer.observe(pageElement);
                const bodyContainer = pageElement.querySelector('.cv-body-container');
                if (bodyContainer) {
                    observer.observe(bodyContainer);
                }
            }
            
            function addNewPage() {
                pageCounter++;
                const newPageContainer = document.createElement('div');
                newPageContainer.className = 'a4-page-container';
                const layoutClass = document.querySelector('.layout-btn.active')?.dataset.layout || 'layout-1-col';
                
                newPageContainer.innerHTML = `
                    <div id="page-${pageCounter}" class="a4-page">
                        <div class="cv-body-container ${layoutClass}">
                            <div id="cv-col-${pageCounter}-1" class="cv-column"></div>
                            <div id="cv-col-${pageCounter}-2" class="cv-column"></div>
                        </div>
                    </div>
                    <button class="remove-page-btn no-print"><i class="fas fa-trash-can"></i></button>
                `;
                
                const addBtnWrapper = document.getElementById('add-page-btn-wrapper');
                preview.previewWrapper.insertBefore(newPageContainer, addBtnWrapper);
                
                const newPageElement = document.getElementById(`page-${pageCounter}`);
                setupOverflowObserver(newPageElement);

                initializeSortableForPage(pageCounter);
                setupAllResizers();
                checkAllPagesOverflow();
            }


            // --- DYNAMIC CONTENT ---
            function createDynamicItem(container, fields, data = {}, index = -1) {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'p-2 border rounded-md bg-white relative';
                
                fields.forEach(field => {
                    const isTextarea = field.type === 'textarea';
                    const input = document.createElement(isTextarea ? 'textarea' : 'input');
                    
                    if (!isTextarea) input.type = 'text';
                    
                    input.placeholder = field.placeholder;
                    input.className = `cv-input w-full p-1 border rounded-sm mb-1 data-${field.key}`;
                    if(isTextarea) input.rows = 3;
                    input.value = data[field.key] || '';
                    itemDiv.appendChild(input);
                });

                const removeBtn = document.createElement('button');
                removeBtn.innerHTML = '<i class="fas fa-times-circle text-red-400 hover:text-red-600"></i>';
                removeBtn.className = 'absolute top-1 right-1 remove-dynamic-item-btn';
                itemDiv.appendChild(removeBtn);
                
                if (index !== -1 && index < container.children.length) {
                    container.insertBefore(itemDiv, container.children[index]);
                } else {
                    container.appendChild(itemDiv);
                }
                
                updatePreview('form');
                const firstInput = itemDiv.querySelector('input, textarea');
                if (firstInput) firstInput.focus();
            }

            function getDynamicData(container) {
                return Array.from(container.children).map(itemDiv => ({
                    title: itemDiv.querySelector('.data-title')?.value || '',
                    meta: itemDiv.querySelector('.data-meta')?.value || '',
                    desc: itemDiv.querySelector('.data-desc')?.value || '',
                }));
            }
            
            // --- SKILLS RENDERING ---
            function renderSkillsAsTags(text) {
                let html = '';
                const sections = text.split('\n').filter(Boolean);
                sections.forEach(section => {
                    const parts = section.split(':');
                    if (parts.length === 2 && parts[0].trim() !== '') {
                        html += `<h3 class="skill-category" contenteditable="true">${parts[0].trim()}</h3>`;
                        html += `<ul>${parts[1].split(',').map(item => item.trim().replace(/\s*\(.*\)/, '')).filter(Boolean).map(item => `<li class="skill-item" contenteditable="false">${item}<span class="delete-skill-btn">&times;</span></li>`).join('')}</ul>`;
                    } else {
                        html += `<ul>${section.split(',').map(item => item.trim().replace(/\s*\(.*\)/, '')).filter(Boolean).map(item => `<li class="skill-item" contenteditable="false">${item}<span class="delete-skill-btn">&times;</span></li>`).join('')}</ul>`;
                    }
                });
                return html;
            }

            function renderSkillsAsLevels() {
                let html = '';
                const gaugeStyle = document.querySelector('.gauge-style-btn.active')?.dataset.gaugeStyle || 'bar';
                const skillItems = controls.skillsLevelList.querySelectorAll('.skill-level-item');

                skillItems.forEach(item => {
                    const name = item.querySelector('.skill-name-input').value;
                    const level = item.querySelector('.skill-level-input').value;
                    if (!name) return;

                    html += `<div class="skill-level">
                                        <div class="skill-level-label" contenteditable="true">${name}</div>
                                        <div class="gauge-container">${renderGauge(level, gaugeStyle)}</div>
                                    </div>`;
                });
                return html;
            }
            
            function renderGauge(level, style) {
                const max = 5;
                let gaugeHtml = '';
                switch (style) {
                    case 'dots':
                        gaugeHtml = `<div class="gauge-dots">`;
                        for (let i = 1; i <= max; i++) gaugeHtml += `<span class="${i <= level ? 'filled' : ''}">●</span>`;
                        gaugeHtml += `</div>`;
                        break;
                    case 'stars':
                        gaugeHtml = `<div class="gauge-stars">`;
                        for (let i = 1; i <= max; i++) gaugeHtml += `<i class="${i <= level ? 'fas' : 'far'} fa-star ${i <= level ? 'filled' : ''}"></i>`;
                        gaugeHtml += `</div>`;
                        break;
                    case 'squares':
                         gaugeHtml = `<div class="gauge-squares">`;
                        for (let i = 1; i <= max; i++) gaugeHtml += `<span class="${i <= level ? 'filled' : ''}">■</span>`;
                        gaugeHtml += `</div>`;
                        break;
                    case 'number':
                        gaugeHtml = `<div class="gauge-number">${level}/${max}</div>`;
                        break;
                    case 'bar':
                    default:
                        const width = (level / max) * 100;
                        gaugeHtml = `<div class="gauge-bar-bg"><div class="gauge-bar-fill" style="width: ${width}%;"></div></div>`;
                        break;
                }
                return gaugeHtml;
            }

            function renderSkillsAsSimple(text) {
                let html = '<ul>';
                const skills = text.split(/,|\n/).map(s => s.trim().replace(/\s*\(.*\)/, '')).filter(Boolean);
                skills.forEach(skill => {
                    html += `<li>${skill}</li>`;
                });
                html += '</ul>';
                return html;
            }

            function createSkillLevelItem(name = '', level = 3) {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'skill-level-item flex items-center gap-2';
                itemDiv.innerHTML = `
                    <input type="text" placeholder="Compétence" value="${name}" class="skill-name-input cv-input flex-grow p-1 border rounded-sm">
                    <input type="range" value="${level}" min="1" max="5" class="skill-level-input w-24">
                    <span class="skill-level-value text-sm font-mono">${level}/5</span>
                    <button class="remove-skill-level-btn text-red-400 hover:text-red-600"><i class="fas fa-times-circle"></i></button>
                `;
                controls.skillsLevelList.appendChild(itemDiv);
                updatePreview('form');
            }

            // --- UPDATES & FORMATTING ---
            function updateBannerBackground() {
                const opacity = controls.bannerBgOpacity.value;
                const blur = controls.bannerBgBlur.value;
                const grayscale = controls.bannerBgGrayscale.checked;

                controls.bannerBgOpacityValue.textContent = opacity;
                controls.bannerBgBlurValue.textContent = blur;

                preview.bannerBgImg.style.opacity = opacity;
                preview.bannerBgImg.style.filter = `blur(${blur}px) grayscale(${grayscale ? 1 : 0})`;
            }

            function updatePreview(source = 'form') {
                // Réinitialiser les sélecteurs si nécessaire
                if (!preview.cvNomPrenom || !preview.cvPoste || !preview.cvDescription) {
                    reinitializePreviewSelectors();
                }
                
                if (source === 'form' || source === 'banner-style' || source === 'theme' || source === 'state') {
                    // Vérification de sécurité pour chaque élément
                    if (preview.cvNomPrenom) {
                        preview.cvNomPrenom.textContent = `${controls.prenom.value} ${controls.nom.value}`.trim() || 'Prénom NOM';
                    }
                    if (preview.cvPoste) {
                        preview.cvPoste.textContent = controls.poste.value || 'Poste Recherché';
                    }
                    if (preview.cvDescription) {
                        preview.cvDescription.innerHTML = `<div class="editable-wrapper"><p contenteditable="true">${controls.description.value.replace(/\n/g, '<br>') || '&nbsp;'}</p><span class="delete-line-btn"><i class="fas fa-times"></i></span></div>`;
                    }
                    
                    const renderDynamicList = (previewContainer, controlContainer, type) => {
                        previewContainer.innerHTML = '';
                        const data = getDynamicData(controlContainer);

                        const createInsertButton = (type, index) => {
                            const wrapper = document.createElement('div');
                            wrapper.className = 'insert-line-wrapper';
                            wrapper.innerHTML = `<button class="add-line-preview-btn" data-type="${type}" data-index="${index}" title="Insérer un nouveau bloc ici"><i class="fas fa-plus"></i></button>`;
                            return wrapper;
                        };

                        const createItemContainer = (item, i) => {
                            const itemContainer = document.createElement('div');
                            itemContainer.className = 'dynamic-item-container';
                            itemContainer.dataset.index = i;
                            itemContainer.dataset.type = type;

                            const itemContent = document.createElement('div');
                            itemContent.className = "dynamic-preview-item";
                            itemContent.innerHTML = `<button class="delete-block-btn" title="Supprimer le bloc"><i class="fas fa-trash-alt"></i></button>`;

                            if (type === 'experience') {
                                const titleHTML = `<div class="editable-wrapper"><p class="item-title" contenteditable="true">${item.title || '&nbsp;'}</p><span class="delete-line-btn"><i class="fas fa-times"></i></span></div>`;
                                const metaHTML = `<div class="editable-wrapper"><p class="item-meta" contenteditable="true">${item.meta || '&nbsp;'}</p><span class="delete-line-btn"><i class="fas fa-times"></i></span></div>`;
                                const descHTML = `<div class="editable-wrapper"><p class="mt-1" contenteditable="true">${item.desc.replace(/\n/g, '<br>') || '&nbsp;'}</p><span class="delete-line-btn"><i class="fas fa-times"></i></span></div>`;
                                const addButtonHTML = `<button class="add-desc-line-btn"><i class="fas fa-plus mr-1"></i> Ajouter une mission</button>`;
                                itemContent.innerHTML += `${titleHTML}${metaHTML}${descHTML}${addButtonHTML}`;
                            } else { // formation
                                const titleHTML = `<div class="editable-wrapper"><p class="item-title" contenteditable="true">${item.title || '&nbsp;'}</p><span class="delete-line-btn"><i class="fas fa-times"></i></span></div>`;
                                const metaHTML = `<div class="editable-wrapper"><p class="item-meta" contenteditable="true">${item.meta || '&nbsp;'}</p><span class="delete-line-btn"><i class="fas fa-times"></i></span></div>`;
                                itemContent.innerHTML += `${titleHTML}${metaHTML}`;
                            }
                            
                            itemContainer.appendChild(createInsertButton(type, i));
                            itemContainer.appendChild(itemContent);
                            return itemContainer;
                        };
                        
                        data.forEach((item, i) => {
                            previewContainer.appendChild(createItemContainer(item, i));
                        });
                        const finalButtonWrapper = document.createElement('div');
                        finalButtonWrapper.className = 'dynamic-item-container';
                        finalButtonWrapper.appendChild(createInsertButton(type, data.length));
                        previewContainer.appendChild(finalButtonWrapper);
                    };

                    // Vérifications de sécurité pour les éléments de preview
                    if (preview.cvExperience) {
                        renderDynamicList(preview.cvExperience, controls.experienceList, 'experience');
                    }
                    if (preview.cvFormation) {
                        renderDynamicList(preview.cvFormation, controls.formationList, 'formation');
                    }

                    const skillStyle = document.querySelector('.skill-style-btn.active')?.dataset.skillStyle || 'tags';
                    if (preview.cvCompetences) {
                        preview.cvCompetences.dataset.style = skillStyle;
                        
                        if (skillStyle === 'tags') {
                            preview.cvCompetences.innerHTML = renderSkillsAsTags(controls.competences.value);
                            initializeSkillSorting(); 
                        } else if (skillStyle === 'levels') {
                            preview.cvCompetences.innerHTML = renderSkillsAsLevels();
                        } else { // simple
                            preview.cvCompetences.innerHTML = renderSkillsAsSimple(controls.competences.value);
                        }
                    }

                    document.querySelectorAll('.custom-module-preview').forEach(m => m.remove());
                    const hasCustomSections = controls.customSectionsList.children.length > 0;
                    Array.from(controls.customSectionsList.children).forEach(div => {
                        const sectionId = div.dataset.sectionId;
                        const title = div.querySelector('input').value;
                        const content = div.querySelector('textarea').value;
                        const iconClass = div.dataset.icon || 'fas fa-puzzle-piece';
                        
                        const moduleDiv = document.createElement('div');
                        moduleDiv.id = sectionId;
                        moduleDiv.className = 'cv-module custom-module-preview'; 
                        moduleDiv.innerHTML = `
                            <div class="drag-handle"><i class="fas fa-grip-vertical"></i></div>
                            <h2 class="section-title" data-section-id="${sectionId}"><i class="${iconClass} section-icon"></i><span contenteditable="true">${title}</span><div class="section-ai-actions"><button class="ai-action-btn toggle-visibility-btn" title="Masquer/Afficher la section"><i class="fas fa-eye"></i></button></div></h2>
                            <div class="dynamic-preview-item">
                                <button class="delete-block-btn" title="Supprimer la section"><i class="fas fa-trash-alt"></i></button>
                                <div class="editable-wrapper">
                                    <div class="custom-content" contenteditable="true">${content.replace(/\n/g, '<br>') || '&nbsp;'}</div>
                                    <span class="delete-line-btn"><i class="fas fa-times"></i></span>
                                </div>
                            </div>
                        `;
                        const lastModule = document.querySelector('#competences-module');
                        if(lastModule && lastModule.parentElement) {
                            lastModule.parentElement.insertBefore(moduleDiv, lastModule.nextSibling);
                        }
                    });
                    
                    // Reinitialize drag and drop after adding custom modules
                    if (hasCustomSections || document.querySelectorAll('.custom-module-preview').length > 0) {
                        setTimeout(() => initializeAllSortable(), 100);
                    }
                    
                    preview.bannerNom.textContent = controls.bannerNom.value || "Nom Prénom Recruteur";
                    preview.bannerPoste.textContent = controls.bannerPoste.value || "Poste du Recruteur";
                    preview.bannerEmail.textContent = controls.bannerEmail.value || "email@recruteur.com";
                    preview.bannerTel.textContent = controls.bannerTel.value || "01 23 45 67 89";
                }

                preview.bannerNom.style.fontFamily = controls.bannerNomFont.value;
                preview.bannerNom.style.fontSize = controls.bannerNomSize.value + 'pt';
                preview.bannerNom.style.color = controls.bannerNomColor.value;
                preview.bannerNom.style.fontWeight = controls.bannerNomBold.classList.contains('active') ? 'bold' : 'normal';
                preview.bannerNom.style.fontStyle = controls.bannerNomItalic.classList.contains('active') ? 'italic' : 'normal';
                
                preview.bannerPoste.style.fontSize = controls.bannerPosteSize.value + 'pt';
                preview.bannerPoste.style.color = controls.bannerPosteColor.value;
                preview.bannerPoste.style.fontWeight = controls.bannerPosteBold.classList.contains('active') ? 'bold' : 'normal';
                preview.bannerPoste.style.fontStyle = controls.bannerPosteItalic.classList.contains('active') ? 'italic' : 'normal';

                preview.bannerContact.style.fontSize = controls.bannerContactSize.value + 'pt';
                preview.bannerContact.style.color = controls.bannerContactColor.value;
                preview.bannerContact.style.fontWeight = controls.bannerContactBold.classList.contains('active') ? 'bold' : 'normal';
                preview.bannerContact.style.fontStyle = controls.bannerContactItalic.classList.contains('active') ? 'italic' : 'normal';
                
                const dispo = controls.qualificationDispo.value;
                const salaire = controls.qualificationSalaire.value;
                const loc = controls.qualificationLoc.value;
                let qualHTML = '';
                if (dispo) qualHTML += `<div><i class="fas fa-calendar-check mr-1 text-gray-400"></i> ${dispo}</div>`;
                if (salaire) qualHTML += `<div><i class="fas fa-euro-sign mr-1 text-gray-400"></i> ${salaire}</div>`;
                if (loc) qualHTML += `<div><i class="fas fa-map-marker-alt mr-1 text-gray-400"></i> ${loc}</div>`;
                preview.qualificationPreview.innerHTML = qualHTML;
                preview.qualificationModule.style.display = (dispo || salaire || loc) ? '' : 'none';

                const isBannerEnabled = controls.toggleBanner.checked;
                const isBannerInTop = preview.fixedBannerTop.contains(preview.banner);
                const isBannerInBottom = preview.fixedBannerBottom.contains(preview.banner);
                const isBannerInModule = preview.bannerModule.contains(preview.banner);
                
                // Cacher/afficher la bannière selon l'état de la checkbox
                preview.banner.style.display = isBannerEnabled ? 'flex' : 'none';
                
                preview.bannerModule.classList.toggle('hidden', !isBannerEnabled || !isBannerInModule);
                preview.fixedBannerTop.style.display = (isBannerEnabled && isBannerInTop) ? 'block' : 'none';
                preview.fixedBannerBottom.style.display = (isBannerEnabled && isBannerInBottom) ? 'block' : 'none';

                checkAllPagesOverflow();
            }
            
            function syncFormFromPreview(element) {
                if (!element) return;
                const id = element.id;

                if (id === 'cv-competences-preview') {
                    const style = preview.cvCompetences.dataset.style;
                    if (style === 'levels') {
                        const skillLabels = preview.cvCompetences.querySelectorAll('.skill-level-label');
                        const controlInputs = controls.skillsLevelList.querySelectorAll('.skill-name-input');
                        skillLabels.forEach((label, index) => {
                            if (controlInputs[index]) {
                                controlInputs[index].value = label.textContent;
                            }
                        });
                    } else { 
                        let result = [];
                        const nodes = Array.from(element.childNodes);
                        for (let i = 0; i < nodes.length; i++) {
                            const node = nodes[i];
                            if (node.nodeName === 'H3' && node.classList.contains('skill-category')) {
                                const categoryName = node.textContent.trim();
                                const nextNode = nodes[i + 1];
                                if (nextNode && nextNode.nodeName === 'UL') {
                                    const skills = Array.from(nextNode.querySelectorAll('li.skill-item')).map(li => li.textContent.replace('×', '').trim()).filter(Boolean).join(', ');
                                    if (categoryName && skills) {
                                        result.push(`${categoryName}: ${skills}`);
                                    }
                                    i++; 
                                }
                            } else if (node.nodeName === 'UL') {
                                const skills = Array.from(node.querySelectorAll('li')).map(li => li.textContent.replace('×', '').trim()).filter(Boolean).join(', ');
                                if (skills) {
                                    result.push(skills);
                                }
                            }
                        }
                        controls.competences.value = result.join('\n');
                    }
                    return;
                }
                
                let text = element.innerHTML.replace(/<br\s*\/?>/gi, '\n').trim();
                text = new DOMParser().parseFromString(text, "text/html").documentElement.textContent;

                if (id) {
                    switch (id) {
                        case 'cv-nom-prenom-preview': const nameParts = text.trim().split(' '); controls.prenom.value = nameParts.shift() || ''; controls.nom.value = nameParts.join(' ') || ''; break;
                        case 'cv-poste-preview': controls.poste.value = text; break;
                        case 'cv-description-preview': controls.description.value = text; break;
                        case 'banner-nom-preview': controls.bannerNom.value = text; break;
                        case 'banner-poste-preview': controls.bannerPoste.value = text; break;
                        case 'banner-email-preview': controls.bannerEmail.value = text; break;
                        case 'banner-tel-preview': controls.bannerTel.value = text; break;
                    }
                } else {
                    const itemContainer = element.closest('.dynamic-item-container');
                    if (itemContainer) {
                        const index = parseInt(itemContainer.dataset.index, 10);
                        const type = itemContainer.dataset.type;
                        const formList = type === 'experience' ? controls.experienceList : controls.formationList;
                        const formItem = formList.children[index];
                        if (!formItem) return;

                        const title = itemContainer.querySelector('.item-title')?.textContent || '';
                        const meta = itemContainer.querySelector('.item-meta')?.textContent || '';
                        const descEl = itemContainer.querySelector('.mt-1');
                        const desc = descEl ? new DOMParser().parseFromString(descEl.innerHTML.replace(/<br\s*\/?>/gi, '\n'), "text/html").documentElement.textContent : '';

                        if (formItem.querySelector('.data-title')) formItem.querySelector('.data-title').value = title;
                        if (formItem.querySelector('.data-meta')) formItem.querySelector('.data-meta').value = meta;
                        if (formItem.querySelector('.data-desc')) formItem.querySelector('.data-desc').value = desc;

                    } else {
                        const customModule = element.closest('.custom-module-preview');
                        if (customModule) {
                            const sectionId = customModule.id;
                            const controlTitleInput = document.getElementById(`custom-section-title-${sectionId}`);
                            const controlContentTextarea = document.getElementById(`custom-section-content-${sectionId}`);
                            
                            if (element.matches('[contenteditable].section-title span')) {
                               if (controlTitleInput) controlTitleInput.value = element.textContent;
                            }
                            if (element.matches('[contenteditable].custom-content')) {
                               if (controlContentTextarea) controlContentTextarea.value = text;
                            }
                        }
                    }
                }
            }

            function moveBannerTo(destination) {
                const recruiterBanner = preview.banner;
                if (destination === 'top') {
                    preview.fixedBannerTop.appendChild(recruiterBanner);
                } else if (destination === 'bottom') {
                    preview.fixedBannerBottom.appendChild(recruiterBanner);
                } else { // 'modular'
                    preview.bannerModule.querySelector('.drag-handle').insertAdjacentElement('afterend', recruiterBanner);
                }
                const isModular = (destination === 'modular');
                document.getElementById('banner-fix-controls').classList.toggle('hidden', !isModular);
                controls.modularBannerBtn.classList.toggle('hidden', isModular);
                updatePreview('banner-move');
            }

            function addCustomSection(title = 'Nouvelle Section', content = '', id = null, icon = 'fas fa-puzzle-piece') {
                customSectionCounter++;
                const sectionId = id || `custom-module-${Date.now()}-${customSectionCounter}`;
                
                const controlDiv = document.createElement('div');
                controlDiv.className = 'p-2 border rounded-md bg-white relative';
                controlDiv.dataset.sectionId = sectionId;
                controlDiv.dataset.icon = icon;
                controlDiv.innerHTML = `
                    <input type="text" value="${title}" class="w-full p-1 border rounded-sm mb-1 font-semibold custom-section-input" id="custom-section-title-${sectionId}">
                    <textarea rows="4" class="w-full p-1 border rounded-sm mb-1 custom-section-input" id="custom-section-content-${sectionId}" placeholder="Contenu...">${content}</textarea>
                    <button class="absolute top-1 right-1 text-red-400 hover:text-red-600 remove-section-btn"><i class="fas fa-times-circle"></i></button>
                `;
                controls.customSectionsList.appendChild(controlDiv);
                
                updatePreview('form');
                updateAllStyles();
            }

            async function callGeminiAPI(prompt, schema) {
                showLoader("L'IA réfléchit...");
                try {
                    const apiKey = localStorage.getItem('gemini-api-key') || "";
                    if (!apiKey) {
                        throw new Error("Clé API Gemini non configurée. Veuillez saisir votre clé API dans les paramètres.");
                    }
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                    
                    const payload = {
                        contents: [{ role: "user", parts: [{ text: prompt }] }],
                        generationConfig: schema ? { responseMimeType: "application/json", responseSchema: schema } : {}
                    };

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorBody = await response.text();
                        throw new Error(`Erreur API: ${response.status} ${response.statusText} - ${errorBody}`);
                    }

                    const result = await response.json();
                    
                    if (result.candidates && result.candidates.length > 0) {
                         if (result.candidates[0].finishReason !== "STOP" && result.candidates[0].finishReason !== "MAX_TOKENS") {
                               throw new Error(`L'IA a été bloquée (raison: ${result.candidates[0].finishReason}). Veuillez reformuler votre demande.`);
                         }
                        if (result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                            const text = result.candidates[0].content.parts[0].text;
                            return schema ? JSON.parse(text) : text;
                        }
                    }
                    
                    throw new Error("Réponse invalide ou vide reçue de l'IA.");

                } catch (error) {
                    console.error("Erreur détaillée de l'IA:", error);
                    showNotification(`Erreur de l'IA : ${error.message}`, 'error', 5000);
                    return null;
                } finally {
                    hideLoader();
                }
            }

            // Rendre la fonction globalement accessible
            window.callGeminiAPI = callGeminiAPI;
            window.updatePreview = updatePreview;
            window.updatePreviewStyles = updatePreviewStyles;
            window.createDynamicItem = createDynamicItem;
            window.showNotification = showNotification;
            
            function updateAllStyles() {
                root.style.setProperty('--primary-color', controls.primaryColorPicker.value);
                root.style.setProperty('--secondary-color', controls.secondaryColorPicker.value);
                root.style.setProperty('--body-text-color', controls.bodyTextColorPicker.value);
                root.style.setProperty('--font-family-h1', controls.fontFamilyH1Select.value);
                root.style.setProperty('--font-family-h2', controls.fontFamilyH2Select.value);
                root.style.setProperty('--font-family-body', controls.fontFamilyBodySelect.value);

                const activeStyle = document.querySelector('.section-title-style-btn.active')?.dataset.titleStyle || 'style-underline';
                document.querySelectorAll('.section-title').forEach(title => {
                    title.classList.remove('style-underline', 'style-side-line', 'style-background', 'style-boxed');
                    title.classList.add(activeStyle);
                });
                
                const banner = preview.banner;
                const newBannerStyle = controls.bannerStyleSelect.value;
                const newAlign = document.querySelector('.banner-align-btn.active')?.dataset.bannerAlign || 'left';
                const isInverted = controls.bannerInvertBtn.classList.contains('active');

                const classesToRemove = Array.from(banner.classList).filter(c => c.startsWith('banner-style-'));
                if (classesToRemove.length > 0) banner.classList.remove(...classesToRemove);

                if (newBannerStyle) banner.classList.add(newBannerStyle);
                
                const contentWrapper = banner.querySelector('.banner-content-wrapper');
                contentWrapper.className = 'banner-content-wrapper'; // Reset classes
                contentWrapper.classList.add(`banner-align-${newAlign}`);
                if (isInverted) contentWrapper.classList.add('banner-layout-inverted');
                
                checkAllPagesOverflow();
            }

            // Rendre updateAllStyles globalement accessible
            window.updateAllStyles = updateAllStyles;
            
            function updatePreviewStyles(source = 'form') {
                updateAllStyles();
            }

            function populateFontSelectors() {
                const fonts = [
                    { name: 'Lato', value: "'Lato', sans-serif" },
                    { name: 'Montserrat', value: "'Montserrat', sans-serif" },
                    { name: 'Roboto Mono', value: "'Roboto Mono', monospace" },
                    { name: 'Playfair Display', value: "'Playfair Display', serif" },
                    { name: 'Merriweather', value: "'Merriweather', serif" },
                    { name: 'Oswald', value: "'Oswald', sans-serif" },
                    { name: 'Open Sans', value: "'Open Sans', sans-serif" },
                    { name: 'Source Sans Pro', value: "'Source Sans Pro', sans-serif" },
                    { name: 'Nunito Sans', value: "'Nunito Sans', sans-serif" },
                    { name: 'Cormorant Garamond', value: "'Cormorant Garamond', serif" },
                ];
                const selects = [controls.fontFamilyH1Select, controls.fontFamilyH2Select, controls.fontFamilyBodySelect, controls.bannerNomFont];
                selects.forEach(select => {
                    if (!select) return;
                    select.innerHTML = '';
                    fonts.forEach(font => {
                        const option = document.createElement('option');
                        option.value = font.value;
                        option.textContent = font.name;
                        select.appendChild(option);
                    });
                });
            }
            
            // Alias for backward compatibility
            function populateFontSelects() {
                return populateFontSelectors();
            }
            
            function populateIconPicker() {
                const icons = ["fa-user-circle", "fa-briefcase", "fa-graduation-cap", "fa-star", "fa-puzzle-piece", "fa-globe", "fa-paint-brush", "fa-certificate", "fa-lightbulb", "fa-heart", "fa-cogs", "fa-code", "fa-chart-line", "fa-comments", "fa-bullhorn", "fa-trophy", "fa-book", "fa-wrench", "fa-users", "fa-award", "fa-phone", "fa-envelope", "fa-map-marker-alt", "fa-linkedin", "fa-github"];
                controls.iconPickerGrid.innerHTML = '';
                icons.forEach(iconClass => {
                    const iconEl = document.createElement('i');
                    iconEl.className = `fas ${iconClass}`;
                    iconEl.dataset.icon = `fas ${iconClass}`;
                    controls.iconPickerGrid.appendChild(iconEl);
                });
            }

            function resetCVToDefault() {
                document.querySelectorAll('.cv-input, .banner-input, .custom-section-input').forEach(input => {
                    if(input.type === 'checkbox') input.checked = false;
                    else if (input.type !== 'range' && input.type !== 'color') input.value = '';
                });
                
                controls.experienceList.innerHTML = '';
                controls.formationList.innerHTML = '';
                controls.customSectionsList.innerHTML = '';
                controls.skillsLevelList.innerHTML = '';
                
                document.querySelectorAll('.custom-module-preview').forEach(m => m.remove());
                
                setDefaultRecruiterInfo();
                applyTheme('professional');
                document.querySelector('.layout-btn[data-layout="layout-1-col"]')?.click();
                document.querySelector('.skill-style-btn[data-skill-style="tags"]')?.click();
                
                Object.values(sliders).forEach(config => {
                    const defaultValue = config.el.defaultValue;
                    config.el.value = defaultValue;
                    config.valueEl.textContent = defaultValue;
                    root.style.setProperty(config.property, `${defaultValue}${config.unit}`);
                });
                
                moveBannerTo('modular');
                removeBannerBackground();

                document.querySelectorAll('.completion-checkbox').forEach(cb => {
                    cb.checked = false;
                    cb.closest('details').open = true;
                });
                updateProgressBar();
                
                updatePreview('form');
                updateAllStyles();
                showNotification("Le CV a été réinitialisé.", "success");
            }

            // --- API KEY MANAGEMENT ---
            function loadApiKey() {
                const savedApiKey = localStorage.getItem('gemini-api-key');
                if (savedApiKey) {
                    controls.apiKeyInput.value = savedApiKey;
                    controls.apiKeyStatus.textContent = 'Clé API configurée';
                    controls.apiKeyStatus.classList.remove('text-red-500', 'text-yellow-600');
                    controls.apiKeyStatus.classList.add('text-green-600');
                } else {
                    controls.apiKeyStatus.textContent = 'Clé API manquante';
                    controls.apiKeyStatus.classList.remove('text-green-600', 'text-yellow-600');
                    controls.apiKeyStatus.classList.add('text-red-500');
                }
            }

            function saveApiKey() {
                const apiKey = controls.apiKeyInput.value.trim();
                if (apiKey) {
                    localStorage.setItem('gemini-api-key', apiKey);
                    controls.apiKeyStatus.textContent = 'Clé API sauvegardée';
                    controls.apiKeyStatus.classList.remove('text-red-500', 'text-yellow-600');
                    controls.apiKeyStatus.classList.add('text-green-600');
                    return true;
                } else {
                    controls.apiKeyStatus.textContent = 'Clé API vide';
                    controls.apiKeyStatus.classList.remove('text-green-600', 'text-yellow-600');
                    controls.apiKeyStatus.classList.add('text-red-500');
                    return false;
                }
            }

            function toggleApiKeyVisibility() {
                const input = controls.apiKeyInput;
                const icon = controls.toggleApiKeyVisibilityBtn.querySelector('i');
                
                if (input.type === 'password') {
                    input.type = 'text';
                    icon.classList.remove('fa-eye');
                    icon.classList.add('fa-eye-slash');
                } else {
                    input.type = 'password';
                    icon.classList.remove('fa-eye-slash');
                    icon.classList.add('fa-eye');
                }
            }

            // --- INITIALIZATION ---
            
            // Load API key on startup
            loadApiKey();
            
            function setDefaultRecruiterInfo() {
                controls.bannerNom.value = "Lyes AMARA";
                controls.bannerPoste.value = "Responsable d'activité recrutement – BTP – France";
                controls.bannerEmail.value = "l.amara@ltd-international.com";
                controls.bannerTel.value = "01 56 02 12 25 / 06 34 25 32 96";
            }

            function anonymizeCV() {
                if (isAnonymized) {
                    // Restoration mode
                    controls.nom.value = originalData.nom || '';
                    controls.prenom.value = originalData.prenom || '';
                    controls.bannerEmail.value = originalData.bannerEmail || '';
                    controls.bannerTel.value = originalData.bannerTel || '';
                    controls.qualificationLoc.value = originalData.qualificationLoc || '';
                    
                    // Update only icon and tooltip for icon-only button
                    controls.anonymizeBtn.innerHTML = '<i class="fa-solid fa-user-secret text-lg"></i>';
                    controls.anonymizeBtn.setAttribute('data-tooltip', '🕵️ Masquer vos informations personnelles pour créer une version anonyme de votre CV');
                    isAnonymized = false;
                    showNotification("CV désanonymisé avec succès !", "success");
                } else {
                    // Anonymization mode - store original data
                    originalData = {
                        nom: controls.nom.value || '',
                        prenom: controls.prenom.value || '',
                        bannerEmail: controls.bannerEmail.value || '',
                        bannerTel: controls.bannerTel.value || '',
                        qualificationLoc: controls.qualificationLoc.value || ''
                    };
                    
                    // Apply anonymization rules
                    // Last name: Keep only first letter + dot
                    const firstLetter = originalData.nom ? originalData.nom.charAt(0) + '.' : '';
                    controls.nom.value = firstLetter;
                    
                    // First name: Keep as-is (no change)
                    // controls.prenom.value remains unchanged
                    
                    // Email: Anonymize to "***@.***"
                    if (originalData.bannerEmail) {
                        controls.bannerEmail.value = "***@.***";
                    }
                    
                    // Phone: Anonymize to "** ** ** ** **"
                    if (originalData.bannerTel) {
                        controls.bannerTel.value = "** ** ** ** **";
                    }
                    
                    // Location: Anonymize to "***"
                    if (originalData.qualificationLoc) {
                        controls.qualificationLoc.value = "***";
                    }
                    
                    // Update only icon and tooltip for icon-only button
                    controls.anonymizeBtn.innerHTML = '<i class="fa-solid fa-user text-lg"></i>';
                    controls.anonymizeBtn.setAttribute('data-tooltip', '👤 Restaurer vos informations personnelles et désanonymiser votre CV');
                    isAnonymized = true;
                    showNotification("CV anonymisé avec succès !", "success");
                }
                updatePreview('form');
            }

            // --- DÉTECTION GLOBALE BOUTONS IA ---
            // Système pour détecter automatiquement tous les boutons IA et leur ajouter l'animation
            function initAIButtonDetection() {
                // Sélecteur pour tous les boutons qui contiennent 'ai' dans leur ID ou qui font appel aux fonctions IA
                const aiButtonSelectors = [
                    '[id*="ai-"]',           // Tous les boutons avec 'ai-' dans l'ID
                    '[id*="generate-"]',     // Boutons de génération
                    '[id*="optimize-"]',     // Boutons d'optimisation  
                    '[id*="analyze-"]',      // Boutons d'analyse
                    '[id*="smart-"]'         // Boutons intelligents
                ];
                
                aiButtonSelectors.forEach(selector => {
                    const buttons = document.querySelectorAll(selector);
                    buttons.forEach(button => {
                        // Vérifier si le bouton fait déjà partie des boutons avec animation personnalisée
                        const hasCustomAnimation = [
                            'ai-keyword-optimize-btn',
                            'ai-create-variants-btn', 
                            'ai-generate-motto-btn',
                            'ai-optimize-one-page-btn',
                            'auto-optimize-layout-btn',
                            'generate-mail-btn',
                            'smart-analyze-btn'
                        ].includes(button.id);
                        
                        if (!hasCustomAnimation && button.id) {
                            // Ajouter l'écouteur avec animation pour les boutons non traités
                            const originalOnClick = button.onclick;
                            button.addEventListener('click', async function(e) {
                                // Si le bouton fait un appel async, ajouter l'animation
                                if (this.textContent.toLowerCase().includes('ia') || 
                                    this.textContent.toLowerCase().includes('ai') ||
                                    this.textContent.toLowerCase().includes('analyser') ||
                                    this.textContent.toLowerCase().includes('générer') ||
                                    this.textContent.toLowerCase().includes('optimiser')) {
                                    
                                    const overlay = showAIReconstruction();
                                    const resetButton = animateAIButton(this);
                                    
                                    // Attendre un délai minimum pour l'effet visuel
                                    setTimeout(() => {
                                        hideAIReconstruction(overlay);
                                        resetButton();
                                        animateCVRebuild();
                                    }, 2000);
                                }
                            });
                        }
                    });
                });
            }
            
            // Initialiser la détection des boutons IA
            initAIButtonDetection();

            // --- EVENT LISTENERS ---
            
            // API Key event listeners
            controls.saveApiKeyBtn.addEventListener('click', () => {
                if (saveApiKey()) {
                    showNotification("Clé API sauvegardée avec succès.", "success");
                }
            });
            
            controls.toggleApiKeyVisibilityBtn.addEventListener('click', toggleApiKeyVisibility);
            
            // Save API key on Enter
            controls.apiKeyInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    if (saveApiKey()) {
                        showNotification("Clé API sauvegardée avec succès.", "success");
                    }
                }
            });

            // Main action buttons
            controls.downloadPdfBtn.addEventListener('click', () => {
                showLoader("Génération du PDF...");
                window.print();
                hideLoader();
            });

            controls.shareBtn.addEventListener('click', () => {
                controls.shareLinkInput.value = window.location.href;
                controls.shareModal.classList.add('active');
            });

            controls.closeShareModal.addEventListener('click', () => {
                controls.shareModal.classList.remove('active');
            });

            controls.copyShareLinkBtn.addEventListener('click', async () => {
                try {
                    await navigator.clipboard.writeText(controls.shareLinkInput.value);
                    showNotification("Lien copié dans le presse-papiers !", "success");
                } catch (err) {
                    showNotification("Erreur lors de la copie", "error");
                }
            });

            controls.anonymizeBtn.addEventListener('click', anonymizeCV);

            controls.resetCvBtn.addEventListener('click', async () => {
                const confirmed = await showConfirmModal("Nouveau CV", "Êtes-vous sûr de vouloir réinitialiser le CV ? Toutes les données seront perdues.");
                if (confirmed) {
                    resetCVToDefault();
                }
            });

            controls.toggleOverflowBtn.addEventListener('click', () => {
                document.body.classList.toggle('overflow-check-active');
                controls.toggleOverflowBtn.classList.toggle('active');
            });

            controls.togglePresentationModeBtn.addEventListener('click', () => {
                document.body.classList.toggle('presentation-mode');
                controls.togglePresentationModeBtn.classList.toggle('active');
            });

            // AI buttons
            controls.analyzeBtn.addEventListener('click', async () => {
                if (!controls.aiInput.value.trim()) {
                    showNotification("Veuillez saisir du texte à analyser.", "error");
                    return;
                }

                const prompt = `Analysez le texte suivant et extractez les informations pour un CV professionnel :
${controls.aiInput.value}

Retournez un objet JSON avec cette structure exacte :
{
    "nom": "nom de famille",
    "prenom": "prénom",
    "poste": "titre du poste",
    "description": "description professionnelle (2-3 phrases)",
    "experiences": [
        {"title": "Titre du poste", "meta": "Entreprise - Période", "desc": "Description des responsabilités"}
    ],
    "formations": [
        {"title": "Diplôme", "meta": "Établissement - Année", "desc": ""}
    ],
    "competences": "liste des compétences séparées par des virgules"
}`;

                const schema = {
                    type: "object",
                    properties: {
                        nom: { type: "string" },
                        prenom: { type: "string" },
                        poste: { type: "string" },
                        description: { type: "string" },
                        experiences: {
                            type: "array",
                            items: {
                                type: "object",
                                properties: {
                                    title: { type: "string" },
                                    meta: { type: "string" },
                                    desc: { type: "string" }
                                }
                            }
                        },
                        formations: {
                            type: "array",
                            items: {
                                type: "object",
                                properties: {
                                    title: { type: "string" },
                                    meta: { type: "string" },
                                    desc: { type: "string" }
                                }
                            }
                        },
                        competences: { type: "string" }
                    }
                };

                const result = await callGeminiAPI(prompt, schema);
                if (result) {
                    // Remplir les champs
                    if (result.nom) controls.nom.value = result.nom;
                    if (result.prenom) controls.prenom.value = result.prenom;
                    if (result.poste) controls.poste.value = result.poste;
                    if (result.description) controls.description.value = result.description;
                    if (result.competences) controls.competences.value = result.competences;

                    // Vider les listes existantes
                    controls.experienceList.innerHTML = '';
                    controls.formationList.innerHTML = '';

                    // Ajouter les expériences
                    if (result.experiences) {
                        result.experiences.forEach(exp => {
                            createDynamicItem(controls.experienceList, [
                                { key: 'title', placeholder: 'Titre du poste', type: 'input' },
                                { key: 'meta', placeholder: 'Entreprise - Période', type: 'input' },
                                { key: 'desc', placeholder: 'Description', type: 'textarea' }
                            ], exp);
                        });
                    }

                    // Ajouter les formations
                    if (result.formations) {
                        result.formations.forEach(form => {
                            createDynamicItem(controls.formationList, [
                                { key: 'title', placeholder: 'Diplôme/Formation', type: 'input' },
                                { key: 'meta', placeholder: 'École - Année', type: 'input' },
                                { key: 'desc', placeholder: 'Description (optionnel)', type: 'textarea' }
                            ], form);
                        });
                    }

                    updatePreview('form');
                    showNotification("Analyse terminée et CV rempli !", "success");
                }
            });

            controls.generateMailBtn.addEventListener('click', async () => {
                const nom = controls.nom.value;
                const prenom = controls.prenom.value;
                const poste = controls.poste.value;
                const description = controls.description.value;
                const dispo = controls.qualificationDispo.value;
                const salaire = controls.qualificationSalaire.value;
                const loc = controls.qualificationLoc.value;

                if (!nom || !prenom || !poste) {
                    showNotification("Veuillez remplir au moins le nom, prénom et poste pour générer le mail.", "error");
                    return;
                }

                await callAIWithAnimation(controls.generateMailBtn, async () => {
                    const prompt = `Générez un mail de présentation professionnel pour un candidat avec ces informations :
- Nom : ${prenom} ${nom}
- Poste recherché : ${poste}
- Description : ${description}
- Disponibilité : ${dispo}
- Prétentions salariales : ${salaire}
- Localisation : ${loc}

Le mail doit être courtois, professionnel et concis (maximum 200 mots).`;

                    const result = await callGeminiAPI(prompt);
                    if (result) {
                        controls.recruiterMailContent.value = result;
                        showNotification("Mail de présentation généré !", "success");
                    }
                    return result;
                });
            });

            // NEW AI FEATURES
            document.getElementById('smart-analyze-btn')?.addEventListener('click', async () => {
                const jobDescription = controls.aiInput.value.trim();
                if (!jobDescription) {
                    showNotification("Veuillez coller une description de poste.", "error");
                    return;
                }

                const button = document.getElementById('smart-analyze-btn');
                await callAIWithAnimation(button, async () => {
                    const prompt = `Analysez cette offre d'emploi et fournissez des recommandations détaillées pour optimiser un CV :

${jobDescription}

Retournez un objet JSON avec cette structure :
{
    "keywords": ["mot-clé1", "mot-clé2", ...],
    "required_skills": ["compétence1", "compétence2", ...],
    "recommended_sections": ["section1", "section2", ...],
    "tone": "professionnel/créatif/technique",
    "layout_suggestion": "1-colonne/2-colonnes",
    "color_theme": "corporate/creative/modern"
}`;

                    const schema = {
                        type: "object",
                        properties: {
                            keywords: { type: "array", items: { type: "string" } },
                            required_skills: { type: "array", items: { type: "string" } },
                            recommended_sections: { type: "array", items: { type: "string" } },
                            tone: { type: "string" },
                            layout_suggestion: { type: "string" },
                            color_theme: { type: "string" }
                        }
                    };

                    const result = await callGeminiAPI(prompt, schema);
                    if (result) {
                        showSmartAnalysisResult(result);
                    }
                    return result;
                });
            });

            document.getElementById('industry-match-btn')?.addEventListener('click', async () => {
                const currentCV = getCurrentCVData();
                if (!currentCV.poste) {
                    showNotification("Veuillez d'abord renseigner le poste recherché.", "error");
                    return;
                }

                const prompt = `Adaptez ce CV au secteur "${currentCV.poste}" en suggérant des améliorations spécifiques :

CV actuel :
- Poste : ${currentCV.poste}
- Description : ${currentCV.description}
- Compétences : ${currentCV.competences}

Retournez des suggestions pour optimiser le CV pour ce secteur.`;

                const result = await callGeminiAPI(prompt);
                if (result) {
                    showImprovementModal("Adaptation Sectorielle", result);
                }
            });

            document.getElementById('ai-score-cv-btn')?.addEventListener('click', async () => {
                const cvData = getCurrentCVData();
                
                const prompt = `Évaluez ce CV selon les critères ATS (Applicant Tracking System) et recruteurs :

${JSON.stringify(cvData)}

Donnez un score sur 100 et des recommendations détaillées pour chaque critère :
- Mots-clés sectoriels (0-20)
- Structure et lisibilité (0-20) 
- Expérience pertinente (0-20)
- Compétences techniques (0-20)
- Présentation professionnelle (0-20)

Format JSON attendu :
{
    "total_score": 85,
    "scores": {
        "keywords": 18,
        "structure": 16,
        "experience": 19,
        "skills": 17,
        "presentation": 15
    },
    "recommendations": ["amélioration 1", "amélioration 2", ...]
}`;

                const result = await callGeminiAPI(prompt, {
                    type: "object",
                    properties: {
                        total_score: { type: "number" },
                        scores: { type: "object" },
                        recommendations: { type: "array", items: { type: "string" } }
                    }
                });

                if (result) {
                    showCVScoreModal(result);
                }
            });

            document.getElementById('ai-keyword-optimize-btn')?.addEventListener('click', async () => {
                const button = document.getElementById('ai-keyword-optimize-btn');
                
                await callAIWithAnimation(button, async () => {
                    const currentCV = getCurrentCVData();
                    
                    const prompt = `Analysez ce CV et suggérez des mots-clés spécifiques au secteur pour améliorer le référencement ATS :

${JSON.stringify(currentCV)}

Retournez une liste de mots-clés à intégrer naturellement dans le CV.`;

                    const result = await callGeminiAPI(prompt);
                    if (result) {
                        highlightKeywordsInCV(result);
                        showNotification("Mots-clés optimisés et mis en évidence dans le CV !", "success");
                    }
                    return result;
                });
            });

            document.getElementById('ai-create-variants-btn')?.addEventListener('click', async () => {
                const button = document.getElementById('ai-create-variants-btn');
                
                await callAIWithAnimation(button, async () => {
                    const currentCV = getCurrentCVData();

                    const prompt = `Créez 3 variantes de ce CV pour différents contextes :

CV de base : ${JSON.stringify(currentCV)}

Variante 1: Version concise (1 page, focus expérience)
Variante 2: Version détaillée (2 pages, projets + compétences)
Variante 3: Version créative (présentation moderne)

Format JSON avec 3 objets CV complets.`;

                    const result = await callGeminiAPI(prompt);
                    if (result) {
                        showCVVariantsModal(result);
                    }
                    return result;
                });
            });

            document.getElementById('ai-personalize-job-btn')?.addEventListener('click', async () => {
                const jobDesc = prompt("Collez la description du poste pour personnaliser le CV :");
                if (!jobDesc) return;

                const currentCV = getCurrentCVData();
                
                const promptText = `Personnalisez ce CV pour correspondre exactement à cette offre d'emploi :

OFFRE : ${jobDesc}

CV ACTUEL : ${JSON.stringify(currentCV)}

Retournez un CV modifié qui maximise les chances de correspondance avec l'offre.`;

                const result = await callGeminiAPI(promptText);
                if (result) {
                    // Apply the personalized CV
                    applyPersonalizedCV(result);
                    showNotification("CV personnalisé pour l'offre d'emploi !", "success");
                }
            });

            document.getElementById('generate-linkedin-msg-btn')?.addEventListener('click', async () => {
                const currentCV = getCurrentCVData();
                
                const prompt = `Générez un message LinkedIn professionnel basé sur ce profil :

${JSON.stringify(currentCV)}

Le message doit être :
- Concis (150 mots max)
- Engageant
- Professionnel
- Personnalisable selon le destinataire`;

                const result = await callGeminiAPI(prompt);
                if (result) {
                    controls.recruiterMailContent.value = result;
                    showNotification("Message LinkedIn généré !", "success");
                }
            });

            document.getElementById('ai-generate-motto-btn')?.addEventListener('click', async () => {
                const button = document.getElementById('ai-generate-motto-btn');
                
                await callAIWithAnimation(button, async () => {
                    const currentCV = getCurrentCVData();
                    
                    const prompt = `Créez une devise/slogan professionnel personnalisé basé sur ce profil :

${JSON.stringify(currentCV)}

La devise doit être :
- Mémorable (10 mots max)
- Refléter la personnalité professionnelle
- Applicable au secteur d'activité`;

                    const result = await callGeminiAPI(prompt);
                    if (result) {
                        addMottoToCV(result);
                        showNotification("Devise personnalisée ajoutée au CV !", "success");
                    }
                    return result;
                });
            });

            document.getElementById('ai-suggest-improvements-btn')?.addEventListener('click', async () => {
                const currentCV = getCurrentCVData();
                
                const prompt = `Analysez ce CV et fournissez 5 suggestions concrètes d'amélioration :

${JSON.stringify(currentCV)}

Pour chaque suggestion, expliquez :
1. Le problème identifié
2. La solution recommandée
3. L'impact attendu`;

                const result = await callGeminiAPI(prompt);
                if (result) {
                    showImprovementModal("Suggestions d'Amélioration", result);
                }
            });

            document.getElementById('ai-translate-cv-btn')?.addEventListener('click', () => {
                document.getElementById('translation-modal').classList.add('active');
            });

            // Helper functions for new AI features
            function getCurrentCVData() {
                return {
                    nom: controls.nom.value,
                    prenom: controls.prenom.value,
                    poste: controls.poste.value,
                    description: controls.description.value,
                    experiences: getDynamicData(controls.experienceList),
                    formations: getDynamicData(controls.formationList),
                    competences: controls.competences.value
                };
            }

            function showSmartAnalysisResult(analysis) {
                const container = document.createElement('div');
                container.className = 'analysis-result';
                container.innerHTML = `
                    <h3 class="font-bold mb-3">📊 Analyse Intelligente</h3>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <p class="font-semibold mb-2">Mots-clés détectés :</p>
                            <div class="flex flex-wrap gap-1">
                                ${analysis.keywords?.map(k => `<span class="keyword-highlight">${k}</span>`).join('') || ''}
                            </div>
                        </div>
                        <div>
                            <p class="font-semibold mb-2">Compétences requises :</p>
                            <ul class="list-disc list-inside">
                                ${analysis.required_skills?.map(s => `<li>${s}</li>`).join('') || ''}
                            </ul>
                        </div>
                        <div>
                            <p class="font-semibold mb-2">Sections recommandées :</p>
                            <ul class="list-disc list-inside">
                                ${analysis.recommended_sections?.map(s => `<li>${s}</li>`).join('') || ''}
                            </ul>
                        </div>
                        <div>
                            <p class="font-semibold mb-2">Recommandations :</p>
                            <p>Ton : ${analysis.tone}</p>
                            <p>Layout : ${analysis.layout_suggestion}</p>
                            <p>Thème : ${analysis.color_theme}</p>
                        </div>
                    </div>
                `;

                // Insert after AI input
                controls.aiInput.parentNode.insertBefore(container, controls.aiInput.nextSibling);

                // Auto-apply some suggestions
                if (analysis.required_skills) {
                    const newSkills = controls.competences.value + ', ' + analysis.required_skills.join(', ');
                    controls.competences.value = newSkills;
                    updatePreview('form');
                }
            }

            function showCVScoreModal(scoreData) {
                const modal = document.getElementById('cv-score-modal');
                const container = document.getElementById('score-result-container');
                
                container.innerHTML = `
                    <div class="cv-score-container">
                        <div class="score-circle">
                            <span class="score-text">${scoreData.total_score}/100</span>
                        </div>
                        <h3 class="text-xl font-bold">Score ATS Global</h3>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 mt-6">
                        ${Object.entries(scoreData.scores).map(([key, value]) => `
                            <div class="bg-gray-50 p-3 rounded-lg">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-sm font-medium">${key}</span>
                                    <span class="font-bold">${value}/20</span>
                                </div>
                                <div class="score-bar">
                                    <div class="score-fill" style="width: ${(value/20)*100}%"></div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="mt-6">
                        <h4 class="font-bold mb-3">💡 Recommandations :</h4>
                        <ul class="list-disc list-inside space-y-1">
                            ${scoreData.recommendations.map(rec => `<li class="text-sm">${rec}</li>`).join('')}
                        </ul>
                    </div>
                `;
                
                modal.classList.add('active');
            }

            function showImprovementModal(title, content) {
                const modal = document.getElementById('improvements-modal');
                const container = document.getElementById('improvements-container');
                
                modal.querySelector('h2').textContent = title;
                container.innerHTML = `<div class="prose max-w-none">${content.replace(/\n/g, '<br>')}</div>`;
                
                modal.classList.add('active');
            }

            // Fonction pour optimiser le CV afin qu'il tienne sur une page
            async function optimizeForOnePage() {
                try {
                    showNotification("Optimisation en cours...", "info");
                    
                    // Collecter toutes les données du CV
                    const cvData = {
                        nom: controls.nom.value,
                        prenom: controls.prenom.value,
                        poste: controls.poste.value,
                        description: controls.description.value,
                        experiences: getDynamicData(controls.experienceList),
                        formations: getDynamicData(controls.formationList),
                        competences: controls.competences.value
                    };

                    // Vérifier si le CV a du contenu
                    if (!cvData.nom && !cvData.prenom && !cvData.poste && cvData.experiences.length === 0) {
                        showNotification("Veuillez remplir au moins les informations de base du CV.", "error");
                        return;
                    }

                    const prompt = `Vous êtes un expert en CV professionnel. Optimisez ce CV pour qu'il tienne parfaitement sur UNE SEULE PAGE tout en conservant les informations les plus importantes et pertinentes.

DONNÉES DU CV ACTUEL :
- Nom: ${cvData.prenom} ${cvData.nom}
- Poste: ${cvData.poste}
- Description: ${cvData.description}
- Expériences: ${cvData.experiences.map(exp => `${exp.title} - ${exp.meta}: ${exp.desc}`).join('\\n')}
- Formations: ${cvData.formations.map(form => `${form.title} - ${form.meta}: ${form.desc || ''}`).join('\\n')}
- Compétences: ${cvData.competences}

CONSIGNES D'OPTIMISATION :
1. Raccourcissez la description professionnelle à 2-3 lignes maximum
2. Limitez chaque expérience à 2-3 points clés maximum
3. Condensez les formations en gardant l'essentiel
4. Sélectionnez les 8-10 compétences les plus pertinentes
5. Utilisez des phrases courtes et percutantes
6. Supprimez les répétitions et informations redondantes
7. Privilégiez les résultats chiffrés et mots-clés du secteur

Retournez un objet JSON avec cette structure exacte :
{
    "description": "description professionnelle optimisée (2-3 lignes max)",
    "experiences": [
        {"title": "Titre du poste", "meta": "Entreprise - Période", "desc": "Description concise avec 2-3 points clés maximum"}
    ],
    "formations": [
        {"title": "Diplôme", "meta": "Établissement - Année", "desc": ""}
    ],
    "competences": "liste des 8-10 compétences les plus importantes séparées par des virgules"
}`;

                    const schema = {
                        type: "object",
                        properties: {
                            description: { type: "string" },
                            experiences: {
                                type: "array",
                                items: {
                                    type: "object",
                                    properties: {
                                        title: { type: "string" },
                                        meta: { type: "string" },
                                        desc: { type: "string" }
                                    }
                                }
                            },
                            formations: {
                                type: "array",
                                items: {
                                    type: "object",
                                    properties: {
                                        title: { type: "string" },
                                        meta: { type: "string" },
                                        desc: { type: "string" }
                                    }
                                }
                            },
                            competences: { type: "string" }
                        }
                    };

                    const result = await callGeminiAPI(prompt, schema);
                    if (result) {
                        // Appliquer les optimisations
                        if (result.description) {
                            controls.description.value = result.description;
                        }
                        
                        if (result.competences) {
                            controls.competences.value = result.competences;
                        }

                        // Remplacer les expériences
                        if (result.experiences && result.experiences.length > 0) {
                            controls.experienceList.innerHTML = '';
                            result.experiences.forEach(exp => {
                                createDynamicItem(controls.experienceList, [
                                    { key: 'title', placeholder: 'Titre du poste', type: 'input' },
                                    { key: 'meta', placeholder: 'Entreprise - Période', type: 'input' },
                                    { key: 'desc', placeholder: 'Description', type: 'textarea' }
                                ], exp);
                            });
                        }

                        // Remplacer les formations
                        if (result.formations && result.formations.length > 0) {
                            controls.formationList.innerHTML = '';
                            result.formations.forEach(form => {
                                createDynamicItem(controls.formationList, [
                                    { key: 'title', placeholder: 'Diplôme/Formation', type: 'input' },
                                    { key: 'meta', placeholder: 'École - Année', type: 'input' },
                                    { key: 'desc', placeholder: 'Description (optionnel)', type: 'textarea' }
                                ], form);
                            });
                        }

                        // Optimiser automatiquement la taille de police et les espacements pour une page
                        document.documentElement.style.setProperty('--font-size-p', '9pt');
                        document.documentElement.style.setProperty('--font-size-h2', '18pt');
                        document.documentElement.style.setProperty('--paragraph-spacing', '0.3rem');
                        document.documentElement.style.setProperty('--module-spacing', '1rem');
                        document.documentElement.style.setProperty('--item-spacing', '0.3rem');
                        
                        // Mettre à jour les sliders pour refléter les nouveaux paramètres
                        const fontSizePSlider = document.getElementById('font-size-p');
                        const fontSizeH2Slider = document.getElementById('font-size-h2');
                        const moduleSpacingSlider = document.getElementById('module-spacing');
                        const paragraphSpacingSlider = document.getElementById('paragraph-spacing');
                        const itemSpacingSlider = document.getElementById('item-spacing');
                        
                        if (fontSizePSlider) {
                            fontSizePSlider.value = 9;
                            document.getElementById('font-size-p-value').textContent = '9';
                        }
                        if (fontSizeH2Slider) {
                            fontSizeH2Slider.value = 18;
                            document.getElementById('font-size-h2-value').textContent = '18';
                        }
                        if (moduleSpacingSlider) {
                            moduleSpacingSlider.value = 1;
                            document.getElementById('module-spacing-value').textContent = '1';
                        }
                        if (paragraphSpacingSlider) {
                            paragraphSpacingSlider.value = 0.3;
                            document.getElementById('paragraph-spacing-value').textContent = '0.3';
                        }
                        if (itemSpacingSlider) {
                            itemSpacingSlider.value = 0.3;
                            document.getElementById('item-spacing-value').textContent = '0.3';
                        }

                        updatePreview('form');
                        
                        // Vérifier si le CV tient maintenant sur une page
                        setTimeout(() => {
                            checkAllPagesOverflow();
                            showNotification("CV optimisé pour tenir sur une page ! ✨", "success");
                        }, 500);
                    }
                } catch (error) {
                    console.error('Erreur lors de l\'optimisation:', error);
                    showNotification("Erreur lors de l'optimisation. Veuillez réessayer.", "error");
                }
            }

            controls.aiOptimizeOnePageBtn.addEventListener('click', async () => {
                // Fonction pour optimiser le CV afin qu'il tienne sur une page
                await callAIWithAnimation(controls.aiOptimizeOnePageBtn, async () => {
                    await optimizeForOnePage();
                    return true;
                });
            });

            // Skills templates
            document.querySelectorAll('.skill-template-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const template = btn.dataset.skillTemplate;
                    if (skillTemplates[template]) {
                        controls.competences.value = skillTemplates[template];
                        updatePreview('form');
                        showNotification(`Template ${template} appliqué !`, "success");
                    }
                });
            });

            // AI skills from job description
            document.getElementById('ai-skills-from-job-btn')?.addEventListener('click', async () => {
                const jobDesc = controls.aiInput.value.trim() || prompt("Collez la description du poste :");
                if (!jobDesc) return;

                const promptText = `Analysez cette offre d'emploi et extrayez les compétences techniques et soft skills requises :

${jobDesc}

Retournez une liste de compétences séparées par des virgules, en français, adaptées pour un CV.`;

                const result = await callGeminiAPI(promptText);
                if (result) {
                    controls.competences.value = result;
                    updatePreview('form');
                    showNotification("Compétences extraites de l'offre d'emploi !", "success");
                }
            });

            // Skill matcher
            document.getElementById('skill-matcher-btn')?.addEventListener('click', async () => {
                const jobDesc = prompt("Collez la description du poste pour analyser la correspondance :");
                if (!jobDesc) return;

                const currentSkills = controls.competences.value;
                
                const prompt = `Analysez la correspondance entre ces compétences du CV et celles requises dans l'offre :

COMPÉTENCES CV : ${currentSkills}

OFFRE D'EMPLOI : ${jobDesc}

Retournez au format JSON :
{
    "match_percentage": 75,
    "matching_skills": ["skill1", "skill2"],
    "missing_skills": ["skill3", "skill4"],
    "recommendations": "conseils pour améliorer la correspondance"
}`;

                const result = await callGeminiAPI(prompt);
                if (result) {
                    showSkillAnalysisModal(result);
                }
            });

            // Suggest missing skills
            document.getElementById('suggest-missing-skills-btn')?.addEventListener('click', async () => {
                const currentCV = getCurrentCVData();
                
                const prompt = `Analysez ce profil et suggérez les compétences manquantes qui pourraient renforcer le CV :

${JSON.stringify(currentCV)}

Suggérez 5-8 compétences complémentaires pertinentes pour ce profil.`;

                const result = await callGeminiAPI(prompt);
                if (result) {
                    const currentSkills = controls.competences.value;
                    const newSkills = currentSkills ? `${currentSkills}, ${result}` : result;
                    controls.competences.value = newSkills;
                    updatePreview('form');
                    showNotification("Compétences complémentaires ajoutées !", "success");
                }
            });

            // Skill trend analysis
            document.getElementById('skill-trend-analysis-btn')?.addEventListener('click', async () => {
                const currentSkills = controls.competences.value;
                const sector = controls.poste.value;
                
                const prompt = `Analysez les tendances du marché pour ces compétences dans le secteur "${sector}" :

COMPÉTENCES : ${currentSkills}

Identifiez :
1. Les compétences les plus demandées
2. Les compétences émergentes à acquérir
3. Les compétences obsolètes à remplacer
4. Les formations recommandées`;

                const result = await callGeminiAPI(prompt);
                if (result) {
                    showImprovementModal("Analyse des Tendances Compétences", result);
                }
            });

            // Enhanced skill styles
            document.querySelectorAll('.skill-style-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.skill-style-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    const style = btn.dataset.skillStyle;
                    
                    // Show/hide appropriate controls
                    if (style === 'levels') {
                        controls.skillsTextControls.classList.add('hidden');
                        controls.skillsLevelControls.classList.remove('hidden');
                    } else {
                        controls.skillsTextControls.classList.remove('hidden');
                        controls.skillsLevelControls.classList.add('hidden');
                    }
                    
                    // Apply style to preview
                    const skillsPreview = document.getElementById('cv-competences-preview');
                    if (skillsPreview) {
                        skillsPreview.dataset.style = style;
                        skillsPreview.className = `cv-competences-${style}`;
                    }
                    
                    updatePreview('form');
                });
            });

            // Section templates
            document.querySelectorAll('.section-template-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const template = btn.dataset.sectionTemplate;
                    if (sectionTemplates[template]) {
                        sectionTemplates[template].forEach(sectionTitle => {
                            addCustomSection(sectionTitle);
                        });
                        showNotification(`Template ${template} appliqué !`, "success");
                    }
                });
            });

            // AI suggest sections
            document.getElementById('ai-suggest-sections-btn')?.addEventListener('click', async () => {
                const currentCV = getCurrentCVData();
                
                const prompt = `Analysez ce CV et suggérez 3-5 sections personnalisées qui pourraient le renforcer :

${JSON.stringify(currentCV)}

Considérez le secteur, l'expérience et les objectifs de carrière.
Retournez une liste de titres de sections avec des emojis.`;

                const result = await callGeminiAPI(prompt);
                if (result) {
                    const sections = result.split('\n').filter(s => s.trim());
                    sections.forEach(section => {
                        addCustomSection(section.trim());
                    });
                    showNotification("Sections suggérées ajoutées !", "success");
                }
            });

            // Import/Export sections
            document.getElementById('export-sections-btn')?.addEventListener('click', () => {
                const customSections = Array.from(document.querySelectorAll('[data-section-id]'))
                    .map(section => ({
                        id: section.dataset.sectionId,
                        title: section.querySelector('span[contenteditable]').textContent,
                        content: section.innerHTML
                    }));

                const dataStr = JSON.stringify(customSections, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'cv-sections.json';
                link.click();
                URL.revokeObjectURL(url);
                
                showNotification("Sections exportées !", "success");
            });

            document.getElementById('import-sections-btn')?.addEventListener('click', () => {
                document.getElementById('import-sections-file').click();
            });

            document.getElementById('import-sections-file')?.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        try {
                            const sections = JSON.parse(event.target.result);
                            sections.forEach(section => {
                                addCustomSection(section.title);
                            });
                            showNotification("Sections importées !", "success");
                        } catch (error) {
                            showNotification("Erreur lors de l'import des sections.", "error");
                        }
                    };
                    reader.readAsText(file);
                }
            });

            // Helper functions for skill analysis
            function showSkillAnalysisModal(analysis) {
                const modal = document.getElementById('skill-analysis-modal');
                const container = document.getElementById('skill-analysis-container');
                
                container.innerHTML = `
                    <div class="text-center mb-6">
                        <div class="score-circle" style="width: 100px; height: 100px; border: 6px solid #e5e7eb; border-top-color: #3b82f6; margin: 0 auto;">
                            <span class="text-2xl font-bold">${analysis.match_percentage}%</span>
                        </div>
                        <p class="mt-2 text-gray-600">Correspondance avec l'offre</p>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-6">
                        <div>
                            <h4 class="font-bold text-green-600 mb-3">✅ Compétences correspondantes</h4>
                            <ul class="list-disc list-inside space-y-1">
                                ${analysis.matching_skills?.map(skill => `<li class="text-sm">${skill}</li>`).join('') || '<li>Aucune</li>'}
                            </ul>
                        </div>
                        
                        <div>
                            <h4 class="font-bold text-red-600 mb-3">❌ Compétences manquantes</h4>
                            <ul class="list-disc list-inside space-y-1">
                                ${analysis.missing_skills?.map(skill => `<li class="text-sm">${skill}</li>`).join('') || '<li>Aucune</li>'}
                            </ul>
                        </div>
                    </div>
                    
                    <div class="mt-6 p-4 bg-blue-50 rounded-lg">
                        <h4 class="font-bold text-blue-800 mb-2">💡 Recommandations</h4>
                        <p class="text-sm text-blue-700">${analysis.recommendations}</p>
                    </div>
                `;
                
                modal.classList.add('active');
            }

            controls.aiSynthesizeSkillsBtn.addEventListener('click', async () => {
                if (!controls.competences.value.trim()) {
                    showNotification("Aucune compétence à synthétiser.", "error");
                    return;
                }

                const prompt = `Analysez et réorganisez ces compétences par catégories logiques :
${controls.competences.value}

Format de sortie : Chaque catégorie sur une ligne avec format "Catégorie: compétence1, compétence2, etc."`;

                const result = await callGeminiAPI(prompt);
                if (result) {
                    controls.competences.value = result;
                    updatePreview('form');
                    showNotification("Compétences synthétisées et organisées !", "success");
                }
            });

            controls.aiColorBtn.addEventListener('click', async () => {
                const primaryColor = controls.primaryColorPicker.value;
                const prompt = `Donnez une couleur secondaire qui s'harmonise bien avec cette couleur primaire ${primaryColor}. Répondez seulement avec le code hexadécimal (ex: #123456).`;

                const result = await callGeminiAPI(prompt);
                if (result && result.match(/#[0-9A-Fa-f]{6}/)) {
                    controls.secondaryColorPicker.value = result.trim();
                    updateAllStyles();
                    showNotification("Couleur suggérée appliquée !", "success");
                }
            });

            controls.addExperienceBtn.addEventListener('click', () => {
                createDynamicItem(controls.experienceList, [
                    { key: 'title', placeholder: 'Titre du poste', type: 'input' },
                    { key: 'meta', placeholder: 'Entreprise - Période', type: 'input' },
                    { key: 'desc', placeholder: 'Description', type: 'textarea' }
                ]);
            });

            // Fix ID for add-experience button
            document.getElementById('add-experience')?.addEventListener('click', () => {
                createDynamicItem(controls.experienceList, [
                    { key: 'title', placeholder: 'Titre du poste', type: 'input' },
                    { key: 'meta', placeholder: 'Entreprise - Période', type: 'input' },
                    { key: 'desc', placeholder: 'Description', type: 'textarea' }
                ]);
            });

            // Fix ID for add-formation button  
            document.getElementById('add-formation')?.addEventListener('click', () => {
                createDynamicItem(controls.formationList, [
                    { key: 'title', placeholder: 'Diplôme/Formation', type: 'input' },
                    { key: 'meta', placeholder: 'École - Année', type: 'input' },
                    { key: 'desc', placeholder: 'Description (optionnel)', type: 'textarea' }
                ]);
            });

            controls.addFormationBtn.addEventListener('click', () => {
                createDynamicItem(controls.formationList, [
                    { key: 'title', placeholder: 'Diplôme/Formation', type: 'input' },
                    { key: 'meta', placeholder: 'École - Année', type: 'input' },
                    { key: 'desc', placeholder: 'Description (optionnel)', type: 'textarea' }
                ]);
            });

            // Skills management
            controls.addSkillLevelBtn.addEventListener('click', () => {
                createSkillLevelItem();
            });

            // Custom sections
            controls.addSectionBtn.addEventListener('click', () => {
                const suggestionSelect = controls.sectionSuggestionSelect;
                const customInput = controls.newSectionTitleInput;
                
                let title = suggestionSelect.value || customInput.value.trim();
                if (!title) {
                    showNotification("Veuillez sélectionner ou saisir un titre de section.", "error");
                    return;
                }
                
                // Clean the title to remove emoji for icon selection
                const cleanTitle = title.replace(/[^\w\s]/gi, '').trim();
                
                addCustomSection(title);
                suggestionSelect.value = '';
                customInput.value = '';
                showNotification("Section ajoutée !", "success");
            });

            // Banner controls
            controls.fixBannerTopBtn.addEventListener('click', () => {
                moveBannerTo('top');
            });

            controls.fixBannerBottomBtn.addEventListener('click', () => {
                moveBannerTo('bottom');
            });

            controls.modularBannerBtn.addEventListener('click', () => {
                moveBannerTo('modular');
            });

            controls.resetRecruiterBtn.addEventListener('click', () => {
                setDefaultRecruiterInfo();
                updatePreview('form');
                showNotification("Informations recruteur réinitialisées.", "success");
            });

            controls.removeBannerBgBtn.addEventListener('click', () => {
                preview.bannerBgImg.src = '';
                preview.bannerBgImg.style.display = 'none';
                showNotification("Image de fond supprimée.", "success");
            });

            controls.randomizeBannerStyleBtn.addEventListener('click', () => {
                // Random style
                const styles = ['banner-style-modern', 'banner-style-elegant', 'banner-style-discret', 'banner-style-carte', 'banner-style-degrade', 'banner-style-premium'];
                const randomStyle = styles[Math.floor(Math.random() * styles.length)];
                controls.bannerStyleSelect.value = randomStyle;

                // Random alignment
                const alignments = ['left', 'center', 'right'];
                const randomAlign = alignments[Math.floor(Math.random() * alignments.length)];
                document.querySelector(`[data-banner-align="${randomAlign}"]`).click();

                // Random colors
                const colors = ['#2563eb', '#dc2626', '#059669', '#7c3aed', '#ea580c', '#0891b2'];
                controls.bannerNomColor.value = colors[Math.floor(Math.random() * colors.length)];
                controls.bannerPosteColor.value = colors[Math.floor(Math.random() * colors.length)];
                controls.bannerContactColor.value = colors[Math.floor(Math.random() * colors.length)];

                updateAllStyles();
                updatePreviewStyles('banner-style');
                showNotification("Style aléatoire appliqué !", "success");
            });

            // Add page button
            controls.addPageBtn.addEventListener('click', addNewPage);

            // Banner background controls
            controls.bannerBgImage.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        preview.bannerBgImg.src = e.target.result;
                        preview.bannerBgImg.style.display = 'block';
                        updateBannerBackground();
                    };
                    reader.readAsDataURL(file);
                }
            });

            controls.bannerBgOpacity.addEventListener('input', updateBannerBackground);
            controls.bannerBgBlur.addEventListener('input', updateBannerBackground);
            controls.bannerBgGrayscale.addEventListener('change', updateBannerBackground);

            // Banner image upload
            controls.bannerImage.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        preview.bannerImg.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            });

            // Undo/Redo buttons
            controls.undoBtn.addEventListener('click', undo);
            controls.redoBtn.addEventListener('click', redo);

            // ===== SYSTÈME DE GESTION DES ONGLETS MODERNISÉ =====
            function initializeTabSystem() {
                const tabBtns = document.querySelectorAll('.tab-btn');
                const tabPanels = document.querySelectorAll('.tab-panel');
                
                // Assurer qu'un seul onglet est actif au démarrage
                tabBtns.forEach(btn => btn.classList.remove('active', 'border-blue-500', 'text-blue-600'));
                tabPanels.forEach(panel => panel.classList.add('hidden'));
                
                // Activer le premier onglet (IA) par défaut
                const firstTab = document.querySelector('.tab-btn[data-target="#panel-ia"]');
                const firstPanel = document.querySelector('#panel-ia');
                if (firstTab && firstPanel) {
                    firstTab.classList.add('active');
                    firstPanel.classList.remove('hidden');
                }
                
                // Gestion des clics sur les onglets avec animations
                tabBtns.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        switchTab(btn);
                    });
                });
            }
            
            function switchTab(clickedBtn) {
                const tabBtns = document.querySelectorAll('.tab-btn');
                const tabPanels = document.querySelectorAll('.tab-panel');
                const targetPanel = document.querySelector(clickedBtn.dataset.target);
                
                if (!targetPanel) return;
                
                // Désactiver tous les onglets
                tabBtns.forEach(btn => {
                    btn.classList.remove('active', 'border-blue-500', 'text-blue-600');
                });
                
                // Masquer tous les panneaux avec animation
                tabPanels.forEach(panel => {
                    if (!panel.classList.contains('hidden')) {
                        panel.style.animation = 'fadeOut 0.2s ease-out';
                        setTimeout(() => {
                            panel.classList.add('hidden');
                            panel.style.animation = '';
                        }, 200);
                    }
                });
                
                // Activer l'onglet cliqué
                clickedBtn.classList.add('active');
                
                // Afficher le panneau correspondant avec animation
                setTimeout(() => {
                    targetPanel.classList.remove('hidden');
                    targetPanel.style.animation = 'fadeIn 0.3s ease-out';
                    setTimeout(() => {
                        targetPanel.style.animation = '';
                    }, 300);
                }, 200);
                
                // Ouvrir automatiquement la première section si aucune n'est ouverte
                setTimeout(() => {
                    const firstControlGroup = targetPanel.querySelector('.control-group:not([open])');
                    if (firstControlGroup) {
                        firstControlGroup.setAttribute('open', '');
                        // Animation d'ouverture
                        const content = firstControlGroup.querySelector('.control-group-content');
                        if (content) {
                            content.style.animation = 'slideDown 0.3s ease-out';
                            setTimeout(() => content.style.animation = '', 300);
                        }
                    }
                }, 400);
            }
            
            // Initialisation du système d'onglets
            initializeTabSystem();
            
            // ===== SYSTÈME D'HARMONISATION DES BOUTONS AMÉLIORÉ =====
            function harmonizeButtons() {
                console.log('🎨 Début de l\'harmonisation des boutons...');
                
                // D'abord, préserver tous les tooltips existants
                const elementsWithTooltips = document.querySelectorAll('[title]');
                elementsWithTooltips.forEach(el => {
                    if (!el.hasAttribute('data-tooltip')) {
                        el.setAttribute('data-tooltip', el.getAttribute('title'));
                        el.removeAttribute('title');
                    }
                });
                
                // Mapping des anciens styles vers les nouveaux avec tailles appropriées
                const buttonMappings = [
                    // Boutons AI Enhanced - taille standard
                    {
                        selector: '.ai-btn-enhanced:not(.btn-base)',
                        newClasses: ['btn-base', 'btn-primary'],
                        removeClasses: ['ai-btn-enhanced'],
                        size: 'standard'
                    },
                    // Boutons compacts - petite taille
                    {
                        selector: '.ai-btn-compact:not(.btn-base)',
                        newClasses: ['btn-base', 'btn-compact', 'btn-secondary', 'btn-sm'],
                        removeClasses: ['ai-btn-compact'],
                        size: 'compact'
                    },
                    // Boutons de thème - petite taille
                    {
                        selector: '.theme-btn:not(.btn-base)',
                        newClasses: ['btn-base', 'btn-sm', 'btn-secondary'],
                        removeClasses: ['theme-btn'],
                        size: 'small'
                    },
                    // Boutons de style de compétences - petite taille
                    {
                        selector: '.skill-style-btn:not(.btn-base)',
                        newClasses: ['btn-base', 'btn-sm', 'btn-info'],
                        removeClasses: ['skill-style-btn'],
                        size: 'small'
                    },
                    // Boutons de layout - petite taille
                    {
                        selector: '.layout-btn:not(.btn-base)',
                        newClasses: ['btn-base', 'btn-sm', 'btn-secondary'],
                        removeClasses: ['layout-btn'],
                        size: 'small'
                    },
                    // Boutons avec couleurs spécifiques
                    {
                        selector: 'button[class*="bg-green"]:not(.btn-base)',
                        newClasses: ['btn-base', 'btn-success'],
                        removeClasses: [],
                        size: 'standard'
                    },
                    {
                        selector: 'button[class*="bg-red"]:not(.btn-base)',
                        newClasses: ['btn-base', 'btn-danger'],
                        removeClasses: [],
                        size: 'standard'
                    },
                    {
                        selector: 'button[class*="bg-yellow"]:not(.btn-base)',
                        newClasses: ['btn-base', 'btn-warning'],
                        removeClasses: [],
                        size: 'standard'
                    },
                    {
                        selector: 'button[class*="bg-blue"]:not(.btn-base)',
                        newClasses: ['btn-base', 'btn-primary'],
                        removeClasses: [],
                        size: 'standard'
                    },
                    {
                        selector: 'button[class*="bg-purple"]:not(.btn-base)',
                        newClasses: ['btn-base', 'btn-info'],
                        removeClasses: [],
                        size: 'standard'
                    },
                    {
                        selector: 'button[class*="bg-gray"]:not(.btn-base)',
                        newClasses: ['btn-base', 'btn-secondary'],
                        removeClasses: [],
                        size: 'standard'
                    }
                ];
                
                let harmonizedCount = 0;
                
                buttonMappings.forEach(mapping => {
                    const buttons = document.querySelectorAll(mapping.selector);
                    buttons.forEach(button => {
                        // Préserver le tooltip
                        const tooltip = button.getAttribute('data-tooltip') || button.getAttribute('title');
                        
                        // Préserver la classe w-full
                        const hasFullWidth = button.classList.contains('w-full') || 
                                           button.style.width === '100%' || 
                                           button.getAttribute('data-full-width');
                        
                        // Supprimer les anciens styles Tailwind
                        const classesToRemove = [
                            'bg-blue-600', 'bg-blue-700', 'bg-green-600', 'bg-green-700',
                            'bg-red-600', 'bg-red-700', 'bg-yellow-500', 'bg-yellow-600',
                            'bg-purple-600', 'bg-purple-700', 'bg-gray-800', 'bg-gray-900',
                            'bg-slate-600', 'bg-slate-700', 'bg-indigo-600', 'bg-indigo-700',
                            'hover:bg-blue-700', 'hover:bg-green-700', 'hover:bg-red-700',
                            'hover:bg-yellow-600', 'hover:bg-purple-700', 'hover:bg-gray-900',
                            'hover:bg-slate-700', 'hover:bg-indigo-700',
                            'text-white', 'py-2', 'px-4', 'py-3', 'px-3', 'p-3',
                            'rounded-lg', 'transition-all', 'duration-200', 'duration-300',
                            'hover:scale-105', 'flex', 'items-center', 'justify-center', 'gap-2',
                            'text-xl', 'text-lg', 'text-sm', 'text-xs', 'font-medium',
                            ...mapping.removeClasses
                        ];
                        
                        classesToRemove.forEach(cls => button.classList.remove(cls));
                        
                        // Ajouter les nouvelles classes
                        mapping.newClasses.forEach(cls => button.classList.add(cls));
                        
                        // Appliquer la taille appropriée selon le contexte
                        if (mapping.size === 'compact') {
                            button.classList.add('btn-compact');
                        } else if (mapping.size === 'small') {
                            button.classList.add('btn-sm');
                        } else if (mapping.size === 'large') {
                            button.classList.add('btn-lg');
                        }
                        
                        // Restaurer le tooltip
                        if (tooltip) {
                            button.setAttribute('data-tooltip', tooltip);
                        }
                        
                        // Restaurer la largeur complète si nécessaire
                        if (hasFullWidth) {
                            button.classList.add('w-full');
                        }
                        
                        // Ajouter la classe interactive-element pour les animations
                        button.classList.add('interactive-element');
                        
                        harmonizedCount++;
                    });
                });
                
                // Harmoniser aussi les boutons sans classes spéciales mais avec des styles inline
                const inlineStyledButtons = document.querySelectorAll('button:not(.btn-base)[style*="background"], button:not(.btn-base)[class*="bg-"]');
                inlineStyledButtons.forEach(button => {
                    if (!button.classList.contains('btn-base')) {
                        const tooltip = button.getAttribute('data-tooltip') || button.getAttribute('title');
                        button.classList.add('btn-base', 'btn-secondary');
                        if (tooltip) {
                            button.setAttribute('data-tooltip', tooltip);
                        }
                        harmonizedCount++;
                    }
                });
                
                // Harmoniser les inputs et selects
                const inputs = document.querySelectorAll('input:not(.completion-checkbox):not(.form-input), select:not(.form-select), textarea:not(.form-input)');
                inputs.forEach(input => {
                    input.classList.add(input.tagName.toLowerCase() === 'select' ? 'form-select' : 'form-input');
                    harmonizedCount++;
                });
                
                console.log(`✅ Harmonisation terminée: ${harmonizedCount} éléments mis à jour`);
                
                // Vérifier que les tooltips fonctionnent
                setTimeout(() => {
                    const tooltippedElements = document.querySelectorAll('[data-tooltip]');
                    console.log(`💬 ${tooltippedElements.length} éléments avec tooltips détectés`);
                }, 100);
            }
            
            // Fonction pour ajouter des animations au survol
            function addInteractiveAnimations() {
                const interactiveElements = document.querySelectorAll('.btn-base, .control-group summary, .tab-btn');
                
                interactiveElements.forEach(el => {
                    el.classList.add('interactive-element');
                    
                    // Animation de clic
                    el.addEventListener('mousedown', () => {
                        el.style.transform = 'scale(0.98)';
                    });
                    
                    el.addEventListener('mouseup', () => {
                        el.style.transform = '';
                    });
                    
                    el.addEventListener('mouseleave', () => {
                        el.style.transform = '';
                    });
                });
            }
            
            // Exécuter l'harmonisation
            harmonizeButtons();
            addInteractiveAnimations();
            
            // Observer les nouveaux éléments ajoutés dynamiquement
            const observer = new MutationObserver((mutations) => {
                let needsHarmonization = false;
                mutations.forEach((mutation) => {
                    if (mutation.type === 'childList') {
                        mutation.addedNodes.forEach((node) => {
                            if (node.nodeType === 1 && (node.tagName === 'BUTTON' || node.querySelector('button'))) {
                                needsHarmonization = true;
                            }
                        });
                    }
                });
                
                if (needsHarmonization) {
                    setTimeout(() => {
                        harmonizeButtons();
                        addInteractiveAnimations();
                    }, 100);
                }
            });
            
            observer.observe(document.body, { childList: true, subtree: true });
            
            // ===== ANIMATIONS AVANCÉES POUR LES GROUPES DE CONTRÔLES =====
            function enhanceControlGroups() {
                const controlGroups = document.querySelectorAll('.control-group');
                
                controlGroups.forEach(group => {
                    const summary = group.querySelector('summary');
                    const content = group.querySelector('.control-group-content');
                    
                    if (summary && content) {
                        // Animation d'ouverture/fermeture
                        summary.addEventListener('click', (e) => {
                            if (group.hasAttribute('open')) {
                                // Se ferme
                                e.preventDefault();
                                content.style.animation = 'slideUp 0.3s ease-out';
                                setTimeout(() => {
                                    group.removeAttribute('open');
                                    content.style.animation = '';
                                }, 300);
                            } else {
                                // S'ouvre
                                setTimeout(() => {
                                    content.style.animation = 'slideDown 0.3s ease-out';
                                    setTimeout(() => content.style.animation = '', 300);
                                }, 10);
                            }
                        });
                        
                        // Animation de survol du summary
                        summary.addEventListener('mouseenter', () => {
                            summary.style.transform = 'translateX(2px)';
                        });
                        
                        summary.addEventListener('mouseleave', () => {
                            summary.style.transform = '';
                        });
                    }
                });
            }
            
            enhanceControlGroups();
            
            // ===== NOTIFICATION DE SUCCÈS =====
            function showHarmonizationComplete() {
                const notification = document.createElement('div');
                notification.innerHTML = `
                    <div style="
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: linear-gradient(135deg, var(--success-color), #059669);
                        color: white;
                        padding: 1rem 1.5rem;
                        border-radius: var(--border-radius-lg);
                        box-shadow: var(--shadow-xl);
                        z-index: 10000;
                        display: flex;
                        align-items: center;
                        gap: 0.5rem;
                        animation: slideInRight 0.5s ease-out;
                        font-weight: 500;
                    ">
                        <i class="fas fa-magic-wand-sparkles"></i>
                        Interface harmonisée avec succès !
                    </div>
                `;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.firstElementChild.style.animation = 'slideOutRight 0.5s ease-out';
                    setTimeout(() => notification.remove(), 500);
                }, 3000);
            }
            
            // Ajouter les keyframes pour les animations de notification
            const notificationStyles = document.createElement('style');
            notificationStyles.textContent = `
                @keyframes slideInRight {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                
                @keyframes slideOutRight {
                    from { transform: translateX(0); opacity: 1; }
                    to { transform: translateX(100%); opacity: 0; }
                }
            `;
            document.head.appendChild(notificationStyles);
            
            // Afficher la notification après un court délai
            setTimeout(showHarmonizationComplete, 1000);
            
            // ===== DEBUG DES TOOLTIPS =====
            function debugTooltips() {
                const tooltippedElements = document.querySelectorAll('[data-tooltip]');
                console.log(`🔍 Debug tooltips: ${tooltippedElements.length} éléments trouvés`);
                
                tooltippedElements.forEach((el, index) => {
                    const tooltip = el.getAttribute('data-tooltip');
                    console.log(`${index + 1}. ${el.tagName}.${el.className} → "${tooltip?.substring(0, 50)}..."`);
                    
                    // Ajouter un event listener de test
                    el.addEventListener('mouseenter', () => {
                        console.log(`💬 Tooltip affiché: "${tooltip?.substring(0, 30)}..."`);
                    });
                });
            }
            
            // Exécuter le debug après l'harmonisation
            setTimeout(debugTooltips, 1500);

            // Sliders
            Object.values(sliders).forEach(config => {
                config.el.addEventListener('input', () => {
                    const value = config.el.value;
                    config.valueEl.textContent = value;
                    document.documentElement.style.setProperty(config.property, `${value}${config.unit}`);
                    checkAllPagesOverflow();
                });
            });

            // Banner style controls
            Object.values(bannerStyleControls).forEach(config => {
                config.el.addEventListener(config.event, () => {
                    if (config.valueEl) {
                        config.valueEl.textContent = config.el.value;
                    }
                    if (config.toggle) {
                        config.el.classList.toggle('active');
                    }
                    updatePreviewStyles('banner-style');
                });
            });

            // Color pickers
            controls.primaryColorPicker.addEventListener('input', updateAllStyles);
            controls.secondaryColorPicker.addEventListener('input', updateAllStyles);
            controls.bodyTextColorPicker.addEventListener('input', updateAllStyles);

            // Font selectors
            controls.fontFamilyH1Select.addEventListener('change', updateAllStyles);
            controls.fontFamilyH2Select.addEventListener('change', updateAllStyles);
            controls.fontFamilyBodySelect.addEventListener('change', updateAllStyles);

            // Layout buttons
            document.querySelectorAll('.layout-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.layout-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    const layout = btn.dataset.layout;
                    document.querySelectorAll('.cv-body-container').forEach(container => {
                        container.className = `cv-body-container ${layout}`;
                    });
                    
                    setupAllResizers();
                    checkAllPagesOverflow();
                });
            });

            // Skill style buttons
            document.querySelectorAll('.skill-style-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.skill-style-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    const style = btn.dataset.skillStyle;
                    if (style === 'levels') {
                        controls.skillsTextControls.classList.add('hidden');
                        controls.skillsLevelControls.classList.remove('hidden');
                    } else {
                        controls.skillsTextControls.classList.remove('hidden');
                        controls.skillsLevelControls.classList.add('hidden');
                    }
                    
                    updatePreview('form');
                });
            });

            // Gauge style buttons
            document.querySelectorAll('.gauge-style-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.gauge-style-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    updatePreview('form');
                });
            });

            // Section title style buttons
            document.querySelectorAll('.section-title-style-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.section-title-style-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    updateAllStyles();
                });
            });

            // Theme buttons
            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.theme-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    const theme = btn.dataset.theme;
                    if (themes[theme]) {
                        controls.primaryColorPicker.value = themes[theme].primaryColor;
                        controls.secondaryColorPicker.value = themes[theme].secondaryColor;
                        controls.bodyTextColorPicker.value = themes[theme].bodyTextColor;
                        controls.fontFamilyH1Select.value = themes[theme].fontH1;
                        controls.fontFamilyH2Select.value = themes[theme].fontH2;
                        controls.fontFamilyBodySelect.value = themes[theme].fontBody;
                        updateAllStyles();
                        showNotification(`Thème ${theme} appliqué !`, "success");
                    }
                });
            });

            // Random theme button
            document.getElementById('random-theme-btn')?.addEventListener('click', () => {
                const themeNames = Object.keys(themes);
                const randomTheme = themeNames[Math.floor(Math.random() * themeNames.length)];
                document.querySelector(`[data-theme="${randomTheme}"]`).click();
            });

            // Color palette buttons
            document.querySelectorAll('.color-palette-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const colors = JSON.parse(btn.dataset.colors);
                    controls.primaryColorPicker.value = colors[0];
                    controls.secondaryColorPicker.value = colors[1];
                    controls.bodyTextColorPicker.value = colors[2];
                    updateAllStyles();
                    showNotification("Palette de couleurs appliquée !", "success");
                });
            });

            // AI font suggestions
            document.getElementById('ai-suggest-fonts-btn')?.addEventListener('click', async () => {
                const currentCV = getCurrentCVData();
                
                const prompt = `Suggérez 3 combinaisons de polices harmonieuses pour ce CV :
                
Secteur : ${currentCV.poste}
Style souhaité : Professionnel

Retournez au format JSON :
{
    "suggestions": [
        {"name": "Combinaison 1", "h1": "font-family", "h2": "font-family", "body": "font-family"},
        {"name": "Combinaison 2", "h1": "font-family", "h2": "font-family", "body": "font-family"},
        {"name": "Combinaison 3", "h1": "font-family", "h2": "font-family", "body": "font-family"}
    ]
}`;

                const result = await callGeminiAPI(prompt);
                if (result && result.suggestions) {
                    showFontSuggestions(result.suggestions);
                }
            });

            // Visual effects
            document.getElementById('cv-shadow-intensity')?.addEventListener('input', (e) => {
                const value = e.target.value;
                document.getElementById('cv-shadow-intensity-value').textContent = value;
                document.querySelectorAll('.a4-page').forEach(page => {
                    page.style.boxShadow = `0 ${value}px ${value * 2}px rgba(0,0,0,0.15)`;
                });
            });

            document.getElementById('section-border-radius')?.addEventListener('input', (e) => {
                const value = e.target.value;
                document.getElementById('section-border-radius-value').textContent = value;
                document.documentElement.style.setProperty('--section-border-radius', `${value}px`);
            });

            document.getElementById('enable-gradients')?.addEventListener('change', (e) => {
                if (e.target.checked) {
                    document.documentElement.style.setProperty('--title-background', 'linear-gradient(45deg, var(--primary-color), var(--secondary-color))');
                } else {
                    document.documentElement.style.setProperty('--title-background', 'var(--primary-color)');
                }
            });

            document.getElementById('enable-animations')?.addEventListener('change', (e) => {
                document.querySelectorAll('.cv-module').forEach(module => {
                    if (e.target.checked) {
                        module.classList.add('animate');
                    } else {
                        module.classList.remove('animate');
                    }
                });
            });

            document.getElementById('apply-glassmorphism-btn')?.addEventListener('click', () => {
                document.querySelectorAll('.cv-module').forEach(module => {
                    module.classList.toggle('glassmorphism');
                });
                showNotification("Effet glassmorphism appliqué !", "success");
            });

            // New layout options
            document.querySelectorAll('.layout-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.layout-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    const layout = btn.dataset.layout;
                    document.querySelectorAll('.cv-body-container').forEach(container => {
                        container.className = `cv-body-container ${layout}`;
                        
                        // Add third column for 3-column layouts
                        if (layout === 'layout-3-col' || layout.includes('asymmetric')) {
                            if (!container.querySelector('#cv-col-1-3')) {
                                const col3 = document.createElement('div');
                                col3.id = 'cv-col-1-3';
                                col3.className = 'cv-column';
                                container.appendChild(col3);
                            }
                        } else {
                            // Remove third column if exists
                            const col3 = container.querySelector('#cv-col-1-3');
                            if (col3) col3.remove();
                        }
                    });
                    
                    setupAllResizers();
                    checkAllPagesOverflow();
                    showNotification("Layout appliqué !", "success");
                });
            });

            // AI layout suggestion
            document.getElementById('ai-suggest-layout-btn')?.addEventListener('click', async () => {
                const currentCV = getCurrentCVData();
                
                const prompt = `Analysez ce CV et suggérez le meilleur layout :

${JSON.stringify(currentCV)}

Considérez :
- Quantité de contenu
- Type de poste
- Secteur d'activité

Retournez : "1-col", "2-col-33-67", "2-col-50-50", "2-col-67-33", "3-col", ou "asymmetric-1"`;

                const result = await callGeminiAPI(prompt);
                if (result) {
                    const layout = result.trim().replace('-', '-layout-');
                    const btn = document.querySelector(`[data-layout="layout-${result.trim()}"]`);
                    if (btn) {
                        btn.click();
                        showNotification(`Layout "${result}" suggéré et appliqué !`, "success");
                    }
                }
            });

            // Advanced layout features
            document.getElementById('enable-zebra-sections')?.addEventListener('change', (e) => {
                if (e.target.checked) {
                    document.body.classList.add('zebra-sections');
                } else {
                    document.body.classList.remove('zebra-sections');
                }
            });

            document.getElementById('auto-optimize-layout-btn')?.addEventListener('click', async () => {
                const button = document.getElementById('auto-optimize-layout-btn');
                
                await callAIWithAnimation(button, async () => {
                    const currentCV = getCurrentCVData();
                    
                    const prompt = `Optimisez automatiquement la mise en page de ce CV :

${JSON.stringify(currentCV)}

Retournez les paramètres optimaux au format JSON :
{
    "layout": "2-col-33-67",
    "font_sizes": {"h1": 36, "h2": 18, "p": 9.5},
    "spacings": {"module": 1.2, "item": 0.4, "paragraph": 0.3},
    "recommendations": "explications des choix"
}`;

                    const result = await callGeminiAPI(prompt);
                    if (result) {
                        applyLayoutOptimization(result);
                        showNotification("Layout auto-optimisé !", "success");
                    }
                    return result;
                });
            });

            // Helper functions for layout optimization
            function applyLayoutOptimization(optimization) {
                // Apply layout
                if (optimization.layout) {
                    const layoutBtn = document.querySelector(`[data-layout="layout-${optimization.layout}"]`);
                    if (layoutBtn) layoutBtn.click();
                }
                
                // Apply font sizes
                if (optimization.font_sizes) {
                    const sizes = optimization.font_sizes;
                    if (sizes.h1) {
                        document.getElementById('font-size-h1').value = sizes.h1;
                        document.getElementById('font-size-h1-value').textContent = sizes.h1;
                        document.documentElement.style.setProperty('--font-size-h1', `${sizes.h1}pt`);
                    }
                    if (sizes.h2) {
                        document.getElementById('font-size-h2').value = sizes.h2;
                        document.getElementById('font-size-h2-value').textContent = sizes.h2;
                        document.documentElement.style.setProperty('--font-size-h2', `${sizes.h2}pt`);
                    }
                    if (sizes.p) {
                        document.getElementById('font-size-p').value = sizes.p;
                        document.getElementById('font-size-p-value').textContent = sizes.p;
                        document.documentElement.style.setProperty('--font-size-p', `${sizes.p}pt`);
                    }
                }
                
                // Apply spacings
                if (optimization.spacings) {
                    const spacings = optimization.spacings;
                    if (spacings.module) {
                        document.getElementById('module-spacing').value = spacings.module;
                        document.getElementById('module-spacing-value').textContent = spacings.module;
                        document.documentElement.style.setProperty('--module-spacing', `${spacings.module}rem`);
                    }
                    if (spacings.item) {
                        document.getElementById('item-spacing').value = spacings.item;
                        document.getElementById('item-spacing-value').textContent = spacings.item;
                        document.documentElement.style.setProperty('--item-spacing', `${spacings.item}rem`);
                    }
                    if (spacings.paragraph) {
                        document.getElementById('paragraph-spacing').value = spacings.paragraph;
                        document.getElementById('paragraph-spacing-value').textContent = spacings.paragraph;
                        document.documentElement.style.setProperty('--paragraph-spacing', `${spacings.paragraph}rem`);
                    }
                }

                if (optimization.recommendations) {
                    showNotification(optimization.recommendations, "info", 5000);
                }
            }

            // Banner alignment buttons
            document.querySelectorAll('.banner-align-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.banner-align-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    updateAllStyles();
                });
            });

            // Logo size buttons
            document.querySelectorAll('.logo-size-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.logo-size-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    const size = btn.dataset.logoSize;
                    preview.bannerImg.className = `logo-${size}`;
                });
            });

            // Banner invert button
            controls.bannerInvertBtn.addEventListener('click', () => {
                controls.bannerInvertBtn.classList.toggle('active');
                updateAllStyles();
            });

            // Form inputs that update preview
            document.querySelectorAll('.cv-input, .banner-input').forEach(input => {
                input.addEventListener('input', () => updatePreview('form'));
            });

            // Modal event handlers
            document.getElementById('close-variants-modal')?.addEventListener('click', () => {
                document.getElementById('cv-variants-modal').classList.remove('active');
            });

            document.getElementById('close-translation-modal')?.addEventListener('click', () => {
                document.getElementById('translation-modal').classList.remove('active');
            });

            document.getElementById('close-score-modal')?.addEventListener('click', () => {
                document.getElementById('cv-score-modal').classList.remove('active');
            });

            document.getElementById('close-score-modal-btn')?.addEventListener('click', () => {
                document.getElementById('cv-score-modal').classList.remove('active');
            });

            document.getElementById('close-improvements-modal')?.addEventListener('click', () => {
                document.getElementById('improvements-modal').classList.remove('active');
            });

            document.getElementById('close-improvements-modal-btn')?.addEventListener('click', () => {
                document.getElementById('improvements-modal').classList.remove('active');
            });

            document.getElementById('close-skill-analysis-modal')?.addEventListener('click', () => {
                document.getElementById('skill-analysis-modal').classList.remove('active');
            });

            document.getElementById('close-skill-analysis-modal-btn')?.addEventListener('click', () => {
                document.getElementById('skill-analysis-modal').classList.remove('active');
            });

            // Translation functionality
            document.getElementById('start-translation-btn')?.addEventListener('click', async () => {
                const targetLang = document.getElementById('target-language-select').value;
                const currentCV = getCurrentCVData();
                
                showLoader("Traduction en cours...");
                
                const prompt = `Traduisez ce CV en ${targetLang} en conservant le professionnalisme et l'impact :

${JSON.stringify(currentCV)}

Retournez le CV traduit au même format JSON.`;

                const result = await callGeminiAPI(prompt);
                if (result) {
                    hideLoader();
                    applyTranslatedCV(result);
                    document.getElementById('translation-modal').classList.remove('active');
                    showNotification("CV traduit avec succès !", "success");
                } else {
                    hideLoader();
                }
            });

            document.getElementById('cancel-translation-btn')?.addEventListener('click', () => {
                document.getElementById('translation-modal').classList.remove('active');
            });

            // Helper functions for new features
            function addMottoToCV(motto) {
                const headerModule = document.getElementById('header-module');
                if (headerModule) {
                    const mottoDiv = document.createElement('div');
                    mottoDiv.className = 'motto-display';
                    mottoDiv.innerHTML = `<p>"${motto}"</p>`;
                    headerModule.appendChild(mottoDiv);
                }
            }

            function highlightKeywordsInCV(keywords) {
                const keywordList = keywords.split(',').map(k => k.trim());
                const textElements = document.querySelectorAll('#cv-description-preview, #cv-experience-preview, #cv-formation-preview');
                
                textElements.forEach(element => {
                    let html = element.innerHTML;
                    keywordList.forEach(keyword => {
                        const regex = new RegExp(`\\b(${keyword})\\b`, 'gi');
                        html = html.replace(regex, '<span class="keyword-highlight">$1</span>');
                    });
                    element.innerHTML = html;
                });
            }

            function applyTranslatedCV(translatedCV) {
                try {
                    const cv = typeof translatedCV === 'string' ? JSON.parse(translatedCV) : translatedCV;
                    
                    if (cv.nom) controls.nom.value = cv.nom;
                    if (cv.prenom) controls.prenom.value = cv.prenom;
                    if (cv.poste) controls.poste.value = cv.poste;
                    if (cv.description) controls.description.value = cv.description;
                    if (cv.competences) controls.competences.value = cv.competences;
                    
                    // Apply experiences
                    if (cv.experiences) {
                        controls.experienceList.innerHTML = '';
                        cv.experiences.forEach(exp => {
                            createDynamicItem(controls.experienceList, [
                                { key: 'title', placeholder: 'Titre du poste', type: 'input' },
                                { key: 'meta', placeholder: 'Entreprise - Période', type: 'input' },
                                { key: 'desc', placeholder: 'Description', type: 'textarea' }
                            ], exp);
                        });
                    }
                    
                    // Apply formations
                    if (cv.formations) {
                        controls.formationList.innerHTML = '';
                        cv.formations.forEach(form => {
                            createDynamicItem(controls.formationList, [
                                { key: 'title', placeholder: 'Diplôme/Formation', type: 'input' },
                                { key: 'meta', placeholder: 'École - Année', type: 'input' },
                                { key: 'desc', placeholder: 'Description (optionnel)', type: 'textarea' }
                            ], form);
                        });
                    }
                    
                    updatePreview('form');
                } catch (error) {
                    console.error('Error applying translated CV:', error);
                    showNotification("Erreur lors de l'application de la traduction.", "error");
                }
            }

            function showFontSuggestions(suggestions) {
                const container = document.createElement('div');
                container.className = 'font-suggestions mt-4 p-4 bg-blue-50 rounded-lg';
                container.innerHTML = `
                    <h4 class="font-bold mb-3">🎨 Suggestions de polices IA</h4>
                    <div class="space-y-2">
                        ${suggestions.map((suggestion, index) => `
                            <button class="font-suggestion-btn w-full text-left p-2 border rounded hover:bg-white" 
                                    data-h1="${suggestion.h1}" data-h2="${suggestion.h2}" data-body="${suggestion.body}">
                                <strong>${suggestion.name}</strong><br>
                                <small>H1: ${suggestion.h1} | H2: ${suggestion.h2} | Body: ${suggestion.body}</small>
                            </button>
                        `).join('')}
                    </div>
                `;

                // Insert suggestions after font controls
                const fontSection = document.querySelector('#completion-styles-fonts').closest('.control-group');
                fontSection.appendChild(container);

                // Add event listeners for font suggestions
                container.querySelectorAll('.font-suggestion-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        controls.fontFamilyH1Select.value = btn.dataset.h1;
                        controls.fontFamilyH2Select.value = btn.dataset.h2;
                        controls.fontFamilyBodySelect.value = btn.dataset.body;
                        updateAllStyles();
                        container.remove();
                        showNotification("Combinaison de polices appliquée !", "success");
                    });
                });

                // Auto-remove after 10 seconds
                setTimeout(() => {
                    if (container.parentNode) container.remove();
                }, 10000);
            }

            // Enhanced progress tracking
            function updateProgressBar() {
                const checkboxes = document.querySelectorAll('.completion-checkbox');
                const completed = document.querySelectorAll('.completion-checkbox:checked').length;
                const total = checkboxes.length;
                const percentage = total > 0 ? (completed / total) * 100 : 0;
                
                const progressBar = document.getElementById('progress-bar');
                const progressText = document.getElementById('progress-text');
                
                if (progressBar) {
                    progressBar.style.width = `${percentage}%`;
                    
                    // Change color based on progress
                    if (percentage < 30) {
                        progressBar.className = 'bg-red-500 h-2.5 rounded-full transition-all duration-300';
                    } else if (percentage < 70) {
                        progressBar.className = 'bg-yellow-500 h-2.5 rounded-full transition-all duration-300';
                    } else {
                        progressBar.className = 'bg-green-500 h-2.5 rounded-full transition-all duration-300';
                    }
                }
                
                if (progressText) {
                    progressText.textContent = `${completed}/${total} sections complétées`;
                }

                // Show celebration when 100% complete
                if (percentage === 100) {
                    setTimeout(() => {
                        showNotification("🎉 Félicitations ! Votre CV est complet !", "success", 5000);
                    }, 500);
                }
            }

            document.querySelectorAll('.completion-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', updateProgressBar);
            });

            // Dynamic event handlers for preview interactions
            document.addEventListener('click', (e) => {
                // AI action buttons
                if (e.target.closest('.ai-action-btn[data-action]')) {
                    const action = e.target.closest('.ai-action-btn[data-action]').dataset.action;
                    handleAIAction(action, e.target);
                }
                
                // Toggle visibility buttons
                if (e.target.closest('.toggle-visibility-btn')) {
                    const module = e.target.closest('.cv-module');
                    if (module) {
                        module.classList.toggle('section-hidden');
                        const icon = e.target.closest('.toggle-visibility-btn').querySelector('i');
                        icon.classList.toggle('fa-eye');
                        icon.classList.toggle('fa-eye-slash');
                    }
                }
                
                // Delete buttons
                if (e.target.closest('.remove-dynamic-item-btn, .delete-block-btn')) {
                    const item = e.target.closest('.p-2, .dynamic-preview-item, .dynamic-item-container');
                    if (item) {
                        item.remove();
                        updatePreview('form');
                    }
                }
                
                // Remove section buttons
                if (e.target.closest('.remove-section-btn')) {
                    const section = e.target.closest('[data-section-id]');
                    if (section) {
                        const sectionId = section.dataset.sectionId;
                        section.remove();
                        document.getElementById(sectionId)?.remove();
                        updatePreview('form');
                    }
                }
                
                // Add line buttons in preview
                if (e.target.closest('.add-line-preview-btn')) {
                    const btn = e.target.closest('.add-line-preview-btn');
                    const type = btn.dataset.type;
                    const index = parseInt(btn.dataset.index);
                    const container = type === 'experience' ? controls.experienceList : controls.formationList;
                    
                    const fields = type === 'experience' ? [
                        { key: 'title', placeholder: 'Titre du poste', type: 'input' },
                        { key: 'meta', placeholder: 'Entreprise - Période', type: 'input' },
                        { key: 'desc', placeholder: 'Description', type: 'textarea' }
                    ] : [
                        { key: 'title', placeholder: 'Diplôme/Formation', type: 'input' },
                        { key: 'meta', placeholder: 'École - Année', type: 'input' },
                        { key: 'desc', placeholder: 'Description (optionnel)', type: 'textarea' }
                    ];
                    
                    createDynamicItem(container, fields, {}, index);
                }
                
                // Remove skill buttons
                if (e.target.closest('.delete-skill-btn')) {
                    const skillItem = e.target.closest('.skill-item');
                    if (skillItem) {
                        skillItem.remove();
                        syncFormFromPreview(document.getElementById('cv-competences-preview'));
                    }
                }
                
                // Remove skill level buttons
                if (e.target.closest('.remove-skill-level-btn')) {
                    const skillLevel = e.target.closest('.skill-level-item');
                    if (skillLevel) {
                        skillLevel.remove();
                        updatePreview('form');
                    }
                }
                
                // Page remove buttons
                if (e.target.closest('.remove-page-btn')) {
                    const pageContainer = e.target.closest('.a4-page-container');
                    if (pageContainer && document.querySelectorAll('.a4-page-container').length > 1) {
                        pageContainer.remove();
                        checkAllPagesOverflow();
                    }
                }
            });

            // Input event for skill level sliders
            document.addEventListener('input', (e) => {
                if (e.target.classList.contains('skill-level-input')) {
                    const valueSpan = e.target.nextElementSibling;
                    if (valueSpan) {
                        valueSpan.textContent = `${e.target.value}/5`;
                    }
                    updatePreview('form');
                }
            });

            // Contenteditable sync
            document.addEventListener('input', (e) => {
                if (e.target.hasAttribute('contenteditable') && e.target.contentEditable === 'true') {
                    syncFormFromPreview(e.target);
                }
            });

            // Handle AI actions
            async function handleAIAction(action, button) {
                switch (action) {
                    case 'rewrite-profile':
                        if (!controls.description.value.trim()) {
                            showNotification("Veuillez saisir une description de profil d'abord.", "error");
                            return;
                        }
                        const profilePrompt = `Réécrivez cette description de profil professionnel pour la rendre plus percutante et professionnelle (maximum 100 mots) :
${controls.description.value}`;
                        const profileResult = await callGeminiAPI(profilePrompt);
                        if (profileResult) {
                            controls.description.value = profileResult;
                            updatePreview('form');
                            showNotification("Profil réécrit !", "success");
                        }
                        break;
                        
                    case 'summarize-experience':
                        const experiences = getDynamicData(controls.experienceList);
                        if (experiences.length === 0) {
                            showNotification("Aucune expérience à synthétiser.", "error");
                            return;
                        }
                        const expText = experiences.map(exp => `${exp.title} - ${exp.meta}: ${exp.desc}`).join('\n');
                        const expPrompt = `Synthétisez ces expériences professionnelles en maximum 5 lignes :
${expText}`;
                        const expResult = await callGeminiAPI(expPrompt);
                        if (expResult) {
                            controls.description.value = expResult;
                            updatePreview('form');
                            showNotification("Expériences synthétisées !", "success");
                        }
                        break;
                        
                    case 'rewrite-formation':
                        const formations = getDynamicData(controls.formationList);
                        if (formations.length === 0) {
                            showNotification("Aucune formation à améliorer.", "error");
                            return;
                        }
                        const formText = formations.map(form => `${form.title} - ${form.meta}`).join('\n');
                        const formPrompt = `Améliorez la présentation de ces formations pour un CV professionnel :
${formText}`;
                        const formResult = await callGeminiAPI(formPrompt);
                        if (formResult) {
                            // Parse and update formations
                            const lines = formResult.split('\n').filter(line => line.trim());
                            controls.formationList.innerHTML = '';
                            lines.forEach(line => {
                                const parts = line.split(' - ');
                                createDynamicItem(controls.formationList, [
                                    { key: 'title', placeholder: 'Diplôme/Formation', type: 'input' },
                                    { key: 'meta', placeholder: 'École - Année', type: 'input' },
                                    { key: 'desc', placeholder: 'Description (optionnel)', type: 'textarea' }
                                ], { title: parts[0] || '', meta: parts[1] || '', desc: '' });
                            });
                            updatePreview('form');
                            showNotification("Formations améliorées !", "success");
                        }
                        break;
                        
                    case 'rewrite-skills':
                        if (!controls.competences.value.trim()) {
                            showNotification("Aucune compétence à améliorer.", "error");
                            return;
                        }
                        const skillsPrompt = `Améliorez et réorganisez ces compétences pour un CV professionnel, en les regroupant par catégories :
${controls.competences.value}`;
                        const skillsResult = await callGeminiAPI(skillsPrompt);
                        if (skillsResult) {
                            controls.competences.value = skillsResult;
                            updatePreview('form');
                            showNotification("Compétences améliorées !", "success");
                        }
                        break;
                }
            }

            // Alias function for backward compatibility
            function populateFontSelects() {
                populateFontSelectors();
            }

            // Initialize everything
            reinitializePreviewSelectors(); // Initialize preview selectors first
            populateFontSelects();
            populateIconPicker();
            setDefaultRecruiterInfo();
            updatePreview('form');
            updateAllStyles();
            
            // Initialize drag & drop for all pages
            initializeAllSortable();
            setupAllResizers();
            
        });
    </script>

    <script>
        // Splash Screen Management
        class SplashScreen {
            constructor() {
                this.splashElement = document.getElementById('splash-screen');
                this.progressBar = document.getElementById('splash-progress');
                this.loadingText = document.getElementById('splash-loading-text');
                this.progress = 0;
                this.loadingSteps = [
                    { text: "Initialisation...", duration: 500 },
                    { text: "Chargement des ressources...", duration: 800 },
                    { text: "Configuration de l'interface...", duration: 600 },
                    { text: "Préparation de l'IA...", duration: 700 },
                    { text: "Finalisation...", duration: 400 }
                ];
                this.init();
            }

            init() {
                this.startLoading();
            }

            async startLoading() {
                const totalSteps = this.loadingSteps.length;
                let currentStep = 0;

                for (const step of this.loadingSteps) {
                    this.loadingText.textContent = step.text;
                    
                    // Animer la progression
                    const targetProgress = ((currentStep + 1) / totalSteps) * 100;
                    await this.animateProgress(targetProgress);
                    
                    // Attendre le temps défini pour cette étape
                    await this.delay(step.duration);
                    currentStep++;
                }

                // Attendre un peu avant de faire disparaître l'écran
                await this.delay(500);
                this.hideSplash();
            }

            animateProgress(targetProgress) {
                return new Promise(resolve => {
                    const startProgress = this.progress;
                    const progressDiff = targetProgress - startProgress;
                    const duration = 300; // durée de l'animation en ms
                    const startTime = Date.now();

                    const animate = () => {
                        const elapsed = Date.now() - startTime;
                        const progress = Math.min(elapsed / duration, 1);
                        
                        // Fonction d'easing pour une animation plus fluide
                        const easeProgress = 1 - Math.pow(1 - progress, 3);
                        
                        this.progress = startProgress + (progressDiff * easeProgress);
                        this.progressBar.style.width = this.progress + '%';

                        if (progress < 1) {
                            requestAnimationFrame(animate);
                        } else {
                            resolve();
                        }
                    };

                    requestAnimationFrame(animate);
                });
            }

            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }

            hideSplash() {
                this.splashElement.classList.add('fade-out');
                setTimeout(() => {
                    this.splashElement.style.display = 'none';
                    // Déclencher l'événement personnalisé pour indiquer que le chargement est terminé
                    document.dispatchEvent(new CustomEvent('splashScreenHidden'));
                }, 800);
            }
        }

        // Initialiser l'écran de chargement dès que le DOM est chargé
        document.addEventListener('DOMContentLoaded', () => {
            new SplashScreen();
        });

        // S'assurer que l'écran de chargement se cache même si tout est déjà chargé
        window.addEventListener('load', () => {
            // Si l'écran de chargement est toujours visible après 5 secondes, le forcer à disparaître
            setTimeout(() => {
                const splashScreen = document.getElementById('splash-screen');
                if (splashScreen && !splashScreen.classList.contains('fade-out')) {
                    splashScreen.classList.add('fade-out');
                    setTimeout(() => {
                        splashScreen.style.display = 'none';
                    }, 800);
                }
            }, 5000);
        });

        // Advanced AI Chat System JavaScript
        class AdvancedAIChat {
            constructor() {
                this.isOpen = false;
                this.isDragging = false;
                this.dragOffset = { x: 0, y: 0 };
                this.init();
            }

            init() {
                // Vérification de l'existence des éléments DOM
                this.floatBtn = document.getElementById('ai-chat-float-btn');
                this.chatContainer = document.getElementById('ai-chat-container');
                this.closeBtn = document.getElementById('ai-chat-close-btn');
                this.header = document.getElementById('ai-chat-header');
                this.messagesContainer = document.getElementById('ai-chat-messages');
                this.input = document.getElementById('ai-chat-input');
                this.sendBtn = document.getElementById('ai-chat-send-btn');
                this.voiceBtn = document.getElementById('ai-voice-btn');
                this.smartSuggestBtn = document.getElementById('ai-smart-suggest-btn');
                this.quickFixBtn = document.getElementById('ai-quick-fix-btn');

                // Vérification que tous les éléments essentiels sont présents
                if (!this.floatBtn || !this.chatContainer || !this.input || !this.sendBtn) {
                    console.error('Chat IA : Éléments DOM manquants pour l\'initialisation');
                    return;
                }

                this.setupEventListeners();
                this.loadChatPosition();
                this.initializeVoiceRecognition();
                
                // S'assurer que le bouton est visible après l'initialisation
                setTimeout(() => {
                    this.adjustPositionsOnResize();
                }, 100);
            }

            setupEventListeners() {
                // Protection contre les éléments manquants
                if (!this.floatBtn || !this.chatContainer || !this.input || !this.sendBtn) return;
                
                // Float button drag functionality
                this.floatBtn.addEventListener('mousedown', this.startDragFloatBtn.bind(this));
                this.floatBtn.addEventListener('click', this.toggleChat.bind(this));
                
                // Chat window drag functionality
                if (this.header) {
                    this.header.addEventListener('mousedown', this.startDragChat.bind(this));
                }
                
                // Close button
                if (this.closeBtn) {
                    this.closeBtn.addEventListener('click', this.closeChat.bind(this));
                }
                
                // Send message functionality
                this.sendBtn.addEventListener('click', this.sendMessage.bind(this));
                this.input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });

                // Voice recognition
                if (this.voiceBtn) {
                    this.voiceBtn.addEventListener('click', this.toggleVoiceRecognition.bind(this));
                }
                
                // Smart suggestions
                if (this.smartSuggestBtn) {
                    this.smartSuggestBtn.addEventListener('click', this.generateSmartSuggestions.bind(this));
                }
                
                // Quick fix
                if (this.quickFixBtn) {
                    this.quickFixBtn.addEventListener('click', this.performQuickFix.bind(this));
                }

                // Auto-resize textarea
                this.input.addEventListener('input', this.autoResizeTextarea.bind(this));

                // Suggestion chips
                document.addEventListener('click', (e) => {
                    if (e.target.classList.contains('suggestion-chip')) {
                        this.input.value = e.target.dataset.suggestion;
                        this.sendMessage();
                    }
                });

                // Global mouse events for dragging
                document.addEventListener('mousemove', this.handleDrag.bind(this));
                document.addEventListener('mouseup', this.stopDrag.bind(this));
                
                // Window resize event to keep elements in screen
                window.addEventListener('resize', this.adjustPositionsOnResize.bind(this));
            }

            startDragFloatBtn(e) {
                this.isDragging = true;
                this.dragTarget = 'float';
                this.floatBtn.classList.add('dragging');
                
                const rect = this.floatBtn.getBoundingClientRect();
                this.dragOffset = {
                    x: e.clientX - rect.left,
                    y: e.clientY - rect.top
                };
                e.preventDefault();
            }

            startDragChat(e) {
                this.isDragging = true;
                this.dragTarget = 'chat';
                
                const rect = this.chatContainer.getBoundingClientRect();
                this.dragOffset = {
                    x: e.clientX - rect.left,
                    y: e.clientY - rect.top
                };
                e.preventDefault();
            }

            handleDrag(e) {
                if (!this.isDragging) return;

                if (this.dragTarget === 'float') {
                    const x = e.clientX - this.dragOffset.x;
                    const y = e.clientY - this.dragOffset.y;
                    
                    const maxX = window.innerWidth - this.floatBtn.offsetWidth;
                    const maxY = window.innerHeight - this.floatBtn.offsetHeight;
                    
                    this.floatBtn.style.left = Math.max(0, Math.min(x, maxX)) + 'px';
                    this.floatBtn.style.top = Math.max(0, Math.min(y, maxY)) + 'px';
                    this.floatBtn.style.right = 'auto';
                    this.floatBtn.style.bottom = 'auto';
                } else if (this.dragTarget === 'chat') {
                    const x = e.clientX - this.dragOffset.x;
                    const y = e.clientY - this.dragOffset.y;
                    
                    const maxX = window.innerWidth - this.chatContainer.offsetWidth;
                    const maxY = window.innerHeight - this.chatContainer.offsetHeight;
                    
                    this.chatContainer.style.left = Math.max(0, Math.min(x, maxX)) + 'px';
                    this.chatContainer.style.top = Math.max(0, Math.min(y, maxY)) + 'px';
                    this.chatContainer.style.right = 'auto';
                    this.chatContainer.style.bottom = 'auto';
                }
            }

            stopDrag() {
                if (this.isDragging) {
                    this.isDragging = false;
                    this.floatBtn.classList.remove('dragging');
                    this.saveChatPosition();
                }
            }

            toggleChat() {
                if (this.isDragging) return;
                
                if (this.isOpen) {
                    this.closeChat();
                } else {
                    this.openChat();
                }
            }

            openChat() {
                this.chatContainer.classList.add('show');
                this.isOpen = true;
                this.input.focus();
            }

            closeChat() {
                this.chatContainer.classList.remove('show');
                this.isOpen = false;
            }

            autoResizeTextarea() {
                this.input.style.height = 'auto';
                this.input.style.height = Math.min(this.input.scrollHeight, 100) + 'px';
            }

            addMessage(content, isUser = false, isThinking = false) {
                if (!this.messagesContainer) {
                    console.error('Chat IA : Container de messages manquant');
                    return null;
                }
                
                const messageDiv = document.createElement('div');
                messageDiv.className = `chat-message ${isUser ? 'user' : 'ai'}${isThinking ? ' thinking' : ''}`;
                
                if (isThinking) {
                    messageDiv.innerHTML = `
                        <div class="chat-typing-indicator">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                    `;
                } else {
                    messageDiv.innerHTML = content;
                }
                
                this.messagesContainer.appendChild(messageDiv);
                this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
                
                return messageDiv;
            }

            async sendMessage() {
                const message = this.input.value.trim();
                if (!message) return;

                this.addMessage(message, true);
                this.input.value = '';
                this.autoResizeTextarea();

                const thinkingMessage = this.addMessage('', false, true);
                this.sendBtn.disabled = true;

                try {
                    const response = await this.processAIRequest(message);
                    thinkingMessage.remove();
                    this.addMessage(response, false);
                } catch (error) {
                    thinkingMessage.remove();
                    this.addMessage(`❌ Erreur : ${error.message}`, false);
                } finally {
                    this.sendBtn.disabled = false;
                }
            }

            async processAIRequest(userMessage) {
                // Vérifier d'abord si l'API Gemini est configurée
                const apiKey = localStorage.getItem('gemini-api-key');
                if (!apiKey) {
                    throw new Error('Clé API Gemini non configurée. Allez dans l\'onglet "IA" > "Configuration API Gemini" pour configurer votre clé API.');
                }
                
                const cvData = this.extractCVData();
                const analysisData = this.performDeepAnalysis();
                
                // Analyser le type de demande pour adapter la réponse
                const requestType = this.categorizeRequest(userMessage);
                
                let prompt = `Tu es un expert en création de CV, recrutement et design graphique avec 20 ans d'expérience. Tu peux modifier directement le CV en temps réel.

DEMANDE DE L'UTILISATEUR: "${userMessage}"

CONTENU ACTUEL DU CV:
${cvData}

ANALYSE TECHNIQUE DU CV:
${analysisData}

INSTRUCTIONS SPÉCIALES:
- Tu peux modifier DIRECTEMENT le contenu du CV
- Pour les modifications, utilise les balises [MODIFY:champ:nouveau_contenu] 
- Pour ajouter des expériences: [ADD_EXPERIENCE:titre|entreprise-période|description]
- Pour ajouter des formations: [ADD_FORMATION:diplôme|école-année|description]
- Pour modifier la mise en page: [LAYOUT:type] (1-col, 2-col-33-67, 2-col-50-50, 2-col-67-33)
- Pour changer les couleurs: [COLORS:primaire|secondaire|texte]
- Pour changer les polices: [FONTS:h1|h2|body]
- Pour réorganiser les sections: [REORDER:section1,section2,section3...]

CAPACITÉS AVANCÉES:
1. Analyse sectorielle et optimisation pour un métier spécifique
2. Détection automatique des faiblesses et suggestions d'amélioration
3. Optimisation ATS (Applicant Tracking System)
4. Conseils de design et lisibilité
5. Adaptation au niveau d'expérience (junior, senior, expert)
6. Optimisation par mots-clés sectoriels

TYPES DE DEMANDES QUE TU PEUX TRAITER:
- Modification de contenu (textes, descriptions, etc.)
- Ajout/suppression d'éléments
- Changement de mise en page et design
- Optimisation pour un poste/secteur spécifique
- Réorganisation des sections
- Amélioration de la lisibilité
- Correction d'erreurs grammaticales/orthographiques
- Suggestions de compétences manquantes
- Adaptation du ton (formel, créatif, technique...)

Réponds de manière proactive et applique directement les modifications nécessaires.`;

                const result = await window.callGeminiAPI(prompt);
                
                if (result) {
                    await this.parseAndApplyAdvancedSuggestions(result, userMessage);
                    return result;
                } else {
                    throw new Error("Impossible de générer une réponse IA. Vérifiez votre clé API Gemini.");
                }
            }

            extractCVData() {
                const data = {
                    nom: document.getElementById('nom')?.value || '',
                    prenom: document.getElementById('prenom')?.value || '',
                    poste: document.getElementById('poste')?.value || '',
                    email: document.getElementById('email')?.value || '',
                    telephone: document.getElementById('telephone')?.value || '',
                    description: document.getElementById('description')?.value || '',
                    competences: document.getElementById('competences')?.value || '',
                    experiences: this.extractDynamicData('experience'),
                    formations: this.extractDynamicData('formation')
                };

                return `
Nom: ${data.prenom} ${data.nom}
Poste: ${data.poste}
Email: ${data.email}
Téléphone: ${data.telephone}

Profil professionnel:
${data.description}

Compétences:
${data.competences}

Expériences:
${data.experiences.map(exp => `- ${exp.title} (${exp.meta}): ${exp.desc}`).join('\n')}

Formations:
${data.formations.map(form => `- ${form.title} (${form.meta}): ${form.desc}`).join('\n')}
                `.trim();
            }

            extractDynamicData(type) {
                const container = document.getElementById(`${type}-list`);
                if (!container) return [];

                const items = [];
                const itemElements = container.querySelectorAll('.p-2');
                
                itemElements.forEach(item => {
                    const titleElement = item.querySelector(`[id*="${type}-title-"]`);
                    const metaElement = item.querySelector(`[id*="${type}-meta-"]`);
                    const descElement = item.querySelector(`[id*="${type}-desc-"]`);
                    
                    const title = titleElement ? titleElement.value || '' : '';
                    const meta = metaElement ? metaElement.value || '' : '';
                    const desc = descElement ? descElement.value || '' : '';
                    
                    if (title) items.push({ title, meta, desc });
                });
                return items;
            }

            categorizeRequest(message) {
                const lower = message.toLowerCase();
                
                if (lower.includes('couleur') || lower.includes('color') || lower.includes('design')) return 'design';
                if (lower.includes('police') || lower.includes('font')) return 'typography';
                if (lower.includes('mise en page') || lower.includes('layout') || lower.includes('colonnes')) return 'layout';
                if (lower.includes('expérience') || lower.includes('travail') || lower.includes('emploi')) return 'experience';
                if (lower.includes('formation') || lower.includes('diplôme') || lower.includes('école')) return 'education';
                if (lower.includes('compétence') || lower.includes('skill')) return 'skills';
                if (lower.includes('profil') || lower.includes('description') || lower.includes('résumé')) return 'profile';
                if (lower.includes('optimis') || lower.includes('amélio') || lower.includes('poste')) return 'optimization';
                if (lower.includes('secteur') || lower.includes('industrie') || lower.includes('métier')) return 'sector';
                return 'general';
            }

            performDeepAnalysis() {
                const preview = document.querySelector('#cv-preview');
                const sections = preview ? preview.querySelectorAll('.cv-module') : [];
                
                const analysis = {
                    sectionsCount: sections.length,
                    currentLayout: this.getCurrentLayout(),
                    currentTheme: this.getCurrentTheme(),
                    currentFonts: this.getCurrentFonts(),
                    contentAnalysis: this.analyzeContent(),
                    designAnalysis: this.analyzeDesign(),
                    missingElements: this.detectMissingElements()
                };

                return `
Nombre de sections: ${analysis.sectionsCount}
Mise en page actuelle: ${analysis.currentLayout}
Thème actuel: ${analysis.currentTheme}
Polices actuelles: H1=${analysis.currentFonts.h1}, H2=${analysis.currentFonts.h2}, Body=${analysis.currentFonts.body}

Analyse du contenu:
${analysis.contentAnalysis}

Analyse du design:
${analysis.designAnalysis}

Éléments manquants détectés:
${analysis.missingElements}
                `;
            }

            getCurrentLayout() {
                const container = document.querySelector('.cv-body-container');
                if (!container) return 'Layout non défini';
                
                if (container.classList.contains('layout-1-col')) return '1 colonne';
                if (container.classList.contains('layout-2-col-33-67')) return '2 colonnes (33%-67%)';
                if (container.classList.contains('layout-2-col-50-50')) return '2 colonnes (50%-50%)';
                if (container.classList.contains('layout-2-col-67-33')) return '2 colonnes (67%-33%)';
                return 'Layout personnalisé';
            }

            getCurrentTheme() {
                const body = document.body;
                if (body.classList.contains('theme-elegant')) return 'Élégant';
                if (body.classList.contains('theme-tech')) return 'Tech';
                if (body.classList.contains('theme-luxury')) return 'Luxe';
                if (body.classList.contains('theme-startup')) return 'Startup';
                if (body.classList.contains('theme-academic')) return 'Académique';
                if (body.classList.contains('theme-artistic')) return 'Artistique';
                return 'Standard';
            }

            getCurrentFonts() {
                try {
                    const styles = getComputedStyle(document.documentElement);
                    return {
                        h1: styles.getPropertyValue('--font-family-h1').trim() || 'Non défini',
                        h2: styles.getPropertyValue('--font-family-h2').trim() || 'Non défini',
                        body: styles.getPropertyValue('--font-family-body').trim() || 'Non défini'
                    };
                } catch (error) {
                    return {
                        h1: 'Non défini',
                        h2: 'Non défini',
                        body: 'Non défini'
                    };
                }
            }

            analyzeContent() {
                const issues = [];
                const suggestions = [];

                // Analyser le profil
                const profile = document.getElementById('description')?.value;
                if (!profile || profile.length < 50) {
                    issues.push('Profil professionnel trop court ou manquant');
                    suggestions.push('Ajouter une description professionnelle de 80-120 mots');
                }

                // Analyser les expériences
                const experiences = this.extractDynamicData('experience');
                if (experiences.length === 0) {
                    issues.push('Aucune expérience professionnelle');
                } else if (experiences.length < 2) {
                    suggestions.push('Ajouter plus d\'expériences si disponibles');
                }

                // Analyser les formations
                const formations = this.extractDynamicData('formation');
                if (formations.length === 0) {
                    issues.push('Aucune formation mentionnée');
                }

                return `Problèmes détectés: ${issues.join(', ') || 'Aucun'}\nSuggestions: ${suggestions.join(', ') || 'Contenu satisfaisant'}`;
            }

            analyzeDesign() {
                const issues = [];
                const suggestions = [];

                // Vérifier la lisibilité
                const primaryColor = getComputedStyle(document.documentElement).getPropertyValue('--primary-color');
                const secondaryColor = getComputedStyle(document.documentElement).getPropertyValue('--secondary-color');
                
                if (primaryColor === secondaryColor) {
                    issues.push('Couleurs primaire et secondaire identiques');
                }

                // Vérifier l'équilibre des colonnes
                const layout = this.getCurrentLayout();
                const contentDensity = this.analyzeContentDensity();
                
                if (contentDensity.leftHeavy && layout.includes('67%-33%')) {
                    suggestions.push('Rééquilibrer le contenu entre les colonnes');
                }

                return `Design: ${issues.join(', ') || 'Bon équilibre'}\nAméliorations possibles: ${suggestions.join(', ') || 'Design optimal'}`;
            }

            analyzeContentDensity() {
                const leftColumn = document.querySelector('.cv-column:first-child');
                const rightColumn = document.querySelector('.cv-column:last-child');
                
                if (!leftColumn || !rightColumn) return { balanced: true };

                const leftContent = leftColumn.textContent ? leftColumn.textContent.length : 0;
                const rightContent = rightColumn.textContent ? rightColumn.textContent.length : 0;
                
                return {
                    leftHeavy: leftContent > rightContent * 1.5,
                    rightHeavy: rightContent > leftContent * 1.5,
                    balanced: Math.abs(leftContent - rightContent) / Math.max(leftContent, rightContent) < 0.3
                };
            }

            detectMissingElements() {
                const missing = [];
                
                if (!document.getElementById('nom')?.value) missing.push('Nom');
                if (!document.getElementById('email')?.value) missing.push('Email');
                if (!document.getElementById('telephone')?.value) missing.push('Téléphone');
                if (!document.getElementById('poste')?.value) missing.push('Intitulé de poste');
                
                const competences = document.getElementById('competences')?.value;
                if (!competences || competences.trim().length < 10) {
                    missing.push('Compétences détaillées');
                }

                return missing.length > 0 ? missing.join(', ') : 'Tous les éléments essentiels sont présents';
            }

            async parseAndApplyAdvancedSuggestions(aiResponse, userRequest) {
                // Expressions régulières pour détecter les commandes
                const modifyRegex = /\[MODIFY:(\w+):([^\]]+)\]/g;
                const addExpRegex = /\[ADD_EXPERIENCE:([^|]+)\|([^|]+)\|([^\]]+)\]/g;
                const addFormRegex = /\[ADD_FORMATION:([^|]+)\|([^|]+)\|([^\]]+)\]/g;
                const layoutRegex = /\[LAYOUT:([^\]]+)\]/g;
                const colorsRegex = /\[COLORS:([^|]+)\|([^|]+)\|([^\]]+)\]/g;
                const fontsRegex = /\[FONTS:([^|]+)\|([^|]+)\|([^\]]+)\]/g;
                const reorderRegex = /\[REORDER:([^\]]+)\]/g;

                let modificationsApplied = [];

                // Traiter les modifications de champs
                let match;
                while ((match = modifyRegex.exec(aiResponse)) !== null) {
                    const [, field, newContent] = match;
                    await this.modifyField(field, newContent);
                    modificationsApplied.push(`${field} modifié`);
                }

                // Ajouter des expériences
                while ((match = addExpRegex.exec(aiResponse)) !== null) {
                    const [, titre, meta, description] = match;
                    await this.addExperience(titre, meta, description);
                    modificationsApplied.push(`Expérience "${titre}" ajoutée`);
                }

                // Ajouter des formations
                while ((match = addFormRegex.exec(aiResponse)) !== null) {
                    const [, diplome, meta, description] = match;
                    await this.addFormation(diplome, meta, description);
                    modificationsApplied.push(`Formation "${diplome}" ajoutée`);
                }

                // Changer la mise en page
                while ((match = layoutRegex.exec(aiResponse)) !== null) {
                    const [, layoutType] = match;
                    await this.changeLayout(layoutType);
                    modificationsApplied.push(`Mise en page changée: ${layoutType}`);
                }

                // Changer les couleurs
                while ((match = colorsRegex.exec(aiResponse)) !== null) {
                    const [, primary, secondary, text] = match;
                    await this.changeColors(primary, secondary, text);
                    modificationsApplied.push(`Couleurs mises à jour`);
                }

                // Changer les polices
                while ((match = fontsRegex.exec(aiResponse)) !== null) {
                    const [, h1, h2, body] = match;
                    await this.changeFonts(h1, h2, body);
                    modificationsApplied.push(`Polices mises à jour`);
                }

                // Auto-modifications intelligentes basées sur le contexte
                await this.applyIntelligentModifications(userRequest, aiResponse);

                if (modificationsApplied.length > 0) {
                    window.showNotification(`🤖 IA: ${modificationsApplied.join(', ')}`, "success", 4000);
                }

                // Mise à jour de l'aperçu
                window.updatePreview('form');
            }

            async modifyField(field, newContent) {
                const element = document.getElementById(field);
                if (element) {
                    element.value = newContent.trim();
                    // Déclencher l'événement de changement pour mettre à jour l'aperçu
                    element.dispatchEvent(new Event('input', { bubbles: true }));
                }
            }

            async addExperience(titre, meta, description) {
                const container = document.getElementById('experience-list');
                if (container) {
                    const fields = [
                        { key: 'title', placeholder: 'Titre du poste', type: 'input' },
                        { key: 'meta', placeholder: 'Entreprise - Période', type: 'input' },
                        { key: 'desc', placeholder: 'Description', type: 'textarea' }
                    ];
                    const data = { title: titre, meta: meta, desc: description };
                    window.createDynamicItem(container, fields, data);
                }
            }

            async addFormation(diplome, meta, description) {
                const container = document.getElementById('formation-list');
                if (container) {
                    const fields = [
                        { key: 'title', placeholder: 'Diplôme/Formation', type: 'input' },
                        { key: 'meta', placeholder: 'École - Année', type: 'input' },
                        { key: 'desc', placeholder: 'Description (optionnel)', type: 'textarea' }
                    ];
                    const data = { title: diplome, meta: meta, desc: description };
                    window.createDynamicItem(container, fields, data);
                }
            }

            async changeLayout(layoutType) {
                const container = document.querySelector('.cv-body-container');
                if (!container) return;
                
                // Supprimer toutes les classes de layout existantes
                container.classList.remove('layout-1-col', 'layout-2-col-33-67', 'layout-2-col-50-50', 'layout-2-col-67-33');
                
                // Ajouter la nouvelle classe de layout
                const layoutMap = {
                    '1-col': 'layout-1-col',
                    '2-col-33-67': 'layout-2-col-33-67',
                    '2-col-50-50': 'layout-2-col-50-50',
                    '2-col-67-33': 'layout-2-col-67-33'
                };
                
                const layoutClass = layoutMap[layoutType] || 'layout-2-col-50-50';
                container.classList.add(layoutClass);
                
                // Mettre à jour les boutons de layout s'ils existent
                const layoutButtons = document.querySelectorAll('.layout-btn');
                if (layoutButtons.length > 0) {
                    layoutButtons.forEach(btn => {
                        btn.classList.remove('active');
                        if (btn.dataset.layout === layoutType) {
                            btn.classList.add('active');
                        }
                    });
                }
            }

            async changeColors(primary, secondary, text) {
                const root = document.documentElement;
                
                // Convertir les noms de couleurs en codes hex si nécessaire
                const colorMap = {
                    'bleu': '#2563eb', 'rouge': '#dc2626', 'vert': '#16a34a', 'violet': '#7c3aed',
                    'orange': '#ea580c', 'rose': '#e91e63', 'cyan': '#0891b2', 'jaune': '#ca8a04',
                    'gris': '#64748b', 'noir': '#1f2937', 'blanc': '#ffffff'
                };
                
                const convertColor = (color) => {
                    const cleanColor = color.toLowerCase().trim();
                    return colorMap[cleanColor] || (cleanColor.startsWith('#') ? cleanColor : `#${cleanColor}`);
                };

                root.style.setProperty('--primary-color', convertColor(primary));
                root.style.setProperty('--secondary-color', convertColor(secondary));
                root.style.setProperty('--body-text-color', convertColor(text));

                // Mettre à jour les sélecteurs de couleur
                const primaryPicker = document.getElementById('primary-color');
                const secondaryPicker = document.getElementById('secondary-color');
                const textPicker = document.getElementById('body-text-color');
                
                if (primaryPicker) primaryPicker.value = convertColor(primary);
                if (secondaryPicker) secondaryPicker.value = convertColor(secondary);
                if (textPicker) textPicker.value = convertColor(text);
            }

            async changeFonts(h1Font, h2Font, bodyFont) {
                const root = document.documentElement;
                
                // Mapper les noms de polices aux valeurs CSS
                const fontMap = {
                    'montserrat': "'Montserrat', sans-serif",
                    'lato': "'Lato', sans-serif",
                    'roboto': "'Roboto', sans-serif",
                    'open sans': "'Open Sans', sans-serif",
                    'playfair': "'Playfair Display', serif",
                    'merriweather': "'Merriweather', serif",
                    'oswald': "'Oswald', sans-serif"
                };

                const convertFont = (font) => {
                    const cleanFont = font.toLowerCase().trim();
                    return fontMap[cleanFont] || font;
                };

                root.style.setProperty('--font-family-h1', convertFont(h1Font));
                root.style.setProperty('--font-family-h2', convertFont(h2Font));
                root.style.setProperty('--font-family-body', convertFont(bodyFont));

                // Mettre à jour les sélecteurs de polices
                const h1Select = document.getElementById('font-family-h1');
                const h2Select = document.getElementById('font-family-h2');
                const bodySelect = document.getElementById('font-family-body');
                
                if (h1Select) h1Select.value = convertFont(h1Font);
                if (h2Select) h2Select.value = convertFont(h2Font);
                if (bodySelect) bodySelect.value = convertFont(bodyFont);
            }

            async applyIntelligentModifications(userRequest, aiResponse) {
                const lowerRequest = userRequest.toLowerCase();
                
                // Détection et amélioration automatique du profil
                if (lowerRequest.includes('profil') || lowerRequest.includes('description') || lowerRequest.includes('résumé')) {
                    const improvedProfile = this.extractImprovedContent(aiResponse, ['profil amélioré', 'description améliorée', 'nouveau profil']);
                    if (improvedProfile) {
                        await this.modifyField('description', improvedProfile);
                    }
                }

                // Détection et amélioration automatique des compétences
                if (lowerRequest.includes('compétence') || lowerRequest.includes('skill')) {
                    const improvedSkills = this.extractImprovedContent(aiResponse, ['compétences améliorées', 'skills améliorés', 'nouvelles compétences']);
                    if (improvedSkills) {
                        await this.modifyField('competences', improvedSkills);
                    }
                }

                // Optimisation automatique pour un secteur
                if (lowerRequest.includes('secteur') || lowerRequest.includes('industrie') || lowerRequest.includes('métier')) {
                    await this.optimizeForSector(userRequest, aiResponse);
                }

                // Amélioration automatique du design si demandé
                if (lowerRequest.includes('design') || lowerRequest.includes('apparence') || lowerRequest.includes('visuel')) {
                    await this.applyDesignImprovements(aiResponse);
                }

                // Correction automatique des erreurs détectées
                if (lowerRequest.includes('corriger') || lowerRequest.includes('améliorer') || lowerRequest.includes('optimiser')) {
                    await this.autoCorrectIssues();
                }
            }

            extractImprovedContent(aiResponse, keywords) {
                for (const keyword of keywords) {
                    const regex = new RegExp(`${keyword}:?\\s*["""]([^"""]+)["""]`, 'i');
                    const match = aiResponse.match(regex);
                    if (match) return match[1].trim();
                    
                    const regex2 = new RegExp(`${keyword}:?\\s*([^\\n]{20,200})`, 'i');
                    const match2 = aiResponse.match(regex2);
                    if (match2) return match2[1].trim();
                }
                return null;
            }

            async optimizeForSector(userRequest, aiResponse) {
                // Extraire le secteur mentionné
                const sectorKeywords = {
                    'tech': ['technologie', 'informatique', 'développement', 'programmation'],
                    'commercial': ['vente', 'commercial', 'business', 'marketing'],
                    'finance': ['finance', 'banque', 'comptabilité', 'audit'],
                    'santé': ['santé', 'médical', 'soins', 'hôpital'],
                    'education': ['éducation', 'enseignement', 'formation', 'pédagogie']
                };

                let detectedSector = null;
                for (const [sector, keywords] of Object.entries(sectorKeywords)) {
                    if (keywords.some(keyword => userRequest.toLowerCase().includes(keyword))) {
                        detectedSector = sector;
                        break;
                    }
                }

                if (detectedSector) {
                    await this.applySectorOptimization(detectedSector);
                }
            }

            async applySectorOptimization(sector) {
                const optimizations = {
                    'tech': {
                        colors: ['#2563eb', '#1e40af', '#1f2937'],
                        fonts: ['Roboto Mono', 'Lato', 'Open Sans'],
                        layout: '2-col-67-33'
                    },
                    'commercial': {
                        colors: ['#dc2626', '#991b1b', '#374151'],
                        fonts: ['Montserrat', 'Montserrat', 'Lato'],
                        layout: '2-col-50-50'
                    },
                    'finance': {
                        colors: ['#1e40af', '#1e3a8a', '#1f2937'],
                        fonts: ['Merriweather', 'Lato', 'Open Sans'],
                        layout: '2-col-33-67'
                    }
                };

                const config = optimizations[sector];
                if (config) {
                    await this.changeColors(config.colors[0], config.colors[1], config.colors[2]);
                    await this.changeFonts(config.fonts[0], config.fonts[1], config.fonts[2]);
                    await this.changeLayout(config.layout);
                }
            }

            async applyDesignImprovements(aiResponse) {
                // Détecter les suggestions de design dans la réponse
                if (aiResponse.toLowerCase().includes('moderne')) {
                    await this.changeColors('#667eea', '#764ba2', '#2d3748');
                }
                if (aiResponse.toLowerCase().includes('professionnel')) {
                    await this.changeColors('#2563eb', '#1e40af', '#1f2937');
                }
                if (aiResponse.toLowerCase().includes('créatif')) {
                    await this.changeColors('#e91e63', '#9c27b0', '#424242');
                }
            }

            async autoCorrectIssues() {
                // Correction automatique des problèmes courants
                const analysis = this.performDeepAnalysis();
                
                // Vérifier si le profil est trop court
                const profile = document.getElementById('description')?.value;
                if (!profile || profile.length < 50) {
                    // Générer un profil automatique basé sur les données existantes
                    await this.generateAutoProfile();
                }

                // Optimiser la mise en page selon le contenu
                const contentDensity = this.analyzeContentDensity();
                if (contentDensity.leftHeavy) {
                    await this.changeLayout('2-col-50-50');
                } else if (contentDensity.rightHeavy) {
                    await this.changeLayout('2-col-67-33');
                }
            }

            async generateAutoProfile() {
                const nom = document.getElementById('nom')?.value || '';
                const prenom = document.getElementById('prenom')?.value || '';
                const poste = document.getElementById('poste')?.value || '';
                const experiences = this.extractDynamicData('experience');
                
                if (poste && experiences.length > 0) {
                    const autoProfile = `Professionnel ${poste.toLowerCase()} avec ${experiences.length > 2 ? 'plusieurs années' : 'une expérience'} d'expérience. Passionné par l'excellence et l'innovation, je mets mes compétences au service de projets ambitieux pour contribuer au succès de l'entreprise.`;
                    
                    await this.modifyField('description', autoProfile);
                    this.addMessage(`✨ J'ai généré automatiquement un profil professionnel basé sur vos informations.`, false);
                }
            }

            initializeVoiceRecognition() {
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    this.recognition = new SpeechRecognition();
                    this.recognition.continuous = false;
                    this.recognition.interimResults = false;
                    this.recognition.lang = 'fr-FR';

                    this.recognition.onresult = (event) => {
                        const transcript = event.results[0][0].transcript;
                        this.input.value = transcript;
                        this.sendMessage();
                        this.voiceBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                        this.voiceBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                    };

                    this.recognition.onerror = () => {
                        this.voiceBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                        this.voiceBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                        this.addMessage('❌ Erreur de reconnaissance vocale. Veuillez réessayer.', false);
                    };
                } else {
                    this.voiceBtn.style.display = 'none';
                }
            }

            toggleVoiceRecognition() {
                if (this.recognition) {
                    if (this.voiceBtn.innerHTML.includes('fa-stop')) {
                        this.recognition.stop();
                        this.voiceBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                        this.voiceBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                    } else {
                        this.recognition.start();
                        this.voiceBtn.innerHTML = '<i class="fas fa-stop"></i>';
                        this.voiceBtn.style.background = '#ef4444';
                        this.addMessage('🎤 Parlez maintenant...', false);
                    }
                }
            }

            async generateSmartSuggestions() {
                const analysis = this.performDeepAnalysis();
                const cvData = this.extractCVData();
                
                this.addMessage('🔍 Analyse de votre CV en cours...', false, true);
                
                const prompt = `Analyse ce CV et génère 3-5 suggestions d'amélioration très spécifiques et actionnables :

${cvData}

Analyse technique :
${analysis}

Fournis des suggestions courtes et précises que l'utilisateur peut demander directement. Format : "suggestion1|suggestion2|suggestion3"`;

                try {
                    const suggestions = await window.callGeminiAPI(prompt);
                    if (suggestions) {
                        const suggestionList = suggestions.split('|').filter(s => s.trim());
                        
                        let suggestionsHTML = '💡 <strong>Suggestions intelligentes basées sur votre CV :</strong><br><br>';
                        suggestionList.forEach((suggestion, index) => {
                            suggestionsHTML += `<span class="suggestion-chip" data-suggestion="${suggestion.trim()}">${index + 1}. ${suggestion.trim()}</span><br>`;
                        });
                        
                        this.addMessage(suggestionsHTML, false);
                    }
                } catch (error) {
                    this.addMessage('❌ Erreur lors de la génération des suggestions.', false);
                }
            }

            async performQuickFix() {
                this.addMessage('⚡ Correction rapide en cours...', false, true);
                
                const issues = this.detectQuickFixIssues();
                let fixesApplied = [];

                // Appliquer les corrections automatiquement
                for (const issue of issues) {
                    switch (issue.type) {
                        case 'missing_profile':
                            await this.generateAutoProfile();
                            fixesApplied.push('Profil professionnel généré');
                            break;
                        case 'short_profile':
                            const currentProfile = document.getElementById('description')?.value || '';
                            const enhancedProfile = await this.enhanceProfile(currentProfile);
                            if (enhancedProfile) {
                                await this.modifyField('description', enhancedProfile);
                                fixesApplied.push('Profil enrichi');
                            }
                            break;
                        case 'missing_contact':
                            this.addMessage('⚠️ Informations de contact manquantes. Veuillez les ajouter manuellement.', false);
                            break;
                        case 'layout_optimization':
                            const optimalLayout = this.calculateOptimalLayout();
                            await this.changeLayout(optimalLayout);
                            fixesApplied.push(`Mise en page optimisée (${optimalLayout})`);
                            break;
                        case 'color_improvement':
                            await this.applyOptimalColors();
                            fixesApplied.push('Couleurs optimisées');
                            break;
                    }
                }

                if (fixesApplied.length > 0) {
                    this.addMessage(`✅ Corrections appliquées : ${fixesApplied.join(', ')}`, false);
                    showNotification(`🤖 IA: ${fixesApplied.length} améliorations appliquées`, "success", 3000);
                } else {
                    this.addMessage('✅ Votre CV est déjà bien optimisé ! Pas de corrections majeures nécessaires.', false);
                }
            }

            detectQuickFixIssues() {
                const issues = [];
                
                // Vérifier le profil
                const profile = document.getElementById('description')?.value;
                if (!profile || profile.trim().length === 0) {
                    issues.push({ type: 'missing_profile', priority: 'high' });
                } else if (profile.length < 80) {
                    issues.push({ type: 'short_profile', priority: 'medium' });
                }

                // Vérifier les informations de contact
                const email = document.getElementById('email')?.value;
                const phone = document.getElementById('telephone')?.value;
                if (!email || !phone) {
                    issues.push({ type: 'missing_contact', priority: 'high' });
                }

                // Vérifier la mise en page
                const contentDensity = this.analyzeContentDensity();
                if (!contentDensity.balanced) {
                    issues.push({ type: 'layout_optimization', priority: 'medium' });
                }

                // Vérifier les couleurs
                const primaryColor = getComputedStyle(document.documentElement).getPropertyValue('--primary-color');
                const secondaryColor = getComputedStyle(document.documentElement).getPropertyValue('--secondary-color');
                if (primaryColor === secondaryColor) {
                    issues.push({ type: 'color_improvement', priority: 'low' });
                }

                return issues;
            }

            async enhanceProfile(currentProfile) {
                const prompt = `Améliore ce profil professionnel pour le rendre plus percutant et professionnel (80-120 mots) :

"${currentProfile}"

Rends-le plus dynamique, professionnel et attractif pour les recruteurs.`;

                try {
                    return await window.callGeminiAPI(prompt);
                } catch (error) {
                    return null;
                }
            }

            calculateOptimalLayout() {
                const experiences = this.extractDynamicData('experience');
                const formations = this.extractDynamicData('formation');
                const competences = document.getElementById('competences')?.value || '';
                
                // Si beaucoup de contenu, utiliser 2 colonnes équilibrées
                if (experiences.length > 3 || formations.length > 2 || competences.length > 200) {
                    return '2-col-50-50';
                }
                // Si peu de contenu, utiliser une colonne
                else if (experiences.length <= 1 && formations.length <= 1) {
                    return '1-col';
                }
                // Sinon, utiliser un layout asymétrique
                else {
                    return '2-col-67-33';
                }
            }

            async applyOptimalColors() {
                // Couleurs professionnelles optimisées
                const colorSchemes = [
                    { primary: '#2563eb', secondary: '#1e40af', text: '#1f2937' }, // Bleu professionnel
                    { primary: '#059669', secondary: '#047857', text: '#1f2937' }, // Vert moderne
                    { primary: '#7c3aed', secondary: '#6d28d9', text: '#1f2937' }, // Violet créatif
                    { primary: '#dc2626', secondary: '#b91c1c', text: '#1f2937' }  // Rouge dynamique
                ];
                
                // Choisir un schéma basé sur le contenu
                const randomScheme = colorSchemes[Math.floor(Math.random() * colorSchemes.length)];
                await this.changeColors(randomScheme.primary, randomScheme.secondary, randomScheme.text);
            }

            saveChatPosition() {
                const floatBtnRect = this.floatBtn.getBoundingClientRect();
                const chatRect = this.chatContainer.getBoundingClientRect();
                
                localStorage.setItem('ai-chat-position', JSON.stringify({
                    floatBtn: { left: floatBtnRect.left, top: floatBtnRect.top },
                    chat: { left: chatRect.left, top: chatRect.top }
                }));
            }

            loadChatPosition() {
                const saved = localStorage.getItem('ai-chat-position');
                if (saved) {
                    const positions = JSON.parse(saved);
                    
                    if (positions.floatBtn) {
                        // S'assurer que le bouton reste dans l'écran visible
                        const maxX = window.innerWidth - this.floatBtn.offsetWidth;
                        const maxY = window.innerHeight - this.floatBtn.offsetHeight;
                        
                        const left = Math.max(0, Math.min(positions.floatBtn.left, maxX));
                        const top = Math.max(0, Math.min(positions.floatBtn.top, maxY));
                        
                        this.floatBtn.style.left = left + 'px';
                        this.floatBtn.style.top = top + 'px';
                        this.floatBtn.style.right = 'auto';
                        this.floatBtn.style.bottom = 'auto';
                    }
                    
                    if (positions.chat) {
                        // S'assurer que le chat reste dans l'écran visible
                        const maxX = window.innerWidth - this.chatContainer.offsetWidth;
                        const maxY = window.innerHeight - this.chatContainer.offsetHeight;
                        
                        const left = Math.max(0, Math.min(positions.chat.left, maxX));
                        const top = Math.max(0, Math.min(positions.chat.top, maxY));
                        
                        this.chatContainer.style.left = left + 'px';
                        this.chatContainer.style.top = top + 'px';
                        this.chatContainer.style.right = 'auto';
                        this.chatContainer.style.bottom = 'auto';
                    }
                }
            }
            
            adjustPositionsOnResize() {
                // Repositionner le bouton flottant s'il est hors écran
                const floatBtnRect = this.floatBtn.getBoundingClientRect();
                if (floatBtnRect.right > window.innerWidth || floatBtnRect.bottom > window.innerHeight || floatBtnRect.left < 0 || floatBtnRect.top < 0) {
                    const maxX = window.innerWidth - this.floatBtn.offsetWidth;
                    const maxY = window.innerHeight - this.floatBtn.offsetHeight;
                    
                    const left = Math.max(0, Math.min(floatBtnRect.left, maxX));
                    const top = Math.max(0, Math.min(floatBtnRect.top, maxY));
                    
                    this.floatBtn.style.left = left + 'px';
                    this.floatBtn.style.top = top + 'px';
                    this.floatBtn.style.right = 'auto';
                    this.floatBtn.style.bottom = 'auto';
                }
                
                // Repositionner le chat s'il est hors écran
                const chatRect = this.chatContainer.getBoundingClientRect();
                if (chatRect.right > window.innerWidth || chatRect.bottom > window.innerHeight || chatRect.left < 0 || chatRect.top < 0) {
                    const maxX = window.innerWidth - this.chatContainer.offsetWidth;
                    const maxY = window.innerHeight - this.chatContainer.offsetHeight;
                    
                    const left = Math.max(0, Math.min(chatRect.left, maxX));
                    const top = Math.max(0, Math.min(chatRect.top, maxY));
                    
                    this.chatContainer.style.left = left + 'px';
                    this.chatContainer.style.top = top + 'px';
                    this.chatContainer.style.right = 'auto';
                    this.chatContainer.style.bottom = 'auto';
                }
            }
        }

        // Initialize the AI Chat when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            window.aiChat = new AdvancedAIChat();
            
            // Vérifier et mettre à jour le statut de l'API
            function updateAPIStatus() {
                const apiKey = localStorage.getItem('gemini-api-key');
                const statusMessage = document.getElementById('api-status-message');
                
                if (statusMessage) {
                    if (apiKey && apiKey.trim() !== '') {
                        statusMessage.innerHTML = `
                            ✅ <strong>API Gemini configurée</strong><br>
                            Toutes mes fonctionnalités sont disponibles !<br><br>
                        `;
                        statusMessage.style.color = '#10b981';
                    } else {
                        statusMessage.innerHTML = `
                            ⚠️ <strong>Clé API Gemini non configurée</strong><br>
                            Pour utiliser toutes mes fonctionnalités, configurez votre clé API dans l'onglet "IA" > "Configuration API Gemini".<br>
                            <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color: #667eea;">Obtenir une clé API gratuite ici</a>
                            <br><br>
                        `;
                        statusMessage.style.color = '#f59e0b';
                    }
                }
            }
            
            // Mettre à jour le statut initialement
            updateAPIStatus();
            
            // Écouter les changements dans le localStorage pour mettre à jour le statut
            window.addEventListener('storage', updateAPIStatus);
            
            // Vérifier périodiquement le statut (au cas où il changerait dans la même fenêtre)
            setInterval(updateAPIStatus, 5000);
        });
    </script>

    <!-- Advanced AI Chat System -->
    <button id="ai-chat-float-btn" title="Chat IA Avancé - Glissez pour déplacer">
        <i class="fas fa-comments"></i>
    </button>

    <div id="ai-chat-container">
        <div id="ai-chat-header">
            <h3><i class="fas fa-robot mr-2"></i>Assistant IA Avancé</h3>
            <button id="ai-chat-close-btn">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div id="ai-chat-messages">
            <div class="chat-message ai" id="initial-ai-message">
                🤖 <strong>Assistant IA Ultra-Intelligent</strong>
                <br><br>
                <div id="api-status-message">
                    ⚠️ <strong>Clé API Gemini non configurée</strong><br>
                    Pour utiliser toutes mes fonctionnalités, configurez votre clé API dans l'onglet "IA" > "Configuration API Gemini".<br>
                    <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color: #667eea;">Obtenir une clé API gratuite ici</a>
                    <br><br>
                </div>
                Je peux <strong>modifier directement</strong> votre CV en temps réel ! Voici mes super-pouvoirs :
                
                <div class="chat-suggestions">
                    <span class="suggestion-chip" data-suggestion="Analyse complète de mon CV et applique toutes les améliorations nécessaires">🔍 Analyse complète</span>
                    <span class="suggestion-chip" data-suggestion="Optimise mon CV pour un poste de développeur web">💻 Optimiser pour un métier</span>
                    <span class="suggestion-chip" data-suggestion="Améliore automatiquement le design et les couleurs">🎨 Améliorer le design</span>
                    <span class="suggestion-chip" data-suggestion="Réécris mon profil professionnel pour le rendre plus percutant">✍️ Réécrire le profil</span>
                    <span class="suggestion-chip" data-suggestion="Ajoute des compétences manquantes selon mon secteur">⭐ Ajouter compétences</span>
                    <span class="suggestion-chip" data-suggestion="Change la mise en page pour une meilleure lisibilité">📋 Optimiser layout</span>
                    <span class="suggestion-chip" data-suggestion="Corrige toutes les erreurs et incohérences">🔧 Correction auto</span>
                    <span class="suggestion-chip" data-suggestion="Adapte le ton pour un secteur créatif">🎭 Changer le ton</span>
                </div>
                
                <br>
                <strong>💡 Exemples de commandes :</strong><br>
                • "Change les couleurs en bleu et gris moderne"<br>
                • "Ajoute une expérience de stage en développement"<br>
                • "Optimise pour un poste de chef de projet"<br>
                • "Réorganise les sections pour plus d'impact"<br>
                • "Change les polices pour un style plus professionnel"<br>
                
                <br>
                <em>Demandez-moi n'importe quoi, je modifierai directement votre CV ! 🚀</em>
            </div>
        </div>
        
        <div id="ai-chat-input-container">
            <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 6px; flex-wrap: wrap;">
                <button id="ai-voice-btn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; color: white; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 10px;">
                    <i class="fas fa-microphone"></i>
                </button>
                <button id="ai-smart-suggest-btn" style="background: #10b981; border: none; color: white; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; font-size: 12px; display: flex; align-items: center; justify-content: center;" title="Suggestions intelligentes">
                    💡
                </button>
                <button id="ai-quick-fix-btn" style="background: #f59e0b; border: none; color: white; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; font-size: 12px; display: flex; align-items: center; justify-content: center;" title="Corrections rapides">
                    ⚡
                </button>
            </div>
            <textarea id="ai-chat-input" placeholder="Ex: 'Change les couleurs en bleu moderne' ou 'Optimise pour un poste de marketing'..." rows="1"></textarea>
            <button id="ai-chat-send-btn">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <script>
        // Compact Interface Initialization
        document.addEventListener('DOMContentLoaded', function() {
            // Close all details elements except the first one in each tab for cleaner interface
            const allDetails = document.querySelectorAll('.control-group');
            allDetails.forEach((detail, index) => {
                // Keep the first detail in each tab open, close others
                if (index % 4 !== 0) { // Keep every 4th element open (roughly first in each tab)
                    detail.removeAttribute('open');
                }
            });

            // Add compact mode toggle button
            const controlsHeader = document.querySelector('#controls .flex.justify-between');
            if (controlsHeader) {
                const compactToggle = document.createElement('button');
                compactToggle.innerHTML = '<i class="fas fa-compress-alt"></i>';
                compactToggle.className = 'ai-btn-compact text-gray-600 hover:text-gray-900';
                compactToggle.title = 'Mode Compact: Fermer/Ouvrir toutes les sections';
                compactToggle.style.cssText = 'width: 32px; height: 32px; padding: 0; display: flex; align-items: center; justify-content: center;';
                
                compactToggle.addEventListener('click', function() {
                    const allDetails = document.querySelectorAll('.control-group');
                    const areAnyOpen = Array.from(allDetails).some(detail => detail.hasAttribute('open'));
                    
                    allDetails.forEach(detail => {
                        if (areAnyOpen) {
                            detail.removeAttribute('open');
                        } else {
                            detail.setAttribute('open', '');
                        }
                    });
                    
                    // Update icon
                    this.innerHTML = areAnyOpen ? '<i class="fas fa-expand-alt"></i>' : '<i class="fas fa-compress-alt"></i>';
                });
                
                controlsHeader.appendChild(compactToggle);
            }

            // Add quick section opener for active tab
            const tabBtns = document.querySelectorAll('.tab-btn');
            tabBtns.forEach(tabBtn => {
                tabBtn.addEventListener('click', function() {
                    // Small delay to let tab switch complete
                    setTimeout(() => {
                        const activePanel = document.querySelector('.tab-panel:not(.hidden)');
                        if (activePanel) {
                            const firstDetail = activePanel.querySelector('.control-group');
                            if (firstDetail && !firstDetail.hasAttribute('open')) {
                                firstDetail.setAttribute('open', '');
                            }
                        }
                    }, 100);
                });
            });

            // Enhanced tooltips for unified buttons
            const allButtons = document.querySelectorAll('.ai-btn-enhanced, .ai-btn-compact, .theme-btn, .skill-style-btn, .layout-btn, .gauge-style-btn');
            allButtons.forEach(btn => {
                // Make sure tooltip positioning is correct for small buttons
                if (btn.offsetWidth <= 40) {
                    btn.classList.add('small-tooltip');
                }
            });

            // Add compact grid controls
            const grids = document.querySelectorAll('.grid');
            grids.forEach(grid => {
                if (grid.children.length > 6) {
                    grid.style.maxHeight = '200px';
                    grid.style.overflowY = 'auto';
                    grid.style.padding = '4px';
                }
            });

            console.log('Interface compacte initialisée - boutons uniformisés et sections optimisées');
        });
    </script>

</body>
</html>
