<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cr√©ateur de CV IA - Pro Recruteur</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&family=Montserrat:wght@400;500;700;800&family=Playfair+Display:ital,wght@0,400..900;1,400..900&family=Roboto+Mono:wght@400;700&family=Merriweather:wght@400;700&family=Oswald:wght@400;700&family=Cormorant+Garamond:wght@400;700&family=Open+Sans:wght@400;700&family=Source+Sans+Pro:wght@400;700&family=Nunito+Sans:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    
    <style>
        :root {
            --page-margin: 2cm;
            --primary-color: #2563eb;
            --secondary-color: #334155;
            --body-text-color: #334155;
            --font-family-h1: 'Montserrat', sans-serif;
            --font-family-h2: 'Montserrat', sans-serif;
            --font-family-body: 'Lato', sans-serif;
            --font-size-h1: 40pt;
            --font-size-h2: 21pt;
            --font-size-p: 10pt;
            --font-size-banner: 9pt;
            --line-height: 1.6;
            --paragraph-spacing: 0.5rem;
            --module-spacing: 1.5rem;
            --item-spacing: 0.5rem;
            --banner-element-spacing: 1rem;
        }

        #cv-preview-wrapper { width: 100%; display: flex; flex-direction: column; align-items: center; gap: 20px; }
        .a4-page-container { position: relative; }
        /* CORRECTIF : Remplacement de min-height par height pour une d√©tection de d√©passement fiable */
        .a4-page { width: 21cm; height: 29.7cm; box-shadow: 0 10px 30px rgba(0,0,0,0.15); background-color: white; overflow: hidden; display: flex; flex-direction: column; transition: all 0.3s ease; font-family: var(--font-family-body); color: var(--body-text-color); position: relative; outline: 2px solid transparent; outline-offset: -2px; padding: var(--page-margin); box-sizing: border-box; }
        body.overflow-check-active .is-overflowing { outline: 3px solid #ef4444 !important; box-shadow: 0 0 20px 8px rgba(239, 68, 68, 0.3) !important; }
        
        .remove-page-btn { position: absolute; top: -10px; right: -10px; width: 30px; height: 30px; background-color: #ef4444; color: white; border: none; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; opacity: 0.5; transition: opacity 0.2s, transform 0.2s; z-index: 10; }
        .remove-page-btn:hover { opacity: 1; transform: scale(1.1); }
        .a4-page-container:first-child .remove-page-btn { display: none; }

        #add-page-btn-wrapper { width: 21cm; text-align: center; padding: 10px 0; }
        #add-page-btn { width: 50px; height: 50px; background-color: #3b82f6; color: white; border-radius: 50%; border: none; cursor: pointer; font-size: 24px; transition: transform 0.2s; }
        #add-page-btn:hover { transform: scale(1.1); }

        .cv-body-container { display: grid; gap: 1rem; height: 100%; flex-grow: 1; position: relative; }
        .layout-1-col { grid-template-columns: 1fr; }
        .layout-2-col-33-67 { grid-template-columns: 1fr 2fr; }
        .layout-2-col-50-50 { grid-template-columns: 1fr 1fr; }
        .layout-2-col-67-33 { grid-template-columns: 2fr 1fr; }

        .cv-column { min-height: 150px; height: 100%; border: 1px dotted #ccc; padding: 5px; }
        .cv-module { position: relative; margin-bottom: var(--module-spacing); }
        .cv-module .drag-handle { position: absolute; top: 10px; left: -25px; cursor: grab; color: #d1d5db; opacity: 0; transition: opacity 0.2s; font-size: 1.2rem; }
        .cv-module:hover .drag-handle { opacity: 1; }
        .sortable-ghost { opacity: 0.4; background: #cce7ff; border: 1px dashed var(--primary-color); }

        [contenteditable="true"]:hover { outline: 1px dashed #3b82f6; background-color: #eff6ff; }
        [contenteditable="true"]:focus { outline: 2px solid #3b82f6; background-color: #dbeafe; }

        .cv-header h1 { font-family: var(--font-family-h1); font-weight: 800; font-size: var(--font-size-h1); color: var(--primary-color); margin-bottom: 0.25rem; }
        .cv-header p { font-family: var(--font-family-body); font-size: 1.2rem; color: var(--secondary-color); }
        .section-title { font-family: var(--font-family-h2); font-weight: 700; font-size: var(--font-size-h2); margin-bottom: 0.8rem; padding-bottom: 0.4rem; color: var(--primary-color); display: flex; align-items: center; gap: 0.5rem; transition: opacity 0.3s; }
        .section-title.style-underline { border-bottom: 2px solid var(--primary-color); }
        .section-title.style-side-line { border-left: 4px solid var(--primary-color); border-bottom: none; padding-left: 0.5rem; }
        .section-title.style-background { background-color: var(--primary-color); color: white; padding: 0.3rem 0.6rem; margin-bottom: 1rem; border-radius: 0.25rem; }
        .section-title.style-background .section-icon { color: white !important; }
        .section-title.style-boxed { border: 2px solid var(--primary-color); padding: 0.3rem 0.6rem; }
        .section-title.style-gradient { background: linear-gradient(45deg, var(--primary-color), var(--secondary-color)); color: white; padding: 0.3rem 0.6rem; margin-bottom: 1rem; border-radius: 0.25rem; }
        .section-title.style-gradient .section-icon { color: white !important; }
        .section-title.style-shadow { text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }

        /* New theme styles */
        .theme-elegant { --primary-color: #8b5a3c; --secondary-color: #d4af37; --body-text-color: #2c2c2c; }
        .theme-tech { --primary-color: #00d4aa; --secondary-color: #1a1a1a; --body-text-color: #333; }
        .theme-luxury { --primary-color: #b8860b; --secondary-color: #4b0082; --body-text-color: #2c2c2c; }
        .theme-startup { --primary-color: #ff6b35; --secondary-color: #f7931e; --body-text-color: #333; }
        .theme-academic { --primary-color: #2c3e50; --secondary-color: #34495e; --body-text-color: #2c3e50; }
        .theme-artistic { --primary-color: #e91e63; --secondary-color: #9c27b0; --body-text-color: #424242; }

        /* Glassmorphism effect */
        .glassmorphism { background: rgba(255, 255, 255, 0.25); backdrop-filter: blur(10px); border-radius: 10px; border: 1px solid rgba(255, 255, 255, 0.18); }
        .glassmorphism-dark { background: rgba(0, 0, 0, 0.25); backdrop-filter: blur(10px); border-radius: 10px; border: 1px solid rgba(255, 255, 255, 0.18); color: white; }

        /* Animation effects */
        @keyframes subtle-bounce { 0%, 20%, 50%, 80%, 100% { transform: translateY(0); } 40% { transform: translateY(-2px); } 60% { transform: translateY(-1px); } }
        @keyframes fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .cv-module.animate { animation: fade-in 0.3s ease-out; }
        .section-title.animate:hover { animation: subtle-bounce 0.6s; }

        /* Enhanced color palettes */
        .color-palette-btn { transition: all 0.2s ease; cursor: pointer; }
        .color-palette-btn:hover { transform: scale(1.05); }

        /* Enhanced tooltips */
        [title] {
            position: relative;
        }
        
        [title]:hover::after {
            content: attr(title);
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #1f2937;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1000;
            pointer-events: none;
            opacity: 0;
            animation: tooltipFadeIn 0.2s forwards;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            max-width: 200px;
            white-space: normal;
            text-align: center;
            line-height: 1.3;
        }
        
        [title]:hover::before {
            content: '';
            position: absolute;
            bottom: 115%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: #1f2937;
            z-index: 1000;
            pointer-events: none;
            opacity: 0;
            animation: tooltipFadeIn 0.2s forwards;
        }
        
        @keyframes tooltipFadeIn {
            from { opacity: 0; transform: translateX(-50%) translateY(10px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }
        
        /* Special positioning for small buttons */
        .logo-size-btn[title]:hover::after,
        .banner-align-btn[title]:hover::after,
        .gauge-style-btn[title]:hover::after {
            bottom: 140%;
            font-size: 11px;
        }

        /* Smart analysis results */
        .analysis-result { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1rem; border-radius: 0.5rem; margin: 1rem 0; }
        .score-indicator { display: inline-flex; align-items: center; gap: 0.5rem; }
        .score-bar { height: 8px; border-radius: 4px; background: rgba(255,255,255,0.3); overflow: hidden; }
        .score-fill { height: 100%; background: #4ade80; transition: width 0.3s ease; }

        /* CV Variants Modal */
        .variant-preview { border: 2px solid transparent; border-radius: 0.5rem; padding: 0.5rem; cursor: pointer; transition: all 0.2s; }
        .variant-preview:hover { border-color: var(--primary-color); background: #f8fafc; }
        .variant-preview.selected { border-color: var(--primary-color); background: #eff6ff; }

        /* Language selector for translation */
        .language-flag { width: 20px; height: 15px; margin-right: 0.5rem; }

        /* Motto/Slogan display */
        .motto-display { font-style: italic; text-align: center; border-left: 4px solid var(--primary-color); padding-left: 1rem; margin: 1rem 0; }

        /* Industry keywords highlight */
        .keyword-highlight { background: rgba(59, 130, 246, 0.1); padding: 2px 4px; border-radius: 3px; font-weight: 500; }

        /* CV scoring display */
        .cv-score-container { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 1.5rem; border-radius: 0.75rem; text-align: center; }
        .score-circle { width: 80px; height: 80px; border-radius: 50%; border: 4px solid rgba(255,255,255,0.3); display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; position: relative; }
        .score-text { font-size: 1.5rem; font-weight: bold; }

        /* New layout options */
        .layout-3-col { grid-template-columns: 1fr 1fr 1fr; }
        .layout-asymmetric-1 { grid-template-columns: 1fr 2fr 1fr; }
        .layout-asymmetric-2 { grid-template-columns: 2fr 1fr 1fr; }

        /* Enhanced section customization */
        .section-icon.animated { transition: transform 0.3s ease; }
        .section-icon.animated:hover { transform: rotate(360deg) scale(1.2); }

        /* Zebra sections effect */
        body.zebra-sections .cv-module:nth-child(even) { background: rgba(0, 0, 0, 0.02); border-radius: 8px; padding: 1rem; margin: 0.5rem 0; }

        /* Floating elements effect */
        .floating-element { animation: float 3s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-5px); } }

        /* Skill styles enhancements */
        .cv-competences-circular .skill-item { border-radius: 50%; width: 60px; height: 60px; display: inline-flex; align-items: center; justify-content: center; margin: 0.25rem; }
        .cv-competences-categories { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
        .cv-competences-timeline .skill-item { position: relative; padding-left: 2rem; }
        .cv-competences-timeline .skill-item::before { content: ''; position: absolute; left: 0; top: 50%; width: 12px; height: 12px; background: var(--primary-color); border-radius: 50%; transform: translateY(-50%); }

        /* Enhanced gauge styles */
        .gauge-percentage { display: flex; align-items: center; gap: 8px; }
        .gauge-percentage .skill-level-label { min-width: 120px; }
        .gauge-percentage .gauge-container { flex-grow: 1; position: relative; }
        .gauge-percentage-fill { background: linear-gradient(90deg, var(--primary-color), var(--secondary-color)); height: 8px; border-radius: 4px; transition: width 0.3s ease; }
        .gauge-percentage-text { min-width: 40px; text-align: right; font-weight: bold; color: var(--primary-color); }

        /* Font suggestion styles */
        .font-suggestions { animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .font-suggestion-btn { transition: all 0.2s ease; }
        .font-suggestion-btn:hover { transform: translateX(5px); }

        /* Enhanced modal animations */
        .modal-overlay { backdrop-filter: blur(5px); }
        .modal-overlay.active .modal-content { animation: modalSlideIn 0.3s ease; }
        @keyframes modalSlideIn { from { opacity: 0; transform: scale(0.9) translateY(-20px); } to { opacity: 1; transform: scale(1) translateY(0); } }

        /* Completion progress enhancements */
        #progress-bar { position: relative; overflow: hidden; }
        #progress-bar::after { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent); animation: shimmer 2s infinite; }
        @keyframes shimmer { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }

        /* Template button hover effects */
        .skill-template-btn, .section-template-btn { transition: all 0.2s ease; position: relative; overflow: hidden; }
        .skill-template-btn:hover, .section-template-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .skill-template-btn::before, .section-template-btn::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent); transition: left 0.5s; }
        .skill-template-btn:hover::before, .section-template-btn:hover::before { left: 100%; }

        /* AI analysis result enhancements */
        .analysis-result { position: relative; overflow: hidden; }
        .analysis-result::before { content: 'ü§ñ'; position: absolute; top: 1rem; right: 1rem; font-size: 1.5rem; opacity: 0.3; }

        /* Advanced AI Chat Styles */
        #ai-chat-float-btn {
            position: fixed;
            right: 30px;
            bottom: 30px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 50%;
            box-shadow: 0 8px 32px rgba(102, 126, 234, 0.3);
            cursor: move;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            transition: all 0.3s ease;
            user-select: none;
        }

        #ai-chat-float-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 48px rgba(102, 126, 234, 0.4);
        }

        #ai-chat-float-btn.dragging {
            cursor: grabbing;
            transform: scale(1.05);
        }

        #ai-chat-container {
            position: fixed;
            right: 100px;
            bottom: 100px;
            width: 400px;
            height: 600px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            z-index: 9998;
            display: none;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid #e5e7eb;
        }

        #ai-chat-container.show {
            display: flex;
            animation: chatSlideIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes chatSlideIn {
            from {
                opacity: 0;
                transform: scale(0.8) translateY(20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        #ai-chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: move;
        }

        #ai-chat-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }

        #ai-chat-close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }

        #ai-chat-close-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        #ai-chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            background: #fafafa;
        }

        .chat-message {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.4;
            animation: messageSlideIn 0.3s ease;
        }

        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .chat-message.user {
            align-self: flex-end;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .chat-message.ai {
            align-self: flex-start;
            background: white;
            color: #333;
            border: 1px solid #e5e7eb;
            border-bottom-left-radius: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .chat-message.ai.thinking {
            background: #f3f4f6;
            font-style: italic;
        }

        #ai-chat-input-container {
            padding: 20px;
            background: white;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 10px;
            align-items: end;
        }

        #ai-chat-input {
            flex: 1;
            resize: none;
            border: 1px solid #d1d5db;
            border-radius: 20px;
            padding: 12px 16px;
            font-size: 14px;
            max-height: 100px;
            min-height: 40px;
            outline: none;
            transition: border-color 0.2s;
            font-family: inherit;
        }

        #ai-chat-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        #ai-chat-send-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
            flex-shrink: 0;
        }

        #ai-chat-send-btn:hover:not(:disabled) {
            transform: scale(1.05);
        }

        #ai-chat-send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .chat-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .suggestion-chip {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            color: #0369a1;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .suggestion-chip:hover {
            background: #0ea5e9;
            color: white;
            transform: translateY(-1px);
        }

        .chat-typing-indicator {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 12px 16px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #9ca3af;
            animation: typingPulse 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typingPulse {
            0%, 60%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            30% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Responsive adjustments for chat */
        @media (max-width: 768px) {
            #ai-chat-container {
                width: 100vw;
                height: 100vh;
                right: 0;
                bottom: 0;
                border-radius: 0;
            }
            
            #ai-chat-float-btn {
                right: 20px;
                bottom: 20px;
                width: 50px;
                height: 50px;
                font-size: 20px;
            }
        }

        /* Responsive enhancements for small screens */
        @media (max-width: 768px) {
            .theme-btn, .skill-style-btn, .layout-btn { font-size: 0.75rem; padding: 0.5rem; }
            .modal-content { margin: 1rem; max-height: 90vh; overflow-y: auto; }
            .grid.grid-cols-3 { grid-template-columns: repeat(2, 1fr); }
            .grid.grid-cols-6 { grid-template-columns: repeat(3, 1fr); }
        }

        .section-title .section-icon { cursor: pointer; transition: transform 0.2s; }
        .section-title .section-icon:hover { transform: scale(1.1); }
        .a4-page p, .a4-page li, #cv-description-preview, #cv-experience-preview, #cv-formation-preview { font-size: var(--font-size-p); line-height: var(--line-height); }
        .a4-page p { margin-bottom: var(--paragraph-spacing); }
        .a4-page ul { list-style: none; padding-left: 0;}
        #cv-competences-preview[data-style="simple"] ul li,
        .a4-page ul li { padding-left: 1.4em; position: relative; margin-bottom: 0.25rem; }
        #cv-competences-preview[data-style="simple"] ul li::before,
        .a4-page ul li::before { content: '‚Ä∫'; font-weight: bold; position: absolute; left: 0; color: var(--primary-color); font-size: 1.2em; top: -0.1em; }
        
        .item-title { font-weight: 700; color: var(--secondary-color); }
        .item-meta { font-size: calc(var(--font-size-p) * 0.9); font-style: italic; }

        #recruiter-banner { display: flex; align-items: center; padding: 0.5rem; box-sizing: border-box; width: 100%; font-size: var(--font-size-banner); position: relative; overflow: hidden; }
        .banner-content-wrapper { position: relative; z-index: 1; display: flex; align-items: center; width: 100%; height: 100%; gap: var(--banner-element-spacing); }
        #banner-bg-img-preview { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 0; transition: opacity 0.3s, filter 0.3s; }
        #fixed-banner-top { margin-bottom: var(--module-spacing); display: none; }
        #fixed-banner-bottom { margin-top: auto; padding-top: var(--module-spacing); display: none; }
        #banner-img-preview { border-radius: 50%; object-fit: cover; flex-shrink: 0; transition: width 0.3s, height 0.3s; background-color: rgba(255,255,255,0.5); }
        #banner-img-preview.logo-sm { width: 40px; height: 40px; }
        #banner-img-preview.logo-md { width: 60px; height: 60px; }
        #banner-img-preview.logo-lg { width: 80px; height: 80px; }
        #banner-img-preview.logo-xl { width: 100px; height: 100px; }
        #banner-img-preview.logo-xxl { width: 120px; height: 120px; }
        #banner-nom-preview { font-weight: 700; }
        .banner-align-left { justify-content: flex-start; text-align: left; }
        .banner-align-center { justify-content: center; text-align: center; }
        .banner-align-right { justify-content: flex-end; text-align: right; }
        .banner-layout-inverted { flex-direction: row-reverse; }
        .banner-style-elegant { border-top: 2px solid var(--primary-color); border-bottom: 2px solid var(--primary-color); background: transparent; }
        .banner-style-modern { background-color: var(--primary-color); color: white; border-radius: 0.5rem; }
        .banner-style-modern p, .banner-style-modern span { color: white !important; }
        .banner-style-discret { border-left: 4px solid #d1d5db; background: transparent; }
        .banner-style-carte { box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); border-radius: 0.5rem; background: #f9fafb; }
        .banner-style-degrade { background: linear-gradient(to right, var(--primary-color), #a5b4fc); color: white; border-radius: 0.5rem; }
        .banner-style-degrade p, .banner-style-degrade span { color: white !important; }
        .banner-style-premium { background-color: #1e293b; color: #fde68a; border: 1px solid #fde68a; border-radius: 0.25rem; }
        .banner-style-premium p, .banner-style-premium span { color: #f1f5f9 !important; }
        .banner-style-minimal { border-bottom: 2px solid var(--primary-color); }
        .banner-style-encadre { border: 2px solid var(--primary-color); border-radius: 0.5rem; }
        .banner-style-ligne-haute { border-top: 4px solid var(--primary-color); padding-top: 0.8rem !important; }

        #notification { position: fixed; top: 20px; right: 20px; z-index: 10000; }
        .toast { background-color: white; color: #111827; padding: 1rem 1.5rem; border-radius: 0.5rem; box-shadow: 0 5px 15px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 0.75rem; transition: all 0.3s ease; transform: translateX(120%); }
        .toast.show { transform: translateX(0); }

        /* Styles for collapsible control panel sections */
        details.control-group {
            background-color: #f9fafb;
            border: 1px solid #f3f4f6;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
        }
        details.control-group[open] {
            background-color: white;
            border-color: #e5e7eb;
        }
        details.control-group summary {
            list-style: none;
            cursor: pointer;
            padding: 1rem;
            font-weight: 600;
            color: #374151;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        details.control-group summary::-webkit-details-marker {
            display: none;
        }
        details.control-group .control-group-content {
            padding: 0 1rem 1rem 1rem;
            border-top: 1px solid #f3f4f6;
            margin-top: -0.5rem;
            padding-top: 1rem;
        }
        .completion-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
            font-weight: 400;
            color: #6b7280;
            cursor: pointer;
        }
        .completion-checkbox {
            height: 1rem;
            width: 1rem;
            border-radius: 0.25rem;
            border-color: #d1d5db;
            color: #4f46e5;
            cursor: pointer;
        }
        .completion-checkbox:focus {
            outline: 2px solid #4f46e5;
            outline-offset: 2px;
        }
        
        /* API Key Management Styles */
        .api-key-container {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border: 1px solid #cbd5e1;
            border-radius: 0.5rem;
            padding: 1rem;
        }
        
        #api-key-input {
            font-family: 'Courier New', monospace;
            letter-spacing: 0.5px;
        }
        
        #api-key-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .api-key-status {
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .api-key-status.text-green-600::before {
            content: '‚úì';
            color: #16a34a;
            font-weight: bold;
        }
        
        .api-key-status.text-red-500::before {
            content: '‚úó';
            color: #dc2626;
            font-weight: bold;
        }
        
        .api-key-status.text-yellow-600::before {
            content: '‚ö†';
            color: #d97706;
            font-weight: bold;
        }
        
        #toggle-api-key-visibility {
            transition: color 0.2s ease;
        }
        
        #toggle-api-key-visibility:hover {
            color: #3b82f6;
        }
        
        /* --- Specific styles for skills section --- */
        #cv-competences-preview h3.skill-category { font-family: var(--font-family-h2); font-weight: 700; color: var(--secondary-color); margin-top: 0.8rem; margin-bottom: 0.4rem; padding-bottom: 0.2rem; border-bottom: 1px solid #e5e7eb; font-size: calc(var(--font-size-p) * 1.05); text-transform: uppercase; letter-spacing: 0.5px; }
        #cv-competences-preview .skill-category:hover { background-color: #f3f4f6; }
        #cv-competences-preview[data-style="tags"] ul { padding-left: 0; list-style: none; margin-top: 0.25rem; margin-bottom: 0.5rem; line-height: 1.5; }
        #cv-competences-preview[data-style="tags"] ul li.skill-item { display: inline-block; margin: 0 8px 6px 0; padding: 3px 20px 3px 10px; border-radius: 12px; background-color: #f3f4f6; font-size: calc(var(--font-size-p) * 0.95); position: relative; cursor: grab; }
        #cv-competences-preview[data-style="tags"] ul li.skill-item:hover { background-color: #e5e7eb; }
        #cv-competences-preview[data-style="tags"] ul li::before { content: none; }
        .skills-ghost { opacity: 0.4; background: #cce7ff; border-radius: 12px; }
        .skill-item .delete-skill-btn { display: none; position: absolute; top: 50%; right: 5px; transform: translateY(-50%); cursor: pointer; font-size: 14px; line-height: 1; color: #9ca3af; padding: 2px; }
        .skill-item:hover .delete-skill-btn { display: inline-block; }
        .skill-item .delete-skill-btn:hover { color: #ef4444; }
        .style-toggle-btn.active, .skill-style-btn.active, .section-title-style-btn.active, .layout-btn.active, .banner-align-btn.active, .logo-size-btn.active, .theme-btn.active, #banner-invert-btn.active, .gauge-style-btn.active, #toggle-overflow-btn.active { background-color: #3b82f6; color: white; }
        .skill-level { display: flex; align-items: center; margin-bottom: 6px; gap: 8px; }
        .skill-level-label { width: 120px; flex-shrink: 0; font-size: var(--font-size-p); }
        
        /* Gauge Styles */
        .gauge-container { flex-grow: 1; }
        .gauge-bar-bg { background-color: #e5e7eb; border-radius: 4px; height: 8px; overflow: hidden;}
        .gauge-bar-fill { background-color: var(--primary-color); height: 100%; border-radius: 4px; transition: width 0.3s ease; }
        .gauge-dots, .gauge-stars, .gauge-squares { display: flex; gap: 4px; font-size: 1.2em; color: #d1d5db; }
        .gauge-dots .filled, .gauge-stars .filled, .gauge-squares .filled { color: var(--primary-color); }
        .gauge-number { font-weight: bold; color: var(--secondary-color); }

        .editable-wrapper { position: relative; }
        .editable-wrapper .delete-line-btn { display: none; position: absolute; top: 50%; right: 2px; transform: translateY(-50%); cursor: pointer; color: #ef4444; background-color: white; border-radius: 50%; width: 18px; height: 18px; text-align: center; line-height: 18px; font-size: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); z-index: 5; }
        .editable-wrapper:hover .delete-line-btn { display: flex; align-items: center; justify-content: center; }
        .history-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .insert-line-wrapper { position: relative; height: 0.5rem; opacity: 0; transition: opacity 0.2s; margin: 0; display: flex; justify-content: center; align-items: center; }
        .dynamic-item-container:hover .insert-line-wrapper { opacity: 1; }
        .add-line-preview-btn { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: #eef2ff; color: #4f46e5; border: 1px dashed #a5b4fc; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; z-index: 5; display: flex; align-items: center; justify-content: center; font-size: 12px; transition: all 0.2s; }
        .add-line-preview-btn:hover { background: #c7d2fe; border-style: solid; transform: translate(-50%, -50%) scale(1.1); }
        
        .add-desc-line-btn { display: none; font-size: 0.8rem; color: #4f46e5; cursor: pointer; margin-top: 0.25rem; padding: 2px 4px; border-radius: 4px; background: transparent; border: none; }
        .add-desc-line-btn:hover { background-color: #eef2ff; }
        .dynamic-preview-item:hover .add-desc-line-btn { display: inline-block; }

        .dynamic-preview-item { position: relative; border: 1px solid transparent; border-radius: 0.375rem; padding: 0.5rem; margin-bottom: var(--item-spacing); transition: border-color 0.2s, background-color 0.2s, opacity 0.3s; }
        .dynamic-preview-item:hover { background-color: #fafafa; border-color: #e5e7eb; }

        .delete-block-btn { display: none; position: absolute; top: 4px; right: 4px; width: 24px; height: 24px; background-color: #fee2e2; color: #b91c1c; border: none; border-radius: 50%; cursor: pointer; align-items: center; justify-content: center; z-index: 6; }
        .dynamic-preview-item:hover .delete-block-btn { display: flex; }
        .delete-block-btn:hover { background-color: #fecaca; color: #991b1b; }
        .new-badge { background-color: #ef4444; color: white; font-size: 0.6rem; font-weight: bold; padding: 2px 5px; border-radius: 4px; margin-left: 6px; vertical-align: middle; }
        
        /* Modal Styles */
        .modal-overlay { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 5000; opacity: 0; transition: opacity 0.2s; pointer-events: none; }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        .modal-content { background: white; padding: 2rem; border-radius: 0.5rem; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 90%; max-width: 500px; transform: scale(0.95); transition: transform 0.2s; }
        .modal-overlay.active .modal-content { transform: scale(1); }
        
        /* Icon Picker Modal */
        #icon-picker-modal .modal-content { max-width: 700px; }
        #icon-picker-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(50px, 1fr)); gap: 0.5rem; max-height: 60vh; overflow-y: auto; }
        #icon-picker-grid i { font-size: 1.5rem; padding: 0.75rem; border-radius: 0.25rem; cursor: pointer; text-align: center; transition: background-color 0.2s, color 0.2s; }
        #icon-picker-grid i:hover { background-color: #eef2ff; color: #4f46e5; }
        
        /* In-Preview AI Buttons */
        .section-ai-actions { margin-left: auto; display: flex; gap: 0.5rem; opacity: 0; transition: opacity 0.2s; }
        .cv-module:hover .section-ai-actions { opacity: 1; }
        .ai-action-btn { background: #e0e7ff; color: #4338ca; border: none; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 0.8rem; }
        .ai-action-btn:hover { background: #c7d2fe; }

        /* Styles for hiding sections */
        .cv-module.section-hidden > *:not(h2) {
            display: none;
        }
        .cv-module.section-hidden > h2 {
            opacity: 0.5;
        }

        /* For column resizing */
        .column-resizer {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 10px; /* Wider grab area */
            cursor: col-resize;
            transform: translateX(-50%);
            z-index: 20; /* High z-index */
        }
        .column-resizer::after {
            content: '';
            position: absolute;
            top: 0;
            bottom: 0;
            left: 4px; /* Centered 2px line in a 10px div */
            width: 2px;
            background-color: #d1d5db;
            transition: background-color 0.2s ease;
        }
        .column-resizer:hover::after,
        body.is-resizing .column-resizer::after {
            background-color: #3b82f6;
        }
        body.is-resizing {
            cursor: col-resize;
            user-select: none;
        }

        /* Presentation Mode & Print Styles */
        body.presentation-mode .cv-column {
            border-color: transparent;
        }
        body.presentation-mode .column-resizer,
        body.presentation-mode .drag-handle,
        body.presentation-mode .remove-page-btn,
        body.presentation-mode #add-page-btn-wrapper,
        body.presentation-mode .section-ai-actions,
        body.presentation-mode .delete-block-btn,
        body.presentation-mode .delete-line-btn,
        body.presentation-mode .insert-line-wrapper {
            display: none !important;
        }
        /* NEW: Completely hide the module in presentation mode if hidden */
        body.presentation-mode .cv-module.section-hidden {
            display: none !important;
        }

        @media print {
            body {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            .column-resizer,
            .drag-handle {
                display: none !important;
            }
            .cv-column {
                border-color: transparent !important;
            }
            .no-print {
                display: none !important;
            }
            .cv-module.section-hidden {
                display: none !important;
            }
            .a4-page {
                box-shadow: none !important;
                margin: 0;
                overflow: visible;
                height: auto;
                break-inside: avoid-page;
            }
            #cv-preview-wrapper {
                gap: 0;
            }
        }

    </style>
</head>
<body class="bg-gray-200 font-sans">

    <!-- OVERLAYS AND MODALS -->
    <div id="loader-overlay" class="hidden fixed inset-0 bg-white bg-opacity-75 flex-col items-center justify-center z-[9999]">
        <div class="h-16 w-16 rounded-full border-4 border-gray-200 border-t-blue-600 animate-spin"></div>
        <p id="loader-text" class="mt-4 text-gray-600 font-medium">Chargement...</p>
    </div>

    <div id="notification"></div>

    <div class="flex flex-col lg:flex-row min-h-screen">
        <!-- CONTROLS PANEL -->
        <div id="controls" class="w-full lg:w-1/3 xl:w-1/4 p-6 bg-white shadow-2xl overflow-y-auto flex flex-col no-print">
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <div class="flex items-center gap-3"><i class="fas fa-magic-wand-sparkles text-3xl text-blue-600"></i><h1 class="text-2xl font-bold text-gray-800">Cr√©ateur de CV</h1></div>
                <div class="flex items-center gap-2">
                    <!-- Save status removed -->
                    <button id="undo-btn" class="history-btn text-xl text-gray-600 hover:text-gray-900 disabled:text-gray-300" title="Annuler (Ctrl+Z)"><i class="fas fa-undo"></i></button>
                    <button id="redo-btn" class="history-btn text-xl text-gray-600 hover:text-gray-900 disabled:text-gray-300" title="R√©tablir (Ctrl+Y)"><i class="fas fa-redo"></i></button>
                </div>
            </div>
            
            <!-- NEW: Progress Bar -->
            <div class="mb-4 flex-shrink-0">
                <label class="text-sm font-medium text-gray-600">Progression</label>
                <div id="progress-bar-container" class="w-full bg-gray-200 rounded-full h-2.5 mt-1">
                    <div id="progress-bar" class="bg-green-500 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <p id="progress-text" class="text-xs text-right text-gray-500 mt-1">0/X sections compl√©t√©es</p>
            </div>

            <!-- Actions Rapides -->
            <div class="space-y-2 mb-4 p-4 bg-slate-50 rounded-lg border border-slate-200 flex-shrink-0">
                 <div class="grid grid-cols-2 gap-2">
                      <button id="download-pdf-btn" class="w-full bg-gray-800 text-white py-2 px-4 rounded-md hover:bg-gray-900 flex items-center justify-center gap-2" title="T√©l√©charger votre CV en format PDF"><i class="fa-solid fa-download"></i> PDF</button>
                      <button id="share-btn" class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 flex items-center justify-center gap-2" title="Partager votre CV avec un lien unique"><i class="fa-solid fa-share-alt"></i> Partager</button>
                 </div>
                 <button id="reset-cv-btn" class="w-full bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700 flex items-center justify-center gap-2" title="Cr√©er un nouveau CV vierge (supprime le contenu actuel)"><i class="fa-solid fa-file-circle-plus"></i> Nouveau CV</button>
                 <button id="toggle-overflow-btn" class="w-full bg-yellow-500 text-white py-2 px-4 rounded-md hover:bg-yellow-600 flex items-center justify-center gap-2" title="Activer la d√©tection visuelle des d√©bordements de contenu"><i class="fa-solid fa-ruler-combined"></i> D√©tection D√©passement</button>
                 <button id="toggle-presentation-mode-btn" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 flex items-center justify-center gap-2 mt-2" title="Mode pr√©sentation : masquer tous les √©l√©ments d'√©dition"><i class="fa-solid fa-eye"></i> Mode Pr√©sentation</button>
            </div>


            <!-- TABS -->
            <div id="tab-navigation" class="flex flex-wrap -mb-px border-b border-gray-200">
                <button class="tab-btn -mb-px py-3 px-4 text-sm font-medium border-b-2 whitespace-nowrap" data-target="#panel-ia"><i class="fa-solid fa-robot mr-1"></i> IA</button>
                <button class="tab-btn -mb-px py-3 px-4 text-sm font-medium border-b-2 whitespace-nowrap" data-target="#panel-content"><i class="fa-solid fa-file-lines mr-1"></i> Contenu</button>
                <button class="tab-btn -mb-px py-3 px-4 text-sm font-medium border-b-2 whitespace-nowrap" data-target="#panel-skills"><i class="fa-solid fa-star mr-1"></i> Comp√©tences</button>
                <button class="tab-btn -mb-px py-3 px-4 text-sm font-medium border-b-2 whitespace-nowrap" data-target="#panel-custom"><i class="fa-solid fa-puzzle-piece mr-1"></i> Sections</button>
                <button class="tab-btn -mb-px py-3 px-4 text-sm font-medium border-b-2 whitespace-nowrap" data-target="#panel-layout"><i class="fa-solid fa-columns mr-1"></i> Mise en Page</button>
                <button class="tab-btn -mb-px py-3 px-4 text-sm font-medium border-b-2 whitespace-nowrap" data-target="#panel-styles"><i class="fa-solid fa-palette mr-1"></i> Styles</button>
                <button class="tab-btn -mb-px py-3 px-4 text-sm font-medium border-b-2 whitespace-nowrap" data-target="#panel-banner"><i class="fa-solid fa-user-tie mr-1"></i> Banni√®re</button>
            </div>

            <div id="tab-content" class="py-4 flex-grow overflow-y-auto">
                <!-- TAB: IA -->
                <div id="panel-ia" class="tab-panel space-y-4">
                    <details class="control-group" open>
                        <summary><span>Configuration API Gemini</span><label class="completion-label"><input type="checkbox" id="completion-ia-config" class="completion-checkbox"><span>Fait ‚úÖ</span></label></summary>
                        <div class="control-group-content space-y-3">
                            <div class="space-y-2">
                                <label for="api-key-input" class="block text-sm font-medium text-gray-700">Cl√© API Gemini</label>
                                <div class="flex gap-2">
                                    <input type="password" id="api-key-input" placeholder="Entrez votre cl√© API Gemini..." class="flex-1 p-2 border rounded-md text-sm">
                                    <button id="save-api-key-btn" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 text-sm flex items-center gap-1" title="Sauvegarder votre cl√© API Gemini pour les fonctionnalit√©s IA">
                                        <i class="fas fa-save"></i> Sauver
                                    </button>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span id="api-key-status" class="api-key-status text-sm text-red-500">Cl√© API manquante</span>
                                    <button id="toggle-api-key-visibility" class="text-gray-500 hover:text-gray-700 text-sm" title="Afficher/Masquer la cl√©">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                                <div class="bg-blue-50 border border-blue-200 rounded-md p-3">
                                    <p class="text-xs text-blue-800">
                                        <i class="fas fa-info-circle mr-1"></i>
                                        <strong>Comment obtenir votre cl√© API :</strong><br>
                                        1. Allez sur <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-blue-600 underline">Google AI Studio</a><br>
                                        2. Cr√©ez une nouvelle cl√© API<br>
                                        3. Copiez-la et collez-la ci-dessus<br>
                                        <em>La cl√© est stock√©e localement dans votre navigateur.</em>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </details>
                    <details class="control-group" open>
                        <summary><span>Analyse IA Avanc√©e</span><label class="completion-label"><input type="checkbox" id="completion-ia-analyse" class="completion-checkbox"><span>Fait ‚úÖ</span></label></summary>
                        <div class="control-group-content space-y-2">
                            <textarea id="ai-input" rows="6" class="w-full p-2 border rounded-md" placeholder="Collez ici une description de poste, un CV brut..."></textarea>
                            <div class="grid grid-cols-2 gap-2">
                                <button id="analyze-btn" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 flex items-center justify-center gap-2"><i class="fa-solid fa-wand-magic-sparkles"></i> Analyser & Remplir</button>
                                <button id="smart-analyze-btn" class="bg-purple-600 text-white py-2 px-4 rounded-md hover:bg-purple-700 flex items-center justify-center gap-2"><i class="fa-solid fa-brain"></i> Analyse Smart</button>
                            </div>
                            <button id="industry-match-btn" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 flex items-center justify-center gap-2"><i class="fa-solid fa-industry"></i> Adapter au Secteur</button>
                        </div>
                    </details>
                    <details class="control-group" open>
                        <summary><span>Optimisations IA <span class="new-badge">NOUVEAU</span></span><label class="completion-label"><input type="checkbox" id="completion-ia-optimizations" class="completion-checkbox"><span>Fait ‚úÖ</span></label></summary>
                        <div class="control-group-content space-y-2">
                            <div class="grid grid-cols-2 gap-2">
                                <button id="ai-score-cv-btn" class="bg-emerald-600 text-white py-2 px-4 rounded-md hover:bg-emerald-700 flex items-center justify-center gap-2"><i class="fa-solid fa-chart-line"></i> Score ATS</button>
                                <button id="ai-keyword-optimize-btn" class="bg-teal-600 text-white py-2 px-4 rounded-md hover:bg-teal-700 flex items-center justify-center gap-2"><i class="fa-solid fa-key"></i> Mots-cl√©s</button>
                            </div>
                            <button id="ai-create-variants-btn" class="w-full bg-orange-600 text-white py-2 px-4 rounded-md hover:bg-orange-700 flex items-center justify-center gap-2"><i class="fa-solid fa-copy"></i> Cr√©er 3 Variantes</button>
                            <button id="ai-personalize-job-btn" class="w-full bg-rose-600 text-white py-2 px-4 rounded-md hover:bg-rose-700 flex items-center justify-center gap-2"><i class="fa-solid fa-bullseye"></i> Personnaliser pour Poste</button>
                        </div>
                    </details>
                    <details class="control-group" open>
                        <summary><span>Pr√©sentation Recruteur</span><label class="completion-label"><input type="checkbox" id="completion-ia-presentation" class="completion-checkbox"><span>Fait ‚úÖ</span></label></summary>
                        <div class="control-group-content space-y-3">
                            <input type="text" id="qualification-dispo" placeholder="Disponibilit√©" class="cv-input w-full p-2 border rounded-md">
                            <input type="text" id="qualification-salaire" placeholder="Pr√©tentions salariales" class="cv-input w-full p-2 border rounded-md">
                            <input type="text" id="qualification-loc" placeholder="Localisation" class="cv-input w-full p-2 border rounded-md">
                            <div class="grid grid-cols-2 gap-2">
                                <button id="generate-mail-btn" class="bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 flex items-center justify-center gap-2" title="G√©n√©rer un email de pr√©sentation professionnel bas√© sur votre CV"><i class="fas fa-wand-magic-sparkles"></i> Mail Pr√©sentation</button>
                                <button id="generate-linkedin-msg-btn" class="bg-blue-700 text-white py-2 px-4 rounded-md hover:bg-blue-800 flex items-center justify-center gap-2" title="Cr√©er un message LinkedIn personnalis√© pour votre recherche d'emploi"><i class="fab fa-linkedin"></i> Message LinkedIn</button>
                            </div>
                            <textarea id="recruiter-mail-content" rows="8" class="cv-input w-full p-2 border rounded-md mt-2" placeholder="Le message g√©n√©r√© appara√Ætra ici..."></textarea>
                        </div>
                    </details>
                    <details class="control-group" open>
                        <summary><span>IA Cr√©ative <span class="new-badge">NOUVEAU</span></span><label class="completion-label"><input type="checkbox" id="completion-ia-creative" class="completion-checkbox"><span>Fait ‚úÖ</span></label></summary>
                        <div class="control-group-content space-y-2">
                            <button id="ai-generate-motto-btn" class="w-full bg-violet-600 text-white py-2 px-4 rounded-md hover:bg-violet-700 flex items-center justify-center gap-2" title="Cr√©er une devise ou un slogan personnel unique avec l'IA"><i class="fa-solid fa-quote-left"></i> G√©n√©rer Devise/Slogan</button>
                            <button id="ai-suggest-improvements-btn" class="w-full bg-amber-600 text-white py-2 px-4 rounded-md hover:bg-amber-700 flex items-center justify-center gap-2" title="Obtenir des suggestions intelligentes pour am√©liorer votre CV"><i class="fa-solid fa-lightbulb"></i> Suggestions d'Am√©lioration</button>
                            <button id="ai-translate-cv-btn" class="w-full bg-cyan-600 text-white py-2 px-4 rounded-md hover:bg-cyan-700 flex items-center justify-center gap-2" title="Traduire automatiquement votre CV dans une autre langue"><i class="fa-solid fa-language"></i> Traduire CV</button>
                        </div>
                    </details>
                </div>

                <!-- TAB: Contenu -->
                <div id="panel-content" class="tab-panel hidden space-y-4">
                    <details class="control-group" open>
                        <summary><span>Informations Principales</span><label class="completion-label"><input type="checkbox" id="completion-content-infos" class="completion-checkbox"><span>Fait ‚úÖ</span></label></summary>
                        <div class="control-group-content space-y-3">
                            <input type="text" id="nom" placeholder="Nom" class="cv-input w-full p-2 border rounded-md">
                            <input type="text" id="prenom" placeholder="Pr√©nom" class="cv-input w-full p-2 border rounded-md">
                            <input type="text" id="poste" placeholder="Poste recherch√©" class="cv-input w-full p-2 border rounded-md">
                            <textarea id="description" placeholder="Description du profil" rows="4" class="cv-input w-full p-2 border rounded-md"></textarea>
                        </div>
                    </details>
                     <details class="control-group" open>
                        <summary><span>Exp√©riences</span><label class="completion-label"><input type="checkbox" id="completion-content-exp" class="completion-checkbox"><span>Fait ‚úÖ</span></label></summary>
                        <div class="control-group-content space-y-2">
                            <div class="flex justify-end mb-2"><button id="add-experience" class="text-sm text-blue-600 hover:text-blue-800 font-medium" title="Ajouter une nouvelle exp√©rience professionnelle"><i class="fas fa-circle-plus"></i> Ajouter un bloc</button></div>
                            <div id="experience-list" class="space-y-2"></div>
                        </div>
                    </details>
                     <details class="control-group" open>
                        <summary><span>Formations</span><label class="completion-label"><input type="checkbox" id="completion-content-form" class="completion-checkbox"><span>Fait ‚úÖ</span></label></summary>
                        <div class="control-group-content space-y-2">
                            <div class="flex justify-end mb-2"><button id="add-formation" class="text-sm text-blue-600 hover:text-blue-800 font-medium" title="Ajouter une nouvelle formation ou un dipl√¥me"><i class="fas fa-circle-plus"></i> Ajouter un bloc</button></div>
                            <div id="formation-list" class="space-y-2"></div>
                        </div>
                    </details>
                </div>
                
                <!-- TAB: Comp√©tences -->
                <div id="panel-skills" class="tab-panel hidden space-y-4">
                     <details class="control-group" open>
                        <summary><span>Comp√©tences</span><label class="completion-label"><input type="checkbox" id="completion-skills" class="completion-checkbox"><span>Fait ‚úÖ</span></label></summary>
                        <div class="control-group-content space-y-3">
                            <p class="text-sm font-medium">Style de Pr√©sentation</p>
                            <div class="grid grid-cols-3 gap-2">
                                <button data-skill-style="tags" class="skill-style-btn bg-gray-200 p-2 rounded-md text-sm active" title="Afficher les comp√©tences sous forme d'√©tiquettes color√©es">Tags</button>
                                <button data-skill-style="levels" class="skill-style-btn bg-gray-200 p-2 rounded-md text-sm" title="Pr√©senter les comp√©tences avec des niveaux de ma√Ætrise">Niveaux</button>
                                <button data-skill-style="simple" class="skill-style-btn bg-gray-200 p-2 rounded-md text-sm" title="Liste simple des comp√©tences sans niveau">Simple</button>
                                <button data-skill-style="circular" class="skill-style-btn bg-gray-200 p-2 rounded-md text-sm" title="Affichage circulaire avec jauges visuelles">Circulaire</button>
                                <button data-skill-style="categories" class="skill-style-btn bg-gray-200 p-2 rounded-md text-sm" title="Organiser les comp√©tences par cat√©gories">Cat√©gories</button>
                                <button data-skill-style="timeline" class="skill-style-btn bg-gray-200 p-2 rounded-md text-sm" title="Pr√©sentation chronologique des comp√©tences acquises">Timeline</button>
                            </div>
                            
                            <div id="skills-text-controls">
                                <div class="flex justify-between items-center"><label for="competences" class="font-medium">Liste des comp√©tences</label><div class="flex gap-2"><button id="ai-limit-skills-btn" class="text-blue-600 hover:text-blue-800" title="Limiter √† 10 comp√©tences par l'IA"><i class="fas fa-filter"></i> 10</button><button id="ai-synthesize-skills-btn" class="text-blue-600 hover:text-blue-800" title="Synth√©tiser et ranger les comp√©tences par l'IA"><i class="fas fa-brain"></i></button><button id="ai-skills-from-job-btn" class="text-purple-600 hover:text-purple-800" title="G√©n√©rer comp√©tences depuis offre d'emploi"><i class="fas fa-magic-wand-sparkles"></i> Job</button></div></div>
                                <textarea id="competences" placeholder="Comp√©tences (s√©par√©es par des virgules)..." rows="4" class="cv-input w-full p-2 border rounded-md"></textarea>
                            </div>

                            <div id="skills-level-controls" class="hidden space-y-3">
                                <p class="text-sm font-medium">Style de Jauge</p>
                                <div class="grid grid-cols-6 gap-2 text-center">
                                    <button data-gauge-style="bar" class="gauge-style-btn bg-gray-200 p-2 rounded-md text-sm active" title="Barre"><i class="fas fa-bars"></i></button>
                                    <button data-gauge-style="dots" class="gauge-style-btn bg-gray-200 p-2 rounded-md text-sm" title="Points"><i class="fas fa-circle"></i></button>
                                    <button data-gauge-style="stars" class="gauge-style-btn bg-gray-200 p-2 rounded-md text-sm" title="√âtoiles"><i class="fas fa-star"></i></button>
                                    <button data-gauge-style="squares" class="gauge-style-btn bg-gray-200 p-2 rounded-md text-sm" title="Carr√©s"><i class="fas fa-square"></i></button>
                                    <button data-gauge-style="number" class="gauge-style-btn bg-gray-200 p-2 rounded-md text-sm font-bold" title="Chiffres">‚Öó</button>
                                    <button data-gauge-style="percentage" class="gauge-style-btn bg-gray-200 p-2 rounded-md text-sm" title="Pourcentage">%</button>
                                </div>
                                <div id="skills-level-list" class="space-y-2 border-t pt-3"></div>
                                <button id="add-skill-level-btn" class="w-full bg-blue-100 text-blue-800 py-2 px-4 rounded-md hover:bg-blue-200 flex items-center justify-center gap-2 text-sm" title="Ajouter une nouvelle comp√©tence avec niveau de ma√Ætrise"><i class="fas fa-plus-circle"></i> Ajouter une comp√©tence</button>
                            </div>
                        </div>
                    </details>
                    <details class="control-group" open>
                        <summary><span>Comp√©tences Avanc√©es <span class="new-badge">NOUVEAU</span></span><label class="completion-label"><input type="checkbox" id="completion-skills-advanced" class="completion-checkbox"><span>Fait ‚úÖ</span></label></summary>
                        <div class="control-group-content space-y-3">
                            <button id="skill-matcher-btn" class="w-full bg-emerald-600 text-white py-2 px-4 rounded-md hover:bg-emerald-700 flex items-center justify-center gap-2" title="Analyser la correspondance entre vos comp√©tences et celles demand√©es dans l'offre d'emploi"><i class="fa-solid fa-search"></i> Analyse Comp√©tences vs Poste</button>
                            <button id="suggest-missing-skills-btn" class="w-full bg-orange-600 text-white py-2 px-4 rounded-md hover:bg-orange-700 flex items-center justify-center gap-2" title="Identifier les comp√©tences manquantes pour le poste vis√©"><i class="fa-solid fa-plus-circle"></i> Comp√©tences Manquantes</button>
                            <button id="skill-trend-analysis-btn" class="w-full bg-purple-600 text-white py-2 px-4 rounded-md hover:bg-purple-700 flex items-center justify-center gap-2" title="D√©couvrir les comp√©tences les plus demand√©es dans votre secteur"><i class="fa-solid fa-trending-up"></i> Tendances du March√©</button>
                            <div class="border-t pt-3">
                                <label class="text-sm font-medium mb-2 block">Templates de Comp√©tences</label>
                                <div class="grid grid-cols-2 gap-2">
                                    <button data-skill-template="tech" class="skill-template-btn bg-blue-100 text-blue-800 p-2 rounded-md text-sm hover:bg-blue-200" title="Comp√©tences techniques et informatiques">Tech</button>
                                    <button data-skill-template="marketing" class="skill-template-btn bg-green-100 text-green-800 p-2 rounded-md text-sm hover:bg-green-200" title="Comp√©tences en marketing et communication">Marketing</button>
                                    <button data-skill-template="finance" class="skill-template-btn bg-yellow-100 text-yellow-800 p-2 rounded-md text-sm hover:bg-yellow-200" title="Comp√©tences financi√®res et comptables">Finance</button>
                                    <button data-skill-template="design" class="skill-template-btn bg-purple-100 text-purple-800 p-2 rounded-md text-sm hover:bg-purple-200" title="Comp√©tences cr√©atives et de design">Design</button>
                                    <button data-skill-template="management" class="skill-template-btn bg-red-100 text-red-800 p-2 rounded-md text-sm hover:bg-red-200" title="Comp√©tences de management et leadership">Management</button>
                                    <button data-skill-template="sales" class="skill-template-btn bg-indigo-100 text-indigo-800 p-2 rounded-md text-sm hover:bg-indigo-200" title="Comp√©tences commerciales et de vente">Ventes</button>
                                </div>
                            </div>
                        </div>
                    </details>
                </div>

                <!-- TAB: Sections Perso -->
                <div id="panel-custom" class="tab-panel hidden space-y-4">
                    <details class="control-group" open>
                        <summary><span>Sections Personnalis√©es</span><label class="completion-label"><input type="checkbox" id="completion-custom" class="completion-checkbox"><span>Fait ‚úÖ</span></label></summary>
                        <div class="control-group-content space-y-3">
                            <div class="space-y-2">
                                <label class="text-sm font-medium">Ajouter une nouvelle section</label>
                                <select id="section-suggestion-select" class="w-full p-2 border rounded-md text-sm">
                                    <option value="">-- Choisir une suggestion --</option>
                                    <option value="Langues üåê">Langues üåê</option>
                                    <option value="Centres d'int√©r√™t üé®">Centres d'int√©r√™t üé®</option>
                                    <option value="Certifications üìú">Certifications üìú</option>
                                    <option value="Projets Personnels üí°">Projets Personnels üí°</option>
                                    <option value="B√©n√©volat ‚ù§Ô∏è">B√©n√©volat ‚ù§Ô∏è</option>
                                    <option value="Publications üìö">Publications üìö</option>
                                    <option value="R√©compenses üèÜ">R√©compenses üèÜ</option>
                                    <option value="R√©f√©rences üë•">R√©f√©rences üë•</option>
                                    <option value="Portfolio üé®">Portfolio üé®</option>
                                    <option value="R√©seaux Sociaux üì±">R√©seaux Sociaux üì±</option>
                                    <option value="Objectifs de Carri√®re üéØ">Objectifs de Carri√®re üéØ</option>
                                    <option value="Soft Skills üí≠">Soft Skills üí≠</option>
                                </select>
                                <div class="flex gap-2">
                                    <input type="text" id="new-section-title-input" class="flex-grow p-2 border rounded-md text-sm" placeholder="Ou tapez un titre personnalis√©...">
                                    <button id="add-section-btn" class="bg-indigo-500 text-white py-2 px-4 rounded-md hover:bg-indigo-600" title="Cr√©er une nouvelle section personnalis√©e"><i class="fas fa-plus"></i></button>
                                </div>
                            </div>
                            <div id="custom-sections-list" class="space-y-2 mt-2 border-t pt-2"></div>
                        </div>
                    </details>
                    <details class="control-group" open>
                        <summary><span>Templates de Sections <span class="new-badge">NOUVEAU</span></span><label class="completion-label"><input type="checkbox" id="completion-custom-templates" class="completion-checkbox"><span>Fait ‚úÖ</span></label></summary>
                        <div class="control-group-content space-y-3">
                            <button id="ai-suggest-sections-btn" class="w-full bg-purple-600 text-white py-2 px-4 rounded-md hover:bg-purple-700 flex items-center justify-center gap-2" title="L'IA sugg√®re les sections les plus adapt√©es √† votre profil"><i class="fa-solid fa-magic-wand-sparkles"></i> IA : Sections Sugg√©r√©es</button>
                            <div class="grid grid-cols-2 gap-2">
                                <button data-section-template="startup" class="section-template-btn bg-orange-100 text-orange-800 p-2 rounded-md text-sm hover:bg-orange-200" title="Sections sp√©cialis√©es pour les profils startup et entrepreneuriat">Startup</button>
                                <button data-section-template="academic" class="section-template-btn bg-blue-100 text-blue-800 p-2 rounded-md text-sm hover:bg-blue-200" title="Sections adapt√©es au monde acad√©mique et √† la recherche">Acad√©mique</button>
                                <button data-section-template="creative" class="section-template-btn bg-purple-100 text-purple-800 p-2 rounded-md text-sm hover:bg-purple-200" title="Sections pour les m√©tiers cr√©atifs et artistiques">Cr√©atif</button>
                                <button data-section-template="executive" class="section-template-btn bg-gray-100 text-gray-800 p-2 rounded-md text-sm hover:bg-gray-200" title="Sections pour les postes de direction et management">Cadre</button>
                                <button data-section-template="international" class="section-template-btn bg-green-100 text-green-800 p-2 rounded-md text-sm hover:bg-green-200" title="Sections pour les profils internationaux et multilingues">International</button>
                                <button data-section-template="freelance" class="section-template-btn bg-yellow-100 text-yellow-800 p-2 rounded-md text-sm hover:bg-yellow-200" title="Sections adapt√©es aux consultants et freelances">Freelance</button>
                            </div>
                        </div>
                    </details>
                    <details class="control-group" open>
                        <summary><span>Import/Export Sections <span class="new-badge">NOUVEAU</span></span><label class="completion-label"><input type="checkbox" id="completion-custom-import" class="completion-checkbox"><span>Fait ‚úÖ</span></label></summary>
                        <div class="control-group-content space-y-3">
                            <button id="export-sections-btn" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 flex items-center justify-center gap-2" title="Sauvegarder vos sections personnalis√©es dans un fichier"><i class="fa-solid fa-download"></i> Exporter Sections</button>
                            <button id="import-sections-btn" class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 flex items-center justify-center gap-2" title="Charger des sections personnalis√©es depuis un fichier"><i class="fa-solid fa-upload"></i> Importer Sections</button>
                            <input type="file" id="import-sections-file" accept=".json" class="hidden">
                        </div>
                    </details>
                </div>

                <!-- TAB: Mise en Page -->
                <div id="panel-layout" class="tab-panel hidden space-y-4">
                    <details class="control-group" open>
                        <summary><span>Mise en Colonnes</span><label class="completion-label"><input type="checkbox" id="completion-layout-cols" class="completion-checkbox"><span>Fait ‚úÖ</span></label></summary>
                        <div class="control-group-content">
                            <div class="grid grid-cols-3 gap-2 mb-3">
                                <button data-layout="layout-1-col" class="layout-btn bg-gray-200 p-2 rounded-md text-sm" title="Une seule colonne pour un design classique">1</button>
                                <button data-layout="layout-2-col-33-67" class="layout-btn bg-gray-200 p-2 rounded-md text-sm" title="Deux colonnes : petite (33%) et grande (67%)">33/67</button>
                                <button data-layout="layout-2-col-50-50" class="layout-btn bg-gray-200 p-2 rounded-md text-sm" title="Deux colonnes √©gales (50% chacune)">50/50</button>
                                <button data-layout="layout-2-col-67-33" class="layout-btn bg-gray-200 p-2 rounded-md text-sm" title="Deux colonnes : grande (67%) et petite (33%)">67/33</button>
                                <button data-layout="layout-3-col" class="layout-btn bg-gray-200 p-2 rounded-md text-sm" title="Trois colonnes √©gales pour plus de contenu">3 Col.</button>
                                <button data-layout="layout-asymmetric-1" class="layout-btn bg-gray-200 p-2 rounded-md text-sm" title="Layout asym√©trique : petite-grande-petite">1-2-1</button>
                            </div>
                            <button id="ai-suggest-layout-btn" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 flex items-center justify-center gap-2" title="L'IA recommande le meilleur layout selon votre contenu"><i class="fa-solid fa-magic-wand-sparkles"></i> Suggestion IA de Layout</button>
                        </div>
                    </details>
                    <details class="control-group" open>
                        <summary><span>Espacements & Tailles</span><label class="completion-label"><input type="checkbox" id="completion-layout-spacing" class="completion-checkbox"><span>Fait ‚úÖ</span></label></summary>
                        <div class="control-group-content space-y-4">
                            <div><label for="page-margin" class="block text-sm font-medium text-gray-700">Marge Page: <span id="page-margin-value">2</span>cm</label><input type="range" id="page-margin" min="0.5" max="3" step="0.1" value="2" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer"></div>
                            <div><label for="module-spacing" class="block text-sm font-medium text-gray-700">Espace Blocs: <span id="module-spacing-value">1.5</span>rem</label><input type="range" id="module-spacing" min="0" max="4" step="0.1" value="1.5" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer"></div>
                            <div><label for="item-spacing" class="block text-sm font-medium text-gray-700">Espace √âl√©ments: <span id="item-spacing-value">0.5</span>rem</label><input type="range" id="item-spacing" min="0" max="2" step="0.1" value="0.5" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer"></div>
                            <div><label for="font-size-h1" class="block text-sm font-medium text-gray-700">Taille Titre Principal: <span id="font-size-h1-value">40</span>pt</label><input type="range" id="font-size-h1" min="20" max="50" step="1" value="40" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer"></div><div><label for="font-size-h2" class="block text-sm font-medium text-gray-700">Taille Titres Section: <span id="font-size-h2-value">21</span>pt</label><input type="range" id="font-size-h2" min="14" max="30" step="1" value="21" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer"></div><div><label for="font-size-p" class="block text-sm font-medium text-gray-700">Taille Paragraphe: <span id="font-size-p-value">10</span>pt</label><input type="range" id="font-size-p" min="8" max="14" step="0.5" value="10" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer"></div><div><label for="font-size-banner" class="block text-sm font-medium text-gray-700">Taille Banni√®re: <span id="font-size-banner-value">9</span>pt</label><input type="range" id="font-size-banner" min="7" max="12" step="0.5" value="9" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer"></div><div><label for="line-height" class="block text-sm font-medium text-gray-700">Interligne: <span id="line-height-value">1.6</span></label><input type="range" id="line-height" min="0.8" max="2.5" step="0.1" value="1.6" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer"></div><div><label for="paragraph-spacing" class="block text-sm font-medium text-gray-700">Espace Paragraphe: <span id="paragraph-spacing-value">0.5</span>rem</label><input type="range" id="paragraph-spacing" min="0" max="2" step="0.1" value="0.5" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer"></div>
                        </div>
                    </details>
                    <details class="control-group" open>
                        <summary><span>Pr√©sentation Avanc√©e <span class="new-badge">NOUVEAU</span></span><label class="completion-label"><input type="checkbox" id="completion-layout-advanced" class="completion-checkbox"><span>Fait ‚úÖ</span></label></summary>
                        <div class="control-group-content space-y-4">
                            <div class="grid grid-cols-2 gap-2">
                                <label class="flex items-center gap-2 text-sm"><input type="checkbox" id="enable-zebra-sections" class="cv-input">Sections altern√©es</label>
                                <label class="flex items-center gap-2 text-sm"><input type="checkbox" id="enable-floating-elements" class="cv-input">√âl√©ments flottants</label>
                            </div>
                            <button id="auto-optimize-layout-btn" class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 flex items-center justify-center gap-2" title="Optimisation automatique de la mise en page pour un rendu parfait"><i class="fa-solid fa-magic-wand-sparkles"></i> Auto-Optimiser Layout</button>
                            <button id="save-layout-template-btn" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 flex items-center justify-center gap-2" title="Sauvegarder cette mise en page comme mod√®le r√©utilisable"><i class="fa-solid fa-bookmark"></i> Sauver comme Template</button>
                        </div>
                    </details>
                </div>
                
                <!-- TAB: Styles Globaux -->
                <div id="panel-styles" class="tab-panel hidden space-y-4">
                     <details class="control-group" open>
                        <summary><span>Th√®mes Pr√©d√©finis</span><label class="completion-label"><input type="checkbox" id="completion-styles-themes" class="completion-checkbox"><span>Fait ‚úÖ</span></label></summary>
                        <div class="control-group-content">
                            <div id="theme-buttons" class="grid grid-cols-3 gap-2">
                                <button data-theme="professional" class="theme-btn bg-gray-200 p-2 rounded-md text-sm" title="Style professionnel classique et sobre">Pro</button>
                                <button data-theme="creative" class="theme-btn bg-gray-200 p-2 rounded-md text-sm" title="Design cr√©atif avec couleurs vives">Cr√©atif</button>
                                <button data-theme="modern" class="theme-btn bg-gray-200 p-2 rounded-md text-sm" title="Look moderne et √©pur√©">Moderne</button>
                                <button data-theme="elegant" class="theme-btn bg-gray-200 p-2 rounded-md text-sm" title="√âl√©gance avec touches dor√©es">√âl√©gant</button>
                                <button data-theme="tech" class="theme-btn bg-gray-200 p-2 rounded-md text-sm" title="Style tech avec couleurs tech">Tech</button>
                                <button data-theme="luxury" class="theme-btn bg-gray-200 p-2 rounded-md text-sm" title="Th√®me luxueux et premium">Luxe</button>
                                <button data-theme="startup" class="theme-btn bg-gray-200 p-2 rounded-md text-sm" title="Dynamique et innovant pour startups">Startup</button>
                                <button data-theme="academic" class="theme-btn bg-gray-200 p-2 rounded-md text-sm" title="Style acad√©mique et s√©rieux">Acad√©mique</button>
                                <button data-theme="artistic" class="theme-btn bg-gray-200 p-2 rounded-md text-sm" title="Th√®me artistique et cr√©atif">Artistique</button>
                            </div>
                            <button id="random-theme-btn" class="w-full mt-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white py-2 px-4 rounded-md hover:from-purple-600 hover:to-pink-600 flex items-center justify-center gap-2" title="Appliquer un th√®me au hasard pour l'inspiration"><i class="fa-solid fa-dice"></i> Th√®me Al√©atoire</button>
                        </div>
                    </details>
                     <details class="control-group" open>
                        <summary><span>Couleurs</span><label class="completion-label"><input type="checkbox" id="completion-styles-colors" class="completion-checkbox"><span>Fait ‚úÖ</span></label></summary>
                        <div class="control-group-content">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="primary-color-picker" class="block text-sm font-medium text-gray-700">Principale</label>
                                    <input type="color" id="primary-color-picker" value="#2563eb" class="cv-input w-full h-10 p-1 border rounded-md">
                                </div>
                                <div>
                                    <label for="secondary-color-picker" class="block text-sm font-medium text-gray-700">Secondaire</label>
                                    <div class="flex items-center">
                                        <input type="color" id="secondary-color-picker" value="#334155" class="cv-input w-full h-10 p-1 border rounded-md">
                                        <button id="ai-color-btn" title="Suggestion IA" class="ml-2 text-blue-600 hover:text-blue-800"><i class="fas fa-wand-magic-sparkles"></i></button>
                                    </div>
                                </div>
                                <div class="col-span-2">
                                    <label for="body-text-color-picker" class="block text-sm font-medium text-gray-700">Texte du corps</label>
                                    <input type="color" id="body-text-color-picker" value="#334155" class="cv-input w-full h-10 p-1 border rounded-md">
                                </div>
                            </div>
                            <div class="mt-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Palettes Harmonieuses</label>
                                <div class="grid grid-cols-4 gap-2">
                                    <button class="color-palette-btn h-8 rounded-md border-2 border-transparent hover:border-gray-400" style="background: linear-gradient(45deg, #667eea 0%, #764ba2 100%)" data-colors='["#667eea", "#764ba2", "#2d3748"]'></button>
                                    <button class="color-palette-btn h-8 rounded-md border-2 border-transparent hover:border-gray-400" style="background: linear-gradient(45deg, #f093fb 0%, #f5576c 100%)" data-colors='["#f093fb", "#f5576c", "#2d3748"]'></button>
                                    <button class="color-palette-btn h-8 rounded-md border-2 border-transparent hover:border-gray-400" style="background: linear-gradient(45deg, #4facfe 0%, #00f2fe 100%)" data-colors='["#4facfe", "#00f2fe", "#2d3748"]'></button>
                                    <button class="color-palette-btn h-8 rounded-md border-2 border-transparent hover:border-gray-400" style="background: linear-gradient(45deg, #43e97b 0%, #38f9d7 100%)" data-colors='["#43e97b", "#38f9d7", "#2d3748"]'></button>
                                    <button class="color-palette-btn h-8 rounded-md border-2 border-transparent hover:border-gray-400" style="background: linear-gradient(45deg, #fa709a 0%, #fee140 100%)" data-colors='["#fa709a", "#fee140", "#2d3748"]'></button>
                                    <button class="color-palette-btn h-8 rounded-md border-2 border-transparent hover:border-gray-400" style="background: linear-gradient(45deg, #a8edea 0%, #fed6e3 100%)" data-colors='["#a8edea", "#fed6e3", "#2d3748"]'></button>
                                    <button class="color-palette-btn h-8 rounded-md border-2 border-transparent hover:border-gray-400" style="background: linear-gradient(45deg, #ff9a9e 0%, #fecfef 100%)" data-colors='["#ff9a9e", "#fecfef", "#2d3748"]'></button>
                                    <button class="color-palette-btn h-8 rounded-md border-2 border-transparent hover:border-gray-400" style="background: linear-gradient(45deg, #667eea 0%, #764ba2 100%)" data-colors='["#667eea", "#764ba2", "#2d3748"]'></button>
                                </div>
                            </div>
                        </div>
                    </details>
                     <details class="control-group" open>
                        <summary><span>Polices</span><label class="completion-label"><input type="checkbox" id="completion-styles-fonts" class="completion-checkbox"><span>Fait ‚úÖ</span></label></summary>
                        <div class="control-group-content space-y-4">
                            <button id="ai-suggest-fonts-btn" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 flex items-center justify-center gap-2" title="L'IA recommande les meilleures combinaisons de polices pour votre CV"><i class="fa-solid fa-font"></i> Suggestions IA de Polices</button>
                            <div>
                                <label for="font-family-h1-select" class="block text-sm font-medium text-gray-700">Titre Principal (H1)</label>
                                <select id="font-family-h1-select" class="cv-input w-full p-2 border rounded-md"></select>
                            </div>
                            <div>
                                <label for="font-family-h2-select" class="block text-sm font-medium text-gray-700">Titres de Section (H2)</label>
                                <select id="font-family-h2-select" class="cv-input w-full p-2 border rounded-md"></select>
                            </div>
                            <div>
                                <label for="font-family-body-select" class="block text-sm font-medium text-gray-700">Corps de Texte</label>
                                <select id="font-family-body-select" class="cv-input w-full p-2 border rounded-md"></select>
                            </div>
                        </div>
                    </details>
                     <details class="control-group" open>
                        <summary><span>Effets Visuels <span class="new-badge">NOUVEAU</span></span><label class="completion-label"><input type="checkbox" id="completion-styles-effects" class="completion-checkbox"><span>Fait ‚úÖ</span></label></summary>
                        <div class="control-group-content space-y-4">
                            <div>
                                <label for="cv-shadow-intensity" class="block text-sm font-medium text-gray-700">Ombre des pages: <span id="cv-shadow-intensity-value">10</span></label>
                                <input type="range" id="cv-shadow-intensity" min="0" max="30" step="1" value="10" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer">
                            </div>
                            <div>
                                <label for="section-border-radius" class="block text-sm font-medium text-gray-700">Arrondi des sections: <span id="section-border-radius-value">0</span>px</label>
                                <input type="range" id="section-border-radius" min="0" max="20" step="1" value="0" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer">
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <label class="flex items-center gap-2 text-sm"><input type="checkbox" id="enable-gradients" class="cv-input">D√©grad√©s sur titres</label>
                                <label class="flex items-center gap-2 text-sm"><input type="checkbox" id="enable-animations" class="cv-input">Animations subtiles</label>
                            </div>
                            <button id="apply-glassmorphism-btn" class="w-full bg-gradient-to-r from-cyan-500 to-blue-500 text-white py-2 px-4 rounded-md hover:from-cyan-600 hover:to-blue-600 flex items-center justify-center gap-2" title="Appliquer un effet glassmorphism moderne et tendance"><i class="fa-solid fa-sparkles"></i> Effet Glassmorphism</button>
                        </div>
                    </details>
                     <details class="control-group" open>
                        <summary><span>Style des Titres de Section</span><label class="completion-label"><input type="checkbox" id="completion-styles-titles" class="completion-checkbox"><span>Fait ‚úÖ</span></label></summary>
                        <div class="control-group-content">
                            <div class="grid grid-cols-2 gap-2">
                                <button data-title-style="style-underline" class="section-title-style-btn bg-gray-200 p-2 rounded-md text-sm active" title="Titres avec soulignement classique">Soulign√©</button>
                                <button data-title-style="style-side-line" class="section-title-style-btn bg-gray-200 p-2 rounded-md text-sm" title="Ligne verticale sur le c√¥t√© gauche">Ligne C√¥t√©</button>
                                <button data-title-style="style-background" class="section-title-style-btn bg-gray-200 p-2 rounded-md text-sm" title="Arri√®re-plan color√© pour les titres">Fond</button>
                                <button data-title-style="style-boxed" class="section-title-style-btn bg-gray-200 p-2 rounded-md text-sm" title="Titres encadr√©s avec bordure">Encadr√©</button>
                                <button data-title-style="style-gradient" class="section-title-style-btn bg-gray-200 p-2 rounded-md text-sm" title="D√©grad√© de couleurs sur les titres">D√©grad√©</button>
                                <button data-title-style="style-shadow" class="section-title-style-btn bg-gray-200 p-2 rounded-md text-sm" title="Effet d'ombre sur le texte">Ombre</button>
                            </div>
                        </div>
                    </details>
                </div>

                <!-- TAB: Banni√®re -->
                <div id="panel-banner" class="tab-panel hidden space-y-4">
                     <details class="control-group" open>
                        <summary><span>Banni√®re Recruteur</span><label class="completion-label"><input type="checkbox" id="completion-banner-main" class="completion-checkbox"><span>Fait ‚úÖ</span></label></summary>
                        <div class="control-group-content space-y-3">
                            <div class="flex justify-between items-center">
                                <h3 class="font-semibold text-gray-700">Banni√®re Recruteur</h3>
                                <button id="reset-recruiter-btn" class="text-sm text-gray-500 hover:text-red-600" title="R√©initialiser les informations recruteur"><i class="fas fa-undo"></i></button>
                            </div>
                            <div id="banner-fix-controls"><button id="fix-banner-top-btn" class="w-full bg-teal-600 text-white py-2 px-4 rounded-md hover:bg-teal-700 flex items-center justify-center gap-2" title="Fixer la banni√®re en haut de toutes les pages"><i class="fas fa-arrow-up"></i>Fixer en haut</button><button id="fix-banner-bottom-btn" class="w-full bg-teal-600 text-white py-2 px-4 rounded-md hover:bg-teal-700 flex items-center justify-center gap-2 mt-2" title="Fixer la banni√®re en bas de toutes les pages"><i class="fas fa-arrow-down"></i>Fixer en bas</button></div><button id="modular-banner-btn" class="cv-input w-full bg-orange-500 text-white py-2 px-4 rounded-md hover:bg-orange-600 flex items-center justify-center gap-2 hidden" title="Rendre la banni√®re d√©pla√ßable dans les colonnes"><i class="fas fa-arrows-up-down-left-right"></i>Rendre modulaire</button><label class="flex items-center gap-2 text-sm"><input type="checkbox" id="toggle-banner-checkbox" class="cv-input">Afficher la banni√®re</label><label for="banner-style-select" class="text-sm font-medium">Style de Banni√®re</label><select id="banner-style-select" class="cv-input w-full p-2 border rounded-md"><option value="banner-style-modern">Moderne</option><option value="banner-style-elegant">√âl√©gant</option><option value="banner-style-discret">Discret</option><option value="banner-style-carte">Carte</option><option value="banner-style-degrade">D√©grad√©</option><option value="banner-style-premium">Premium</option><option value="banner-style-minimal">Minimal</option><option value="banner-style-encadre">Encadr√©</option><option value="banner-style-ligne-haute">Ligne Haute</option></select><p class="text-sm font-medium">Alignement</p><div class="flex gap-2"><button data-banner-align="left" class="banner-align-btn flex-1 bg-gray-200 p-2 rounded-md text-sm" title="Aligner la banni√®re √† gauche"><i class="fas fa-align-left"></i></button><button data-banner-align="center" class="banner-align-btn flex-1 bg-gray-200 p-2 rounded-md text-sm" title="Centrer la banni√®re"><i class="fas fa-align-center"></i></button><button data-banner-align="right" class="banner-align-btn flex-1 bg-gray-200 p-2 rounded-md text-sm" title="Aligner la banni√®re √† droite"><i class="fas fa-align-right"></i></button><button id="banner-invert-btn" class="p-2 bg-gray-200 rounded-md text-sm" title="Inverser Logo/Texte"><i class="fas fa-right-left"></i></button></div><p class="text-sm font-medium">Taille Logo</p><div class="flex gap-2"><button data-logo-size="sm" class="logo-size-btn flex-1 bg-gray-200 p-2 rounded-md text-sm" title="Logo petit (40px)">P</button><button data-logo-size="md" class="logo-size-btn flex-1 bg-gray-200 p-2 rounded-md text-sm" title="Logo moyen (60px)">M</button><button data-logo-size="lg" class="logo-size-btn flex-1 bg-gray-200 p-2 rounded-md text-sm" title="Logo grand (80px)">G</button><button data-logo-size="xl" class="logo-size-btn flex-1 bg-gray-200 p-2 rounded-md text-sm" title="Logo tr√®s grand (100px)">XL</button><button data-logo-size="xxl" class="logo-size-btn flex-1 bg-gray-200 p-2 rounded-md text-sm" title="Logo extra grand (120px)">XXL</button></div><div><label for="banner-element-spacing" class="block text-sm font-medium text-gray-700">Espace Banni√®re: <span id="banner-element-spacing-value">1</span>rem</label><input type="range" id="banner-element-spacing" min="0.5" max="4" step="0.1" value="1" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer"></div><input type="text" id="banner-nom" placeholder="Votre Nom & Pr√©nom" class="banner-input w-full p-2 border rounded-md"><input type="text" id="banner-poste" placeholder="Votre Poste" class="banner-input w-full p-2 border rounded-md"><input type="email" id="banner-email" placeholder="Email" class="banner-input w-full p-2 border rounded-md"><input type="tel" id="banner-tel" placeholder="T√©l√©phone" class="banner-input w-full p-2 border rounded-md"><div><label for="banner-image" class="block text-sm font-medium text-gray-700">Photo/Logo</label><input type="file" id="banner-image" accept="image/*" class="banner-input mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"></div>
                        </div>
                    </details>
                     <details class="control-group" open>
                        <summary><span>Image de Fond</span><label class="completion-label"><input type="checkbox" id="completion-banner-bg" class="completion-checkbox"><span>Fait ‚úÖ</span></label></summary>
                        <div class="control-group-content space-y-4">
                            <div>
                                <label for="banner-bg-image" class="block text-sm font-medium text-gray-700">T√©l√©charger une image</label>
                                <input type="file" id="banner-bg-image" accept="image/*" class="banner-input mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                            </div>
                            <div>
                                <label for="banner-bg-opacity" class="block text-sm font-medium text-gray-700">Opacit√©: <span id="banner-bg-opacity-value">1</span></label>
                                <input type="range" id="banner-bg-opacity" min="0" max="1" step="0.05" value="1" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer">
                            </div>
                            <div>
                                <label for="banner-bg-blur" class="block text-sm font-medium text-gray-700">Flou: <span id="banner-bg-blur-value">0</span>px</label>
                                <input type="range" id="banner-bg-blur" min="0" max="20" step="1" value="0" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer">
                            </div>
                            <label class="flex items-center gap-2 text-sm"><input type="checkbox" id="banner-bg-grayscale" class="cv-input">Image en noir et blanc</label>
                            <button id="remove-banner-bg-btn" class="w-full bg-red-500 text-white py-2 px-4 rounded-md hover:bg-red-600 flex items-center justify-center gap-2" title="Supprimer l'image de fond de la banni√®re"><i class="fas fa-trash"></i> Supprimer l'image de fond</button>
                        </div>
                    </details>
                     <details class="control-group" open>
                        <summary><span>Style du Texte</span><label class="completion-label"><input type="checkbox" id="completion-banner-text" class="completion-checkbox"><span>Fait ‚úÖ</span></label></summary>
                        <div class="control-group-content space-y-4">
                            <button id="randomize-banner-style-btn" class="w-full bg-indigo-500 text-white py-2 px-4 rounded-md hover:bg-indigo-600 flex items-center justify-center gap-2" title="Appliquer un style de banni√®re al√©atoire pour l'inspiration"><i class="fas fa-dice"></i> Style Al√©atoire</button><div class="border-t pt-4 mt-4"><h4 class="font-semibold text-sm mb-2">Nom & Pr√©nom</h4><label class="text-xs">Police</label><select id="banner-nom-font" class="cv-input w-full p-1 border text-sm rounded-md"><option value="'Montserrat', sans-serif">Montserrat</option><option value="'Playfair Display', serif">Playfair Display</option><option value="'Oswald', sans-serif">Oswald</option><option value="'Cormorant Garamond', serif">Cormorant Garamond</option><option value="'Merriweather', serif">Merriweather</option><option value="'Lato', sans-serif">Lato</option></select><label class="text-xs mt-2 block">Taille: <span id="banner-nom-size-value">24</span>pt</label><input type="range" id="banner-nom-size" min="14" max="40" step="1" value="24" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer"><div class="flex items-center gap-2 mt-2"><label class="text-xs">Couleur:</label><input type="color" id="banner-nom-color" value="#334155" class="cv-input w-full h-8 p-1 border rounded-md"><button id="banner-nom-bold" class="style-toggle-btn p-1 px-2 rounded-md bg-gray-200 text-sm"><i class="fas fa-bold"></i></button><button id="banner-nom-italic" class="style-toggle-btn p-1 px-2 rounded-md bg-gray-200 text-sm"><i class="fas fa-italic"></i></button></div></div><div class="border-t pt-4 mt-4"><h4 class="font-semibold text-sm mb-2">Poste</h4><label class="text-xs mt-2 block">Taille: <span id="banner-poste-size-value">12</span>pt</label><input type="range" id="banner-poste-size" min="8" max="20" step="0.5" value="12" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer"><div class="flex items-center gap-2 mt-2"><label class="text-xs">Couleur:</label><input type="color" id="banner-poste-color" value="#334155" class="cv-input w-full h-8 p-1 border rounded-md"><button id="banner-poste-bold" class="style-toggle-btn p-1 px-2 rounded-md bg-gray-200 text-sm"><i class="fas fa-bold"></i></button><button id="banner-poste-italic" class="style-toggle-btn p-1 px-2 rounded-md bg-gray-200 text-sm"><i class="fas fa-italic"></i></button></div></div><div class="border-t pt-4 mt-4"><h4 class="font-semibold text-sm mb-2">Coordonn√©es</h4><label class="text-xs mt-2 block">Taille: <span id="banner-contact-size-value">9</span>pt</label><input type="range" id="banner-contact-size" min="7" max="14" step="0.5" value="9" class="cv-input w-full h-2 bg-gray-200 rounded-lg cursor-pointer"><div class="flex items-center gap-2 mt-2"><label class="text-xs">Couleur:</label><input type="color" id="banner-contact-color" value="#334155" class="cv-input w-full h-8 p-1 border rounded-md"><button id="banner-contact-bold" class="style-toggle-btn p-1 px-2 rounded-md bg-gray-200 text-sm"><i class="fas fa-bold"></i></button><button id="banner-contact-italic" class="style-toggle-btn p-1 px-2 rounded-md bg-gray-200 text-sm"><i class="fas fa-italic"></i></button></div></div>
                        </div>
                    </details>
                </div>
            </div>

        </div>

        <!-- PREVIEW PANEL -->
        <div class="w-full lg:w-2/3 xl:w-3/4 p-4 bg-gray-200 flex flex-col items-center overflow-auto" id="preview-area">
            <!-- Boutons d'action CV -->
            <div class="w-full flex justify-center gap-4 mb-4 mt-2">
                <button id="ai-optimize-one-page-btn" class="bg-gradient-to-r from-purple-600 to-blue-600 text-white py-3 px-6 rounded-lg hover:from-purple-700 hover:to-blue-700 flex items-center justify-center gap-3 shadow-lg transform transition-all duration-200 hover:scale-105 no-print" title="L'IA optimise automatiquement votre CV pour qu'il tienne sur une seule page tout en gardant l'essentiel">
                    <i class="fas fa-magic-wand-sparkles text-lg"></i>
                    <span class="font-semibold">Optimiser pour 1 page IA</span>
                    <i class="fas fa-file-alt text-lg"></i>
                </button>
                <button id="anonymize-btn" class="bg-gradient-to-r from-slate-500 to-slate-600 text-white py-3 px-6 rounded-lg hover:from-slate-600 hover:to-slate-700 flex items-center justify-center gap-3 shadow-lg transform transition-all duration-200 hover:scale-105 no-print" title="Masquer vos informations personnelles pour cr√©er une version anonyme de votre CV">
                    <i class="fa-solid fa-user-secret text-lg"></i>
                    <span class="font-semibold">Anonymiser le CV</span>
                </button>
            </div>
            
            <div class="w-full flex justify-center">
            <div id="cv-preview-wrapper">
                <div class="a4-page-container">
                    <div id="page-1" class="a4-page">
                        <div id="fixed-banner-top"></div>
                        <div class="cv-body-container layout-1-col">
                            <div id="cv-col-1-1" class="cv-column">
                                <div id="banner-module" class="cv-module">
                                    <div class="drag-handle"><i class="fas fa-grip-vertical"></i></div>
                                    <div id="recruiter-banner" class="banner-align-left">
                                        <img id="banner-bg-img-preview" src="" alt="Banner background" class="absolute top-0 left-0 w-full h-full object-cover z-0 transition-all duration-300">
                                        <div class="banner-content-wrapper">
                                            <img id="banner-img-preview" class="logo-md" src="https://placehold.co/100x100/EFEFEF/AAAAAA&text=Photo" alt="Photo recruteur" onerror="this.onerror=null; this.src='https://placehold.co/100x100/EFEFEF/AAAAAA&text=Photo';">
                                            <div class="banner-content">
                                                <p id="banner-nom-preview" class="item-title" contenteditable="true"></p>
                                                <p id="banner-poste-preview" contenteditable="true"></p>
                                                <p id="banner-contact-preview"><span id="banner-email-preview" contenteditable="true"></span> | <span id="banner-tel-preview" contenteditable="true"></span></p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div id="header-module" class="cv-module"><div class="drag-handle"><i class="fas fa-grip-vertical"></i></div><div class="cv-header text-center"><div class="editable-wrapper"><h1 id="cv-nom-prenom-preview" contenteditable="true">Pr√©nom NOM</h1><span class="delete-line-btn"><i class="fas fa-times"></i></span></div><div class="editable-wrapper"><p id="cv-poste-preview" contenteditable="true">Poste Recherch√©</p><span class="delete-line-btn"><i class="fas fa-times"></i></span></div></div></div>
                                <div id="qualification-module" class="cv-module"><div class="drag-handle"><i class="fas fa-grip-vertical"></i></div><div id="qualification-preview" class="flex justify-center gap-4 text-center text-sm p-2 bg-slate-50 rounded-md"></div></div>
                                <div id="description-module" class="cv-module"><div class="drag-handle"><i class="fas fa-grip-vertical"></i></div><h2 class="section-title style-underline" data-section-id="description"><i class="fas fa-user-circle section-icon"></i><span contenteditable="true">Profil</span><div class="section-ai-actions"><button class="ai-action-btn toggle-visibility-btn" title="Masquer/Afficher la section"><i class="fas fa-eye"></i></button><button class="ai-action-btn" data-action="rewrite-profile" title="R√©√©crire le profil avec l'IA"><i class="fas fa-magic-wand-sparkles"></i></button></div></h2><div id="cv-description-preview"></div></div>
                                <div id="experience-module" class="cv-module"><div class="drag-handle"><i class="fas fa-grip-vertical"></i></div><h2 class="section-title style-underline" data-section-id="experience"><i class="fas fa-briefcase section-icon"></i><span contenteditable="true">Exp√©rience</span><div class="section-ai-actions"><button class="ai-action-btn toggle-visibility-btn" title="Masquer/Afficher la section"><i class="fas fa-eye"></i></button><button class="ai-action-btn" data-action="summarize-experience" title="Synth√©tiser les exp√©riences avec l'IA (5 lignes max)"><i class="fas fa-magic-wand-sparkles"></i></button></div></h2><div id="cv-experience-preview"></div></div>
                                <div id="formation-module" class="cv-module"><div class="drag-handle"><i class="fas fa-grip-vertical"></i></div><h2 class="section-title style-underline" data-section-id="formation"><i class="fas fa-graduation-cap section-icon"></i><span contenteditable="true">Formation</span><div class="section-ai-actions"><button class="ai-action-btn toggle-visibility-btn" title="Masquer/Afficher la section"><i class="fas fa-eye"></i></button><button class="ai-action-btn" data-action="rewrite-formation" title="Am√©liorer les formations avec l'IA"><i class="fas fa-magic-wand-sparkles"></i></button></div></h2><div id="cv-formation-preview"></div></div>
                                <div id="competences-module" class="cv-module"><div class="drag-handle"><i class="fas fa-grip-vertical"></i></div><h2 class="section-title style-underline" data-section-id="competences"><i class="fas fa-star section-icon"></i><span contenteditable="true">Comp√©tences</span><div class="section-ai-actions"><button class="ai-action-btn toggle-visibility-btn" title="Masquer/Afficher la section"><i class="fas fa-eye"></i></button><button class="ai-action-btn" data-action="rewrite-skills" title="Am√©liorer les comp√©tences avec l'IA"><i class="fas fa-magic-wand-sparkles"></i></button></div></h2><div id="cv-competences-preview" data-style="tags"></div></div>
                            </div>
                            <div id="cv-col-1-2" class="cv-column"></div>
                        </div>
                        <div id="fixed-banner-bottom"></div>
                    </div>
                     <button class="remove-page-btn no-print"><i class="fas fa-trash-can"></i></button>
                </div>
                 <div id="add-page-btn-wrapper" class="no-print">
                     <button id="add-page-btn" title="Ajouter une nouvelle page au CV"><i class="fas fa-plus"></i></button>
                 </div>
            </div>
            </div>
        </div>
    </div>
    
    <!-- MODALS -->
    <div id="share-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="text-xl font-bold mb-4">Partager le CV</h2>
            <p class="text-sm text-gray-600 mb-2">Copiez ce lien unique pour partager une version en lecture seule de ce CV.</p>
            <div class="flex items-center border rounded-md p-2 bg-gray-50">
                <input type="text" id="share-link-input" readonly class="flex-grow bg-transparent outline-none text-sm">
                <button id="copy-share-link-btn" class="ml-2 px-3 py-1 bg-blue-500 text-white text-sm rounded-md hover:bg-blue-600">Copier</button>
            </div>
            <div class="text-right mt-4">
                 <button id="close-share-modal" class="px-4 py-2 bg-gray-200 text-sm rounded-md hover:bg-gray-300">Fermer</button>
            </div>
        </div>
    </div>
    
    <div id="icon-picker-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Choisir une ic√¥ne</h2>
                <button id="close-icon-picker-modal" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <div class="mb-4">
                <input type="text" id="icon-search-input" placeholder="Rechercher une ic√¥ne..." class="w-full p-2 border rounded-md">
            </div>
            <div id="icon-picker-grid"></div>
        </div>
    </div>

    <div id="confirm-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="confirm-modal-title" class="text-xl font-bold mb-4">Confirmation</h2>
            <p id="confirm-modal-text" class="text-gray-600 mb-6">√ätes-vous s√ªr ?</p>
            <div class="flex justify-end gap-4">
                <button id="confirm-modal-cancel-btn" class="px-4 py-2 bg-gray-200 text-sm rounded-md hover:bg-gray-300">Annuler</button>
                <button id="confirm-modal-ok-btn" class="px-4 py-2 bg-red-600 text-white text-sm rounded-md hover:bg-red-700">Confirmer</button>
            </div>
        </div>
    </div>

    <!-- NEW MODALS -->
    <div id="cv-variants-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 800px;">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Variantes de CV g√©n√©r√©es par l'IA</h2>
                <button id="close-variants-modal" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <div id="variants-container" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- Variants will be inserted here -->
            </div>
            <div class="flex justify-end gap-4 mt-6">
                <button id="cancel-variants-btn" class="px-4 py-2 bg-gray-200 text-sm rounded-md hover:bg-gray-300">Annuler</button>
                <button id="apply-variant-btn" class="px-4 py-2 bg-blue-600 text-white text-sm rounded-md hover:bg-blue-700" disabled>Appliquer la Variante</button>
            </div>
        </div>
    </div>

    <div id="translation-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Traduire le CV</h2>
                <button id="close-translation-modal" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Langue cible</label>
                    <select id="target-language-select" class="w-full p-2 border rounded-md">
                        <option value="en">üá∫üá∏ Anglais</option>
                        <option value="es">üá™üá∏ Espagnol</option>
                        <option value="de">üá©üá™ Allemand</option>
                        <option value="it">üáÆüáπ Italien</option>
                        <option value="pt">üáµüáπ Portugais</option>
                        <option value="zh">üá®üá≥ Chinois</option>
                        <option value="ja">üáØüáµ Japonais</option>
                        <option value="ar">üá∏üá¶ Arabe</option>
                    </select>
                </div>
                <div class="flex justify-end gap-4">
                    <button id="cancel-translation-btn" class="px-4 py-2 bg-gray-200 text-sm rounded-md hover:bg-gray-300">Annuler</button>
                    <button id="start-translation-btn" class="px-4 py-2 bg-blue-600 text-white text-sm rounded-md hover:bg-blue-700">Traduire</button>
                </div>
            </div>
        </div>
    </div>

    <div id="cv-score-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Score ATS du CV</h2>
                <button id="close-score-modal" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <div id="score-result-container">
                <!-- Score results will be inserted here -->
            </div>
            <div class="text-right mt-4">
                <button id="close-score-modal-btn" class="px-4 py-2 bg-gray-200 text-sm rounded-md hover:bg-gray-300">Fermer</button>
            </div>
        </div>
    </div>

    <div id="improvements-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 600px;">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Suggestions d'am√©lioration IA</h2>
                <button id="close-improvements-modal" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <div id="improvements-container" class="space-y-4">
                <!-- Improvements will be inserted here -->
            </div>
            <div class="text-right mt-4">
                <button id="close-improvements-modal-btn" class="px-4 py-2 bg-gray-200 text-sm rounded-md hover:bg-gray-300">Fermer</button>
            </div>
        </div>
    </div>

    <div id="skill-analysis-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 700px;">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Analyse des Comp√©tences</h2>
                <button id="close-skill-analysis-modal" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <div id="skill-analysis-container">
                <!-- Analysis results will be inserted here -->
            </div>
            <div class="text-right mt-4">
                <button id="close-skill-analysis-modal-btn" class="px-4 py-2 bg-gray-200 text-sm rounded-md hover:bg-gray-300">Fermer</button>
            </div>
        </div>
    </div>

    <script type="module">
        // This script is now self-contained and does not use Firebase for saving.
        
        document.addEventListener('DOMContentLoaded', function() {
            // --- GLOBAL SELECTORS (STATIC) ---
            const controls = {
                aiInput: document.getElementById('ai-input'), analyzeBtn: document.getElementById('analyze-btn'), loader: document.getElementById('loader-overlay'), loaderText: document.getElementById('loader-text'),
                nom: document.getElementById('nom'), prenom: document.getElementById('prenom'), poste: document.getElementById('poste'),
                description: document.getElementById('description'), competences: document.getElementById('competences'), aiSynthesizeSkillsBtn: document.getElementById('ai-synthesize-skills-btn'),
                experienceList: document.getElementById('experience-list'), addExperienceBtn: document.getElementById('add-experience'),
                formationList: document.getElementById('formation-list'), addFormationBtn: document.getElementById('add-formation'),
                toggleBanner: document.getElementById('toggle-banner-checkbox'), bannerNom: document.getElementById('banner-nom'), bannerPoste: document.getElementById('banner-poste'), bannerEmail: document.getElementById('banner-email'), bannerTel: document.getElementById('banner-tel'), bannerImage: document.getElementById('banner-image'),
                bannerStyleSelect: document.getElementById('banner-style-select'), bannerInvertBtn: document.getElementById('banner-invert-btn'),
                fixBannerTopBtn: document.getElementById('fix-banner-top-btn'), fixBannerBottomBtn: document.getElementById('fix-banner-bottom-btn'), modularBannerBtn: document.getElementById('modular-banner-btn'),
                qualificationDispo: document.getElementById('qualification-dispo'), qualificationSalaire: document.getElementById('qualification-salaire'), qualificationLoc: document.getElementById('qualification-loc'),
                generateMailBtn: document.getElementById('generate-mail-btn'), recruiterMailContent: document.getElementById('recruiter-mail-content'),
                anonymizeBtn: document.getElementById('anonymize-btn'), downloadPdfBtn: document.getElementById('download-pdf-btn'),
                resetCvBtn: document.getElementById('reset-cv-btn'),
                togglePresentationModeBtn: document.getElementById('toggle-presentation-mode-btn'),
                toggleOverflowBtn: document.getElementById('toggle-overflow-btn'),
                aiOptimizeOnePageBtn: document.getElementById('ai-optimize-one-page-btn'),
                resetRecruiterBtn: document.getElementById('reset-recruiter-btn'),
                aiLimitSkillsBtn: document.getElementById('ai-limit-skills-btn'),
                pageMargin: document.getElementById('page-margin'), pageMarginValue: document.getElementById('page-margin-value'),
                moduleSpacing: document.getElementById('module-spacing'), moduleSpacingValue: document.getElementById('module-spacing-value'),
                itemSpacing: document.getElementById('item-spacing'), itemSpacingValue: document.getElementById('item-spacing-value'),
                fontSizeH1: document.getElementById('font-size-h1'), fontSizeH1Value: document.getElementById('font-size-h1-value'),
                fontSizeH2: document.getElementById('font-size-h2'), fontSizeH2Value: document.getElementById('font-size-h2-value'),
                fontSizeP: document.getElementById('font-size-p'), fontSizePValue: document.getElementById('font-size-p-value'),
                fontSizeBanner: document.getElementById('font-size-banner'), fontSizeBannerValue: document.getElementById('font-size-banner-value'),
                bannerElementSpacing: document.getElementById('banner-element-spacing'), bannerElementSpacingValue: document.getElementById('banner-element-spacing-value'),
                lineHeight: document.getElementById('line-height'), lineHeightValue: document.getElementById('line-height-value'),
                paragraphSpacing: document.getElementById('paragraph-spacing'), paragraphSpacingValue: document.getElementById('paragraph-spacing-value'),
                randomizeBannerStyleBtn: document.getElementById('randomize-banner-style-btn'),
                bannerNomFont: document.getElementById('banner-nom-font'), bannerNomSize: document.getElementById('banner-nom-size'), bannerNomSizeValue: document.getElementById('banner-nom-size-value'), bannerNomColor: document.getElementById('banner-nom-color'), bannerNomBold: document.getElementById('banner-nom-bold'), bannerNomItalic: document.getElementById('banner-nom-italic'),
                bannerPosteSize: document.getElementById('banner-poste-size'), bannerPosteSizeValue: document.getElementById('banner-poste-size-value'), bannerPosteColor: document.getElementById('banner-poste-color'), bannerPosteBold: document.getElementById('banner-poste-bold'), bannerPosteItalic: document.getElementById('banner-poste-italic'),
                bannerContactSize: document.getElementById('banner-contact-size'), bannerContactSizeValue: document.getElementById('banner-contact-size-value'), bannerContactColor: document.getElementById('banner-contact-color'), bannerContactBold: document.getElementById('banner-contact-bold'), bannerContactItalic: document.getElementById('banner-contact-italic'),
                undoBtn: document.getElementById('undo-btn'), redoBtn: document.getElementById('redo-btn'),
                addSectionBtn: document.getElementById('add-section-btn'), customSectionsList: document.getElementById('custom-sections-list'), sectionSuggestionSelect: document.getElementById('section-suggestion-select'), newSectionTitleInput: document.getElementById('new-section-title-input'),
                primaryColorPicker: document.getElementById('primary-color-picker'),
                secondaryColorPicker: document.getElementById('secondary-color-picker'),
                aiColorBtn: document.getElementById('ai-color-btn'),
                bodyTextColorPicker: document.getElementById('body-text-color-picker'),
                fontFamilyH1Select: document.getElementById('font-family-h1-select'),
                fontFamilyH2Select: document.getElementById('font-family-h2-select'),
                fontFamilyBodySelect: document.getElementById('font-family-body-select'),
                shareBtn: document.getElementById('share-btn'), shareModal: document.getElementById('share-modal'), closeShareModal: document.getElementById('close-share-modal'), shareLinkInput: document.getElementById('share-link-input'), copyShareLinkBtn: document.getElementById('copy-share-link-btn'),
                iconPickerModal: document.getElementById('icon-picker-modal'), closeIconPickerModal: document.getElementById('close-icon-picker-modal'), iconPickerGrid: document.getElementById('icon-picker-grid'), iconSearchInput: document.getElementById('icon-search-input'),
                addPageBtn: document.getElementById('add-page-btn'),
                bannerBgImage: document.getElementById('banner-bg-image'),
                bannerBgOpacity: document.getElementById('banner-bg-opacity'),
                bannerBgOpacityValue: document.getElementById('banner-bg-opacity-value'),
                bannerBgBlur: document.getElementById('banner-bg-blur'),
                bannerBgBlurValue: document.getElementById('banner-bg-blur-value'),
                bannerBgGrayscale: document.getElementById('banner-bg-grayscale'),
                removeBannerBgBtn: document.getElementById('remove-banner-bg-btn'),
                skillsTextControls: document.getElementById('skills-text-controls'),
                skillsLevelControls: document.getElementById('skills-level-controls'),
                skillsLevelList: document.getElementById('skills-level-list'),
                addSkillLevelBtn: document.getElementById('add-skill-level-btn'),
                apiKeyInput: document.getElementById('api-key-input'),
                apiKeyStatus: document.getElementById('api-key-status'),
                saveApiKeyBtn: document.getElementById('save-api-key-btn'),
                toggleApiKeyVisibilityBtn: document.getElementById('toggle-api-key-visibility'),
                confirmModal: {
                    overlay: document.getElementById('confirm-modal'),
                    title: document.getElementById('confirm-modal-title'),
                    text: document.getElementById('confirm-modal-text'),
                    okBtn: document.getElementById('confirm-modal-ok-btn'),
                    cancelBtn: document.getElementById('confirm-modal-cancel-btn'),
                }
            };

            // --- DYNAMIC SELECTORS ---
            let preview = {};
            function reinitializePreviewSelectors() {
                preview.previewWrapper = document.getElementById('cv-preview-wrapper');
                preview.cvNomPrenom = document.getElementById('cv-nom-prenom-preview');
                preview.cvPoste = document.getElementById('cv-poste-preview');
                preview.cvDescription = document.getElementById('cv-description-preview');
                preview.cvFormation = document.getElementById('cv-formation-preview');
                preview.cvCompetences = document.getElementById('cv-competences-preview');
                preview.cvExperience = document.getElementById('cv-experience-preview');
                preview.bannerModule = document.getElementById('banner-module');
                preview.banner = document.getElementById('recruiter-banner');
                preview.bannerImg = document.getElementById('banner-img-preview');
                preview.bannerNom = document.getElementById('banner-nom-preview');
                preview.bannerPoste = document.getElementById('banner-poste-preview');
                preview.bannerContact = document.getElementById('banner-contact-preview');
                preview.bannerEmail = document.getElementById('banner-email-preview');
                preview.bannerTel = document.getElementById('banner-tel-preview');
                preview.qualificationModule = document.getElementById('qualification-module');
                preview.qualificationPreview = document.getElementById('qualification-preview');
                preview.fixedBannerTop = document.getElementById('fixed-banner-top');
                preview.fixedBannerBottom = document.getElementById('fixed-banner-bottom');
                preview.bannerBgImg = document.getElementById('banner-bg-img-preview');
            }
            
            // --- CONFIGURATION OBJECTS ---
            const sliders = {
                pageMargin: { el: controls.pageMargin, valueEl: controls.pageMarginValue, property: '--page-margin', unit: 'cm' },
                moduleSpacing: { el: controls.moduleSpacing, valueEl: controls.moduleSpacingValue, property: '--module-spacing', unit: 'rem' },
                itemSpacing: { el: controls.itemSpacing, valueEl: controls.itemSpacingValue, property: '--item-spacing', unit: 'rem' },
                fontSizeH1: { el: controls.fontSizeH1, valueEl: controls.fontSizeH1Value, property: '--font-size-h1', unit: 'pt' },
                fontSizeH2: { el: controls.fontSizeH2, valueEl: controls.fontSizeH2Value, property: '--font-size-h2', unit: 'pt' },
                fontSizeP: { el: controls.fontSizeP, valueEl: controls.fontSizePValue, property: '--font-size-p', unit: 'pt' },
                fontSizeBanner: { el: controls.fontSizeBanner, valueEl: controls.fontSizeBannerValue, property: '--font-size-banner', unit: 'pt' },
                lineHeight: { el: controls.lineHeight, valueEl: controls.lineHeightValue, property: '--line-height', unit: '' },
                paragraphSpacing: { el: controls.paragraphSpacing, valueEl: controls.paragraphSpacingValue, property: '--paragraph-spacing', unit: 'rem' },
                bannerElementSpacing: { el: controls.bannerElementSpacing, valueEl: controls.bannerElementSpacingValue, property: '--banner-element-spacing', unit: 'rem' },
            };

            const bannerStyleControls = {
                nomFont: { el: controls.bannerNomFont, event: 'change', stateKey: 'nomFont' },
                nomSize: { el: controls.bannerNomSize, event: 'input', valueEl: controls.bannerNomSizeValue, stateKey: 'nomSize' },
                nomColor: { el: controls.bannerNomColor, event: 'input', stateKey: 'nomColor' },
                nomBold: { el: controls.bannerNomBold, event: 'click', toggle: true, stateKey: 'nomBold' },
                nomItalic: { el: controls.bannerNomItalic, event: 'click', toggle: true, stateKey: 'nomItalic' },
                posteSize: { el: controls.bannerPosteSize, event: 'input', valueEl: controls.bannerPosteSizeValue, stateKey: 'posteSize' },
                posteColor: { el: controls.bannerPosteColor, event: 'input', stateKey: 'posteColor' },
                posteBold: { el: controls.bannerPosteBold, event: 'click', toggle: true, stateKey: 'posteBold' },
                posteItalic: { el: controls.bannerPosteItalic, event: 'click', toggle: true, stateKey: 'posteItalic' },
                contactSize: { el: controls.bannerContactSize, event: 'input', valueEl: controls.bannerContactSizeValue, stateKey: 'contactSize' },
                contactColor: { el: controls.bannerContactColor, event: 'input', stateKey: 'contactColor' },
                contactBold: { el: controls.bannerContactBold, event: 'click', toggle: true, stateKey: 'contactBold' },
                contactItalic: { el: controls.bannerContactItalic, event: 'click', toggle: true, stateKey: 'contactItalic' },
            };

            const themes = {
                professional: {
                    primaryColor: '#2563eb', secondaryColor: '#334155', bodyTextColor: '#334155',
                    fontH1: "'Montserrat', sans-serif", fontH2: "'Montserrat', sans-serif", fontBody: "'Lato', sans-serif"
                },
                creative: {
                    primaryColor: '#db2777', secondaryColor: '#4f46e5', bodyTextColor: '#44403c',
                    fontH1: "'Playfair Display', serif", fontH2: "'Oswald', sans-serif", fontBody: "'Nunito Sans', sans-serif"
                },
                modern: {
                    primaryColor: '#16a34a', secondaryColor: '#1f2937', bodyTextColor: '#374151',
                    fontH1: "'Oswald', sans-serif", fontH2: "'Source Sans Pro', sans-serif", fontBody: "'Source Sans Pro', sans-serif"
                },
                elegant: {
                    primaryColor: '#8b5a3c', secondaryColor: '#d4af37', bodyTextColor: '#2c2c2c',
                    fontH1: "'Playfair Display', serif", fontH2: "'Cormorant Garamond', serif", fontBody: "'Merriweather', serif"
                },
                tech: {
                    primaryColor: '#00d4aa', secondaryColor: '#1a1a1a', bodyTextColor: '#333',
                    fontH1: "'Roboto Mono', monospace", fontH2: "'Source Sans Pro', sans-serif", fontBody: "'Source Sans Pro', sans-serif"
                },
                luxury: {
                    primaryColor: '#b8860b', secondaryColor: '#4b0082', bodyTextColor: '#2c2c2c',
                    fontH1: "'Playfair Display', serif", fontH2: "'Cormorant Garamond', serif", fontBody: "'Lato', sans-serif"
                },
                startup: {
                    primaryColor: '#ff6b35', secondaryColor: '#f7931e', bodyTextColor: '#333',
                    fontH1: "'Montserrat', sans-serif", fontH2: "'Nunito Sans', sans-serif", fontBody: "'Open Sans', sans-serif"
                },
                academic: {
                    primaryColor: '#2c3e50', secondaryColor: '#34495e', bodyTextColor: '#2c3e50',
                    fontH1: "'Merriweather', serif", fontH2: "'Source Sans Pro', sans-serif", fontBody: "'Source Sans Pro', sans-serif"
                },
                artistic: {
                    primaryColor: '#e91e63', secondaryColor: '#9c27b0', bodyTextColor: '#424242',
                    fontH1: "'Playfair Display', serif", fontH2: "'Oswald', sans-serif", fontBody: "'Nunito Sans', sans-serif"
                }
            };

            // Skill templates
            const skillTemplates = {
                tech: "JavaScript, Python, React, Node.js, SQL, Git, Docker, AWS, TypeScript, MongoDB",
                marketing: "Google Analytics, SEO, SEM, Social Media Marketing, Content Marketing, Email Marketing, Adobe Creative Suite, HubSpot, Canva, WordPress",
                finance: "Excel Avanc√©, Analyse Financi√®re, Budg√©tisation, SAP, Bloomberg Terminal, VBA, PowerBI, Audit, Comptabilit√©, Gestion des Risques",
                design: "Adobe Photoshop, Illustrator, InDesign, Figma, Sketch, After Effects, UI/UX Design, Prototypage, Design Thinking, Typography",
                management: "Leadership, Gestion d'√âquipe, Planification Strat√©gique, Gestion de Projet, Scrum, Agile, Communication, N√©gociation, Budgets, KPI",
                sales: "Prospection, N√©gociation, CRM, Salesforce, Closing, Pipeline Management, Pr√©sentation Commerciale, Relation Client, T√©l√©prospection, Account Management"
            };

            // Section templates
            const sectionTemplates = {
                startup: ["Projets Entrepreneuriaux üöÄ", "Lev√©es de Fonds üí∞", "√âquipes Constitu√©es üë•", "Technologies Ma√Ætris√©es üíª"],
                academic: ["Publications üìö", "Conf√©rences üé§", "Recherches üî¨", "Collaborations ü§ù"],
                creative: ["Portfolio üé®", "Cr√©ations üé≠", "Expositions üñºÔ∏è", "Collaborations Artistiques üé™"],
                executive: ["√âquipes Dirig√©es üëî", "Budgets G√©r√©s üíº", "Strat√©gies D√©ploy√©es üìä", "Acquisitions üè¢"],
                international: ["Langues üåç", "Exp√©rience Internationale ‚úàÔ∏è", "Certifications Linguistiques üìú", "Missions √† l'√âtranger üó∫Ô∏è"],
                freelance: ["Clients Principaux üë•", "Projets R√©alis√©s üíº", "Testimonials üí¨", "Tarification üí∞"]
            };
            
            // --- GLOBAL STATE VARIABLES ---
            let pageCounter = 1;
            let customSectionCounter = 0;
            const root = document.documentElement;
            let isAnonymized = false;
            let originalData = {};
            let isRestoringState = false; 
            let activeIconTarget = null;
            
            // --- UI UTILITIES ---
            function showLoader(text = "Chargement...") {
                controls.loaderText.textContent = text;
                controls.loader.classList.remove('hidden');
                controls.loader.classList.add('flex');
            }

            function hideLoader() {
                controls.loader.classList.add('hidden');
                controls.loader.classList.remove('flex');
            }

            function showNotification(message, type = 'success', duration = 3000) {
                const toast = document.createElement('div');
                const icon = type === 'error' ? 'fa-times-circle text-red-500' : 'fa-check-circle text-green-500';
                toast.className = 'toast';
                toast.innerHTML = `<i class="fas ${icon}"></i><span>${message}</span>`;
                document.getElementById('notification').appendChild(toast);
                setTimeout(() => toast.classList.add('show'), 10);
                setTimeout(() => {
                    toast.classList.remove('show');
                    toast.addEventListener('transitionend', () => toast.remove());
                }, duration);
            }
            
            function showConfirmModal(title, text) {
                return new Promise((resolve) => {
                    controls.confirmModal.title.textContent = title;
                    controls.confirmModal.text.innerHTML = text;
                    controls.confirmModal.overlay.classList.add('active');

                    const cleanup = (result) => {
                        controls.confirmModal.overlay.classList.remove('active');
                        controls.confirmModal.okBtn.onclick = null;
                        controls.confirmModal.cancelBtn.onclick = null;
                        resolve(result);
                    };

                    controls.confirmModal.okBtn.onclick = () => cleanup(true);
                    controls.confirmModal.cancelBtn.onclick = () => cleanup(false);
                });
            }


            // --- HISTORY (UNDO/REDO) SYSTEM ---
            // History is not saved, so this is a simple implementation
            function undo() { showNotification("Fonctionnalit√© non disponible en mode hors ligne.", "error"); }
            function redo() { showNotification("Fonctionnalit√© non disponible en mode hors ligne.", "error"); }
            
            // --- DRAG & DROP & RESIZE ---
            let activeResizer = null;
            let activeContainer = null;
            let activeCol1 = null;
            let initialX = 0;
            let initialCol1Width = 0;

            function initResize(e) {
                e.preventDefault();
                activeResizer = e.target;
                activeContainer = activeResizer.parentElement;
                const columns = activeContainer.querySelectorAll('.cv-column');
                activeCol1 = columns[0];
                initialX = e.clientX;
                initialCol1Width = activeCol1.offsetWidth;

                document.addEventListener('mousemove', doResize);
                document.addEventListener('mouseup', stopResize);
                document.body.classList.add('is-resizing');
            }

            function doResize(e) {
                if (!activeResizer) return;
                const dx = e.clientX - initialX;
                const newCol1Width = initialCol1Width + dx;
                const containerWidth = activeContainer.offsetWidth;
                
                if (newCol1Width < 50 || newCol1Width > containerWidth - 50) return;

                const newCol1Percent = (newCol1Width / containerWidth) * 100;
                const newCol2Percent = 100 - newCol1Percent;

                activeContainer.classList.remove('layout-2-col-33-67', 'layout-2-col-50-50', 'layout-2-col-67-33');
                activeContainer.style.gridTemplateColumns = `${newCol1Percent}% ${newCol2Percent}%`;
                activeResizer.style.left = `${newCol1Percent}%`;
            }

            function stopResize() {
                document.removeEventListener('mousemove', doResize);
                document.removeEventListener('mouseup', stopResize);
                document.body.classList.remove('is-resizing');
                activeResizer = null;
                activeContainer = null;
                activeCol1 = null;
            }

            function setupAllResizers() {
                document.querySelectorAll('.a4-page').forEach(page => {
                    const container = page.querySelector('.cv-body-container');
                    const oldResizer = container.querySelector('.column-resizer');
                    if (oldResizer) oldResizer.remove();

                    const columns = container.querySelectorAll('.cv-column');
                    if (columns.length === 2 && getComputedStyle(container).gridTemplateColumns.split(' ').length === 2) {
                        const resizer = document.createElement('div');
                        resizer.className = 'column-resizer';
                        container.appendChild(resizer);
                        const col1 = columns[0];
                        const col1WidthPercent = parseFloat(getComputedStyle(col1).width) / parseFloat(getComputedStyle(container).width) * 100;
                        resizer.style.left = col1WidthPercent + '%';
                        resizer.addEventListener('mousedown', initResize);
                    }
                });
            }

            function initializeSortableForPage(pageId) {
                const col1 = document.getElementById(`cv-col-${pageId}-1`);
                const col2 = document.getElementById(`cv-col-${pageId}-2`);
                const onEnd = () => { checkAllPagesOverflow(); };
                
                // Destroy existing Sortable instances to avoid conflicts
                if (col1 && col1.sortable) {
                    col1.sortable.destroy();
                }
                if (col2 && col2.sortable) {
                    col2.sortable.destroy();
                }
                
                // Create new Sortable instances
                if (col1) {
                    col1.sortable = new Sortable(col1, { 
                        group: 'cv-modules', 
                        animation: 150, 
                        handle: '.drag-handle', 
                        ghostClass: 'sortable-ghost', 
                        onEnd 
                    });
                }
                if (col2) {
                    col2.sortable = new Sortable(col2, { 
                        group: 'cv-modules', 
                        animation: 150, 
                        handle: '.drag-handle', 
                        ghostClass: 'sortable-ghost', 
                        onEnd 
                    });
                }
            }

            function initializeAllSortable() {
                // Initialize drag and drop for all existing pages
                document.querySelectorAll('.a4-page').forEach((page) => {
                    const pageId = page.id.replace('page-', '');
                    if (pageId) {
                        initializeSortableForPage(pageId);
                    } else {
                        // For the first page that might not have an ID
                        initializeSortableForPage(1);
                    }
                });
            }

            function initializeSkillSorting() {
                const skillLists = document.querySelectorAll('#cv-competences-preview ul');
                skillLists.forEach(list => {
                    new Sortable(list, {
                        group: 'skills', animation: 150, ghostClass: 'skills-ghost',
                        onEnd: function () {
                            syncFormFromPreview(document.getElementById('cv-competences-preview'));
                        }
                    });
                });
            }

            // --- PAGE & OVERFLOW MANAGEMENT ---
            function checkPageOverflow(page) {
                requestAnimationFrame(() => {
                    // Using a 1px tolerance for floating point inaccuracies
                    const isOverflowing = page.scrollHeight > page.clientHeight + 1;
                    page.classList.toggle('is-overflowing', isOverflowing);
                });
            }

            function checkAllPagesOverflow() {
                document.querySelectorAll('.a4-page').forEach(checkPageOverflow);
            }

            function setupOverflowObserver(pageElement) {
                const observer = new ResizeObserver(() => {
                    checkPageOverflow(pageElement);
                });
                // Observe the page element itself and its direct content container
                observer.observe(pageElement);
                const bodyContainer = pageElement.querySelector('.cv-body-container');
                if (bodyContainer) {
                    observer.observe(bodyContainer);
                }
            }
            
            function addNewPage() {
                pageCounter++;
                const newPageContainer = document.createElement('div');
                newPageContainer.className = 'a4-page-container';
                const layoutClass = document.querySelector('.layout-btn.active')?.dataset.layout || 'layout-1-col';
                
                newPageContainer.innerHTML = `
                    <div id="page-${pageCounter}" class="a4-page">
                        <div class="cv-body-container ${layoutClass}">
                            <div id="cv-col-${pageCounter}-1" class="cv-column"></div>
                            <div id="cv-col-${pageCounter}-2" class="cv-column"></div>
                        </div>
                    </div>
                    <button class="remove-page-btn no-print"><i class="fas fa-trash-can"></i></button>
                `;
                
                const addBtnWrapper = document.getElementById('add-page-btn-wrapper');
                preview.previewWrapper.insertBefore(newPageContainer, addBtnWrapper);
                
                const newPageElement = document.getElementById(`page-${pageCounter}`);
                setupOverflowObserver(newPageElement);

                initializeSortableForPage(pageCounter);
                setupAllResizers();
                checkAllPagesOverflow();
            }


            // --- DYNAMIC CONTENT ---
            function createDynamicItem(container, fields, data = {}, index = -1) {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'p-2 border rounded-md bg-white relative';
                
                fields.forEach(field => {
                    const isTextarea = field.type === 'textarea';
                    const input = document.createElement(isTextarea ? 'textarea' : 'input');
                    
                    if (!isTextarea) input.type = 'text';
                    
                    input.placeholder = field.placeholder;
                    input.className = `cv-input w-full p-1 border rounded-sm mb-1 data-${field.key}`;
                    if(isTextarea) input.rows = 3;
                    input.value = data[field.key] || '';
                    itemDiv.appendChild(input);
                });

                const removeBtn = document.createElement('button');
                removeBtn.innerHTML = '<i class="fas fa-times-circle text-red-400 hover:text-red-600"></i>';
                removeBtn.className = 'absolute top-1 right-1 remove-dynamic-item-btn';
                itemDiv.appendChild(removeBtn);
                
                if (index !== -1 && index < container.children.length) {
                    container.insertBefore(itemDiv, container.children[index]);
                } else {
                    container.appendChild(itemDiv);
                }
                
                updatePreview('form');
                const firstInput = itemDiv.querySelector('input, textarea');
                if (firstInput) firstInput.focus();
            }

            function getDynamicData(container) {
                return Array.from(container.children).map(itemDiv => ({
                    title: itemDiv.querySelector('.data-title')?.value || '',
                    meta: itemDiv.querySelector('.data-meta')?.value || '',
                    desc: itemDiv.querySelector('.data-desc')?.value || '',
                }));
            }
            
            // --- SKILLS RENDERING ---
            function renderSkillsAsTags(text) {
                let html = '';
                const sections = text.split('\n').filter(Boolean);
                sections.forEach(section => {
                    const parts = section.split(':');
                    if (parts.length === 2 && parts[0].trim() !== '') {
                        html += `<h3 class="skill-category" contenteditable="true">${parts[0].trim()}</h3>`;
                        html += `<ul>${parts[1].split(',').map(item => item.trim().replace(/\s*\(.*\)/, '')).filter(Boolean).map(item => `<li class="skill-item" contenteditable="false">${item}<span class="delete-skill-btn">&times;</span></li>`).join('')}</ul>`;
                    } else {
                        html += `<ul>${section.split(',').map(item => item.trim().replace(/\s*\(.*\)/, '')).filter(Boolean).map(item => `<li class="skill-item" contenteditable="false">${item}<span class="delete-skill-btn">&times;</span></li>`).join('')}</ul>`;
                    }
                });
                return html;
            }

            function renderSkillsAsLevels() {
                let html = '';
                const gaugeStyle = document.querySelector('.gauge-style-btn.active')?.dataset.gaugeStyle || 'bar';
                const skillItems = controls.skillsLevelList.querySelectorAll('.skill-level-item');

                skillItems.forEach(item => {
                    const name = item.querySelector('.skill-name-input').value;
                    const level = item.querySelector('.skill-level-input').value;
                    if (!name) return;

                    html += `<div class="skill-level">
                                        <div class="skill-level-label" contenteditable="true">${name}</div>
                                        <div class="gauge-container">${renderGauge(level, gaugeStyle)}</div>
                                    </div>`;
                });
                return html;
            }
            
            function renderGauge(level, style) {
                const max = 5;
                let gaugeHtml = '';
                switch (style) {
                    case 'dots':
                        gaugeHtml = `<div class="gauge-dots">`;
                        for (let i = 1; i <= max; i++) gaugeHtml += `<span class="${i <= level ? 'filled' : ''}">‚óè</span>`;
                        gaugeHtml += `</div>`;
                        break;
                    case 'stars':
                        gaugeHtml = `<div class="gauge-stars">`;
                        for (let i = 1; i <= max; i++) gaugeHtml += `<i class="${i <= level ? 'fas' : 'far'} fa-star ${i <= level ? 'filled' : ''}"></i>`;
                        gaugeHtml += `</div>`;
                        break;
                    case 'squares':
                         gaugeHtml = `<div class="gauge-squares">`;
                        for (let i = 1; i <= max; i++) gaugeHtml += `<span class="${i <= level ? 'filled' : ''}">‚ñ†</span>`;
                        gaugeHtml += `</div>`;
                        break;
                    case 'number':
                        gaugeHtml = `<div class="gauge-number">${level}/${max}</div>`;
                        break;
                    case 'bar':
                    default:
                        const width = (level / max) * 100;
                        gaugeHtml = `<div class="gauge-bar-bg"><div class="gauge-bar-fill" style="width: ${width}%;"></div></div>`;
                        break;
                }
                return gaugeHtml;
            }

            function renderSkillsAsSimple(text) {
                let html = '<ul>';
                const skills = text.split(/,|\n/).map(s => s.trim().replace(/\s*\(.*\)/, '')).filter(Boolean);
                skills.forEach(skill => {
                    html += `<li>${skill}</li>`;
                });
                html += '</ul>';
                return html;
            }

            function createSkillLevelItem(name = '', level = 3) {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'skill-level-item flex items-center gap-2';
                itemDiv.innerHTML = `
                    <input type="text" placeholder="Comp√©tence" value="${name}" class="skill-name-input cv-input flex-grow p-1 border rounded-sm">
                    <input type="range" value="${level}" min="1" max="5" class="skill-level-input w-24">
                    <span class="skill-level-value text-sm font-mono">${level}/5</span>
                    <button class="remove-skill-level-btn text-red-400 hover:text-red-600"><i class="fas fa-times-circle"></i></button>
                `;
                controls.skillsLevelList.appendChild(itemDiv);
                updatePreview('form');
            }

            // --- UPDATES & FORMATTING ---
            function updateBannerBackground() {
                const opacity = controls.bannerBgOpacity.value;
                const blur = controls.bannerBgBlur.value;
                const grayscale = controls.bannerBgGrayscale.checked;

                controls.bannerBgOpacityValue.textContent = opacity;
                controls.bannerBgBlurValue.textContent = blur;

                preview.bannerBgImg.style.opacity = opacity;
                preview.bannerBgImg.style.filter = `blur(${blur}px) grayscale(${grayscale ? 1 : 0})`;
            }

            function updatePreview(source = 'form') {
                // R√©initialiser les s√©lecteurs si n√©cessaire
                if (!preview.cvNomPrenom || !preview.cvPoste || !preview.cvDescription) {
                    reinitializePreviewSelectors();
                }
                
                if (source === 'form' || source === 'banner-style' || source === 'theme' || source === 'state') {
                    // V√©rification de s√©curit√© pour chaque √©l√©ment
                    if (preview.cvNomPrenom) {
                        preview.cvNomPrenom.textContent = `${controls.prenom.value} ${controls.nom.value}`.trim() || 'Pr√©nom NOM';
                    }
                    if (preview.cvPoste) {
                        preview.cvPoste.textContent = controls.poste.value || 'Poste Recherch√©';
                    }
                    if (preview.cvDescription) {
                        preview.cvDescription.innerHTML = `<div class="editable-wrapper"><p contenteditable="true">${controls.description.value.replace(/\n/g, '<br>') || '&nbsp;'}</p><span class="delete-line-btn"><i class="fas fa-times"></i></span></div>`;
                    }
                    
                    const renderDynamicList = (previewContainer, controlContainer, type) => {
                        previewContainer.innerHTML = '';
                        const data = getDynamicData(controlContainer);

                        const createInsertButton = (type, index) => {
                            const wrapper = document.createElement('div');
                            wrapper.className = 'insert-line-wrapper';
                            wrapper.innerHTML = `<button class="add-line-preview-btn" data-type="${type}" data-index="${index}" title="Ins√©rer un nouveau bloc ici"><i class="fas fa-plus"></i></button>`;
                            return wrapper;
                        };

                        const createItemContainer = (item, i) => {
                            const itemContainer = document.createElement('div');
                            itemContainer.className = 'dynamic-item-container';
                            itemContainer.dataset.index = i;
                            itemContainer.dataset.type = type;

                            const itemContent = document.createElement('div');
                            itemContent.className = "dynamic-preview-item";
                            itemContent.innerHTML = `<button class="delete-block-btn" title="Supprimer le bloc"><i class="fas fa-trash-alt"></i></button>`;

                            if (type === 'experience') {
                                const titleHTML = `<div class="editable-wrapper"><p class="item-title" contenteditable="true">${item.title || '&nbsp;'}</p><span class="delete-line-btn"><i class="fas fa-times"></i></span></div>`;
                                const metaHTML = `<div class="editable-wrapper"><p class="item-meta" contenteditable="true">${item.meta || '&nbsp;'}</p><span class="delete-line-btn"><i class="fas fa-times"></i></span></div>`;
                                const descHTML = `<div class="editable-wrapper"><p class="mt-1" contenteditable="true">${item.desc.replace(/\n/g, '<br>') || '&nbsp;'}</p><span class="delete-line-btn"><i class="fas fa-times"></i></span></div>`;
                                const addButtonHTML = `<button class="add-desc-line-btn"><i class="fas fa-plus mr-1"></i> Ajouter une mission</button>`;
                                itemContent.innerHTML += `${titleHTML}${metaHTML}${descHTML}${addButtonHTML}`;
                            } else { // formation
                                const titleHTML = `<div class="editable-wrapper"><p class="item-title" contenteditable="true">${item.title || '&nbsp;'}</p><span class="delete-line-btn"><i class="fas fa-times"></i></span></div>`;
                                const metaHTML = `<div class="editable-wrapper"><p class="item-meta" contenteditable="true">${item.meta || '&nbsp;'}</p><span class="delete-line-btn"><i class="fas fa-times"></i></span></div>`;
                                itemContent.innerHTML += `${titleHTML}${metaHTML}`;
                            }
                            
                            itemContainer.appendChild(createInsertButton(type, i));
                            itemContainer.appendChild(itemContent);
                            return itemContainer;
                        };
                        
                        data.forEach((item, i) => {
                            previewContainer.appendChild(createItemContainer(item, i));
                        });
                        const finalButtonWrapper = document.createElement('div');
                        finalButtonWrapper.className = 'dynamic-item-container';
                        finalButtonWrapper.appendChild(createInsertButton(type, data.length));
                        previewContainer.appendChild(finalButtonWrapper);
                    };

                    // V√©rifications de s√©curit√© pour les √©l√©ments de preview
                    if (preview.cvExperience) {
                        renderDynamicList(preview.cvExperience, controls.experienceList, 'experience');
                    }
                    if (preview.cvFormation) {
                        renderDynamicList(preview.cvFormation, controls.formationList, 'formation');
                    }

                    const skillStyle = document.querySelector('.skill-style-btn.active')?.dataset.skillStyle || 'tags';
                    if (preview.cvCompetences) {
                        preview.cvCompetences.dataset.style = skillStyle;
                        
                        if (skillStyle === 'tags') {
                            preview.cvCompetences.innerHTML = renderSkillsAsTags(controls.competences.value);
                            initializeSkillSorting(); 
                        } else if (skillStyle === 'levels') {
                            preview.cvCompetences.innerHTML = renderSkillsAsLevels();
                        } else { // simple
                            preview.cvCompetences.innerHTML = renderSkillsAsSimple(controls.competences.value);
                        }
                    }

                    document.querySelectorAll('.custom-module-preview').forEach(m => m.remove());
                    const hasCustomSections = controls.customSectionsList.children.length > 0;
                    Array.from(controls.customSectionsList.children).forEach(div => {
                        const sectionId = div.dataset.sectionId;
                        const title = div.querySelector('input').value;
                        const content = div.querySelector('textarea').value;
                        const iconClass = div.dataset.icon || 'fas fa-puzzle-piece';
                        
                        const moduleDiv = document.createElement('div');
                        moduleDiv.id = sectionId;
                        moduleDiv.className = 'cv-module custom-module-preview'; 
                        moduleDiv.innerHTML = `
                            <div class="drag-handle"><i class="fas fa-grip-vertical"></i></div>
                            <h2 class="section-title" data-section-id="${sectionId}"><i class="${iconClass} section-icon"></i><span contenteditable="true">${title}</span><div class="section-ai-actions"><button class="ai-action-btn toggle-visibility-btn" title="Masquer/Afficher la section"><i class="fas fa-eye"></i></button></div></h2>
                            <div class="dynamic-preview-item">
                                <button class="delete-block-btn" title="Supprimer la section"><i class="fas fa-trash-alt"></i></button>
                                <div class="editable-wrapper">
                                    <div class="custom-content" contenteditable="true">${content.replace(/\n/g, '<br>') || '&nbsp;'}</div>
                                    <span class="delete-line-btn"><i class="fas fa-times"></i></span>
                                </div>
                            </div>
                        `;
                        const lastModule = document.querySelector('#competences-module');
                        if(lastModule && lastModule.parentElement) {
                            lastModule.parentElement.insertBefore(moduleDiv, lastModule.nextSibling);
                        }
                    });
                    
                    // Reinitialize drag and drop after adding custom modules
                    if (hasCustomSections || document.querySelectorAll('.custom-module-preview').length > 0) {
                        setTimeout(() => initializeAllSortable(), 100);
                    }
                    
                    preview.bannerNom.textContent = controls.bannerNom.value || "Nom Pr√©nom Recruteur";
                    preview.bannerPoste.textContent = controls.bannerPoste.value || "Poste du Recruteur";
                    preview.bannerEmail.textContent = controls.bannerEmail.value || "email@recruteur.com";
                    preview.bannerTel.textContent = controls.bannerTel.value || "01 23 45 67 89";
                }

                preview.bannerNom.style.fontFamily = controls.bannerNomFont.value;
                preview.bannerNom.style.fontSize = controls.bannerNomSize.value + 'pt';
                preview.bannerNom.style.color = controls.bannerNomColor.value;
                preview.bannerNom.style.fontWeight = controls.bannerNomBold.classList.contains('active') ? 'bold' : 'normal';
                preview.bannerNom.style.fontStyle = controls.bannerNomItalic.classList.contains('active') ? 'italic' : 'normal';
                
                preview.bannerPoste.style.fontSize = controls.bannerPosteSize.value + 'pt';
                preview.bannerPoste.style.color = controls.bannerPosteColor.value;
                preview.bannerPoste.style.fontWeight = controls.bannerPosteBold.classList.contains('active') ? 'bold' : 'normal';
                preview.bannerPoste.style.fontStyle = controls.bannerPosteItalic.classList.contains('active') ? 'italic' : 'normal';

                preview.bannerContact.style.fontSize = controls.bannerContactSize.value + 'pt';
                preview.bannerContact.style.color = controls.bannerContactColor.value;
                preview.bannerContact.style.fontWeight = controls.bannerContactBold.classList.contains('active') ? 'bold' : 'normal';
                preview.bannerContact.style.fontStyle = controls.bannerContactItalic.classList.contains('active') ? 'italic' : 'normal';
                
                const dispo = controls.qualificationDispo.value;
                const salaire = controls.qualificationSalaire.value;
                const loc = controls.qualificationLoc.value;
                let qualHTML = '';
                if (dispo) qualHTML += `<div><i class="fas fa-calendar-check mr-1 text-gray-400"></i> ${dispo}</div>`;
                if (salaire) qualHTML += `<div><i class="fas fa-euro-sign mr-1 text-gray-400"></i> ${salaire}</div>`;
                if (loc) qualHTML += `<div><i class="fas fa-map-marker-alt mr-1 text-gray-400"></i> ${loc}</div>`;
                preview.qualificationPreview.innerHTML = qualHTML;
                preview.qualificationModule.style.display = (dispo || salaire || loc) ? '' : 'none';

                const isBannerEnabled = controls.toggleBanner.checked;
                const isBannerInTop = preview.fixedBannerTop.contains(preview.banner);
                const isBannerInBottom = preview.fixedBannerBottom.contains(preview.banner);
                const isBannerInModule = preview.bannerModule.contains(preview.banner);
                
                preview.bannerModule.classList.toggle('hidden', !isBannerEnabled || !isBannerInModule);
                preview.fixedBannerTop.style.display = (isBannerEnabled && isBannerInTop) ? 'block' : 'none';
                preview.fixedBannerBottom.style.display = (isBannerEnabled && isBannerInBottom) ? 'block' : 'none';

                checkAllPagesOverflow();
            }
            
            function syncFormFromPreview(element) {
                if (!element) return;
                const id = element.id;

                if (id === 'cv-competences-preview') {
                    const style = preview.cvCompetences.dataset.style;
                    if (style === 'levels') {
                        const skillLabels = preview.cvCompetences.querySelectorAll('.skill-level-label');
                        const controlInputs = controls.skillsLevelList.querySelectorAll('.skill-name-input');
                        skillLabels.forEach((label, index) => {
                            if (controlInputs[index]) {
                                controlInputs[index].value = label.textContent;
                            }
                        });
                    } else { 
                        let result = [];
                        const nodes = Array.from(element.childNodes);
                        for (let i = 0; i < nodes.length; i++) {
                            const node = nodes[i];
                            if (node.nodeName === 'H3' && node.classList.contains('skill-category')) {
                                const categoryName = node.textContent.trim();
                                const nextNode = nodes[i + 1];
                                if (nextNode && nextNode.nodeName === 'UL') {
                                    const skills = Array.from(nextNode.querySelectorAll('li.skill-item')).map(li => li.textContent.replace('√ó', '').trim()).filter(Boolean).join(', ');
                                    if (categoryName && skills) {
                                        result.push(`${categoryName}: ${skills}`);
                                    }
                                    i++; 
                                }
                            } else if (node.nodeName === 'UL') {
                                const skills = Array.from(node.querySelectorAll('li')).map(li => li.textContent.replace('√ó', '').trim()).filter(Boolean).join(', ');
                                if (skills) {
                                    result.push(skills);
                                }
                            }
                        }
                        controls.competences.value = result.join('\n');
                    }
                    return;
                }
                
                let text = element.innerHTML.replace(/<br\s*\/?>/gi, '\n').trim();
                text = new DOMParser().parseFromString(text, "text/html").documentElement.textContent;

                if (id) {
                    switch (id) {
                        case 'cv-nom-prenom-preview': const nameParts = text.trim().split(' '); controls.prenom.value = nameParts.shift() || ''; controls.nom.value = nameParts.join(' ') || ''; break;
                        case 'cv-poste-preview': controls.poste.value = text; break;
                        case 'cv-description-preview': controls.description.value = text; break;
                        case 'banner-nom-preview': controls.bannerNom.value = text; break;
                        case 'banner-poste-preview': controls.bannerPoste.value = text; break;
                        case 'banner-email-preview': controls.bannerEmail.value = text; break;
                        case 'banner-tel-preview': controls.bannerTel.value = text; break;
                    }
                } else {
                    const itemContainer = element.closest('.dynamic-item-container');
                    if (itemContainer) {
                        const index = parseInt(itemContainer.dataset.index, 10);
                        const type = itemContainer.dataset.type;
                        const formList = type === 'experience' ? controls.experienceList : controls.formationList;
                        const formItem = formList.children[index];
                        if (!formItem) return;

                        const title = itemContainer.querySelector('.item-title')?.textContent || '';
                        const meta = itemContainer.querySelector('.item-meta')?.textContent || '';
                        const descEl = itemContainer.querySelector('.mt-1');
                        const desc = descEl ? new DOMParser().parseFromString(descEl.innerHTML.replace(/<br\s*\/?>/gi, '\n'), "text/html").documentElement.textContent : '';

                        if (formItem.querySelector('.data-title')) formItem.querySelector('.data-title').value = title;
                        if (formItem.querySelector('.data-meta')) formItem.querySelector('.data-meta').value = meta;
                        if (formItem.querySelector('.data-desc')) formItem.querySelector('.data-desc').value = desc;

                    } else {
                        const customModule = element.closest('.custom-module-preview');
                        if (customModule) {
                            const sectionId = customModule.id;
                            const controlTitleInput = document.getElementById(`custom-section-title-${sectionId}`);
                            const controlContentTextarea = document.getElementById(`custom-section-content-${sectionId}`);
                            
                            if (element.matches('[contenteditable].section-title span')) {
                               if (controlTitleInput) controlTitleInput.value = element.textContent;
                            }
                            if (element.matches('[contenteditable].custom-content')) {
                               if (controlContentTextarea) controlContentTextarea.value = text;
                            }
                        }
                    }
                }
            }

            function moveBannerTo(destination) {
                const recruiterBanner = preview.banner;
                if (destination === 'top') {
                    preview.fixedBannerTop.appendChild(recruiterBanner);
                } else if (destination === 'bottom') {
                    preview.fixedBannerBottom.appendChild(recruiterBanner);
                } else { // 'modular'
                    preview.bannerModule.querySelector('.drag-handle').insertAdjacentElement('afterend', recruiterBanner);
                }
                const isModular = (destination === 'modular');
                document.getElementById('banner-fix-controls').classList.toggle('hidden', !isModular);
                controls.modularBannerBtn.classList.toggle('hidden', isModular);
                updatePreview('banner-move');
            }

            function addCustomSection(title = 'Nouvelle Section', content = '', id = null, icon = 'fas fa-puzzle-piece') {
                customSectionCounter++;
                const sectionId = id || `custom-module-${Date.now()}-${customSectionCounter}`;
                
                const controlDiv = document.createElement('div');
                controlDiv.className = 'p-2 border rounded-md bg-white relative';
                controlDiv.dataset.sectionId = sectionId;
                controlDiv.dataset.icon = icon;
                controlDiv.innerHTML = `
                    <input type="text" value="${title}" class="w-full p-1 border rounded-sm mb-1 font-semibold custom-section-input" id="custom-section-title-${sectionId}">
                    <textarea rows="4" class="w-full p-1 border rounded-sm mb-1 custom-section-input" id="custom-section-content-${sectionId}" placeholder="Contenu...">${content}</textarea>
                    <button class="absolute top-1 right-1 text-red-400 hover:text-red-600 remove-section-btn"><i class="fas fa-times-circle"></i></button>
                `;
                controls.customSectionsList.appendChild(controlDiv);
                
                updatePreview('form');
                updateAllStyles();
            }

            async function callGeminiAPI(prompt, schema) {
                showLoader("L'IA r√©fl√©chit...");
                try {
                    const apiKey = localStorage.getItem('gemini-api-key') || "";
                    if (!apiKey) {
                        throw new Error("Cl√© API Gemini non configur√©e. Veuillez saisir votre cl√© API dans les param√®tres.");
                    }
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                    
                    const payload = {
                        contents: [{ role: "user", parts: [{ text: prompt }] }],
                        generationConfig: schema ? { responseMimeType: "application/json", responseSchema: schema } : {}
                    };

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorBody = await response.text();
                        throw new Error(`Erreur API: ${response.status} ${response.statusText} - ${errorBody}`);
                    }

                    const result = await response.json();
                    
                    if (result.candidates && result.candidates.length > 0) {
                         if (result.candidates[0].finishReason !== "STOP" && result.candidates[0].finishReason !== "MAX_TOKENS") {
                               throw new Error(`L'IA a √©t√© bloqu√©e (raison: ${result.candidates[0].finishReason}). Veuillez reformuler votre demande.`);
                         }
                        if (result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                            const text = result.candidates[0].content.parts[0].text;
                            return schema ? JSON.parse(text) : text;
                        }
                    }
                    
                    throw new Error("R√©ponse invalide ou vide re√ßue de l'IA.");

                } catch (error) {
                    console.error("Erreur d√©taill√©e de l'IA:", error);
                    showNotification(`Erreur de l'IA : ${error.message}`, 'error', 5000);
                    return null;
                } finally {
                    hideLoader();
                }
            }
            
            function updateAllStyles() {
                root.style.setProperty('--primary-color', controls.primaryColorPicker.value);
                root.style.setProperty('--secondary-color', controls.secondaryColorPicker.value);
                root.style.setProperty('--body-text-color', controls.bodyTextColorPicker.value);
                root.style.setProperty('--font-family-h1', controls.fontFamilyH1Select.value);
                root.style.setProperty('--font-family-h2', controls.fontFamilyH2Select.value);
                root.style.setProperty('--font-family-body', controls.fontFamilyBodySelect.value);

                const activeStyle = document.querySelector('.section-title-style-btn.active')?.dataset.titleStyle || 'style-underline';
                document.querySelectorAll('.section-title').forEach(title => {
                    title.classList.remove('style-underline', 'style-side-line', 'style-background', 'style-boxed');
                    title.classList.add(activeStyle);
                });
                
                const banner = preview.banner;
                const newBannerStyle = controls.bannerStyleSelect.value;
                const newAlign = document.querySelector('.banner-align-btn.active')?.dataset.bannerAlign || 'left';
                const isInverted = controls.bannerInvertBtn.classList.contains('active');

                const classesToRemove = Array.from(banner.classList).filter(c => c.startsWith('banner-style-'));
                if (classesToRemove.length > 0) banner.classList.remove(...classesToRemove);

                if (newBannerStyle) banner.classList.add(newBannerStyle);
                
                const contentWrapper = banner.querySelector('.banner-content-wrapper');
                contentWrapper.className = 'banner-content-wrapper'; // Reset classes
                contentWrapper.classList.add(`banner-align-${newAlign}`);
                if (isInverted) contentWrapper.classList.add('banner-layout-inverted');
                
                checkAllPagesOverflow();
            }

            function populateFontSelectors() {
                const fonts = [
                    { name: 'Lato', value: "'Lato', sans-serif" },
                    { name: 'Montserrat', value: "'Montserrat', sans-serif" },
                    { name: 'Roboto Mono', value: "'Roboto Mono', monospace" },
                    { name: 'Playfair Display', value: "'Playfair Display', serif" },
                    { name: 'Merriweather', value: "'Merriweather', serif" },
                    { name: 'Oswald', value: "'Oswald', sans-serif" },
                    { name: 'Open Sans', value: "'Open Sans', sans-serif" },
                    { name: 'Source Sans Pro', value: "'Source Sans Pro', sans-serif" },
                    { name: 'Nunito Sans', value: "'Nunito Sans', sans-serif" },
                    { name: 'Cormorant Garamond', value: "'Cormorant Garamond', serif" },
                ];
                const selects = [controls.fontFamilyH1Select, controls.fontFamilyH2Select, controls.fontFamilyBodySelect, controls.bannerNomFont];
                selects.forEach(select => {
                    if (!select) return;
                    select.innerHTML = '';
                    fonts.forEach(font => {
                        const option = document.createElement('option');
                        option.value = font.value;
                        option.textContent = font.name;
                        select.appendChild(option);
                    });
                });
            }
            
            // Alias for backward compatibility
            function populateFontSelects() {
                return populateFontSelectors();
            }
            
            function populateIconPicker() {
                const icons = ["fa-user-circle", "fa-briefcase", "fa-graduation-cap", "fa-star", "fa-puzzle-piece", "fa-globe", "fa-paint-brush", "fa-certificate", "fa-lightbulb", "fa-heart", "fa-cogs", "fa-code", "fa-chart-line", "fa-comments", "fa-bullhorn", "fa-trophy", "fa-book", "fa-wrench", "fa-users", "fa-award", "fa-phone", "fa-envelope", "fa-map-marker-alt", "fa-linkedin", "fa-github"];
                controls.iconPickerGrid.innerHTML = '';
                icons.forEach(iconClass => {
                    const iconEl = document.createElement('i');
                    iconEl.className = `fas ${iconClass}`;
                    iconEl.dataset.icon = `fas ${iconClass}`;
                    controls.iconPickerGrid.appendChild(iconEl);
                });
            }

            function resetCVToDefault() {
                document.querySelectorAll('.cv-input, .banner-input, .custom-section-input').forEach(input => {
                    if(input.type === 'checkbox') input.checked = false;
                    else if (input.type !== 'range' && input.type !== 'color') input.value = '';
                });
                
                controls.experienceList.innerHTML = '';
                controls.formationList.innerHTML = '';
                controls.customSectionsList.innerHTML = '';
                controls.skillsLevelList.innerHTML = '';
                
                document.querySelectorAll('.custom-module-preview').forEach(m => m.remove());
                
                setDefaultRecruiterInfo();
                applyTheme('professional');
                document.querySelector('.layout-btn[data-layout="layout-1-col"]')?.click();
                document.querySelector('.skill-style-btn[data-skill-style="tags"]')?.click();
                
                Object.values(sliders).forEach(config => {
                    const defaultValue = config.el.defaultValue;
                    config.el.value = defaultValue;
                    config.valueEl.textContent = defaultValue;
                    root.style.setProperty(config.property, `${defaultValue}${config.unit}`);
                });
                
                moveBannerTo('modular');
                removeBannerBackground();

                document.querySelectorAll('.completion-checkbox').forEach(cb => {
                    cb.checked = false;
                    cb.closest('details').open = true;
                });
                updateProgressBar();
                
                updatePreview('form');
                updateAllStyles();
                showNotification("Le CV a √©t√© r√©initialis√©.", "success");
            }

            // --- API KEY MANAGEMENT ---
            function loadApiKey() {
                const savedApiKey = localStorage.getItem('gemini-api-key');
                if (savedApiKey) {
                    controls.apiKeyInput.value = savedApiKey;
                    controls.apiKeyStatus.textContent = 'Cl√© API configur√©e';
                    controls.apiKeyStatus.classList.remove('text-red-500', 'text-yellow-600');
                    controls.apiKeyStatus.classList.add('text-green-600');
                } else {
                    controls.apiKeyStatus.textContent = 'Cl√© API manquante';
                    controls.apiKeyStatus.classList.remove('text-green-600', 'text-yellow-600');
                    controls.apiKeyStatus.classList.add('text-red-500');
                }
            }

            function saveApiKey() {
                const apiKey = controls.apiKeyInput.value.trim();
                if (apiKey) {
                    localStorage.setItem('gemini-api-key', apiKey);
                    controls.apiKeyStatus.textContent = 'Cl√© API sauvegard√©e';
                    controls.apiKeyStatus.classList.remove('text-red-500', 'text-yellow-600');
                    controls.apiKeyStatus.classList.add('text-green-600');
                    return true;
                } else {
                    controls.apiKeyStatus.textContent = 'Cl√© API vide';
                    controls.apiKeyStatus.classList.remove('text-green-600', 'text-yellow-600');
                    controls.apiKeyStatus.classList.add('text-red-500');
                    return false;
                }
            }

            function toggleApiKeyVisibility() {
                const input = controls.apiKeyInput;
                const icon = controls.toggleApiKeyVisibilityBtn.querySelector('i');
                
                if (input.type === 'password') {
                    input.type = 'text';
                    icon.classList.remove('fa-eye');
                    icon.classList.add('fa-eye-slash');
                } else {
                    input.type = 'password';
                    icon.classList.remove('fa-eye-slash');
                    icon.classList.add('fa-eye');
                }
            }

            // --- INITIALIZATION ---
            
            // Load API key on startup
            loadApiKey();
            
            function setDefaultRecruiterInfo() {
                controls.bannerNom.value = "Lyes AMARA";
                controls.bannerPoste.value = "Responsable d'activit√© recrutement ‚Äì BTP ‚Äì France";
                controls.bannerEmail.value = "l.amara@ltd-international.com";
                controls.bannerTel.value = "01 56 02 12 25 / 06 34 25 32 96";
            }

            function anonymizeCV() {
                if (isAnonymized) {
                    // Restoration mode
                    controls.nom.value = originalData.nom || '';
                    controls.prenom.value = originalData.prenom || '';
                    controls.bannerEmail.value = originalData.bannerEmail || '';
                    controls.bannerTel.value = originalData.bannerTel || '';
                    controls.qualificationLoc.value = originalData.qualificationLoc || '';
                    
                    controls.anonymizeBtn.innerHTML = '<i class="fa-solid fa-user-secret text-lg"></i><span class="font-semibold">Anonymiser le CV</span>';
                    isAnonymized = false;
                    showNotification("CV d√©sanonymis√© avec succ√®s !", "success");
                } else {
                    // Anonymization mode - store original data
                    originalData = {
                        nom: controls.nom.value || '',
                        prenom: controls.prenom.value || '',
                        bannerEmail: controls.bannerEmail.value || '',
                        bannerTel: controls.bannerTel.value || '',
                        qualificationLoc: controls.qualificationLoc.value || ''
                    };
                    
                    // Apply anonymization rules
                    // Last name: Keep only first letter + dot
                    const firstLetter = originalData.nom ? originalData.nom.charAt(0) + '.' : '';
                    controls.nom.value = firstLetter;
                    
                    // First name: Keep as-is (no change)
                    // controls.prenom.value remains unchanged
                    
                    // Email: Anonymize to "***@.***"
                    if (originalData.bannerEmail) {
                        controls.bannerEmail.value = "***@.***";
                    }
                    
                    // Phone: Anonymize to "** ** ** ** **"
                    if (originalData.bannerTel) {
                        controls.bannerTel.value = "** ** ** ** **";
                    }
                    
                    // Location: Anonymize to "***"
                    if (originalData.qualificationLoc) {
                        controls.qualificationLoc.value = "***";
                    }
                    
                    controls.anonymizeBtn.innerHTML = '<i class="fa-solid fa-user text-lg"></i><span class="font-semibold">D√©sanonymiser le CV</span>';
                    isAnonymized = true;
                    showNotification("CV anonymis√© avec succ√®s !", "success");
                }
                updatePreview('form');
            }

            // --- EVENT LISTENERS ---
            
            // API Key event listeners
            controls.saveApiKeyBtn.addEventListener('click', () => {
                if (saveApiKey()) {
                    showNotification("Cl√© API sauvegard√©e avec succ√®s.", "success");
                }
            });
            
            controls.toggleApiKeyVisibilityBtn.addEventListener('click', toggleApiKeyVisibility);
            
            // Save API key on Enter
            controls.apiKeyInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    if (saveApiKey()) {
                        showNotification("Cl√© API sauvegard√©e avec succ√®s.", "success");
                    }
                }
            });

            // Main action buttons
            controls.downloadPdfBtn.addEventListener('click', () => {
                showLoader("G√©n√©ration du PDF...");
                window.print();
                hideLoader();
            });

            controls.shareBtn.addEventListener('click', () => {
                controls.shareLinkInput.value = window.location.href;
                controls.shareModal.classList.add('active');
            });

            controls.closeShareModal.addEventListener('click', () => {
                controls.shareModal.classList.remove('active');
            });

            controls.copyShareLinkBtn.addEventListener('click', async () => {
                try {
                    await navigator.clipboard.writeText(controls.shareLinkInput.value);
                    showNotification("Lien copi√© dans le presse-papiers !", "success");
                } catch (err) {
                    showNotification("Erreur lors de la copie", "error");
                }
            });

            controls.anonymizeBtn.addEventListener('click', anonymizeCV);

            controls.resetCvBtn.addEventListener('click', async () => {
                const confirmed = await showConfirmModal("Nouveau CV", "√ätes-vous s√ªr de vouloir r√©initialiser le CV ? Toutes les donn√©es seront perdues.");
                if (confirmed) {
                    resetCVToDefault();
                }
            });

            controls.toggleOverflowBtn.addEventListener('click', () => {
                document.body.classList.toggle('overflow-check-active');
                controls.toggleOverflowBtn.classList.toggle('active');
            });

            controls.togglePresentationModeBtn.addEventListener('click', () => {
                document.body.classList.toggle('presentation-mode');
                controls.togglePresentationModeBtn.classList.toggle('active');
            });

            // AI buttons
            controls.analyzeBtn.addEventListener('click', async () => {
                if (!controls.aiInput.value.trim()) {
                    showNotification("Veuillez saisir du texte √† analyser.", "error");
                    return;
                }

                const prompt = `Analysez le texte suivant et extractez les informations pour un CV professionnel :
${controls.aiInput.value}

Retournez un objet JSON avec cette structure exacte :
{
    "nom": "nom de famille",
    "prenom": "pr√©nom",
    "poste": "titre du poste",
    "description": "description professionnelle (2-3 phrases)",
    "experiences": [
        {"title": "Titre du poste", "meta": "Entreprise - P√©riode", "desc": "Description des responsabilit√©s"}
    ],
    "formations": [
        {"title": "Dipl√¥me", "meta": "√âtablissement - Ann√©e", "desc": ""}
    ],
    "competences": "liste des comp√©tences s√©par√©es par des virgules"
}`;

                const schema = {
                    type: "object",
                    properties: {
                        nom: { type: "string" },
                        prenom: { type: "string" },
                        poste: { type: "string" },
                        description: { type: "string" },
                        experiences: {
                            type: "array",
                            items: {
                                type: "object",
                                properties: {
                                    title: { type: "string" },
                                    meta: { type: "string" },
                                    desc: { type: "string" }
                                }
                            }
                        },
                        formations: {
                            type: "array",
                            items: {
                                type: "object",
                                properties: {
                                    title: { type: "string" },
                                    meta: { type: "string" },
                                    desc: { type: "string" }
                                }
                            }
                        },
                        competences: { type: "string" }
                    }
                };

                const result = await callGeminiAPI(prompt, schema);
                if (result) {
                    // Remplir les champs
                    if (result.nom) controls.nom.value = result.nom;
                    if (result.prenom) controls.prenom.value = result.prenom;
                    if (result.poste) controls.poste.value = result.poste;
                    if (result.description) controls.description.value = result.description;
                    if (result.competences) controls.competences.value = result.competences;

                    // Vider les listes existantes
                    controls.experienceList.innerHTML = '';
                    controls.formationList.innerHTML = '';

                    // Ajouter les exp√©riences
                    if (result.experiences) {
                        result.experiences.forEach(exp => {
                            createDynamicItem(controls.experienceList, [
                                { key: 'title', placeholder: 'Titre du poste', type: 'input' },
                                { key: 'meta', placeholder: 'Entreprise - P√©riode', type: 'input' },
                                { key: 'desc', placeholder: 'Description', type: 'textarea' }
                            ], exp);
                        });
                    }

                    // Ajouter les formations
                    if (result.formations) {
                        result.formations.forEach(form => {
                            createDynamicItem(controls.formationList, [
                                { key: 'title', placeholder: 'Dipl√¥me/Formation', type: 'input' },
                                { key: 'meta', placeholder: '√âcole - Ann√©e', type: 'input' },
                                { key: 'desc', placeholder: 'Description (optionnel)', type: 'textarea' }
                            ], form);
                        });
                    }

                    updatePreview('form');
                    showNotification("Analyse termin√©e et CV rempli !", "success");
                }
            });

            controls.generateMailBtn.addEventListener('click', async () => {
                const nom = controls.nom.value;
                const prenom = controls.prenom.value;
                const poste = controls.poste.value;
                const description = controls.description.value;
                const dispo = controls.qualificationDispo.value;
                const salaire = controls.qualificationSalaire.value;
                const loc = controls.qualificationLoc.value;

                if (!nom || !prenom || !poste) {
                    showNotification("Veuillez remplir au moins le nom, pr√©nom et poste pour g√©n√©rer le mail.", "error");
                    return;
                }

                const prompt = `G√©n√©rez un mail de pr√©sentation professionnel pour un candidat avec ces informations :
- Nom : ${prenom} ${nom}
- Poste recherch√© : ${poste}
- Description : ${description}
- Disponibilit√© : ${dispo}
- Pr√©tentions salariales : ${salaire}
- Localisation : ${loc}

Le mail doit √™tre courtois, professionnel et concis (maximum 200 mots).`;

                const result = await callGeminiAPI(prompt);
                if (result) {
                    controls.recruiterMailContent.value = result;
                    showNotification("Mail de pr√©sentation g√©n√©r√© !", "success");
                }
            });

            // NEW AI FEATURES
            document.getElementById('smart-analyze-btn')?.addEventListener('click', async () => {
                const jobDescription = controls.aiInput.value.trim();
                if (!jobDescription) {
                    showNotification("Veuillez coller une description de poste.", "error");
                    return;
                }

                showLoader("Analyse intelligente en cours...");

                const prompt = `Analysez cette offre d'emploi et fournissez des recommandations d√©taill√©es pour optimiser un CV :

${jobDescription}

Retournez un objet JSON avec cette structure :
{
    "keywords": ["mot-cl√©1", "mot-cl√©2", ...],
    "required_skills": ["comp√©tence1", "comp√©tence2", ...],
    "recommended_sections": ["section1", "section2", ...],
    "tone": "professionnel/cr√©atif/technique",
    "layout_suggestion": "1-colonne/2-colonnes",
    "color_theme": "corporate/creative/modern"
}`;

                const schema = {
                    type: "object",
                    properties: {
                        keywords: { type: "array", items: { type: "string" } },
                        required_skills: { type: "array", items: { type: "string" } },
                        recommended_sections: { type: "array", items: { type: "string" } },
                        tone: { type: "string" },
                        layout_suggestion: { type: "string" },
                        color_theme: { type: "string" }
                    }
                };

                const result = await callGeminiAPI(prompt, schema);
                if (result) {
                    hideLoader();
                    showSmartAnalysisResult(result);
                } else {
                    hideLoader();
                }
            });

            document.getElementById('industry-match-btn')?.addEventListener('click', async () => {
                const currentCV = getCurrentCVData();
                if (!currentCV.poste) {
                    showNotification("Veuillez d'abord renseigner le poste recherch√©.", "error");
                    return;
                }

                const prompt = `Adaptez ce CV au secteur "${currentCV.poste}" en sugg√©rant des am√©liorations sp√©cifiques :

CV actuel :
- Poste : ${currentCV.poste}
- Description : ${currentCV.description}
- Comp√©tences : ${currentCV.competences}

Retournez des suggestions pour optimiser le CV pour ce secteur.`;

                const result = await callGeminiAPI(prompt);
                if (result) {
                    showImprovementModal("Adaptation Sectorielle", result);
                }
            });

            document.getElementById('ai-score-cv-btn')?.addEventListener('click', async () => {
                const cvData = getCurrentCVData();
                
                const prompt = `√âvaluez ce CV selon les crit√®res ATS (Applicant Tracking System) et recruteurs :

${JSON.stringify(cvData)}

Donnez un score sur 100 et des recommendations d√©taill√©es pour chaque crit√®re :
- Mots-cl√©s sectoriels (0-20)
- Structure et lisibilit√© (0-20) 
- Exp√©rience pertinente (0-20)
- Comp√©tences techniques (0-20)
- Pr√©sentation professionnelle (0-20)

Format JSON attendu :
{
    "total_score": 85,
    "scores": {
        "keywords": 18,
        "structure": 16,
        "experience": 19,
        "skills": 17,
        "presentation": 15
    },
    "recommendations": ["am√©lioration 1", "am√©lioration 2", ...]
}`;

                const result = await callGeminiAPI(prompt, {
                    type: "object",
                    properties: {
                        total_score: { type: "number" },
                        scores: { type: "object" },
                        recommendations: { type: "array", items: { type: "string" } }
                    }
                });

                if (result) {
                    showCVScoreModal(result);
                }
            });

            document.getElementById('ai-keyword-optimize-btn')?.addEventListener('click', async () => {
                const currentCV = getCurrentCVData();
                
                const prompt = `Analysez ce CV et sugg√©rez des mots-cl√©s sp√©cifiques au secteur pour am√©liorer le r√©f√©rencement ATS :

${JSON.stringify(currentCV)}

Retournez une liste de mots-cl√©s √† int√©grer naturellement dans le CV.`;

                const result = await callGeminiAPI(prompt);
                if (result) {
                    highlightKeywordsInCV(result);
                    showNotification("Mots-cl√©s optimis√©s et mis en √©vidence dans le CV !", "success");
                }
            });

            document.getElementById('ai-create-variants-btn')?.addEventListener('click', async () => {
                const currentCV = getCurrentCVData();
                
                showLoader("Cr√©ation de 3 variantes de CV...");

                const prompt = `Cr√©ez 3 variantes de ce CV pour diff√©rents contextes :

CV de base : ${JSON.stringify(currentCV)}

Variante 1: Version concise (1 page, focus exp√©rience)
Variante 2: Version d√©taill√©e (2 pages, projets + comp√©tences)
Variante 3: Version cr√©ative (pr√©sentation moderne)

Format JSON avec 3 objets CV complets.`;

                const result = await callGeminiAPI(prompt);
                if (result) {
                    hideLoader();
                    showCVVariantsModal(result);
                } else {
                    hideLoader();
                }
            });

            document.getElementById('ai-personalize-job-btn')?.addEventListener('click', async () => {
                const jobDesc = prompt("Collez la description du poste pour personnaliser le CV :");
                if (!jobDesc) return;

                const currentCV = getCurrentCVData();
                
                const promptText = `Personnalisez ce CV pour correspondre exactement √† cette offre d'emploi :

OFFRE : ${jobDesc}

CV ACTUEL : ${JSON.stringify(currentCV)}

Retournez un CV modifi√© qui maximise les chances de correspondance avec l'offre.`;

                const result = await callGeminiAPI(promptText);
                if (result) {
                    // Apply the personalized CV
                    applyPersonalizedCV(result);
                    showNotification("CV personnalis√© pour l'offre d'emploi !", "success");
                }
            });

            document.getElementById('generate-linkedin-msg-btn')?.addEventListener('click', async () => {
                const currentCV = getCurrentCVData();
                
                const prompt = `G√©n√©rez un message LinkedIn professionnel bas√© sur ce profil :

${JSON.stringify(currentCV)}

Le message doit √™tre :
- Concis (150 mots max)
- Engageant
- Professionnel
- Personnalisable selon le destinataire`;

                const result = await callGeminiAPI(prompt);
                if (result) {
                    controls.recruiterMailContent.value = result;
                    showNotification("Message LinkedIn g√©n√©r√© !", "success");
                }
            });

            document.getElementById('ai-generate-motto-btn')?.addEventListener('click', async () => {
                const currentCV = getCurrentCVData();
                
                const prompt = `Cr√©ez une devise/slogan professionnel personnalis√© bas√© sur ce profil :

${JSON.stringify(currentCV)}

La devise doit √™tre :
- M√©morable (10 mots max)
- Refl√©ter la personnalit√© professionnelle
- Applicable au secteur d'activit√©`;

                const result = await callGeminiAPI(prompt);
                if (result) {
                    addMottoToCV(result);
                    showNotification("Devise personnalis√©e ajout√©e au CV !", "success");
                }
            });

            document.getElementById('ai-suggest-improvements-btn')?.addEventListener('click', async () => {
                const currentCV = getCurrentCVData();
                
                const prompt = `Analysez ce CV et fournissez 5 suggestions concr√®tes d'am√©lioration :

${JSON.stringify(currentCV)}

Pour chaque suggestion, expliquez :
1. Le probl√®me identifi√©
2. La solution recommand√©e
3. L'impact attendu`;

                const result = await callGeminiAPI(prompt);
                if (result) {
                    showImprovementModal("Suggestions d'Am√©lioration", result);
                }
            });

            document.getElementById('ai-translate-cv-btn')?.addEventListener('click', () => {
                document.getElementById('translation-modal').classList.add('active');
            });

            // Helper functions for new AI features
            function getCurrentCVData() {
                return {
                    nom: controls.nom.value,
                    prenom: controls.prenom.value,
                    poste: controls.poste.value,
                    description: controls.description.value,
                    experiences: getDynamicData(controls.experienceList),
                    formations: getDynamicData(controls.formationList),
                    competences: controls.competences.value
                };
            }

            function showSmartAnalysisResult(analysis) {
                const container = document.createElement('div');
                container.className = 'analysis-result';
                container.innerHTML = `
                    <h3 class="font-bold mb-3">üìä Analyse Intelligente</h3>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <p class="font-semibold mb-2">Mots-cl√©s d√©tect√©s :</p>
                            <div class="flex flex-wrap gap-1">
                                ${analysis.keywords?.map(k => `<span class="keyword-highlight">${k}</span>`).join('') || ''}
                            </div>
                        </div>
                        <div>
                            <p class="font-semibold mb-2">Comp√©tences requises :</p>
                            <ul class="list-disc list-inside">
                                ${analysis.required_skills?.map(s => `<li>${s}</li>`).join('') || ''}
                            </ul>
                        </div>
                        <div>
                            <p class="font-semibold mb-2">Sections recommand√©es :</p>
                            <ul class="list-disc list-inside">
                                ${analysis.recommended_sections?.map(s => `<li>${s}</li>`).join('') || ''}
                            </ul>
                        </div>
                        <div>
                            <p class="font-semibold mb-2">Recommandations :</p>
                            <p>Ton : ${analysis.tone}</p>
                            <p>Layout : ${analysis.layout_suggestion}</p>
                            <p>Th√®me : ${analysis.color_theme}</p>
                        </div>
                    </div>
                `;

                // Insert after AI input
                controls.aiInput.parentNode.insertBefore(container, controls.aiInput.nextSibling);

                // Auto-apply some suggestions
                if (analysis.required_skills) {
                    const newSkills = controls.competences.value + ', ' + analysis.required_skills.join(', ');
                    controls.competences.value = newSkills;
                    updatePreview('form');
                }
            }

            function showCVScoreModal(scoreData) {
                const modal = document.getElementById('cv-score-modal');
                const container = document.getElementById('score-result-container');
                
                container.innerHTML = `
                    <div class="cv-score-container">
                        <div class="score-circle">
                            <span class="score-text">${scoreData.total_score}/100</span>
                        </div>
                        <h3 class="text-xl font-bold">Score ATS Global</h3>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 mt-6">
                        ${Object.entries(scoreData.scores).map(([key, value]) => `
                            <div class="bg-gray-50 p-3 rounded-lg">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-sm font-medium">${key}</span>
                                    <span class="font-bold">${value}/20</span>
                                </div>
                                <div class="score-bar">
                                    <div class="score-fill" style="width: ${(value/20)*100}%"></div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="mt-6">
                        <h4 class="font-bold mb-3">üí° Recommandations :</h4>
                        <ul class="list-disc list-inside space-y-1">
                            ${scoreData.recommendations.map(rec => `<li class="text-sm">${rec}</li>`).join('')}
                        </ul>
                    </div>
                `;
                
                modal.classList.add('active');
            }

            function showImprovementModal(title, content) {
                const modal = document.getElementById('improvements-modal');
                const container = document.getElementById('improvements-container');
                
                modal.querySelector('h2').textContent = title;
                container.innerHTML = `<div class="prose max-w-none">${content.replace(/\n/g, '<br>')}</div>`;
                
                modal.classList.add('active');
            }

            // Fonction pour optimiser le CV afin qu'il tienne sur une page
            async function optimizeForOnePage() {
                try {
                    showNotification("Optimisation en cours...", "info");
                    
                    // Collecter toutes les donn√©es du CV
                    const cvData = {
                        nom: controls.nom.value,
                        prenom: controls.prenom.value,
                        poste: controls.poste.value,
                        description: controls.description.value,
                        experiences: getDynamicData(controls.experienceList),
                        formations: getDynamicData(controls.formationList),
                        competences: controls.competences.value
                    };

                    // V√©rifier si le CV a du contenu
                    if (!cvData.nom && !cvData.prenom && !cvData.poste && cvData.experiences.length === 0) {
                        showNotification("Veuillez remplir au moins les informations de base du CV.", "error");
                        return;
                    }

                    const prompt = `Vous √™tes un expert en CV professionnel. Optimisez ce CV pour qu'il tienne parfaitement sur UNE SEULE PAGE tout en conservant les informations les plus importantes et pertinentes.

DONN√âES DU CV ACTUEL :
- Nom: ${cvData.prenom} ${cvData.nom}
- Poste: ${cvData.poste}
- Description: ${cvData.description}
- Exp√©riences: ${cvData.experiences.map(exp => `${exp.title} - ${exp.meta}: ${exp.desc}`).join('\\n')}
- Formations: ${cvData.formations.map(form => `${form.title} - ${form.meta}: ${form.desc || ''}`).join('\\n')}
- Comp√©tences: ${cvData.competences}

CONSIGNES D'OPTIMISATION :
1. Raccourcissez la description professionnelle √† 2-3 lignes maximum
2. Limitez chaque exp√©rience √† 2-3 points cl√©s maximum
3. Condensez les formations en gardant l'essentiel
4. S√©lectionnez les 8-10 comp√©tences les plus pertinentes
5. Utilisez des phrases courtes et percutantes
6. Supprimez les r√©p√©titions et informations redondantes
7. Privil√©giez les r√©sultats chiffr√©s et mots-cl√©s du secteur

Retournez un objet JSON avec cette structure exacte :
{
    "description": "description professionnelle optimis√©e (2-3 lignes max)",
    "experiences": [
        {"title": "Titre du poste", "meta": "Entreprise - P√©riode", "desc": "Description concise avec 2-3 points cl√©s maximum"}
    ],
    "formations": [
        {"title": "Dipl√¥me", "meta": "√âtablissement - Ann√©e", "desc": ""}
    ],
    "competences": "liste des 8-10 comp√©tences les plus importantes s√©par√©es par des virgules"
}`;

                    const schema = {
                        type: "object",
                        properties: {
                            description: { type: "string" },
                            experiences: {
                                type: "array",
                                items: {
                                    type: "object",
                                    properties: {
                                        title: { type: "string" },
                                        meta: { type: "string" },
                                        desc: { type: "string" }
                                    }
                                }
                            },
                            formations: {
                                type: "array",
                                items: {
                                    type: "object",
                                    properties: {
                                        title: { type: "string" },
                                        meta: { type: "string" },
                                        desc: { type: "string" }
                                    }
                                }
                            },
                            competences: { type: "string" }
                        }
                    };

                    const result = await callGeminiAPI(prompt, schema);
                    if (result) {
                        // Appliquer les optimisations
                        if (result.description) {
                            controls.description.value = result.description;
                        }
                        
                        if (result.competences) {
                            controls.competences.value = result.competences;
                        }

                        // Remplacer les exp√©riences
                        if (result.experiences && result.experiences.length > 0) {
                            controls.experienceList.innerHTML = '';
                            result.experiences.forEach(exp => {
                                createDynamicItem(controls.experienceList, [
                                    { key: 'title', placeholder: 'Titre du poste', type: 'input' },
                                    { key: 'meta', placeholder: 'Entreprise - P√©riode', type: 'input' },
                                    { key: 'desc', placeholder: 'Description', type: 'textarea' }
                                ], exp);
                            });
                        }

                        // Remplacer les formations
                        if (result.formations && result.formations.length > 0) {
                            controls.formationList.innerHTML = '';
                            result.formations.forEach(form => {
                                createDynamicItem(controls.formationList, [
                                    { key: 'title', placeholder: 'Dipl√¥me/Formation', type: 'input' },
                                    { key: 'meta', placeholder: '√âcole - Ann√©e', type: 'input' },
                                    { key: 'desc', placeholder: 'Description (optionnel)', type: 'textarea' }
                                ], form);
                            });
                        }

                        // Optimiser automatiquement la taille de police et les espacements pour une page
                        document.documentElement.style.setProperty('--font-size-p', '9pt');
                        document.documentElement.style.setProperty('--font-size-h2', '18pt');
                        document.documentElement.style.setProperty('--paragraph-spacing', '0.3rem');
                        document.documentElement.style.setProperty('--module-spacing', '1rem');
                        document.documentElement.style.setProperty('--item-spacing', '0.3rem');
                        
                        // Mettre √† jour les sliders pour refl√©ter les nouveaux param√®tres
                        const fontSizePSlider = document.getElementById('font-size-p');
                        const fontSizeH2Slider = document.getElementById('font-size-h2');
                        const moduleSpacingSlider = document.getElementById('module-spacing');
                        const paragraphSpacingSlider = document.getElementById('paragraph-spacing');
                        const itemSpacingSlider = document.getElementById('item-spacing');
                        
                        if (fontSizePSlider) {
                            fontSizePSlider.value = 9;
                            document.getElementById('font-size-p-value').textContent = '9';
                        }
                        if (fontSizeH2Slider) {
                            fontSizeH2Slider.value = 18;
                            document.getElementById('font-size-h2-value').textContent = '18';
                        }
                        if (moduleSpacingSlider) {
                            moduleSpacingSlider.value = 1;
                            document.getElementById('module-spacing-value').textContent = '1';
                        }
                        if (paragraphSpacingSlider) {
                            paragraphSpacingSlider.value = 0.3;
                            document.getElementById('paragraph-spacing-value').textContent = '0.3';
                        }
                        if (itemSpacingSlider) {
                            itemSpacingSlider.value = 0.3;
                            document.getElementById('item-spacing-value').textContent = '0.3';
                        }

                        updatePreview('form');
                        
                        // V√©rifier si le CV tient maintenant sur une page
                        setTimeout(() => {
                            checkAllPagesOverflow();
                            showNotification("CV optimis√© pour tenir sur une page ! ‚ú®", "success");
                        }, 500);
                    }
                } catch (error) {
                    console.error('Erreur lors de l\'optimisation:', error);
                    showNotification("Erreur lors de l'optimisation. Veuillez r√©essayer.", "error");
                }
            }

            controls.aiOptimizeOnePageBtn.addEventListener('click', async () => {
                // Fonction pour optimiser le CV afin qu'il tienne sur une page
                await optimizeForOnePage();
            });

            // Skills templates
            document.querySelectorAll('.skill-template-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const template = btn.dataset.skillTemplate;
                    if (skillTemplates[template]) {
                        controls.competences.value = skillTemplates[template];
                        updatePreview('form');
                        showNotification(`Template ${template} appliqu√© !`, "success");
                    }
                });
            });

            // AI skills from job description
            document.getElementById('ai-skills-from-job-btn')?.addEventListener('click', async () => {
                const jobDesc = controls.aiInput.value.trim() || prompt("Collez la description du poste :");
                if (!jobDesc) return;

                const promptText = `Analysez cette offre d'emploi et extrayez les comp√©tences techniques et soft skills requises :

${jobDesc}

Retournez une liste de comp√©tences s√©par√©es par des virgules, en fran√ßais, adapt√©es pour un CV.`;

                const result = await callGeminiAPI(promptText);
                if (result) {
                    controls.competences.value = result;
                    updatePreview('form');
                    showNotification("Comp√©tences extraites de l'offre d'emploi !", "success");
                }
            });

            // Skill matcher
            document.getElementById('skill-matcher-btn')?.addEventListener('click', async () => {
                const jobDesc = prompt("Collez la description du poste pour analyser la correspondance :");
                if (!jobDesc) return;

                const currentSkills = controls.competences.value;
                
                const prompt = `Analysez la correspondance entre ces comp√©tences du CV et celles requises dans l'offre :

COMP√âTENCES CV : ${currentSkills}

OFFRE D'EMPLOI : ${jobDesc}

Retournez au format JSON :
{
    "match_percentage": 75,
    "matching_skills": ["skill1", "skill2"],
    "missing_skills": ["skill3", "skill4"],
    "recommendations": "conseils pour am√©liorer la correspondance"
}`;

                const result = await callGeminiAPI(prompt);
                if (result) {
                    showSkillAnalysisModal(result);
                }
            });

            // Suggest missing skills
            document.getElementById('suggest-missing-skills-btn')?.addEventListener('click', async () => {
                const currentCV = getCurrentCVData();
                
                const prompt = `Analysez ce profil et sugg√©rez les comp√©tences manquantes qui pourraient renforcer le CV :

${JSON.stringify(currentCV)}

Sugg√©rez 5-8 comp√©tences compl√©mentaires pertinentes pour ce profil.`;

                const result = await callGeminiAPI(prompt);
                if (result) {
                    const currentSkills = controls.competences.value;
                    const newSkills = currentSkills ? `${currentSkills}, ${result}` : result;
                    controls.competences.value = newSkills;
                    updatePreview('form');
                    showNotification("Comp√©tences compl√©mentaires ajout√©es !", "success");
                }
            });

            // Skill trend analysis
            document.getElementById('skill-trend-analysis-btn')?.addEventListener('click', async () => {
                const currentSkills = controls.competences.value;
                const sector = controls.poste.value;
                
                const prompt = `Analysez les tendances du march√© pour ces comp√©tences dans le secteur "${sector}" :

COMP√âTENCES : ${currentSkills}

Identifiez :
1. Les comp√©tences les plus demand√©es
2. Les comp√©tences √©mergentes √† acqu√©rir
3. Les comp√©tences obsol√®tes √† remplacer
4. Les formations recommand√©es`;

                const result = await callGeminiAPI(prompt);
                if (result) {
                    showImprovementModal("Analyse des Tendances Comp√©tences", result);
                }
            });

            // Enhanced skill styles
            document.querySelectorAll('.skill-style-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.skill-style-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    const style = btn.dataset.skillStyle;
                    
                    // Show/hide appropriate controls
                    if (style === 'levels') {
                        controls.skillsTextControls.classList.add('hidden');
                        controls.skillsLevelControls.classList.remove('hidden');
                    } else {
                        controls.skillsTextControls.classList.remove('hidden');
                        controls.skillsLevelControls.classList.add('hidden');
                    }
                    
                    // Apply style to preview
                    const skillsPreview = document.getElementById('cv-competences-preview');
                    if (skillsPreview) {
                        skillsPreview.dataset.style = style;
                        skillsPreview.className = `cv-competences-${style}`;
                    }
                    
                    updatePreview('form');
                });
            });

            // Section templates
            document.querySelectorAll('.section-template-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const template = btn.dataset.sectionTemplate;
                    if (sectionTemplates[template]) {
                        sectionTemplates[template].forEach(sectionTitle => {
                            addCustomSection(sectionTitle);
                        });
                        showNotification(`Template ${template} appliqu√© !`, "success");
                    }
                });
            });

            // AI suggest sections
            document.getElementById('ai-suggest-sections-btn')?.addEventListener('click', async () => {
                const currentCV = getCurrentCVData();
                
                const prompt = `Analysez ce CV et sugg√©rez 3-5 sections personnalis√©es qui pourraient le renforcer :

${JSON.stringify(currentCV)}

Consid√©rez le secteur, l'exp√©rience et les objectifs de carri√®re.
Retournez une liste de titres de sections avec des emojis.`;

                const result = await callGeminiAPI(prompt);
                if (result) {
                    const sections = result.split('\n').filter(s => s.trim());
                    sections.forEach(section => {
                        addCustomSection(section.trim());
                    });
                    showNotification("Sections sugg√©r√©es ajout√©es !", "success");
                }
            });

            // Import/Export sections
            document.getElementById('export-sections-btn')?.addEventListener('click', () => {
                const customSections = Array.from(document.querySelectorAll('[data-section-id]'))
                    .map(section => ({
                        id: section.dataset.sectionId,
                        title: section.querySelector('span[contenteditable]').textContent,
                        content: section.innerHTML
                    }));

                const dataStr = JSON.stringify(customSections, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'cv-sections.json';
                link.click();
                URL.revokeObjectURL(url);
                
                showNotification("Sections export√©es !", "success");
            });

            document.getElementById('import-sections-btn')?.addEventListener('click', () => {
                document.getElementById('import-sections-file').click();
            });

            document.getElementById('import-sections-file')?.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        try {
                            const sections = JSON.parse(event.target.result);
                            sections.forEach(section => {
                                addCustomSection(section.title);
                            });
                            showNotification("Sections import√©es !", "success");
                        } catch (error) {
                            showNotification("Erreur lors de l'import des sections.", "error");
                        }
                    };
                    reader.readAsText(file);
                }
            });

            // Helper functions for skill analysis
            function showSkillAnalysisModal(analysis) {
                const modal = document.getElementById('skill-analysis-modal');
                const container = document.getElementById('skill-analysis-container');
                
                container.innerHTML = `
                    <div class="text-center mb-6">
                        <div class="score-circle" style="width: 100px; height: 100px; border: 6px solid #e5e7eb; border-top-color: #3b82f6; margin: 0 auto;">
                            <span class="text-2xl font-bold">${analysis.match_percentage}%</span>
                        </div>
                        <p class="mt-2 text-gray-600">Correspondance avec l'offre</p>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-6">
                        <div>
                            <h4 class="font-bold text-green-600 mb-3">‚úÖ Comp√©tences correspondantes</h4>
                            <ul class="list-disc list-inside space-y-1">
                                ${analysis.matching_skills?.map(skill => `<li class="text-sm">${skill}</li>`).join('') || '<li>Aucune</li>'}
                            </ul>
                        </div>
                        
                        <div>
                            <h4 class="font-bold text-red-600 mb-3">‚ùå Comp√©tences manquantes</h4>
                            <ul class="list-disc list-inside space-y-1">
                                ${analysis.missing_skills?.map(skill => `<li class="text-sm">${skill}</li>`).join('') || '<li>Aucune</li>'}
                            </ul>
                        </div>
                    </div>
                    
                    <div class="mt-6 p-4 bg-blue-50 rounded-lg">
                        <h4 class="font-bold text-blue-800 mb-2">üí° Recommandations</h4>
                        <p class="text-sm text-blue-700">${analysis.recommendations}</p>
                    </div>
                `;
                
                modal.classList.add('active');
            }

            controls.aiSynthesizeSkillsBtn.addEventListener('click', async () => {
                if (!controls.competences.value.trim()) {
                    showNotification("Aucune comp√©tence √† synth√©tiser.", "error");
                    return;
                }

                const prompt = `Analysez et r√©organisez ces comp√©tences par cat√©gories logiques :
${controls.competences.value}

Format de sortie : Chaque cat√©gorie sur une ligne avec format "Cat√©gorie: comp√©tence1, comp√©tence2, etc."`;

                const result = await callGeminiAPI(prompt);
                if (result) {
                    controls.competences.value = result;
                    updatePreview('form');
                    showNotification("Comp√©tences synth√©tis√©es et organis√©es !", "success");
                }
            });

            controls.aiColorBtn.addEventListener('click', async () => {
                const primaryColor = controls.primaryColorPicker.value;
                const prompt = `Donnez une couleur secondaire qui s'harmonise bien avec cette couleur primaire ${primaryColor}. R√©pondez seulement avec le code hexad√©cimal (ex: #123456).`;

                const result = await callGeminiAPI(prompt);
                if (result && result.match(/#[0-9A-Fa-f]{6}/)) {
                    controls.secondaryColorPicker.value = result.trim();
                    updateAllStyles();
                    showNotification("Couleur sugg√©r√©e appliqu√©e !", "success");
                }
            });

            controls.addExperienceBtn.addEventListener('click', () => {
                createDynamicItem(controls.experienceList, [
                    { key: 'title', placeholder: 'Titre du poste', type: 'input' },
                    { key: 'meta', placeholder: 'Entreprise - P√©riode', type: 'input' },
                    { key: 'desc', placeholder: 'Description', type: 'textarea' }
                ]);
            });

            // Fix ID for add-experience button
            document.getElementById('add-experience')?.addEventListener('click', () => {
                createDynamicItem(controls.experienceList, [
                    { key: 'title', placeholder: 'Titre du poste', type: 'input' },
                    { key: 'meta', placeholder: 'Entreprise - P√©riode', type: 'input' },
                    { key: 'desc', placeholder: 'Description', type: 'textarea' }
                ]);
            });

            // Fix ID for add-formation button  
            document.getElementById('add-formation')?.addEventListener('click', () => {
                createDynamicItem(controls.formationList, [
                    { key: 'title', placeholder: 'Dipl√¥me/Formation', type: 'input' },
                    { key: 'meta', placeholder: '√âcole - Ann√©e', type: 'input' },
                    { key: 'desc', placeholder: 'Description (optionnel)', type: 'textarea' }
                ]);
            });

            controls.addFormationBtn.addEventListener('click', () => {
                createDynamicItem(controls.formationList, [
                    { key: 'title', placeholder: 'Dipl√¥me/Formation', type: 'input' },
                    { key: 'meta', placeholder: '√âcole - Ann√©e', type: 'input' },
                    { key: 'desc', placeholder: 'Description (optionnel)', type: 'textarea' }
                ]);
            });

            // Skills management
            controls.addSkillLevelBtn.addEventListener('click', () => {
                createSkillLevelItem();
            });

            // Custom sections
            controls.addSectionBtn.addEventListener('click', () => {
                const suggestionSelect = controls.sectionSuggestionSelect;
                const customInput = controls.newSectionTitleInput;
                
                let title = suggestionSelect.value || customInput.value.trim();
                if (!title) {
                    showNotification("Veuillez s√©lectionner ou saisir un titre de section.", "error");
                    return;
                }
                
                // Clean the title to remove emoji for icon selection
                const cleanTitle = title.replace(/[^\w\s]/gi, '').trim();
                
                addCustomSection(title);
                suggestionSelect.value = '';
                customInput.value = '';
                showNotification("Section ajout√©e !", "success");
            });

            // Banner controls
            controls.fixBannerTopBtn.addEventListener('click', () => {
                moveBannerTo('top');
            });

            controls.fixBannerBottomBtn.addEventListener('click', () => {
                moveBannerTo('bottom');
            });

            controls.modularBannerBtn.addEventListener('click', () => {
                moveBannerTo('modular');
            });

            controls.resetRecruiterBtn.addEventListener('click', () => {
                setDefaultRecruiterInfo();
                updatePreview('form');
                showNotification("Informations recruteur r√©initialis√©es.", "success");
            });

            controls.removeBannerBgBtn.addEventListener('click', () => {
                preview.bannerBgImg.src = '';
                preview.bannerBgImg.style.display = 'none';
                showNotification("Image de fond supprim√©e.", "success");
            });

            controls.randomizeBannerStyleBtn.addEventListener('click', () => {
                // Random style
                const styles = ['banner-style-modern', 'banner-style-elegant', 'banner-style-discret', 'banner-style-carte', 'banner-style-degrade', 'banner-style-premium'];
                const randomStyle = styles[Math.floor(Math.random() * styles.length)];
                controls.bannerStyleSelect.value = randomStyle;

                // Random alignment
                const alignments = ['left', 'center', 'right'];
                const randomAlign = alignments[Math.floor(Math.random() * alignments.length)];
                document.querySelector(`[data-banner-align="${randomAlign}"]`).click();

                // Random colors
                const colors = ['#2563eb', '#dc2626', '#059669', '#7c3aed', '#ea580c', '#0891b2'];
                controls.bannerNomColor.value = colors[Math.floor(Math.random() * colors.length)];
                controls.bannerPosteColor.value = colors[Math.floor(Math.random() * colors.length)];
                controls.bannerContactColor.value = colors[Math.floor(Math.random() * colors.length)];

                updateAllStyles();
                updatePreview('banner-style');
                showNotification("Style al√©atoire appliqu√© !", "success");
            });

            // Add page button
            controls.addPageBtn.addEventListener('click', addNewPage);

            // Banner background controls
            controls.bannerBgImage.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        preview.bannerBgImg.src = e.target.result;
                        preview.bannerBgImg.style.display = 'block';
                        updateBannerBackground();
                    };
                    reader.readAsDataURL(file);
                }
            });

            controls.bannerBgOpacity.addEventListener('input', updateBannerBackground);
            controls.bannerBgBlur.addEventListener('input', updateBannerBackground);
            controls.bannerBgGrayscale.addEventListener('change', updateBannerBackground);

            // Banner image upload
            controls.bannerImage.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        preview.bannerImg.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            });

            // Undo/Redo buttons
            controls.undoBtn.addEventListener('click', undo);
            controls.redoBtn.addEventListener('click', redo);

            // Tab navigation
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    // Remove active class from all tabs and panels
                    document.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('border-blue-500', 'text-blue-600'));
                    document.querySelectorAll('.tab-panel').forEach(p => p.classList.add('hidden'));
                    
                    // Add active class to clicked tab
                    btn.classList.add('border-blue-500', 'text-blue-600');
                    
                    // Show corresponding panel
                    const targetPanel = document.querySelector(btn.dataset.target);
                    if (targetPanel) {
                        targetPanel.classList.remove('hidden');
                    }
                });
            });

            // Sliders
            Object.values(sliders).forEach(config => {
                config.el.addEventListener('input', () => {
                    const value = config.el.value;
                    config.valueEl.textContent = value;
                    document.documentElement.style.setProperty(config.property, `${value}${config.unit}`);
                    checkAllPagesOverflow();
                });
            });

            // Banner style controls
            Object.values(bannerStyleControls).forEach(config => {
                config.el.addEventListener(config.event, () => {
                    if (config.valueEl) {
                        config.valueEl.textContent = config.el.value;
                    }
                    if (config.toggle) {
                        config.el.classList.toggle('active');
                    }
                    updatePreview('banner-style');
                });
            });

            // Color pickers
            controls.primaryColorPicker.addEventListener('input', updateAllStyles);
            controls.secondaryColorPicker.addEventListener('input', updateAllStyles);
            controls.bodyTextColorPicker.addEventListener('input', updateAllStyles);

            // Font selectors
            controls.fontFamilyH1Select.addEventListener('change', updateAllStyles);
            controls.fontFamilyH2Select.addEventListener('change', updateAllStyles);
            controls.fontFamilyBodySelect.addEventListener('change', updateAllStyles);

            // Layout buttons
            document.querySelectorAll('.layout-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.layout-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    const layout = btn.dataset.layout;
                    document.querySelectorAll('.cv-body-container').forEach(container => {
                        container.className = `cv-body-container ${layout}`;
                    });
                    
                    setupAllResizers();
                    checkAllPagesOverflow();
                });
            });

            // Skill style buttons
            document.querySelectorAll('.skill-style-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.skill-style-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    const style = btn.dataset.skillStyle;
                    if (style === 'levels') {
                        controls.skillsTextControls.classList.add('hidden');
                        controls.skillsLevelControls.classList.remove('hidden');
                    } else {
                        controls.skillsTextControls.classList.remove('hidden');
                        controls.skillsLevelControls.classList.add('hidden');
                    }
                    
                    updatePreview('form');
                });
            });

            // Gauge style buttons
            document.querySelectorAll('.gauge-style-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.gauge-style-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    updatePreview('form');
                });
            });

            // Section title style buttons
            document.querySelectorAll('.section-title-style-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.section-title-style-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    updateAllStyles();
                });
            });

            // Theme buttons
            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.theme-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    const theme = btn.dataset.theme;
                    if (themes[theme]) {
                        controls.primaryColorPicker.value = themes[theme].primaryColor;
                        controls.secondaryColorPicker.value = themes[theme].secondaryColor;
                        controls.bodyTextColorPicker.value = themes[theme].bodyTextColor;
                        controls.fontFamilyH1Select.value = themes[theme].fontH1;
                        controls.fontFamilyH2Select.value = themes[theme].fontH2;
                        controls.fontFamilyBodySelect.value = themes[theme].fontBody;
                        updateAllStyles();
                        showNotification(`Th√®me ${theme} appliqu√© !`, "success");
                    }
                });
            });

            // Random theme button
            document.getElementById('random-theme-btn')?.addEventListener('click', () => {
                const themeNames = Object.keys(themes);
                const randomTheme = themeNames[Math.floor(Math.random() * themeNames.length)];
                document.querySelector(`[data-theme="${randomTheme}"]`).click();
            });

            // Color palette buttons
            document.querySelectorAll('.color-palette-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const colors = JSON.parse(btn.dataset.colors);
                    controls.primaryColorPicker.value = colors[0];
                    controls.secondaryColorPicker.value = colors[1];
                    controls.bodyTextColorPicker.value = colors[2];
                    updateAllStyles();
                    showNotification("Palette de couleurs appliqu√©e !", "success");
                });
            });

            // AI font suggestions
            document.getElementById('ai-suggest-fonts-btn')?.addEventListener('click', async () => {
                const currentCV = getCurrentCVData();
                
                const prompt = `Sugg√©rez 3 combinaisons de polices harmonieuses pour ce CV :
                
Secteur : ${currentCV.poste}
Style souhait√© : Professionnel

Retournez au format JSON :
{
    "suggestions": [
        {"name": "Combinaison 1", "h1": "font-family", "h2": "font-family", "body": "font-family"},
        {"name": "Combinaison 2", "h1": "font-family", "h2": "font-family", "body": "font-family"},
        {"name": "Combinaison 3", "h1": "font-family", "h2": "font-family", "body": "font-family"}
    ]
}`;

                const result = await callGeminiAPI(prompt);
                if (result && result.suggestions) {
                    showFontSuggestions(result.suggestions);
                }
            });

            // Visual effects
            document.getElementById('cv-shadow-intensity')?.addEventListener('input', (e) => {
                const value = e.target.value;
                document.getElementById('cv-shadow-intensity-value').textContent = value;
                document.querySelectorAll('.a4-page').forEach(page => {
                    page.style.boxShadow = `0 ${value}px ${value * 2}px rgba(0,0,0,0.15)`;
                });
            });

            document.getElementById('section-border-radius')?.addEventListener('input', (e) => {
                const value = e.target.value;
                document.getElementById('section-border-radius-value').textContent = value;
                document.documentElement.style.setProperty('--section-border-radius', `${value}px`);
            });

            document.getElementById('enable-gradients')?.addEventListener('change', (e) => {
                if (e.target.checked) {
                    document.documentElement.style.setProperty('--title-background', 'linear-gradient(45deg, var(--primary-color), var(--secondary-color))');
                } else {
                    document.documentElement.style.setProperty('--title-background', 'var(--primary-color)');
                }
            });

            document.getElementById('enable-animations')?.addEventListener('change', (e) => {
                document.querySelectorAll('.cv-module').forEach(module => {
                    if (e.target.checked) {
                        module.classList.add('animate');
                    } else {
                        module.classList.remove('animate');
                    }
                });
            });

            document.getElementById('apply-glassmorphism-btn')?.addEventListener('click', () => {
                document.querySelectorAll('.cv-module').forEach(module => {
                    module.classList.toggle('glassmorphism');
                });
                showNotification("Effet glassmorphism appliqu√© !", "success");
            });

            // New layout options
            document.querySelectorAll('.layout-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.layout-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    const layout = btn.dataset.layout;
                    document.querySelectorAll('.cv-body-container').forEach(container => {
                        container.className = `cv-body-container ${layout}`;
                        
                        // Add third column for 3-column layouts
                        if (layout === 'layout-3-col' || layout.includes('asymmetric')) {
                            if (!container.querySelector('#cv-col-1-3')) {
                                const col3 = document.createElement('div');
                                col3.id = 'cv-col-1-3';
                                col3.className = 'cv-column';
                                container.appendChild(col3);
                            }
                        } else {
                            // Remove third column if exists
                            const col3 = container.querySelector('#cv-col-1-3');
                            if (col3) col3.remove();
                        }
                    });
                    
                    setupAllResizers();
                    checkAllPagesOverflow();
                    showNotification("Layout appliqu√© !", "success");
                });
            });

            // AI layout suggestion
            document.getElementById('ai-suggest-layout-btn')?.addEventListener('click', async () => {
                const currentCV = getCurrentCVData();
                
                const prompt = `Analysez ce CV et sugg√©rez le meilleur layout :

${JSON.stringify(currentCV)}

Consid√©rez :
- Quantit√© de contenu
- Type de poste
- Secteur d'activit√©

Retournez : "1-col", "2-col-33-67", "2-col-50-50", "2-col-67-33", "3-col", ou "asymmetric-1"`;

                const result = await callGeminiAPI(prompt);
                if (result) {
                    const layout = result.trim().replace('-', '-layout-');
                    const btn = document.querySelector(`[data-layout="layout-${result.trim()}"]`);
                    if (btn) {
                        btn.click();
                        showNotification(`Layout "${result}" sugg√©r√© et appliqu√© !`, "success");
                    }
                }
            });

            // Advanced layout features
            document.getElementById('enable-zebra-sections')?.addEventListener('change', (e) => {
                if (e.target.checked) {
                    document.body.classList.add('zebra-sections');
                } else {
                    document.body.classList.remove('zebra-sections');
                }
            });

            document.getElementById('auto-optimize-layout-btn')?.addEventListener('click', async () => {
                const currentCV = getCurrentCVData();
                
                showLoader("Optimisation automatique du layout...");
                
                const prompt = `Optimisez automatiquement la mise en page de ce CV :

${JSON.stringify(currentCV)}

Retournez les param√®tres optimaux au format JSON :
{
    "layout": "2-col-33-67",
    "font_sizes": {"h1": 36, "h2": 18, "p": 9.5},
    "spacings": {"module": 1.2, "item": 0.4, "paragraph": 0.3},
    "recommendations": "explications des choix"
}`;

                const result = await callGeminiAPI(prompt);
                if (result) {
                    hideLoader();
                    applyLayoutOptimization(result);
                    showNotification("Layout auto-optimis√© !", "success");
                } else {
                    hideLoader();
                }
            });

            // Helper functions for layout optimization
            function applyLayoutOptimization(optimization) {
                // Apply layout
                if (optimization.layout) {
                    const layoutBtn = document.querySelector(`[data-layout="layout-${optimization.layout}"]`);
                    if (layoutBtn) layoutBtn.click();
                }
                
                // Apply font sizes
                if (optimization.font_sizes) {
                    const sizes = optimization.font_sizes;
                    if (sizes.h1) {
                        document.getElementById('font-size-h1').value = sizes.h1;
                        document.getElementById('font-size-h1-value').textContent = sizes.h1;
                        document.documentElement.style.setProperty('--font-size-h1', `${sizes.h1}pt`);
                    }
                    if (sizes.h2) {
                        document.getElementById('font-size-h2').value = sizes.h2;
                        document.getElementById('font-size-h2-value').textContent = sizes.h2;
                        document.documentElement.style.setProperty('--font-size-h2', `${sizes.h2}pt`);
                    }
                    if (sizes.p) {
                        document.getElementById('font-size-p').value = sizes.p;
                        document.getElementById('font-size-p-value').textContent = sizes.p;
                        document.documentElement.style.setProperty('--font-size-p', `${sizes.p}pt`);
                    }
                }
                
                // Apply spacings
                if (optimization.spacings) {
                    const spacings = optimization.spacings;
                    if (spacings.module) {
                        document.getElementById('module-spacing').value = spacings.module;
                        document.getElementById('module-spacing-value').textContent = spacings.module;
                        document.documentElement.style.setProperty('--module-spacing', `${spacings.module}rem`);
                    }
                    if (spacings.item) {
                        document.getElementById('item-spacing').value = spacings.item;
                        document.getElementById('item-spacing-value').textContent = spacings.item;
                        document.documentElement.style.setProperty('--item-spacing', `${spacings.item}rem`);
                    }
                    if (spacings.paragraph) {
                        document.getElementById('paragraph-spacing').value = spacings.paragraph;
                        document.getElementById('paragraph-spacing-value').textContent = spacings.paragraph;
                        document.documentElement.style.setProperty('--paragraph-spacing', `${spacings.paragraph}rem`);
                    }
                }

                if (optimization.recommendations) {
                    showNotification(optimization.recommendations, "info", 5000);
                }
            }

            // Banner alignment buttons
            document.querySelectorAll('.banner-align-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.banner-align-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    updateAllStyles();
                });
            });

            // Logo size buttons
            document.querySelectorAll('.logo-size-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.logo-size-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    const size = btn.dataset.logoSize;
                    preview.bannerImg.className = `logo-${size}`;
                });
            });

            // Banner invert button
            controls.bannerInvertBtn.addEventListener('click', () => {
                controls.bannerInvertBtn.classList.toggle('active');
                updateAllStyles();
            });

            // Form inputs that update preview
            document.querySelectorAll('.cv-input, .banner-input').forEach(input => {
                input.addEventListener('input', () => updatePreview('form'));
            });

            // Modal event handlers
            document.getElementById('close-variants-modal')?.addEventListener('click', () => {
                document.getElementById('cv-variants-modal').classList.remove('active');
            });

            document.getElementById('close-translation-modal')?.addEventListener('click', () => {
                document.getElementById('translation-modal').classList.remove('active');
            });

            document.getElementById('close-score-modal')?.addEventListener('click', () => {
                document.getElementById('cv-score-modal').classList.remove('active');
            });

            document.getElementById('close-score-modal-btn')?.addEventListener('click', () => {
                document.getElementById('cv-score-modal').classList.remove('active');
            });

            document.getElementById('close-improvements-modal')?.addEventListener('click', () => {
                document.getElementById('improvements-modal').classList.remove('active');
            });

            document.getElementById('close-improvements-modal-btn')?.addEventListener('click', () => {
                document.getElementById('improvements-modal').classList.remove('active');
            });

            document.getElementById('close-skill-analysis-modal')?.addEventListener('click', () => {
                document.getElementById('skill-analysis-modal').classList.remove('active');
            });

            document.getElementById('close-skill-analysis-modal-btn')?.addEventListener('click', () => {
                document.getElementById('skill-analysis-modal').classList.remove('active');
            });

            // Translation functionality
            document.getElementById('start-translation-btn')?.addEventListener('click', async () => {
                const targetLang = document.getElementById('target-language-select').value;
                const currentCV = getCurrentCVData();
                
                showLoader("Traduction en cours...");
                
                const prompt = `Traduisez ce CV en ${targetLang} en conservant le professionnalisme et l'impact :

${JSON.stringify(currentCV)}

Retournez le CV traduit au m√™me format JSON.`;

                const result = await callGeminiAPI(prompt);
                if (result) {
                    hideLoader();
                    applyTranslatedCV(result);
                    document.getElementById('translation-modal').classList.remove('active');
                    showNotification("CV traduit avec succ√®s !", "success");
                } else {
                    hideLoader();
                }
            });

            document.getElementById('cancel-translation-btn')?.addEventListener('click', () => {
                document.getElementById('translation-modal').classList.remove('active');
            });

            // Helper functions for new features
            function addMottoToCV(motto) {
                const headerModule = document.getElementById('header-module');
                if (headerModule) {
                    const mottoDiv = document.createElement('div');
                    mottoDiv.className = 'motto-display';
                    mottoDiv.innerHTML = `<p>"${motto}"</p>`;
                    headerModule.appendChild(mottoDiv);
                }
            }

            function highlightKeywordsInCV(keywords) {
                const keywordList = keywords.split(',').map(k => k.trim());
                const textElements = document.querySelectorAll('#cv-description-preview, #cv-experience-preview, #cv-formation-preview');
                
                textElements.forEach(element => {
                    let html = element.innerHTML;
                    keywordList.forEach(keyword => {
                        const regex = new RegExp(`\\b(${keyword})\\b`, 'gi');
                        html = html.replace(regex, '<span class="keyword-highlight">$1</span>');
                    });
                    element.innerHTML = html;
                });
            }

            function applyTranslatedCV(translatedCV) {
                try {
                    const cv = typeof translatedCV === 'string' ? JSON.parse(translatedCV) : translatedCV;
                    
                    if (cv.nom) controls.nom.value = cv.nom;
                    if (cv.prenom) controls.prenom.value = cv.prenom;
                    if (cv.poste) controls.poste.value = cv.poste;
                    if (cv.description) controls.description.value = cv.description;
                    if (cv.competences) controls.competences.value = cv.competences;
                    
                    // Apply experiences
                    if (cv.experiences) {
                        controls.experienceList.innerHTML = '';
                        cv.experiences.forEach(exp => {
                            createDynamicItem(controls.experienceList, [
                                { key: 'title', placeholder: 'Titre du poste', type: 'input' },
                                { key: 'meta', placeholder: 'Entreprise - P√©riode', type: 'input' },
                                { key: 'desc', placeholder: 'Description', type: 'textarea' }
                            ], exp);
                        });
                    }
                    
                    // Apply formations
                    if (cv.formations) {
                        controls.formationList.innerHTML = '';
                        cv.formations.forEach(form => {
                            createDynamicItem(controls.formationList, [
                                { key: 'title', placeholder: 'Dipl√¥me/Formation', type: 'input' },
                                { key: 'meta', placeholder: '√âcole - Ann√©e', type: 'input' },
                                { key: 'desc', placeholder: 'Description (optionnel)', type: 'textarea' }
                            ], form);
                        });
                    }
                    
                    updatePreview('form');
                } catch (error) {
                    console.error('Error applying translated CV:', error);
                    showNotification("Erreur lors de l'application de la traduction.", "error");
                }
            }

            function showFontSuggestions(suggestions) {
                const container = document.createElement('div');
                container.className = 'font-suggestions mt-4 p-4 bg-blue-50 rounded-lg';
                container.innerHTML = `
                    <h4 class="font-bold mb-3">üé® Suggestions de polices IA</h4>
                    <div class="space-y-2">
                        ${suggestions.map((suggestion, index) => `
                            <button class="font-suggestion-btn w-full text-left p-2 border rounded hover:bg-white" 
                                    data-h1="${suggestion.h1}" data-h2="${suggestion.h2}" data-body="${suggestion.body}">
                                <strong>${suggestion.name}</strong><br>
                                <small>H1: ${suggestion.h1} | H2: ${suggestion.h2} | Body: ${suggestion.body}</small>
                            </button>
                        `).join('')}
                    </div>
                `;

                // Insert suggestions after font controls
                const fontSection = document.querySelector('#completion-styles-fonts').closest('.control-group');
                fontSection.appendChild(container);

                // Add event listeners for font suggestions
                container.querySelectorAll('.font-suggestion-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        controls.fontFamilyH1Select.value = btn.dataset.h1;
                        controls.fontFamilyH2Select.value = btn.dataset.h2;
                        controls.fontFamilyBodySelect.value = btn.dataset.body;
                        updateAllStyles();
                        container.remove();
                        showNotification("Combinaison de polices appliqu√©e !", "success");
                    });
                });

                // Auto-remove after 10 seconds
                setTimeout(() => {
                    if (container.parentNode) container.remove();
                }, 10000);
            }

            // Enhanced progress tracking
            function updateProgressBar() {
                const checkboxes = document.querySelectorAll('.completion-checkbox');
                const completed = document.querySelectorAll('.completion-checkbox:checked').length;
                const total = checkboxes.length;
                const percentage = total > 0 ? (completed / total) * 100 : 0;
                
                const progressBar = document.getElementById('progress-bar');
                const progressText = document.getElementById('progress-text');
                
                if (progressBar) {
                    progressBar.style.width = `${percentage}%`;
                    
                    // Change color based on progress
                    if (percentage < 30) {
                        progressBar.className = 'bg-red-500 h-2.5 rounded-full transition-all duration-300';
                    } else if (percentage < 70) {
                        progressBar.className = 'bg-yellow-500 h-2.5 rounded-full transition-all duration-300';
                    } else {
                        progressBar.className = 'bg-green-500 h-2.5 rounded-full transition-all duration-300';
                    }
                }
                
                if (progressText) {
                    progressText.textContent = `${completed}/${total} sections compl√©t√©es`;
                }

                // Show celebration when 100% complete
                if (percentage === 100) {
                    setTimeout(() => {
                        showNotification("üéâ F√©licitations ! Votre CV est complet !", "success", 5000);
                    }, 500);
                }
            }

            document.querySelectorAll('.completion-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', updateProgressBar);
            });

            // Dynamic event handlers for preview interactions
            document.addEventListener('click', (e) => {
                // AI action buttons
                if (e.target.closest('.ai-action-btn[data-action]')) {
                    const action = e.target.closest('.ai-action-btn[data-action]').dataset.action;
                    handleAIAction(action, e.target);
                }
                
                // Toggle visibility buttons
                if (e.target.closest('.toggle-visibility-btn')) {
                    const module = e.target.closest('.cv-module');
                    if (module) {
                        module.classList.toggle('section-hidden');
                        const icon = e.target.closest('.toggle-visibility-btn').querySelector('i');
                        icon.classList.toggle('fa-eye');
                        icon.classList.toggle('fa-eye-slash');
                    }
                }
                
                // Delete buttons
                if (e.target.closest('.remove-dynamic-item-btn, .delete-block-btn')) {
                    const item = e.target.closest('.p-2, .dynamic-preview-item, .dynamic-item-container');
                    if (item) {
                        item.remove();
                        updatePreview('form');
                    }
                }
                
                // Remove section buttons
                if (e.target.closest('.remove-section-btn')) {
                    const section = e.target.closest('[data-section-id]');
                    if (section) {
                        const sectionId = section.dataset.sectionId;
                        section.remove();
                        document.getElementById(sectionId)?.remove();
                        updatePreview('form');
                    }
                }
                
                // Add line buttons in preview
                if (e.target.closest('.add-line-preview-btn')) {
                    const btn = e.target.closest('.add-line-preview-btn');
                    const type = btn.dataset.type;
                    const index = parseInt(btn.dataset.index);
                    const container = type === 'experience' ? controls.experienceList : controls.formationList;
                    
                    const fields = type === 'experience' ? [
                        { key: 'title', placeholder: 'Titre du poste', type: 'input' },
                        { key: 'meta', placeholder: 'Entreprise - P√©riode', type: 'input' },
                        { key: 'desc', placeholder: 'Description', type: 'textarea' }
                    ] : [
                        { key: 'title', placeholder: 'Dipl√¥me/Formation', type: 'input' },
                        { key: 'meta', placeholder: '√âcole - Ann√©e', type: 'input' },
                        { key: 'desc', placeholder: 'Description (optionnel)', type: 'textarea' }
                    ];
                    
                    createDynamicItem(container, fields, {}, index);
                }
                
                // Remove skill buttons
                if (e.target.closest('.delete-skill-btn')) {
                    const skillItem = e.target.closest('.skill-item');
                    if (skillItem) {
                        skillItem.remove();
                        syncFormFromPreview(document.getElementById('cv-competences-preview'));
                    }
                }
                
                // Remove skill level buttons
                if (e.target.closest('.remove-skill-level-btn')) {
                    const skillLevel = e.target.closest('.skill-level-item');
                    if (skillLevel) {
                        skillLevel.remove();
                        updatePreview('form');
                    }
                }
                
                // Page remove buttons
                if (e.target.closest('.remove-page-btn')) {
                    const pageContainer = e.target.closest('.a4-page-container');
                    if (pageContainer && document.querySelectorAll('.a4-page-container').length > 1) {
                        pageContainer.remove();
                        checkAllPagesOverflow();
                    }
                }
            });

            // Input event for skill level sliders
            document.addEventListener('input', (e) => {
                if (e.target.classList.contains('skill-level-input')) {
                    const valueSpan = e.target.nextElementSibling;
                    if (valueSpan) {
                        valueSpan.textContent = `${e.target.value}/5`;
                    }
                    updatePreview('form');
                }
            });

            // Contenteditable sync
            document.addEventListener('input', (e) => {
                if (e.target.hasAttribute('contenteditable') && e.target.contentEditable === 'true') {
                    syncFormFromPreview(e.target);
                }
            });

            // Handle AI actions
            async function handleAIAction(action, button) {
                switch (action) {
                    case 'rewrite-profile':
                        if (!controls.description.value.trim()) {
                            showNotification("Veuillez saisir une description de profil d'abord.", "error");
                            return;
                        }
                        const profilePrompt = `R√©√©crivez cette description de profil professionnel pour la rendre plus percutante et professionnelle (maximum 100 mots) :
${controls.description.value}`;
                        const profileResult = await callGeminiAPI(profilePrompt);
                        if (profileResult) {
                            controls.description.value = profileResult;
                            updatePreview('form');
                            showNotification("Profil r√©√©crit !", "success");
                        }
                        break;
                        
                    case 'summarize-experience':
                        const experiences = getDynamicData(controls.experienceList);
                        if (experiences.length === 0) {
                            showNotification("Aucune exp√©rience √† synth√©tiser.", "error");
                            return;
                        }
                        const expText = experiences.map(exp => `${exp.title} - ${exp.meta}: ${exp.desc}`).join('\n');
                        const expPrompt = `Synth√©tisez ces exp√©riences professionnelles en maximum 5 lignes :
${expText}`;
                        const expResult = await callGeminiAPI(expPrompt);
                        if (expResult) {
                            controls.description.value = expResult;
                            updatePreview('form');
                            showNotification("Exp√©riences synth√©tis√©es !", "success");
                        }
                        break;
                        
                    case 'rewrite-formation':
                        const formations = getDynamicData(controls.formationList);
                        if (formations.length === 0) {
                            showNotification("Aucune formation √† am√©liorer.", "error");
                            return;
                        }
                        const formText = formations.map(form => `${form.title} - ${form.meta}`).join('\n');
                        const formPrompt = `Am√©liorez la pr√©sentation de ces formations pour un CV professionnel :
${formText}`;
                        const formResult = await callGeminiAPI(formPrompt);
                        if (formResult) {
                            // Parse and update formations
                            const lines = formResult.split('\n').filter(line => line.trim());
                            controls.formationList.innerHTML = '';
                            lines.forEach(line => {
                                const parts = line.split(' - ');
                                createDynamicItem(controls.formationList, [
                                    { key: 'title', placeholder: 'Dipl√¥me/Formation', type: 'input' },
                                    { key: 'meta', placeholder: '√âcole - Ann√©e', type: 'input' },
                                    { key: 'desc', placeholder: 'Description (optionnel)', type: 'textarea' }
                                ], { title: parts[0] || '', meta: parts[1] || '', desc: '' });
                            });
                            updatePreview('form');
                            showNotification("Formations am√©lior√©es !", "success");
                        }
                        break;
                        
                    case 'rewrite-skills':
                        if (!controls.competences.value.trim()) {
                            showNotification("Aucune comp√©tence √† am√©liorer.", "error");
                            return;
                        }
                        const skillsPrompt = `Am√©liorez et r√©organisez ces comp√©tences pour un CV professionnel, en les regroupant par cat√©gories :
${controls.competences.value}`;
                        const skillsResult = await callGeminiAPI(skillsPrompt);
                        if (skillsResult) {
                            controls.competences.value = skillsResult;
                            updatePreview('form');
                            showNotification("Comp√©tences am√©lior√©es !", "success");
                        }
                        break;
                }
            }

            // Alias function for backward compatibility
            function populateFontSelects() {
                populateFontSelectors();
            }

            // Initialize everything
            reinitializePreviewSelectors(); // Initialize preview selectors first
            populateFontSelects();
            populateIconPicker();
            setDefaultRecruiterInfo();
            updatePreview('form');
            updateAllStyles();
            
            // Initialize drag & drop for all pages
            initializeAllSortable();
            setupAllResizers();
            
        });
    </script>

    <script>
        // Advanced AI Chat System JavaScript
        class AdvancedAIChat {
            constructor() {
                this.isOpen = false;
                this.isDragging = false;
                this.dragOffset = { x: 0, y: 0 };
                this.init();
            }

            init() {
                this.floatBtn = document.getElementById('ai-chat-float-btn');
                this.chatContainer = document.getElementById('ai-chat-container');
                this.closeBtn = document.getElementById('ai-chat-close-btn');
                this.header = document.getElementById('ai-chat-header');
                this.messagesContainer = document.getElementById('ai-chat-messages');
                this.input = document.getElementById('ai-chat-input');
                this.sendBtn = document.getElementById('ai-chat-send-btn');
                this.voiceBtn = document.getElementById('ai-voice-btn');
                this.smartSuggestBtn = document.getElementById('ai-smart-suggest-btn');
                this.quickFixBtn = document.getElementById('ai-quick-fix-btn');

                this.setupEventListeners();
                this.loadChatPosition();
                this.initializeVoiceRecognition();
            }

            setupEventListeners() {
                // Float button drag functionality
                this.floatBtn.addEventListener('mousedown', this.startDragFloatBtn.bind(this));
                this.floatBtn.addEventListener('click', this.toggleChat.bind(this));
                
                // Chat window drag functionality
                this.header.addEventListener('mousedown', this.startDragChat.bind(this));
                
                // Close button
                this.closeBtn.addEventListener('click', this.closeChat.bind(this));
                
                // Send message functionality
                this.sendBtn.addEventListener('click', this.sendMessage.bind(this));
                this.input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });

                // Voice recognition
                this.voiceBtn.addEventListener('click', this.toggleVoiceRecognition.bind(this));
                
                // Smart suggestions
                this.smartSuggestBtn.addEventListener('click', this.generateSmartSuggestions.bind(this));
                
                // Quick fix
                this.quickFixBtn.addEventListener('click', this.performQuickFix.bind(this));

                // Auto-resize textarea
                this.input.addEventListener('input', this.autoResizeTextarea.bind(this));

                // Suggestion chips
                document.addEventListener('click', (e) => {
                    if (e.target.classList.contains('suggestion-chip')) {
                        this.input.value = e.target.dataset.suggestion;
                        this.sendMessage();
                    }
                });

                // Global mouse events for dragging
                document.addEventListener('mousemove', this.handleDrag.bind(this));
                document.addEventListener('mouseup', this.stopDrag.bind(this));
            }

            startDragFloatBtn(e) {
                this.isDragging = true;
                this.dragTarget = 'float';
                this.floatBtn.classList.add('dragging');
                
                const rect = this.floatBtn.getBoundingClientRect();
                this.dragOffset = {
                    x: e.clientX - rect.left,
                    y: e.clientY - rect.top
                };
                e.preventDefault();
            }

            startDragChat(e) {
                this.isDragging = true;
                this.dragTarget = 'chat';
                
                const rect = this.chatContainer.getBoundingClientRect();
                this.dragOffset = {
                    x: e.clientX - rect.left,
                    y: e.clientY - rect.top
                };
                e.preventDefault();
            }

            handleDrag(e) {
                if (!this.isDragging) return;

                if (this.dragTarget === 'float') {
                    const x = e.clientX - this.dragOffset.x;
                    const y = e.clientY - this.dragOffset.y;
                    
                    const maxX = window.innerWidth - this.floatBtn.offsetWidth;
                    const maxY = window.innerHeight - this.floatBtn.offsetHeight;
                    
                    this.floatBtn.style.left = Math.max(0, Math.min(x, maxX)) + 'px';
                    this.floatBtn.style.top = Math.max(0, Math.min(y, maxY)) + 'px';
                    this.floatBtn.style.right = 'auto';
                    this.floatBtn.style.bottom = 'auto';
                } else if (this.dragTarget === 'chat') {
                    const x = e.clientX - this.dragOffset.x;
                    const y = e.clientY - this.dragOffset.y;
                    
                    const maxX = window.innerWidth - this.chatContainer.offsetWidth;
                    const maxY = window.innerHeight - this.chatContainer.offsetHeight;
                    
                    this.chatContainer.style.left = Math.max(0, Math.min(x, maxX)) + 'px';
                    this.chatContainer.style.top = Math.max(0, Math.min(y, maxY)) + 'px';
                    this.chatContainer.style.right = 'auto';
                    this.chatContainer.style.bottom = 'auto';
                }
            }

            stopDrag() {
                if (this.isDragging) {
                    this.isDragging = false;
                    this.floatBtn.classList.remove('dragging');
                    this.saveChatPosition();
                }
            }

            toggleChat() {
                if (this.isDragging) return;
                
                if (this.isOpen) {
                    this.closeChat();
                } else {
                    this.openChat();
                }
            }

            openChat() {
                this.chatContainer.classList.add('show');
                this.isOpen = true;
                this.input.focus();
            }

            closeChat() {
                this.chatContainer.classList.remove('show');
                this.isOpen = false;
            }

            autoResizeTextarea() {
                this.input.style.height = 'auto';
                this.input.style.height = Math.min(this.input.scrollHeight, 100) + 'px';
            }

            addMessage(content, isUser = false, isThinking = false) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `chat-message ${isUser ? 'user' : 'ai'}${isThinking ? ' thinking' : ''}`;
                
                if (isThinking) {
                    messageDiv.innerHTML = `
                        <div class="chat-typing-indicator">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                    `;
                } else {
                    messageDiv.innerHTML = content;
                }
                
                this.messagesContainer.appendChild(messageDiv);
                this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
                
                return messageDiv;
            }

            async sendMessage() {
                const message = this.input.value.trim();
                if (!message) return;

                this.addMessage(message, true);
                this.input.value = '';
                this.autoResizeTextarea();

                const thinkingMessage = this.addMessage('', false, true);
                this.sendBtn.disabled = true;

                try {
                    const response = await this.processAIRequest(message);
                    thinkingMessage.remove();
                    this.addMessage(response, false);
                } catch (error) {
                    thinkingMessage.remove();
                    this.addMessage(`‚ùå Erreur : ${error.message}`, false);
                } finally {
                    this.sendBtn.disabled = false;
                }
            }

            async processAIRequest(userMessage) {
                const cvData = this.extractCVData();
                const analysisData = this.performDeepAnalysis();
                
                // Analyser le type de demande pour adapter la r√©ponse
                const requestType = this.categorizeRequest(userMessage);
                
                let prompt = `Tu es un expert en cr√©ation de CV, recrutement et design graphique avec 20 ans d'exp√©rience. Tu peux modifier directement le CV en temps r√©el.

DEMANDE DE L'UTILISATEUR: "${userMessage}"

CONTENU ACTUEL DU CV:
${cvData}

ANALYSE TECHNIQUE DU CV:
${analysisData}

INSTRUCTIONS SP√âCIALES:
- Tu peux modifier DIRECTEMENT le contenu du CV
- Pour les modifications, utilise les balises [MODIFY:champ:nouveau_contenu] 
- Pour ajouter des exp√©riences: [ADD_EXPERIENCE:titre|entreprise-p√©riode|description]
- Pour ajouter des formations: [ADD_FORMATION:dipl√¥me|√©cole-ann√©e|description]
- Pour modifier la mise en page: [LAYOUT:type] (1-col, 2-col-33-67, 2-col-50-50, 2-col-67-33)
- Pour changer les couleurs: [COLORS:primaire|secondaire|texte]
- Pour changer les polices: [FONTS:h1|h2|body]
- Pour r√©organiser les sections: [REORDER:section1,section2,section3...]

CAPACIT√âS AVANC√âES:
1. Analyse sectorielle et optimisation pour un m√©tier sp√©cifique
2. D√©tection automatique des faiblesses et suggestions d'am√©lioration
3. Optimisation ATS (Applicant Tracking System)
4. Conseils de design et lisibilit√©
5. Adaptation au niveau d'exp√©rience (junior, senior, expert)
6. Optimisation par mots-cl√©s sectoriels

TYPES DE DEMANDES QUE TU PEUX TRAITER:
- Modification de contenu (textes, descriptions, etc.)
- Ajout/suppression d'√©l√©ments
- Changement de mise en page et design
- Optimisation pour un poste/secteur sp√©cifique
- R√©organisation des sections
- Am√©lioration de la lisibilit√©
- Correction d'erreurs grammaticales/orthographiques
- Suggestions de comp√©tences manquantes
- Adaptation du ton (formel, cr√©atif, technique...)

R√©ponds de mani√®re proactive et applique directement les modifications n√©cessaires.`;

                const result = await callGeminiAPI(prompt);
                
                if (result) {
                    await this.parseAndApplyAdvancedSuggestions(result, userMessage);
                    return result;
                } else {
                    throw new Error("Impossible de g√©n√©rer une r√©ponse IA");
                }
            }

            extractCVData() {
                const data = {
                    nom: document.getElementById('nom')?.value || '',
                    prenom: document.getElementById('prenom')?.value || '',
                    poste: document.getElementById('poste')?.value || '',
                    email: document.getElementById('email')?.value || '',
                    telephone: document.getElementById('telephone')?.value || '',
                    description: document.getElementById('description')?.value || '',
                    competences: document.getElementById('competences')?.value || '',
                    experiences: this.extractDynamicData('experience'),
                    formations: this.extractDynamicData('formation')
                };

                return `
Nom: ${data.prenom} ${data.nom}
Poste: ${data.poste}
Email: ${data.email}
T√©l√©phone: ${data.telephone}

Profil professionnel:
${data.description}

Comp√©tences:
${data.competences}

Exp√©riences:
${data.experiences.map(exp => `- ${exp.title} (${exp.meta}): ${exp.desc}`).join('\n')}

Formations:
${data.formations.map(form => `- ${form.title} (${form.meta}): ${form.desc}`).join('\n')}
                `.trim();
            }

            extractDynamicData(type) {
                const container = document.getElementById(`${type}-list`);
                if (!container) return [];

                const items = [];
                container.querySelectorAll('.p-2').forEach(item => {
                    const title = item.querySelector(`[id*="${type}-title-"]`)?.value || '';
                    const meta = item.querySelector(`[id*="${type}-meta-"]`)?.value || '';
                    const desc = item.querySelector(`[id*="${type}-desc-"]`)?.value || '';
                    if (title) items.push({ title, meta, desc });
                });
                return items;
            }

            categorizeRequest(message) {
                const lower = message.toLowerCase();
                
                if (lower.includes('couleur') || lower.includes('color') || lower.includes('design')) return 'design';
                if (lower.includes('police') || lower.includes('font')) return 'typography';
                if (lower.includes('mise en page') || lower.includes('layout') || lower.includes('colonnes')) return 'layout';
                if (lower.includes('exp√©rience') || lower.includes('travail') || lower.includes('emploi')) return 'experience';
                if (lower.includes('formation') || lower.includes('dipl√¥me') || lower.includes('√©cole')) return 'education';
                if (lower.includes('comp√©tence') || lower.includes('skill')) return 'skills';
                if (lower.includes('profil') || lower.includes('description') || lower.includes('r√©sum√©')) return 'profile';
                if (lower.includes('optimis') || lower.includes('am√©lio') || lower.includes('poste')) return 'optimization';
                if (lower.includes('secteur') || lower.includes('industrie') || lower.includes('m√©tier')) return 'sector';
                return 'general';
            }

            performDeepAnalysis() {
                const preview = document.querySelector('#cv-preview');
                const sections = preview.querySelectorAll('.cv-module');
                
                const analysis = {
                    sectionsCount: sections.length,
                    currentLayout: this.getCurrentLayout(),
                    currentTheme: this.getCurrentTheme(),
                    currentFonts: this.getCurrentFonts(),
                    contentAnalysis: this.analyzeContent(),
                    designAnalysis: this.analyzeDesign(),
                    missingElements: this.detectMissingElements()
                };

                return `
Nombre de sections: ${analysis.sectionsCount}
Mise en page actuelle: ${analysis.currentLayout}
Th√®me actuel: ${analysis.currentTheme}
Polices actuelles: H1=${analysis.currentFonts.h1}, H2=${analysis.currentFonts.h2}, Body=${analysis.currentFonts.body}

Analyse du contenu:
${analysis.contentAnalysis}

Analyse du design:
${analysis.designAnalysis}

√âl√©ments manquants d√©tect√©s:
${analysis.missingElements}
                `;
            }

            getCurrentLayout() {
                const container = document.querySelector('.cv-body-container');
                if (container.classList.contains('layout-1-col')) return '1 colonne';
                if (container.classList.contains('layout-2-col-33-67')) return '2 colonnes (33%-67%)';
                if (container.classList.contains('layout-2-col-50-50')) return '2 colonnes (50%-50%)';
                if (container.classList.contains('layout-2-col-67-33')) return '2 colonnes (67%-33%)';
                return 'Layout personnalis√©';
            }

            getCurrentTheme() {
                const body = document.body;
                if (body.classList.contains('theme-elegant')) return '√âl√©gant';
                if (body.classList.contains('theme-tech')) return 'Tech';
                if (body.classList.contains('theme-luxury')) return 'Luxe';
                if (body.classList.contains('theme-startup')) return 'Startup';
                if (body.classList.contains('theme-academic')) return 'Acad√©mique';
                if (body.classList.contains('theme-artistic')) return 'Artistique';
                return 'Standard';
            }

            getCurrentFonts() {
                const styles = getComputedStyle(document.documentElement);
                return {
                    h1: styles.getPropertyValue('--font-family-h1').trim(),
                    h2: styles.getPropertyValue('--font-family-h2').trim(),
                    body: styles.getPropertyValue('--font-family-body').trim()
                };
            }

            analyzeContent() {
                const issues = [];
                const suggestions = [];

                // Analyser le profil
                const profile = document.getElementById('description')?.value;
                if (!profile || profile.length < 50) {
                    issues.push('Profil professionnel trop court ou manquant');
                    suggestions.push('Ajouter une description professionnelle de 80-120 mots');
                }

                // Analyser les exp√©riences
                const experiences = this.extractDynamicData('experience');
                if (experiences.length === 0) {
                    issues.push('Aucune exp√©rience professionnelle');
                } else if (experiences.length < 2) {
                    suggestions.push('Ajouter plus d\'exp√©riences si disponibles');
                }

                // Analyser les formations
                const formations = this.extractDynamicData('formation');
                if (formations.length === 0) {
                    issues.push('Aucune formation mentionn√©e');
                }

                return `Probl√®mes d√©tect√©s: ${issues.join(', ') || 'Aucun'}\nSuggestions: ${suggestions.join(', ') || 'Contenu satisfaisant'}`;
            }

            analyzeDesign() {
                const issues = [];
                const suggestions = [];

                // V√©rifier la lisibilit√©
                const primaryColor = getComputedStyle(document.documentElement).getPropertyValue('--primary-color');
                const secondaryColor = getComputedStyle(document.documentElement).getPropertyValue('--secondary-color');
                
                if (primaryColor === secondaryColor) {
                    issues.push('Couleurs primaire et secondaire identiques');
                }

                // V√©rifier l'√©quilibre des colonnes
                const layout = this.getCurrentLayout();
                const contentDensity = this.analyzeContentDensity();
                
                if (contentDensity.leftHeavy && layout.includes('67%-33%')) {
                    suggestions.push('R√©√©quilibrer le contenu entre les colonnes');
                }

                return `Design: ${issues.join(', ') || 'Bon √©quilibre'}\nAm√©liorations possibles: ${suggestions.join(', ') || 'Design optimal'}`;
            }

            analyzeContentDensity() {
                const leftColumn = document.querySelector('.cv-column:first-child');
                const rightColumn = document.querySelector('.cv-column:last-child');
                
                if (!leftColumn || !rightColumn) return { balanced: true };

                const leftContent = leftColumn.textContent.length;
                const rightContent = rightColumn.textContent.length;
                
                return {
                    leftHeavy: leftContent > rightContent * 1.5,
                    rightHeavy: rightContent > leftContent * 1.5,
                    balanced: Math.abs(leftContent - rightContent) / Math.max(leftContent, rightContent) < 0.3
                };
            }

            detectMissingElements() {
                const missing = [];
                
                if (!document.getElementById('nom')?.value) missing.push('Nom');
                if (!document.getElementById('email')?.value) missing.push('Email');
                if (!document.getElementById('telephone')?.value) missing.push('T√©l√©phone');
                if (!document.getElementById('poste')?.value) missing.push('Intitul√© de poste');
                
                const competences = document.getElementById('competences')?.value;
                if (!competences || competences.trim().length < 10) {
                    missing.push('Comp√©tences d√©taill√©es');
                }

                return missing.length > 0 ? missing.join(', ') : 'Tous les √©l√©ments essentiels sont pr√©sents';
            }

            async parseAndApplyAdvancedSuggestions(aiResponse, userRequest) {
                // Expressions r√©guli√®res pour d√©tecter les commandes
                const modifyRegex = /\[MODIFY:(\w+):([^\]]+)\]/g;
                const addExpRegex = /\[ADD_EXPERIENCE:([^|]+)\|([^|]+)\|([^\]]+)\]/g;
                const addFormRegex = /\[ADD_FORMATION:([^|]+)\|([^|]+)\|([^\]]+)\]/g;
                const layoutRegex = /\[LAYOUT:([^\]]+)\]/g;
                const colorsRegex = /\[COLORS:([^|]+)\|([^|]+)\|([^\]]+)\]/g;
                const fontsRegex = /\[FONTS:([^|]+)\|([^|]+)\|([^\]]+)\]/g;
                const reorderRegex = /\[REORDER:([^\]]+)\]/g;

                let modificationsApplied = [];

                // Traiter les modifications de champs
                let match;
                while ((match = modifyRegex.exec(aiResponse)) !== null) {
                    const [, field, newContent] = match;
                    await this.modifyField(field, newContent);
                    modificationsApplied.push(`${field} modifi√©`);
                }

                // Ajouter des exp√©riences
                while ((match = addExpRegex.exec(aiResponse)) !== null) {
                    const [, titre, meta, description] = match;
                    await this.addExperience(titre, meta, description);
                    modificationsApplied.push(`Exp√©rience "${titre}" ajout√©e`);
                }

                // Ajouter des formations
                while ((match = addFormRegex.exec(aiResponse)) !== null) {
                    const [, diplome, meta, description] = match;
                    await this.addFormation(diplome, meta, description);
                    modificationsApplied.push(`Formation "${diplome}" ajout√©e`);
                }

                // Changer la mise en page
                while ((match = layoutRegex.exec(aiResponse)) !== null) {
                    const [, layoutType] = match;
                    await this.changeLayout(layoutType);
                    modificationsApplied.push(`Mise en page chang√©e: ${layoutType}`);
                }

                // Changer les couleurs
                while ((match = colorsRegex.exec(aiResponse)) !== null) {
                    const [, primary, secondary, text] = match;
                    await this.changeColors(primary, secondary, text);
                    modificationsApplied.push(`Couleurs mises √† jour`);
                }

                // Changer les polices
                while ((match = fontsRegex.exec(aiResponse)) !== null) {
                    const [, h1, h2, body] = match;
                    await this.changeFonts(h1, h2, body);
                    modificationsApplied.push(`Polices mises √† jour`);
                }

                // Auto-modifications intelligentes bas√©es sur le contexte
                await this.applyIntelligentModifications(userRequest, aiResponse);

                if (modificationsApplied.length > 0) {
                    showNotification(`ü§ñ IA: ${modificationsApplied.join(', ')}`, "success", 4000);
                }

                // Mise √† jour de l'aper√ßu
                updatePreview('form');
            }

            async modifyField(field, newContent) {
                const element = document.getElementById(field);
                if (element) {
                    element.value = newContent.trim();
                    // D√©clencher l'√©v√©nement de changement pour mettre √† jour l'aper√ßu
                    element.dispatchEvent(new Event('input', { bubbles: true }));
                }
            }

            async addExperience(titre, meta, description) {
                const container = document.getElementById('experience-list');
                if (container) {
                    const fields = [
                        { key: 'title', placeholder: 'Titre du poste', type: 'input' },
                        { key: 'meta', placeholder: 'Entreprise - P√©riode', type: 'input' },
                        { key: 'desc', placeholder: 'Description', type: 'textarea' }
                    ];
                    const data = { title: titre, meta: meta, desc: description };
                    createDynamicItem(container, fields, data);
                }
            }

            async addFormation(diplome, meta, description) {
                const container = document.getElementById('formation-list');
                if (container) {
                    const fields = [
                        { key: 'title', placeholder: 'Dipl√¥me/Formation', type: 'input' },
                        { key: 'meta', placeholder: '√âcole - Ann√©e', type: 'input' },
                        { key: 'desc', placeholder: 'Description (optionnel)', type: 'textarea' }
                    ];
                    const data = { title: diplome, meta: meta, desc: description };
                    createDynamicItem(container, fields, data);
                }
            }

            async changeLayout(layoutType) {
                const container = document.querySelector('.cv-body-container');
                if (container) {
                    // Supprimer toutes les classes de layout existantes
                    container.classList.remove('layout-1-col', 'layout-2-col-33-67', 'layout-2-col-50-50', 'layout-2-col-67-33');
                    
                    // Ajouter la nouvelle classe de layout
                    const layoutMap = {
                        '1-col': 'layout-1-col',
                        '2-col-33-67': 'layout-2-col-33-67',
                        '2-col-50-50': 'layout-2-col-50-50',
                        '2-col-67-33': 'layout-2-col-67-33'
                    };
                    
                    const layoutClass = layoutMap[layoutType] || 'layout-2-col-50-50';
                    container.classList.add(layoutClass);
                    
                    // Mettre √† jour les boutons de layout
                    document.querySelectorAll('.layout-btn').forEach(btn => {
                        btn.classList.remove('active');
                        if (btn.dataset.layout === layoutType) {
                            btn.classList.add('active');
                        }
                    });
                }
            }

            async changeColors(primary, secondary, text) {
                const root = document.documentElement;
                
                // Convertir les noms de couleurs en codes hex si n√©cessaire
                const colorMap = {
                    'bleu': '#2563eb', 'rouge': '#dc2626', 'vert': '#16a34a', 'violet': '#7c3aed',
                    'orange': '#ea580c', 'rose': '#e91e63', 'cyan': '#0891b2', 'jaune': '#ca8a04',
                    'gris': '#64748b', 'noir': '#1f2937', 'blanc': '#ffffff'
                };
                
                const convertColor = (color) => {
                    const cleanColor = color.toLowerCase().trim();
                    return colorMap[cleanColor] || (cleanColor.startsWith('#') ? cleanColor : `#${cleanColor}`);
                };

                root.style.setProperty('--primary-color', convertColor(primary));
                root.style.setProperty('--secondary-color', convertColor(secondary));
                root.style.setProperty('--body-text-color', convertColor(text));

                // Mettre √† jour les s√©lecteurs de couleur
                const primaryPicker = document.getElementById('primary-color');
                const secondaryPicker = document.getElementById('secondary-color');
                const textPicker = document.getElementById('body-text-color');
                
                if (primaryPicker) primaryPicker.value = convertColor(primary);
                if (secondaryPicker) secondaryPicker.value = convertColor(secondary);
                if (textPicker) textPicker.value = convertColor(text);
            }

            async changeFonts(h1Font, h2Font, bodyFont) {
                const root = document.documentElement;
                
                // Mapper les noms de polices aux valeurs CSS
                const fontMap = {
                    'montserrat': "'Montserrat', sans-serif",
                    'lato': "'Lato', sans-serif",
                    'roboto': "'Roboto', sans-serif",
                    'open sans': "'Open Sans', sans-serif",
                    'playfair': "'Playfair Display', serif",
                    'merriweather': "'Merriweather', serif",
                    'oswald': "'Oswald', sans-serif"
                };

                const convertFont = (font) => {
                    const cleanFont = font.toLowerCase().trim();
                    return fontMap[cleanFont] || font;
                };

                root.style.setProperty('--font-family-h1', convertFont(h1Font));
                root.style.setProperty('--font-family-h2', convertFont(h2Font));
                root.style.setProperty('--font-family-body', convertFont(bodyFont));

                // Mettre √† jour les s√©lecteurs de polices
                const h1Select = document.getElementById('font-family-h1');
                const h2Select = document.getElementById('font-family-h2');
                const bodySelect = document.getElementById('font-family-body');
                
                if (h1Select) h1Select.value = convertFont(h1Font);
                if (h2Select) h2Select.value = convertFont(h2Font);
                if (bodySelect) bodySelect.value = convertFont(bodyFont);
            }

            async applyIntelligentModifications(userRequest, aiResponse) {
                const lowerRequest = userRequest.toLowerCase();
                
                // D√©tection et am√©lioration automatique du profil
                if (lowerRequest.includes('profil') || lowerRequest.includes('description') || lowerRequest.includes('r√©sum√©')) {
                    const improvedProfile = this.extractImprovedContent(aiResponse, ['profil am√©lior√©', 'description am√©lior√©e', 'nouveau profil']);
                    if (improvedProfile) {
                        await this.modifyField('description', improvedProfile);
                    }
                }

                // D√©tection et am√©lioration automatique des comp√©tences
                if (lowerRequest.includes('comp√©tence') || lowerRequest.includes('skill')) {
                    const improvedSkills = this.extractImprovedContent(aiResponse, ['comp√©tences am√©lior√©es', 'skills am√©lior√©s', 'nouvelles comp√©tences']);
                    if (improvedSkills) {
                        await this.modifyField('competences', improvedSkills);
                    }
                }

                // Optimisation automatique pour un secteur
                if (lowerRequest.includes('secteur') || lowerRequest.includes('industrie') || lowerRequest.includes('m√©tier')) {
                    await this.optimizeForSector(userRequest, aiResponse);
                }

                // Am√©lioration automatique du design si demand√©
                if (lowerRequest.includes('design') || lowerRequest.includes('apparence') || lowerRequest.includes('visuel')) {
                    await this.applyDesignImprovements(aiResponse);
                }

                // Correction automatique des erreurs d√©tect√©es
                if (lowerRequest.includes('corriger') || lowerRequest.includes('am√©liorer') || lowerRequest.includes('optimiser')) {
                    await this.autoCorrectIssues();
                }
            }

            extractImprovedContent(aiResponse, keywords) {
                for (const keyword of keywords) {
                    const regex = new RegExp(`${keyword}:?\\s*["""]([^"""]+)["""]`, 'i');
                    const match = aiResponse.match(regex);
                    if (match) return match[1].trim();
                    
                    const regex2 = new RegExp(`${keyword}:?\\s*([^\\n]{20,200})`, 'i');
                    const match2 = aiResponse.match(regex2);
                    if (match2) return match2[1].trim();
                }
                return null;
            }

            async optimizeForSector(userRequest, aiResponse) {
                // Extraire le secteur mentionn√©
                const sectorKeywords = {
                    'tech': ['technologie', 'informatique', 'd√©veloppement', 'programmation'],
                    'commercial': ['vente', 'commercial', 'business', 'marketing'],
                    'finance': ['finance', 'banque', 'comptabilit√©', 'audit'],
                    'sant√©': ['sant√©', 'm√©dical', 'soins', 'h√¥pital'],
                    'education': ['√©ducation', 'enseignement', 'formation', 'p√©dagogie']
                };

                let detectedSector = null;
                for (const [sector, keywords] of Object.entries(sectorKeywords)) {
                    if (keywords.some(keyword => userRequest.toLowerCase().includes(keyword))) {
                        detectedSector = sector;
                        break;
                    }
                }

                if (detectedSector) {
                    await this.applySectorOptimization(detectedSector);
                }
            }

            async applySectorOptimization(sector) {
                const optimizations = {
                    'tech': {
                        colors: ['#2563eb', '#1e40af', '#1f2937'],
                        fonts: ['Roboto Mono', 'Lato', 'Open Sans'],
                        layout: '2-col-67-33'
                    },
                    'commercial': {
                        colors: ['#dc2626', '#991b1b', '#374151'],
                        fonts: ['Montserrat', 'Montserrat', 'Lato'],
                        layout: '2-col-50-50'
                    },
                    'finance': {
                        colors: ['#1e40af', '#1e3a8a', '#1f2937'],
                        fonts: ['Merriweather', 'Lato', 'Open Sans'],
                        layout: '2-col-33-67'
                    }
                };

                const config = optimizations[sector];
                if (config) {
                    await this.changeColors(config.colors[0], config.colors[1], config.colors[2]);
                    await this.changeFonts(config.fonts[0], config.fonts[1], config.fonts[2]);
                    await this.changeLayout(config.layout);
                }
            }

            async applyDesignImprovements(aiResponse) {
                // D√©tecter les suggestions de design dans la r√©ponse
                if (aiResponse.toLowerCase().includes('moderne')) {
                    await this.changeColors('#667eea', '#764ba2', '#2d3748');
                }
                if (aiResponse.toLowerCase().includes('professionnel')) {
                    await this.changeColors('#2563eb', '#1e40af', '#1f2937');
                }
                if (aiResponse.toLowerCase().includes('cr√©atif')) {
                    await this.changeColors('#e91e63', '#9c27b0', '#424242');
                }
            }

            async autoCorrectIssues() {
                // Correction automatique des probl√®mes courants
                const analysis = this.performDeepAnalysis();
                
                // V√©rifier si le profil est trop court
                const profile = document.getElementById('description')?.value;
                if (!profile || profile.length < 50) {
                    // G√©n√©rer un profil automatique bas√© sur les donn√©es existantes
                    await this.generateAutoProfile();
                }

                // Optimiser la mise en page selon le contenu
                const contentDensity = this.analyzeContentDensity();
                if (contentDensity.leftHeavy) {
                    await this.changeLayout('2-col-50-50');
                } else if (contentDensity.rightHeavy) {
                    await this.changeLayout('2-col-67-33');
                }
            }

            async generateAutoProfile() {
                const nom = document.getElementById('nom')?.value || '';
                const prenom = document.getElementById('prenom')?.value || '';
                const poste = document.getElementById('poste')?.value || '';
                const experiences = this.extractDynamicData('experience');
                
                if (poste && experiences.length > 0) {
                    const autoProfile = `Professionnel ${poste.toLowerCase()} avec ${experiences.length > 2 ? 'plusieurs ann√©es' : 'une exp√©rience'} d'exp√©rience. Passionn√© par l'excellence et l'innovation, je mets mes comp√©tences au service de projets ambitieux pour contribuer au succ√®s de l'entreprise.`;
                    
                    await this.modifyField('description', autoProfile);
                    this.addMessage(`‚ú® J'ai g√©n√©r√© automatiquement un profil professionnel bas√© sur vos informations.`, false);
                }
            }

            initializeVoiceRecognition() {
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    this.recognition = new SpeechRecognition();
                    this.recognition.continuous = false;
                    this.recognition.interimResults = false;
                    this.recognition.lang = 'fr-FR';

                    this.recognition.onresult = (event) => {
                        const transcript = event.results[0][0].transcript;
                        this.input.value = transcript;
                        this.sendMessage();
                        this.voiceBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                        this.voiceBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                    };

                    this.recognition.onerror = () => {
                        this.voiceBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                        this.voiceBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                        this.addMessage('‚ùå Erreur de reconnaissance vocale. Veuillez r√©essayer.', false);
                    };
                } else {
                    this.voiceBtn.style.display = 'none';
                }
            }

            toggleVoiceRecognition() {
                if (this.recognition) {
                    if (this.voiceBtn.innerHTML.includes('fa-stop')) {
                        this.recognition.stop();
                        this.voiceBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                        this.voiceBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                    } else {
                        this.recognition.start();
                        this.voiceBtn.innerHTML = '<i class="fas fa-stop"></i>';
                        this.voiceBtn.style.background = '#ef4444';
                        this.addMessage('üé§ Parlez maintenant...', false);
                    }
                }
            }

            async generateSmartSuggestions() {
                const analysis = this.performDeepAnalysis();
                const cvData = this.extractCVData();
                
                this.addMessage('üîç Analyse de votre CV en cours...', false, true);
                
                const prompt = `Analyse ce CV et g√©n√®re 3-5 suggestions d'am√©lioration tr√®s sp√©cifiques et actionnables :

${cvData}

Analyse technique :
${analysis}

Fournis des suggestions courtes et pr√©cises que l'utilisateur peut demander directement. Format : "suggestion1|suggestion2|suggestion3"`;

                try {
                    const suggestions = await callGeminiAPI(prompt);
                    if (suggestions) {
                        const suggestionList = suggestions.split('|').filter(s => s.trim());
                        
                        let suggestionsHTML = 'üí° <strong>Suggestions intelligentes bas√©es sur votre CV :</strong><br><br>';
                        suggestionList.forEach((suggestion, index) => {
                            suggestionsHTML += `<span class="suggestion-chip" data-suggestion="${suggestion.trim()}">${index + 1}. ${suggestion.trim()}</span><br>`;
                        });
                        
                        this.addMessage(suggestionsHTML, false);
                    }
                } catch (error) {
                    this.addMessage('‚ùå Erreur lors de la g√©n√©ration des suggestions.', false);
                }
            }

            async performQuickFix() {
                this.addMessage('‚ö° Correction rapide en cours...', false, true);
                
                const issues = this.detectQuickFixIssues();
                let fixesApplied = [];

                // Appliquer les corrections automatiquement
                for (const issue of issues) {
                    switch (issue.type) {
                        case 'missing_profile':
                            await this.generateAutoProfile();
                            fixesApplied.push('Profil professionnel g√©n√©r√©');
                            break;
                        case 'short_profile':
                            const currentProfile = document.getElementById('description')?.value || '';
                            const enhancedProfile = await this.enhanceProfile(currentProfile);
                            if (enhancedProfile) {
                                await this.modifyField('description', enhancedProfile);
                                fixesApplied.push('Profil enrichi');
                            }
                            break;
                        case 'missing_contact':
                            this.addMessage('‚ö†Ô∏è Informations de contact manquantes. Veuillez les ajouter manuellement.', false);
                            break;
                        case 'layout_optimization':
                            const optimalLayout = this.calculateOptimalLayout();
                            await this.changeLayout(optimalLayout);
                            fixesApplied.push(`Mise en page optimis√©e (${optimalLayout})`);
                            break;
                        case 'color_improvement':
                            await this.applyOptimalColors();
                            fixesApplied.push('Couleurs optimis√©es');
                            break;
                    }
                }

                if (fixesApplied.length > 0) {
                    this.addMessage(`‚úÖ Corrections appliqu√©es : ${fixesApplied.join(', ')}`, false);
                    showNotification(`ü§ñ IA: ${fixesApplied.length} am√©liorations appliqu√©es`, "success", 3000);
                } else {
                    this.addMessage('‚úÖ Votre CV est d√©j√† bien optimis√© ! Pas de corrections majeures n√©cessaires.', false);
                }
            }

            detectQuickFixIssues() {
                const issues = [];
                
                // V√©rifier le profil
                const profile = document.getElementById('description')?.value;
                if (!profile || profile.trim().length === 0) {
                    issues.push({ type: 'missing_profile', priority: 'high' });
                } else if (profile.length < 80) {
                    issues.push({ type: 'short_profile', priority: 'medium' });
                }

                // V√©rifier les informations de contact
                const email = document.getElementById('email')?.value;
                const phone = document.getElementById('telephone')?.value;
                if (!email || !phone) {
                    issues.push({ type: 'missing_contact', priority: 'high' });
                }

                // V√©rifier la mise en page
                const contentDensity = this.analyzeContentDensity();
                if (!contentDensity.balanced) {
                    issues.push({ type: 'layout_optimization', priority: 'medium' });
                }

                // V√©rifier les couleurs
                const primaryColor = getComputedStyle(document.documentElement).getPropertyValue('--primary-color');
                const secondaryColor = getComputedStyle(document.documentElement).getPropertyValue('--secondary-color');
                if (primaryColor === secondaryColor) {
                    issues.push({ type: 'color_improvement', priority: 'low' });
                }

                return issues;
            }

            async enhanceProfile(currentProfile) {
                const prompt = `Am√©liore ce profil professionnel pour le rendre plus percutant et professionnel (80-120 mots) :

"${currentProfile}"

Rends-le plus dynamique, professionnel et attractif pour les recruteurs.`;

                try {
                    return await callGeminiAPI(prompt);
                } catch (error) {
                    return null;
                }
            }

            calculateOptimalLayout() {
                const experiences = this.extractDynamicData('experience');
                const formations = this.extractDynamicData('formation');
                const competences = document.getElementById('competences')?.value || '';
                
                // Si beaucoup de contenu, utiliser 2 colonnes √©quilibr√©es
                if (experiences.length > 3 || formations.length > 2 || competences.length > 200) {
                    return '2-col-50-50';
                }
                // Si peu de contenu, utiliser une colonne
                else if (experiences.length <= 1 && formations.length <= 1) {
                    return '1-col';
                }
                // Sinon, utiliser un layout asym√©trique
                else {
                    return '2-col-67-33';
                }
            }

            async applyOptimalColors() {
                // Couleurs professionnelles optimis√©es
                const colorSchemes = [
                    { primary: '#2563eb', secondary: '#1e40af', text: '#1f2937' }, // Bleu professionnel
                    { primary: '#059669', secondary: '#047857', text: '#1f2937' }, // Vert moderne
                    { primary: '#7c3aed', secondary: '#6d28d9', text: '#1f2937' }, // Violet cr√©atif
                    { primary: '#dc2626', secondary: '#b91c1c', text: '#1f2937' }  // Rouge dynamique
                ];
                
                // Choisir un sch√©ma bas√© sur le contenu
                const randomScheme = colorSchemes[Math.floor(Math.random() * colorSchemes.length)];
                await this.changeColors(randomScheme.primary, randomScheme.secondary, randomScheme.text);
            }

            saveChatPosition() {
                const floatBtnRect = this.floatBtn.getBoundingClientRect();
                const chatRect = this.chatContainer.getBoundingClientRect();
                
                localStorage.setItem('ai-chat-position', JSON.stringify({
                    floatBtn: { left: floatBtnRect.left, top: floatBtnRect.top },
                    chat: { left: chatRect.left, top: chatRect.top }
                }));
            }

            loadChatPosition() {
                const saved = localStorage.getItem('ai-chat-position');
                if (saved) {
                    const positions = JSON.parse(saved);
                    
                    if (positions.floatBtn) {
                        this.floatBtn.style.left = positions.floatBtn.left + 'px';
                        this.floatBtn.style.top = positions.floatBtn.top + 'px';
                        this.floatBtn.style.right = 'auto';
                        this.floatBtn.style.bottom = 'auto';
                    }
                    
                    if (positions.chat) {
                        this.chatContainer.style.left = positions.chat.left + 'px';
                        this.chatContainer.style.top = positions.chat.top + 'px';
                        this.chatContainer.style.right = 'auto';
                        this.chatContainer.style.bottom = 'auto';
                    }
                }
            }
        }

        // Initialize the AI Chat when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            window.aiChat = new AdvancedAIChat();
        });
    </script>

    <!-- Advanced AI Chat System -->
    <button id="ai-chat-float-btn" title="Chat IA Avanc√© - Glissez pour d√©placer">
        <i class="fas fa-comments"></i>
    </button>

    <div id="ai-chat-container">
        <div id="ai-chat-header">
            <h3><i class="fas fa-robot mr-2"></i>Assistant IA Avanc√©</h3>
            <button id="ai-chat-close-btn">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div id="ai-chat-messages">
            <div class="chat-message ai">
                ü§ñ <strong>Assistant IA Ultra-Intelligent</strong>
                <br><br>
                Je peux <strong>modifier directement</strong> votre CV en temps r√©el ! Voici mes super-pouvoirs :
                
                <div class="chat-suggestions">
                    <span class="suggestion-chip" data-suggestion="Analyse compl√®te de mon CV et applique toutes les am√©liorations n√©cessaires">üîç Analyse compl√®te</span>
                    <span class="suggestion-chip" data-suggestion="Optimise mon CV pour un poste de d√©veloppeur web">üíª Optimiser pour un m√©tier</span>
                    <span class="suggestion-chip" data-suggestion="Am√©liore automatiquement le design et les couleurs">üé® Am√©liorer le design</span>
                    <span class="suggestion-chip" data-suggestion="R√©√©cris mon profil professionnel pour le rendre plus percutant">‚úçÔ∏è R√©√©crire le profil</span>
                    <span class="suggestion-chip" data-suggestion="Ajoute des comp√©tences manquantes selon mon secteur">‚≠ê Ajouter comp√©tences</span>
                    <span class="suggestion-chip" data-suggestion="Change la mise en page pour une meilleure lisibilit√©">üìã Optimiser layout</span>
                    <span class="suggestion-chip" data-suggestion="Corrige toutes les erreurs et incoh√©rences">üîß Correction auto</span>
                    <span class="suggestion-chip" data-suggestion="Adapte le ton pour un secteur cr√©atif">üé≠ Changer le ton</span>
                </div>
                
                <br>
                <strong>üí° Exemples de commandes :</strong><br>
                ‚Ä¢ "Change les couleurs en bleu et gris moderne"<br>
                ‚Ä¢ "Ajoute une exp√©rience de stage en d√©veloppement"<br>
                ‚Ä¢ "Optimise pour un poste de chef de projet"<br>
                ‚Ä¢ "R√©organise les sections pour plus d'impact"<br>
                ‚Ä¢ "Change les polices pour un style plus professionnel"<br>
                
                <br>
                <em>Demandez-moi n'importe quoi, je modifierai directement votre CV ! üöÄ</em>
            </div>
        </div>
        
        <div id="ai-chat-input-container">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                <button id="ai-voice-btn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; color: white; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px;">
                    <i class="fas fa-microphone"></i>
                </button>
                <button id="ai-smart-suggest-btn" style="background: #10b981; border: none; color: white; padding: 4px 8px; border-radius: 12px; cursor: pointer; font-size: 12px;">
                    üí° Suggestions intelligentes
                </button>
                <button id="ai-quick-fix-btn" style="background: #f59e0b; border: none; color: white; padding: 4px 8px; border-radius: 12px; cursor: pointer; font-size: 12px;">
                    ‚ö° Correction rapide
                </button>
            </div>
            <textarea id="ai-chat-input" placeholder="Ex: 'Change les couleurs en bleu moderne' ou 'Optimise pour un poste de marketing'..." rows="1"></textarea>
            <button id="ai-chat-send-btn">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

</body>
</html>